<!DOCTYPE html><html class="theme-next gemini" lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><script src="//cdn.jsdelivr.net/npm/pace-js@1/pace.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/pace-js@1/themes/blue/pace-theme-minimal.css"><meta name="google-site-verification" content="27nKwb_oPifd-peB2Juh7eiKE-ZIpIcPp7ug9xPLKh4"><script data-ad-client="ca-pub-6677803223619857" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>
  window.onload = function() {
          setTimeout(function() {
                  let script = document.createElement("script");
                  script.setAttribute("async", "");
                  script.src = "//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js";
                  document.body.appendChild(script);
          }, 2e3);
  }
  </script><meta name="baidu-site-verification" content="2U3NKVcqUGdR2dZr"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4/css/font-awesome.min.css"><link rel="stylesheet" href="/css/main.css?v=6.7.0"><link rel="icon" type="image/png" sizes="32x32" href="//cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io/images/next-favicon-32.png?v=6.7.0"><link rel="icon" type="image/png" sizes="16x16" href="//cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io/images/next-favicon-16.png?v=6.7.0"><script id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Gemini",version:"6.7.0",sidebar:{position:"left",display:"post",offset:12,b2t:!0,scrollpercent:!0,onmobile:!1},fancybox:!1,fastclick:!1,lazyload:!1,tabs:!0,motion:{enable:!1,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><meta name="description" content="前面文章对数据库中间层进行了选型，那么要怎么安装，怎么验证，怎么优化，又有哪些坑可以避免呢？本文就详细介绍下。"><meta name="keywords" content="Mysql"><meta property="og:type" content="article"><meta property="og:title" content="生产mysql数据库集群优化&lt;二&gt;--proxysql安装及优化"><meta property="og:url" content="https://wandouduoduo.github.io/articles/8307f670.html"><meta property="og:site_name" content="运维随笔"><meta property="og:description" content="前面文章对数据库中间层进行了选型，那么要怎么安装，怎么验证，怎么优化，又有哪些坑可以避免呢？本文就详细介绍下。"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@master/articles/8307f670/1.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@master/articles/8307f670/2.png"><meta property="og:updated_time" content="2021-06-23T06:50:34.742Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="生产mysql数据库集群优化&lt;二&gt;--proxysql安装及优化"><meta name="twitter:description" content="前面文章对数据库中间层进行了选型，那么要怎么安装，怎么验证，怎么优化，又有哪些坑可以避免呢？本文就详细介绍下。"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@master/articles/8307f670/1.png"><link rel="alternate" href="/atom.xml" title="运维随笔" type="application/atom+xml"><link rel="canonical" href="https://wandouduoduo.github.io/articles/8307f670.html"><script id="page.configurations">CONFIG.page={sidebar:""}</script><title>生产mysql数据库集群优化<二>--proxysql安装及优化 | 运维随笔</二></title><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?a40bcdb5c2cd18d8294a08372dea701b";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-title,.use-motion .comments,.use-motion .menu-item,.use-motion .motion-element,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .logo,.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN"><link rel="stylesheet" href="/dist/APlayer.min.css"><div id="aplayer"></div><script type="text/javascript" src="/dist/APlayer.min.js"></script><script type="text/javascript" src="/dist/music.js"></script><div class="container sidebar-position-left page-post-detail"><div class="headband"></div> <a href="https://github.com/wandouduoduo" rel="external nofollow noreferrer" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewbox="0 0 250 250" style="fill:#fd6c6c;color:#fff;position:absolute;top:0;border:0;right:0" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"/></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">运维随笔</span><span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">SRE & Devops & Architect</h1></div><div class="site-nav-toggle"> <button aria-label="切换导航栏"><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>分类</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于</a></li><li class="menu-item menu-item-tools"><a href="/tools/" rel="section"><i class="menu-item-icon fa fa-fw fa-heartbeat"></i><br>工具</a></li><li class="menu-item menu-item-search"><a href="javascript:;" rel="external nofollow noreferrer" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i></span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"> <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://wandouduoduo.github.io/articles/8307f670.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="豌豆多多"><meta itemprop="description" content="资深运维架构师豌豆多多的呕心笔记"><meta itemprop="image" content="/images/yunwei.png"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="运维随笔"></span><header class="post-header"><h2 class="post-title" itemprop="name headline">生产mysql数据库集群优化<二>--proxysql安装及优化</二></h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2021-06-23 14:26:18 / 修改时间：14:50:34" itemprop="dateCreated datePublished" datetime="2021-06-23T14:26:18+08:00">2021-06-23</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/数据库/" itemprop="url" rel="index"><span itemprop="name">数据库</span></a></span> > <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/数据库/SQL/" itemprop="url" rel="index"><span itemprop="name">SQL</span></a></span> > <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/数据库/SQL/Mysql/" itemprop="url" rel="index"><span itemprop="name">Mysql</span></a></span></span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-eye"></i> 阅读次数：<span class="busuanzi-value" id="busuanzi_value_page_pv"></span></span><div class="post-symbolscount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i></span> <span class="post-meta-item-text">本文字数：</span> <span title="本文字数">235k</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span title="阅读时长">3:33</span></div></div></header><div class="post-body" itemprop="articleBody"><div id="vip-container"><p>前面文章对数据库中间层进行了选型，那么要怎么安装，怎么验证，怎么优化，又有哪些坑可以避免呢？本文就详细介绍下。</p><a id="more"></a><h2 id="ProxySQL-安装-两种方式"><a href="#ProxySQL-安装-两种方式" class="headerlink" title="ProxySQL 安装 (两种方式)"></a><strong>ProxySQL 安装 (两种方式)</strong></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">1) 采用yum方式安装</span><br><span class="line">[root@mysql-proxy ~]<span class="comment"># vim /etc/yum.repos.d/proxysql.repo</span></span><br><span class="line">[proxysql_repo]</span><br><span class="line">name= ProxySQL YUM repository</span><br><span class="line">baseurl=http://repo.proxysql.com/ProxySQL/proxysql-1.4.x/centos/\<span class="variable">$releasever</span></span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=http://repo.proxysql.com/ProxySQL/repo_pub_key</span><br><span class="line"> </span><br><span class="line">执行安装</span><br><span class="line">[root@mysql-proxy ~]<span class="comment"># yum clean all</span></span><br><span class="line">[root@mysql-proxy ~]<span class="comment"># yum makecache</span></span><br><span class="line">[root@mysql-proxy ~]<span class="comment"># yum -y install proxysql</span></span><br><span class="line">  </span><br><span class="line">[root@mysql-proxy ~]<span class="comment"># proxysql --version</span></span><br><span class="line">ProxySQL version 1.4.13-15-g69d4207, codename Truls</span><br><span class="line">  </span><br><span class="line">启动ProxySQL</span><br><span class="line">[root@mysql-proxy ~]<span class="comment"># chkconfig proxysql on</span></span><br><span class="line">[root@mysql-proxy ~]<span class="comment"># systemctl start proxysql      </span></span><br><span class="line">[root@mysql-proxy ~]<span class="comment"># systemctl status proxysql</span></span><br><span class="line"> </span><br><span class="line">启动后会监听两个端口，</span><br><span class="line">默认为6032和6033。6032端口是ProxySQL的管理端口，6033是ProxySQL对外提供服务的端口 (即连接到转发后端的真正数据库的转发端口)。</span><br><span class="line">[root@mysql-proxy ~]<span class="comment"># netstat -tunlp</span></span><br><span class="line">Active Internet connections (only servers)</span><br><span class="line">Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name  </span><br><span class="line">tcp        0      0 0.0.0.0:6032            0.0.0.0:*               LISTEN      23940/proxysql    </span><br><span class="line">tcp        0      0 0.0.0.0:6033            0.0.0.0:*               LISTEN      23940/proxysql</span><br><span class="line"> </span><br><span class="line">2）采用rpm包方式安装</span><br><span class="line">proxysql的rpm包下载地址: https://pan.baidu.com/s/1S1_b5DKVCpZSOUNmtCXrrg</span><br><span class="line">提取密码: 5t1c</span><br><span class="line">  </span><br><span class="line">[root@mysql-proxy ~]<span class="comment"># wget https://github.com/sysown/proxysql/releases/download/v1.4.8/proxysql-1.4.8-1-centos7.x86_64.rpm</span></span><br><span class="line">[root@mysql-proxy ~]<span class="comment"># rpm -ivh proxysql-1.4.8-1-centos7.x86_64.rpm --force</span></span><br><span class="line"> </span><br><span class="line">[root@mysql-proxy ~]<span class="comment"># /etc/init.d/proxysql start</span></span><br><span class="line">Starting ProxySQL: DONE!</span><br><span class="line"> </span><br><span class="line">[root@mysql-proxy ~]<span class="comment"># ss -lntup|grep proxy</span></span><br><span class="line">tcp    LISTEN     0      128       *:6032                  *:*                   users:((<span class="string">"proxysql"</span>,pid=2943,fd=24))</span><br><span class="line">tcp    LISTEN     0      128       *:6033                  *:*                   users:((<span class="string">"proxysql"</span>,pid=2943,fd=22))</span><br><span class="line">tcp    LISTEN     0      128       *:6033                  *:*                   users:((<span class="string">"proxysql"</span>,pid=2943,fd=21))</span><br><span class="line">tcp    LISTEN     0      128       *:6033                  *:*                   users:((<span class="string">"proxysql"</span>,pid=2943,fd=20))</span><br><span class="line">tcp    LISTEN     0      128       *:6033                  *:*                   users:((<span class="string">"proxysql"</span>,pid=2943,fd=19))</span><br><span class="line"> </span><br><span class="line">如上可以看出转发端口6033是启动了四个线程</span><br><span class="line"> </span><br><span class="line">==============================================================</span><br><span class="line">以上两种方式采用任何一种都可以顺利安装proxysql插件。</span><br><span class="line"> </span><br><span class="line">另外，记得在proxysql服务器上安装mysql客户端，用于在本机连接到ProxySQL的管理接口</span><br><span class="line">[root@mysql-proxy ~]<span class="comment"># vim /etc/yum.repos.d/mariadb.repo</span></span><br><span class="line">[mariadb]</span><br><span class="line">name = MariaDB</span><br><span class="line">baseurl = http://yum.mariadb.org/10.3.5/centos6-amd64</span><br><span class="line">gpgkey=https://yum.mariadb.org/RPM-GPG-KEY-MariaDB</span><br><span class="line">gpgcheck=1</span><br><span class="line">   </span><br><span class="line">安装mysql-clinet客户端</span><br><span class="line">[root@mysql-proxy ~]<span class="comment"># yum install -y MariaDB-client</span></span><br><span class="line">  </span><br><span class="line">--------------------------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line">如果遇到报错：</span><br><span class="line">Error: MariaDB-compat conflicts with 1:mariadb-libs-5.5.60-1.el7_5.x86_64</span><br><span class="line"> You could try using --skip-broken to work around the problem</span><br><span class="line"> You could try running: rpm -Va --nofiles --nodigest</span><br><span class="line">   </span><br><span class="line">解决办法：</span><br><span class="line">[root@mysql-proxy ~]<span class="comment"># rpm -qa|grep mariadb*</span></span><br><span class="line">mariadb-libs-5.5.56-2.el7.x86_64</span><br><span class="line">[root@mysql-proxy ~]<span class="comment"># rpm -e mariadb-libs-5.5.56-2.el7.x86_64 --nodeps</span></span><br><span class="line">[root@mysql-proxy ~]<span class="comment"># yum install -y MariaDB-client</span></span><br></pre></td></tr></table></figure><h2 id="ProxySQL配置"><a href="#ProxySQL配置" class="headerlink" title="ProxySQL配置"></a><strong>ProxySQL配置</strong></h2><p>ProxySQL有配置文件/etc/proxysql.cnf和配置数据库文件/var/lib/proxysql/proxysql.db。<strong>这里需要特别注意：如果存在如果存在”proxysql.db”文件(在/var/lib/proxysql目录下)，则ProxySQL服务只有在第一次启动时才会去读取proxysql.cnf文件并解析；后面启动会就不会读取proxysql.cnf文件了！如果想要让proxysql.cnf文件里的配置在重启proxysql服务后生效(即想要让proxysql重启时读取并解析proxysql.cnf配置文件)，则需要先删除/var/lib/proxysql/proxysql.db数据库文件，然后再重启proxysql服务。这样就相当于初始化启动proxysql服务了，会再次生产一个纯净的proxysql.db数据库文件(如果之前配置了proxysql相关路由规则等，则就会被抹掉)。</strong> 官方推荐用admin interface方式！(即在proxysql本机使用mysql客户端连接管理端口)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br></pre></td><td class="code"><pre><span class="line">[root@mysql-proxy ~]<span class="comment"># egrep -v "^#|^$" /etc/proxysql.cnf</span></span><br><span class="line">datadir=<span class="string">"/var/lib/proxysql"</span>                                   <span class="comment">#数据目录</span></span><br><span class="line">admin_variables=</span><br><span class="line">&#123;</span><br><span class="line">        admin_credentials=<span class="string">"admin:admin"</span>                       <span class="comment">#连接管理端的用户名与密码</span></span><br><span class="line">        mysql_ifaces=<span class="string">"0.0.0.0:6032"</span>                           <span class="comment">#管理端口，用来连接proxysql的管理数据库</span></span><br><span class="line">&#125;</span><br><span class="line">mysql_variables=</span><br><span class="line">&#123;</span><br><span class="line">        threads=4                                             <span class="comment">#指定转发端口开启的线程数量</span></span><br><span class="line">        max_connections=2048</span><br><span class="line">        default_query_delay=0</span><br><span class="line">        default_query_timeout=36000000</span><br><span class="line">        have_compress=<span class="literal">true</span></span><br><span class="line">        poll_timeout=2000</span><br><span class="line">        interfaces=<span class="string">"0.0.0.0:6033"</span>                             <span class="comment">#指定转发端口，用于连接后端mysql数据库的，相当于代理作用</span></span><br><span class="line">        default_schema=<span class="string">"information_schema"</span></span><br><span class="line">        stacksize=1048576</span><br><span class="line">        server_version=<span class="string">"5.5.30"</span>                               <span class="comment">#指定后端mysql的版本</span></span><br><span class="line">        connect_timeout_server=3000</span><br><span class="line">        monitor_username=<span class="string">"monitor"</span></span><br><span class="line">        monitor_password=<span class="string">"monitor"</span></span><br><span class="line">        monitor_history=600000</span><br><span class="line">        monitor_connect_interval=60000</span><br><span class="line">        monitor_ping_interval=10000</span><br><span class="line">        monitor_read_only_interval=1500</span><br><span class="line">        monitor_read_only_timeout=500</span><br><span class="line">        ping_interval_server_msec=120000</span><br><span class="line">        ping_timeout_server=500</span><br><span class="line">        commands_stats=<span class="literal">true</span></span><br><span class="line">        sessions_sort=<span class="literal">true</span></span><br><span class="line">        connect_retries_on_failure=10</span><br><span class="line">&#125;</span><br><span class="line">mysql_servers =</span><br><span class="line">(</span><br><span class="line">)</span><br><span class="line">mysql_users:</span><br><span class="line">(</span><br><span class="line">)</span><br><span class="line">mysql_query_rules:</span><br><span class="line">(</span><br><span class="line">)</span><br><span class="line">scheduler=</span><br><span class="line">(</span><br><span class="line">)</span><br><span class="line">mysql_replication_hostgroups=</span><br><span class="line">(</span><br><span class="line">)</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">proxysql的数据目录</span><br><span class="line">[root@mysql-proxy ~]<span class="comment"># ll /var/lib/proxysql/</span></span><br><span class="line">total 1014052</span><br><span class="line">-rw------- 1 root root     122880 Jan 25 14:33 proxysql.db</span><br><span class="line">-rw------- 1 root root 1023288179 Jan 28 12:30 proxysql.log</span><br><span class="line">-rw-r--r-- 1 root root          6 Jan 25 14:20 proxysql.pid</span><br><span class="line">-rw------- 1 root root    1736704 Jan 28 12:29 proxysql_stats.db</span><br><span class="line"> </span><br><span class="line">查看main库（默认登陆后即在此库）的global_variables表信息</span><br><span class="line">MySQL [(none)]&gt; show databases;</span><br><span class="line">+-----+---------------+-------------------------------------+</span><br><span class="line">| seq | name          | file                                |</span><br><span class="line">+-----+---------------+-------------------------------------+</span><br><span class="line">| 0   | main          |                                     |</span><br><span class="line">| 2   | disk          | /var/lib/proxysql/proxysql.db       |</span><br><span class="line">| 3   | stats         |                                     |</span><br><span class="line">| 4   | monitor       |                                     |</span><br><span class="line">| 5   | stats_history | /var/lib/proxysql/proxysql_stats.db |</span><br><span class="line">+-----+---------------+-------------------------------------+</span><br><span class="line">5 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.000 sec)</span><br><span class="line"> </span><br><span class="line">MySQL [(none)]&gt; use main;</span><br><span class="line">Reading table information <span class="keyword">for</span> completion of table and column names</span><br><span class="line">You can turn off this feature to get a quicker startup with -A</span><br><span class="line"> </span><br><span class="line">Database changed</span><br><span class="line">MySQL [main]&gt; show tables;</span><br><span class="line">+--------------------------------------------+</span><br><span class="line">| tables                                     |</span><br><span class="line">+--------------------------------------------+</span><br><span class="line">| global_variables                           |</span><br><span class="line">| mysql_collations                           |</span><br><span class="line">| mysql_group_replication_hostgroups         |</span><br><span class="line">| mysql_query_rules                          |</span><br><span class="line">| mysql_query_rules_fast_routing             |</span><br><span class="line">| mysql_replication_hostgroups               |</span><br><span class="line">| mysql_servers                              |</span><br><span class="line">| mysql_users                                |</span><br><span class="line">| proxysql_servers                           |</span><br><span class="line">| runtime_checksums_values                   |</span><br><span class="line">| runtime_global_variables                   |</span><br><span class="line">| runtime_mysql_group_replication_hostgroups |</span><br><span class="line">| runtime_mysql_query_rules                  |</span><br><span class="line">| runtime_mysql_query_rules_fast_routing     |</span><br><span class="line">| runtime_mysql_replication_hostgroups       |</span><br><span class="line">| runtime_mysql_servers                      |</span><br><span class="line">| runtime_mysql_users                        |</span><br><span class="line">| runtime_proxysql_servers                   |</span><br><span class="line">| runtime_scheduler                          |</span><br><span class="line">| scheduler                                  |</span><br><span class="line">+--------------------------------------------+</span><br><span class="line">20 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.000 sec)</span><br><span class="line"> </span><br><span class="line">MySQL [main]&gt; select * from global_variables;</span><br><span class="line">+-----------------------------------------------------+---------------------------+</span><br><span class="line">| variable_name                                       | variable_value            |</span><br><span class="line">+-----------------------------------------------------+---------------------------+</span><br><span class="line">| mysql-shun_on_failures                              | 5                         |</span><br><span class="line">| mysql-shun_recovery_time_sec                        | 10                        |</span><br><span class="line">| mysql-query_retries_on_failure                      | 1                         |</span><br><span class="line">| mysql-connect_retries_delay                         | 1                         |</span><br><span class="line">| mysql-connection_delay_multiplex_ms                 | 0                         |</span><br><span class="line">| mysql-connection_max_age_ms                         | 0                         |</span><br><span class="line">| mysql-connect_timeout_server_max                    | 10000                     |</span><br><span class="line">| mysql-eventslog_filename                            |                           |</span><br><span class="line">| mysql-eventslog_filesize                            | 104857600                 |</span><br><span class="line">| mysql-default_charset                               | utf8                      |</span><br><span class="line">| mysql-free_connections_pct                          | 10                        |</span><br><span class="line">| mysql-session_idle_ms                               | 1000                      |</span><br><span class="line">| mysql-client_found_rows                             | <span class="literal">true</span>                      |</span><br><span class="line">| mysql-monitor_enabled                               | <span class="literal">true</span>                      |</span><br><span class="line">| mysql-monitor_connect_timeout                       | 600                       |</span><br><span class="line">| mysql-monitor_ping_max_failures                     | 3                         |</span><br><span class="line">| mysql-monitor_ping_timeout                          | 1000                      |</span><br><span class="line">| mysql-monitor_read_only_max_timeout_count           | 3                         |</span><br><span class="line">| mysql-monitor_replication_lag_interval              | 10000                     |</span><br><span class="line">| mysql-monitor_replication_lag_timeout               | 1000                      |</span><br><span class="line">| mysql-monitor_groupreplication_healthcheck_interval | 5000                      |</span><br><span class="line">| mysql-monitor_groupreplication_healthcheck_timeout  | 800                       |</span><br><span class="line">| mysql-monitor_replication_lag_use_percona_heartbeat |                           |</span><br><span class="line">| mysql-monitor_query_interval                        | 60000                     |</span><br><span class="line">| mysql-monitor_query_timeout                         | 100                       |</span><br><span class="line">| mysql-monitor_slave_lag_when_null                   | 60                        |</span><br><span class="line">| mysql-monitor_wait_timeout                          | <span class="literal">true</span>                      |</span><br><span class="line">| mysql-monitor_writer_is_also_reader                 | <span class="literal">true</span>                      |</span><br><span class="line">| mysql-max_allowed_packet                            | 4194304                   |</span><br><span class="line">| mysql-throttle_connections_per_sec_to_hostgroup     | 1000000                   |</span><br><span class="line">| mysql-max_transaction_time                          | 14400000                  |</span><br><span class="line">| mysql-multiplexing                                  | <span class="literal">true</span>                      |</span><br><span class="line">| mysql-forward_autocommit                            | <span class="literal">false</span>                     |</span><br><span class="line">| mysql-enforce_autocommit_on_reads                   | <span class="literal">false</span>                     |</span><br><span class="line">| mysql-autocommit_false_not_reusable                 | <span class="literal">false</span>                     |</span><br><span class="line">| mysql-autocommit_false_is_transaction               | <span class="literal">false</span>                     |</span><br><span class="line">| mysql-verbose_query_error                           | <span class="literal">false</span>                     |</span><br><span class="line">| mysql-hostgroup_manager_verbose                     | 1                         |</span><br><span class="line">| mysql-threshold_query_length                        | 524288                    |</span><br><span class="line">| mysql-threshold_resultset_size                      | 4194304                   |</span><br><span class="line">| mysql-query_digests_max_digest_length               | 2048                      |</span><br><span class="line">| mysql-query_digests_max_query_length                | 65000                     |</span><br><span class="line">| mysql-wait_timeout                                  | 28800000                  |</span><br><span class="line">| mysql-throttle_max_bytes_per_second_to_client       | 2147483647                |</span><br><span class="line">| mysql-throttle_ratio_server_to_client               | 0                         |</span><br><span class="line">| mysql-max_stmts_per_connection                      | 20                        |</span><br><span class="line">| mysql-max_stmts_cache                               | 10000                     |</span><br><span class="line">| mysql-mirror_max_concurrency                        | 16                        |</span><br><span class="line">| mysql-mirror_max_queue_length                       | 32000                     |</span><br><span class="line">| mysql-default_max_latency_ms                        | 1000                      |</span><br><span class="line">| mysql-query_processor_iterations                    | 0                         |</span><br><span class="line">| mysql-query_processor_regex                         | 1                         |</span><br><span class="line">| mysql-long_query_time                               | 1000                      |</span><br><span class="line">| mysql-query_cache_size_MB                           | 256                       |</span><br><span class="line">| mysql-poll_timeout_on_failure                       | 100                       |</span><br><span class="line">| mysql-server_capabilities                           | 45578                     |</span><br><span class="line">| mysql-session_idle_show_processlist                 | <span class="literal">true</span>                      |</span><br><span class="line">| mysql-query_digests                                 | <span class="literal">true</span>                      |</span><br><span class="line">| mysql-query_digests_lowercase                       | <span class="literal">false</span>                     |</span><br><span class="line">| mysql-servers_stats                                 | <span class="literal">true</span>                      |</span><br><span class="line">| mysql-default_reconnect                             | <span class="literal">true</span>                      |</span><br><span class="line">| mysql-ssl_p2s_ca                                    |                           |</span><br><span class="line">| mysql-ssl_p2s_cert                                  |                           |</span><br><span class="line">| mysql-ssl_p2s_key                                   |                           |</span><br><span class="line">| mysql-ssl_p2s_cipher                                |                           |</span><br><span class="line">| mysql-init_connect                                  |                           |</span><br><span class="line">| mysql-default_sql_mode                              |                           |</span><br><span class="line">| mysql-default_time_zone                             | SYSTEM                    |</span><br><span class="line">| mysql-connpoll_reset_queue_length                   | 50                        |</span><br><span class="line">| mysql-stats_time_backend_query                      | <span class="literal">false</span>                     |</span><br><span class="line">| mysql-stats_time_query_processor                    | <span class="literal">false</span>                     |</span><br><span class="line">| mysql-threads                                       | 4                         |</span><br><span class="line">| mysql-max_connections                               | 2048                      |</span><br><span class="line">| mysql-default_query_delay                           | 0                         |</span><br><span class="line">| mysql-default_query_timeout                         | 36000000                  |</span><br><span class="line">| mysql-have_compress                                 | <span class="literal">true</span>                      |</span><br><span class="line">| mysql-poll_timeout                                  | 2000                      |</span><br><span class="line">| mysql-interfaces                                    | 0.0.0.0:6033              |</span><br><span class="line">| mysql-default_schema                                | information_schema        |</span><br><span class="line">| mysql-stacksize                                     | 1048576                   |</span><br><span class="line">| mysql-server_version                                | 5.5.30                    |</span><br><span class="line">| mysql-connect_timeout_server                        | 3000                      |</span><br><span class="line">| mysql-monitor_username                              | proxysql                  |</span><br><span class="line">| mysql-monitor_password                              | proxysql                  |</span><br><span class="line">| mysql-monitor_history                               | 600000                    |</span><br><span class="line">| mysql-monitor_connect_interval                      | 60000                     |</span><br><span class="line">| mysql-monitor_ping_interval                         | 10000                     |</span><br><span class="line">| mysql-monitor_read_only_interval                    | 1500                      |</span><br><span class="line">| mysql-monitor_read_only_timeout                     | 500                       |</span><br><span class="line">| mysql-ping_interval_server_msec                     | 120000                    |</span><br><span class="line">| mysql-ping_timeout_server                           | 500                       |</span><br><span class="line">| mysql-commands_stats                                | <span class="literal">true</span>                      |</span><br><span class="line">| mysql-sessions_sort                                 | <span class="literal">true</span>                      |</span><br><span class="line">| mysql-connect_retries_on_failure                    | 10                        |</span><br><span class="line">| admin-stats_credentials                             | stats:stats               |</span><br><span class="line">| admin-stats_mysql_connections                       | 60                        |</span><br><span class="line">| admin-stats_mysql_connection_pool                   | 60                        |</span><br><span class="line">| admin-stats_mysql_query_cache                       | 60                        |</span><br><span class="line">| admin-stats_system_cpu                              | 60                        |</span><br><span class="line">| admin-stats_system_memory                           | 60                        |</span><br><span class="line">| admin-telnet_admin_ifaces                           | (null)                    |</span><br><span class="line">| admin-telnet_stats_ifaces                           | (null)                    |</span><br><span class="line">| admin-refresh_interval                              | 2000                      |</span><br><span class="line">| admin-read_only                                     | <span class="literal">false</span>                     |</span><br><span class="line">| admin-hash_passwords                                | <span class="literal">true</span>                      |</span><br><span class="line">| admin-cluster_username                              |                           |</span><br><span class="line">| admin-cluster_password                              |                           |</span><br><span class="line">| admin-cluster_check_interval_ms                     | 1000                      |</span><br><span class="line">| admin-cluster_check_status_frequency                | 10                        |</span><br><span class="line">| admin-cluster_mysql_query_rules_diffs_before_sync   | 3                         |</span><br><span class="line">| admin-cluster_mysql_servers_diffs_before_sync       | 3                         |</span><br><span class="line">| admin-cluster_mysql_users_diffs_before_sync         | 3                         |</span><br><span class="line">| admin-cluster_proxysql_servers_diffs_before_sync    | 3                         |</span><br><span class="line">| admin-cluster_mysql_query_rules_save_to_disk        | <span class="literal">true</span>                      |</span><br><span class="line">| admin-cluster_mysql_servers_save_to_disk            | <span class="literal">true</span>                      |</span><br><span class="line">| admin-cluster_mysql_users_save_to_disk              | <span class="literal">true</span>                      |</span><br><span class="line">| admin-cluster_proxysql_servers_save_to_disk         | <span class="literal">true</span>                      |</span><br><span class="line">| admin-checksum_mysql_query_rules                    | <span class="literal">true</span>                      |</span><br><span class="line">| admin-checksum_mysql_servers                        | <span class="literal">true</span>                      |</span><br><span class="line">| admin-checksum_mysql_users                          | <span class="literal">true</span>                      |</span><br><span class="line">| admin-web_enabled                                   | <span class="literal">false</span>                     |</span><br><span class="line">| admin-web_port                                      | 6080                      |</span><br><span class="line">| admin-admin_credentials                             | admin:admin|</span><br><span class="line">| admin-mysql_ifaces                                  | 0.0.0.0:6032              |</span><br><span class="line">| admin-version                                       | 1.4.8-32-g669c149         |</span><br><span class="line">+-----------------------------------------------------+---------------------------+</span><br><span class="line">125 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.003 sec)</span><br><span class="line"> </span><br><span class="line"><span class="comment">#登陆成功后，可通过对main库（默认登陆后即在此库）的global_variables表中的"admin-admin_credentials" 和 "admin-mysql_ifaces"</span></span><br><span class="line"><span class="comment">#两个变量进行更改来修改登录认证! 比如说修改密码或定义一个非admin的用户用于远程登录(下面会说到)。</span></span><br></pre></td></tr></table></figure><p>proxysql的6032端口是管理入口，账号密码是admin(可以动态修改),允许客户端连接；6033端口就是客户端入口，账号密码通过管理接口去设置。在proxysql本机使用mysql客户端连接到ProxySQL的管理接口(admin interface), 该接口的默认管理员用户和密码都是admin。</p><p><strong>mysql_ifaces</strong><br>也就是说proxysql有一个admin接口专门来做配置，相当于一个mysql shell可以通过sql来让配置实时生效。<br>mysql_ifaces配置了允许连接proxysql的ip和port</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@mysql-proxy ~]<span class="comment"># vim /etc/proxysql.cnf</span></span><br><span class="line">........</span><br><span class="line"><span class="comment"># 将admin_variables中的mysql_ifaces修改成允许远程访问</span></span><br><span class="line"><span class="comment">#      mysql_ifaces="127.0.0.1:6032;/tmp/proxysql_admin.sock"</span></span><br><span class="line">       mysql_ifaces=<span class="string">"0.0.0.0:6032"</span></span><br></pre></td></tr></table></figure><p>如果ip配置为0.0.0.0表示不限制ip，但是出于安全考虑，admin用户无论怎么设置都只能在本机登录!!!</p><p><strong>admin_credentials</strong><br>这个key保存所有可以操作proxysql的用户名和密码，格式为：user:pass;user1:pass1，这里可以修改密码或定义一个非admin的用户用于远程登录。 前提是保证想要管理proxysql的机器安装有mysql client客户端！</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">先在proxysql本机登录 (因为初始账号密码是admin:admin，只能在本机登录), 这里的proxysql本机地址是172.16.60.214</span><br><span class="line"> </span><br><span class="line">修改远程连接proxysql管理端口的账号和密码radmin:radmin.</span><br><span class="line">[root@mysql-proxy ~]<span class="comment"># mysql -uadmin -padmin -h127.0.0.1 -P6032       </span></span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 34</span><br><span class="line">Server version: 5.5.30 (ProxySQL Admin Module)</span><br><span class="line"> </span><br><span class="line">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line"> </span><br><span class="line">Type <span class="string">'help;'</span> or <span class="string">'\h'</span> <span class="keyword">for</span> <span class="built_in">help</span>. Type <span class="string">'\c'</span> to clear the current input statement.</span><br><span class="line"> </span><br><span class="line">MySQL [(none)]&gt; update global_variables <span class="built_in">set</span> variable_value = <span class="string">'admin:admin;radmin:radmin'</span> <span class="built_in">where</span> variable_name = <span class="string">'admin-admin_credentials'</span>;</span><br><span class="line">Query OK, 1 row affected (0.002 sec)</span><br><span class="line"> </span><br><span class="line">MySQL [(none)]&gt; LOAD ADMIN VARIABLES TO RUNTIME;</span><br><span class="line">Query OK, 0 rows affected (0.000 sec)</span><br><span class="line"> </span><br><span class="line">MySQL [(none)]&gt; SAVE ADMIN VARIABLES TO DISK;</span><br><span class="line">Query OK, 31 rows affected (0.077 sec)</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">这样就可以使用下面的命令在其他机器上使用radmin用户登录（其他机器上需要有mysql client）</span><br><span class="line">[root@MGR-node3 ~]<span class="comment"># mysql -uradmin -pradmin -h172.16.60.214 -P6032        </span></span><br><span class="line">mysql: [Warning] Using a password on the <span class="built_in">command</span> line interface can be insecure.</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 35</span><br><span class="line">Server version: 5.5.30 (ProxySQL Admin Module)</span><br><span class="line"> </span><br><span class="line">Copyright (c) 2000, 2018, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"> </span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"> </span><br><span class="line">Type <span class="string">'help;'</span> or <span class="string">'\h'</span> <span class="keyword">for</span> <span class="built_in">help</span>. Type <span class="string">'\c'</span> to clear the current input statement.</span><br><span class="line"> </span><br><span class="line">mysql&gt; show databases;</span><br><span class="line">+-----+---------------+-------------------------------------+</span><br><span class="line">| seq | name          | file                                |</span><br><span class="line">+-----+---------------+-------------------------------------+</span><br><span class="line">| 0   | main          |                                     |</span><br><span class="line">| 2   | disk          | /var/lib/proxysql/proxysql.db       |</span><br><span class="line">| 3   | stats         |                                     |</span><br><span class="line">| 4   | monitor       |                                     |</span><br><span class="line">| 5   | stats_history | /var/lib/proxysql/proxysql_stats.db |</span><br><span class="line">+-----+---------------+-------------------------------------+</span><br><span class="line">5 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure><p><strong>ProxySQL的库、表说明</strong> （默认管理端口是6032，客户端服务端口是6033。默认的用户名密码都是 admin）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line">通过管理端口6032去连接的 (注意, 下面连接命令中后面的--prompt <span class="string">'admin'</span>字段可以不加，也是可以登录进去的)</span><br><span class="line">  </span><br><span class="line">[root@mysql-proxy ~]<span class="comment"># mysql -uadmin -padmin -P6032 -h127.0.0.1</span></span><br><span class="line">或者</span><br><span class="line">[root@mysql-proxy ~]<span class="comment"># mysql -uadmin -padmin -P6032 -h127.0.0.1 --prompt 'admin&gt; '</span></span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 33</span><br><span class="line">Server version: 5.5.30 (ProxySQL Admin Module)</span><br><span class="line">  </span><br><span class="line">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line">  </span><br><span class="line">Type <span class="string">'help;'</span> or <span class="string">'\h'</span> <span class="keyword">for</span> <span class="built_in">help</span>. Type <span class="string">'\c'</span> to clear the current input statement.</span><br><span class="line">  </span><br><span class="line">admin&gt; show databases;</span><br><span class="line">+-----+---------------+-------------------------------------+</span><br><span class="line">| seq | name          | file                                |</span><br><span class="line">+-----+---------------+-------------------------------------+</span><br><span class="line">| 0   | main          |                                     |</span><br><span class="line">| 2   | disk          | /var/lib/proxysql/proxysql.db       |</span><br><span class="line">| 3   | stats         |                                     |</span><br><span class="line">| 4   | monitor       |                                     |</span><br><span class="line">| 5   | stats_history | /var/lib/proxysql/proxysql_stats.db |</span><br><span class="line">+-----+---------------+-------------------------------------+</span><br><span class="line">5 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.000 sec)</span><br><span class="line">  </span><br><span class="line">ProxySQL提供了几个库，每个库都有各自的意义；</span><br><span class="line">-  main 内存配置数据库，表里存放后端db实例、用户验证、路由规则等信息。表名以 runtime_开头的表示proxysql当前运行的配置内容，</span><br><span class="line">不能通过dml语句修改，只能修改对应的不以 runtime_ 开头的（在内存）里的表，然后 LOAD 使其生效， SAVE 使其存到硬盘以供下次重启加载。</span><br><span class="line">-  disk 是持久化到硬盘的配置，sqlite数据文件。</span><br><span class="line">-  stats 是proxysql运行抓取的统计信息，包括到后端各命令的执行次数、流量、processlist、查询种类汇总/执行时间等等。</span><br><span class="line">-  monitor 库存储 monitor 模块收集的信息，主要是对后端db的健康/延迟检查。</span><br><span class="line">  </span><br><span class="line">1) main 库 （disk库的表字段和main一样）</span><br><span class="line">admin&gt; show tables from main;</span><br><span class="line">+--------------------------------------------+</span><br><span class="line">| tables                                     |</span><br><span class="line">+--------------------------------------------+</span><br><span class="line">| global_variables                           |</span><br><span class="line">| mysql_collations                           |</span><br><span class="line">| mysql_group_replication_hostgroups         |</span><br><span class="line">| mysql_query_rules                          |</span><br><span class="line">| mysql_query_rules_fast_routing             |</span><br><span class="line">| mysql_replication_hostgroups               |</span><br><span class="line">| mysql_servers                              |</span><br><span class="line">| mysql_users                                |</span><br><span class="line">| proxysql_servers                           |</span><br><span class="line">| runtime_checksums_values                   |</span><br><span class="line">| runtime_global_variables                   |</span><br><span class="line">| runtime_mysql_group_replication_hostgroups |</span><br><span class="line">| runtime_mysql_query_rules                  |</span><br><span class="line">| runtime_mysql_query_rules_fast_routing     |</span><br><span class="line">| runtime_mysql_replication_hostgroups       |</span><br><span class="line">| runtime_mysql_servers                      |</span><br><span class="line">| runtime_mysql_users                        |</span><br><span class="line">| runtime_proxysql_servers                   |</span><br><span class="line">| runtime_scheduler                          |</span><br><span class="line">| scheduler                                  |</span><br><span class="line">+--------------------------------------------+</span><br><span class="line">20 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.001 sec)</span><br><span class="line"> </span><br><span class="line">常用的几个表介绍</span><br><span class="line">===============================================</span><br><span class="line">global_variables      </span><br><span class="line">设置变量，包括监听的端口、管理账号等。</span><br><span class="line"> </span><br><span class="line">mysql_collations      </span><br><span class="line">相关字符集和校验规则。</span><br><span class="line"> </span><br><span class="line">mysql_query_rules     </span><br><span class="line">定义查询路由规则。</span><br><span class="line"> </span><br><span class="line">mysql_replication_hostgroups  </span><br><span class="line">监视指定主机组中所有服务器的read_only值，并且根据read_only的值将服务器分配给写入器或读取器主机组。ProxySQL monitor模块会监控hostgroups</span><br><span class="line">后端所有servers 的read_only 变量，如果发现从库的read_only变为0、主库变为1，则认为角色互换了，自动改写mysql_servers表里面 hostgroup关系，</span><br><span class="line">达到自动 Failover 效果。</span><br><span class="line"> </span><br><span class="line">mysql_servers</span><br><span class="line">设置后端MySQL的表</span><br><span class="line"> </span><br><span class="line">mysql_users</span><br><span class="line">配置后端数据库的程序账号和监控账号。</span><br><span class="line"> </span><br><span class="line">scheduler</span><br><span class="line">调度器是一个类似于cron的实现，集成在ProxySQL中，具有毫秒的粒度。通过脚本检测来设置ProxySQL。</span><br><span class="line"> </span><br><span class="line">2）stats库</span><br><span class="line">MySQL [(none)]&gt; show tables from stats;</span><br><span class="line">+--------------------------------------+</span><br><span class="line">| tables                               |</span><br><span class="line">+--------------------------------------+</span><br><span class="line">| global_variables                     |</span><br><span class="line">| stats_memory_metrics                 |</span><br><span class="line">| stats_mysql_commands_counters        |</span><br><span class="line">| stats_mysql_connection_pool          |</span><br><span class="line">| stats_mysql_connection_pool_reset    |</span><br><span class="line">| stats_mysql_global                   |</span><br><span class="line">| stats_mysql_prepared_statements_info |</span><br><span class="line">| stats_mysql_processlist              |</span><br><span class="line">| stats_mysql_query_digest             |</span><br><span class="line">| stats_mysql_query_digest_reset       |</span><br><span class="line">| stats_mysql_query_rules              |</span><br><span class="line">| stats_mysql_users                    |</span><br><span class="line">| stats_proxysql_servers_checksums     |</span><br><span class="line">| stats_proxysql_servers_metrics       |</span><br><span class="line">| stats_proxysql_servers_status        |</span><br><span class="line">+--------------------------------------+</span><br><span class="line">15 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.001 sec)</span><br><span class="line"> </span><br><span class="line">常用的几个表介绍</span><br><span class="line">===============================================</span><br><span class="line">stats_mysql_commands_counters</span><br><span class="line">统计各种SQL类型的执行次数和时间，通过参数mysql-commands_stats控制开关，默认是ture。</span><br><span class="line"> </span><br><span class="line">stats_mysql_connection_pool</span><br><span class="line">连接后端MySQL的连接信息。</span><br><span class="line"> </span><br><span class="line">stats_mysql_processlist</span><br><span class="line">类似MySQL的show processlist的命令，查看各线程的状态。</span><br><span class="line"> </span><br><span class="line">stats_mysql_query_digest</span><br><span class="line">表示SQL的执行次数、时间消耗等。通过变量mysql-query_digests控制开关，默认是开。</span><br><span class="line"> </span><br><span class="line">stats_mysql_query_rules</span><br><span class="line">路由命中次数统计。</span><br><span class="line"> </span><br><span class="line">3）monitor库</span><br><span class="line">MySQL [(none)]&gt; show tables from monitor;            </span><br><span class="line">+------------------------------------+</span><br><span class="line">| tables                             |</span><br><span class="line">+------------------------------------+</span><br><span class="line">| mysql_server_connect_log           |</span><br><span class="line">| mysql_server_group_replication_log |</span><br><span class="line">| mysql_server_ping_log              |</span><br><span class="line">| mysql_server_read_only_log         |</span><br><span class="line">| mysql_server_replication_lag_log   |</span><br><span class="line">+------------------------------------+</span><br><span class="line">5 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.000 sec)</span><br><span class="line"> </span><br><span class="line">常用的几个表介绍</span><br><span class="line">===============================================</span><br><span class="line">mysql_server_connect_log</span><br><span class="line">连接到所有MySQL服务器以检查它们是否可用，该表用来存放检测连接的日志。</span><br><span class="line"> </span><br><span class="line">mysql_server_ping_log</span><br><span class="line">使用mysql_ping API ping后端MySQL服务器，检查它们是否可用，该表用来存放ping的日志。</span><br><span class="line"> </span><br><span class="line">mysql_server_replication_lag_log</span><br><span class="line">后端MySQL服务主从延迟的检测。</span><br><span class="line"> </span><br><span class="line">runtime_开头的是运行时的配置，这些是不能修改的。要修改ProxySQL的配置，需要修改了非runtime_表，</span><br><span class="line">修改后必须执行<span class="string">"LOAD ... TO RUNTIME"</span>才能加载到RUNTIME生效，执行save ... to disk才能将配置持久化保存到磁盘。</span><br></pre></td></tr></table></figure><p>global_variables 有80多个变量可以设置，其中就包括监听的端口、管理账号、禁用monitor等</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">(admin@127.0.0.1:6032) [(none)]&gt; show tables;</span><br><span class="line">+--------------------------------------------+</span><br><span class="line">| tables                                     |</span><br><span class="line">+--------------------------------------------+</span><br><span class="line">| global_variables                           |</span><br><span class="line">| mysql_collations                           |</span><br><span class="line">| mysql_group_replication_hostgroups         |</span><br><span class="line">| mysql_query_rules                          |</span><br><span class="line">| mysql_query_rules_fast_routing             |</span><br><span class="line">| mysql_replication_hostgroups               |</span><br><span class="line">| mysql_servers                              |</span><br><span class="line">| mysql_users                                |</span><br><span class="line">| proxysql_servers                           |</span><br><span class="line">| runtime_checksums_values                   |</span><br><span class="line">| runtime_global_variables                   |</span><br><span class="line">| runtime_mysql_group_replication_hostgroups |</span><br><span class="line">| runtime_mysql_query_rules                  |</span><br><span class="line">| runtime_mysql_query_rules_fast_routing     |</span><br><span class="line">| runtime_mysql_replication_hostgroups       |</span><br><span class="line">| runtime_mysql_servers                      |</span><br><span class="line">| runtime_mysql_users                        |</span><br><span class="line">| runtime_proxysql_servers                   |</span><br><span class="line">| runtime_scheduler                          |</span><br><span class="line">| scheduler                                  |</span><br><span class="line">+--------------------------------------------+</span><br><span class="line">20 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.001 sec)</span><br><span class="line">  </span><br><span class="line">(admin@127.0.0.1:6032) [(none)]&gt; show tables from stats;</span><br><span class="line">+--------------------------------------+</span><br><span class="line">| tables                               |</span><br><span class="line">+--------------------------------------+</span><br><span class="line">| global_variables                     |</span><br><span class="line">| stats_memory_metrics                 |</span><br><span class="line">| stats_mysql_commands_counters        |</span><br><span class="line">| stats_mysql_connection_pool          |</span><br><span class="line">| stats_mysql_connection_pool_reset    |</span><br><span class="line">| stats_mysql_global                   |</span><br><span class="line">| stats_mysql_prepared_statements_info |</span><br><span class="line">| stats_mysql_processlist              |</span><br><span class="line">| stats_mysql_query_digest             |</span><br><span class="line">| stats_mysql_query_digest_reset       |</span><br><span class="line">| stats_mysql_query_rules              |</span><br><span class="line">| stats_mysql_users                    |</span><br><span class="line">| stats_proxysql_servers_checksums     |</span><br><span class="line">| stats_proxysql_servers_metrics       |</span><br><span class="line">| stats_proxysql_servers_status        |</span><br><span class="line">+--------------------------------------+</span><br><span class="line">15 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.000 sec)</span><br><span class="line">  </span><br><span class="line">(admin@127.0.0.1:6032) [(none)]&gt; show create table mysql_servers\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">       table: mysql_servers</span><br><span class="line">Create Table: CREATE TABLE mysql_servers (</span><br><span class="line">    hostgroup_id INT CHECK (hostgroup_id&gt;=0) NOT NULL DEFAULT 0,</span><br><span class="line">    hostname VARCHAR NOT NULL,</span><br><span class="line">    port INT NOT NULL DEFAULT 3306,</span><br><span class="line">    status VARCHAR CHECK (UPPER(status) IN (<span class="string">'ONLINE'</span>,<span class="string">'SHUNNED'</span>,<span class="string">'OFFLINE_SOFT'</span>, <span class="string">'OFFLINE_HARD'</span>)) NOT NULL DEFAULT <span class="string">'ONLINE'</span>,</span><br><span class="line">    weight INT CHECK (weight &gt;= 0) NOT NULL DEFAULT 1,</span><br><span class="line">    compression INT CHECK (compression &gt;=0 AND compression &lt;= 102400) NOT NULL DEFAULT 0,</span><br><span class="line">    max_connections INT CHECK (max_connections &gt;=0) NOT NULL DEFAULT 1000,</span><br><span class="line">    max_replication_lag INT CHECK (max_replication_lag &gt;= 0 AND max_replication_lag &lt;= 126144000) NOT NULL DEFAULT 0,</span><br><span class="line">    use_ssl INT CHECK (use_ssl IN(0,1)) NOT NULL DEFAULT 0,</span><br><span class="line">    max_latency_ms INT UNSIGNED CHECK (max_latency_ms&gt;=0) NOT NULL DEFAULT 0,</span><br><span class="line">    comment VARCHAR NOT NULL DEFAULT <span class="string">''</span>,</span><br><span class="line">    PRIMARY KEY (hostgroup_id, hostname, port) )</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.000 sec)</span><br><span class="line">  </span><br><span class="line">ERROR: No query specified</span><br><span class="line">  </span><br><span class="line">(admin@127.0.0.1:6032) [(none)]&gt; select * from mysql_servers;</span><br><span class="line">+--------------+---------------+------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">| hostgroup_id | hostname      | port | status | weight | compression | max_connections | max_replication_lag | use_ssl | max_latency_ms | comment |</span><br><span class="line">+--------------+---------------+------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">| 10           | 172.16.60.211 | 3306 | ONLINE | 1      | 0           | 1000            | 0                   | 0       | 0              |         |</span><br><span class="line">| 20           | 172.16.60.212 | 3306 | ONLINE | 1      | 0           | 1000            | 0                   | 0       | 0              |         |</span><br><span class="line">| 20           | 172.16.60.213 | 3306 | ONLINE | 1      | 0           | 1000            | 0                   | 0       | 0              |         |</span><br><span class="line">+--------------+---------------+------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------+</span><br><span class="line">3 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.000 sec)</span><br></pre></td></tr></table></figure><p><strong>-</strong> hostgroup_id: ProxySQL通过 hostgroup (<strong>下称HG</strong>) 的形式组织后端db实例。一个 HG 代表同属于一个角色<br><strong>-</strong> 该表的主键是 (hostgroup_id, hostname, port)，可以看到一个 hostname:port 可以在多个hostgroup里面，如上面的 10.0.100.100:3307，这样可以避免 HG 1000 的从库全都不可用时，依然可以把读请求发到主库上。<br><strong>-</strong> 一个 HG 可以有多个实例，即多个从库，可以通过 weight 分配权重<br><strong>-</strong> hostgroup_id 0 是一个特殊的HG，路由查询的时候，没有匹配到规则则默认选择 HG 0<br><strong>-</strong> status:<br><strong>-</strong> ONLINE: 当前后端实例状态正常<br> <strong>-</strong> SHUNNED: 临时被剔除，可能因为后端 too many connections error，或者超过了可容忍延迟阀值 max_replication_lag<br> <strong>-</strong> OFFLINE_SOFT: “软离线”状态，不再接受新的连接，但已建立的连接会等待活跃事务完成。<br> <strong>-</strong> OFFLINE_HARD: “硬离线”状态，不再接受新的连接，已建立的连接或被强制中断。当后端实例宕机或网络不可达，会出现。<br><strong>-</strong> max_connections: 允许连接到该后端mysql实例的最大连接数。不要大于MySQL设置的 max_connections，如果后端实例 hostname:port 在多个 hostgroup 里，以较大者为准，而不是各自独立允许的最大连接数。<br><strong>-</strong> max_replication_lag: 允许的最大延迟，主库不受这个影响，默认0。如果 &gt; 0， monitor 模块监控主从延迟大于阀值时，会临时把它变为 SHUNNED 。<br><strong>-</strong> max_latency_ms: mysql_ping 响应时间，大于这个阀值会把它从连接池剔除（即使是ONLINE）<br><strong>-</strong> comment: 备注，不建议留空。可以通过它的内容如json格式的数据，配合自己写的check脚本，完成一些自动化的工作。</p><p>表 mysql_users</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">MySQL [(none)]&gt; show create table mysql_users\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">       table: mysql_users</span><br><span class="line">Create Table: CREATE TABLE mysql_users (</span><br><span class="line">    username VARCHAR NOT NULL,</span><br><span class="line">    password VARCHAR,</span><br><span class="line">    active INT CHECK (active IN (0,1)) NOT NULL DEFAULT 1,</span><br><span class="line">    use_ssl INT CHECK (use_ssl IN (0,1)) NOT NULL DEFAULT 0,</span><br><span class="line">    default_hostgroup INT NOT NULL DEFAULT 0,</span><br><span class="line">    default_schema VARCHAR,</span><br><span class="line">    schema_locked INT CHECK (schema_locked IN (0,1)) NOT NULL DEFAULT 0,</span><br><span class="line">    transaction_persistent INT CHECK (transaction_persistent IN (0,1)) NOT NULL DEFAULT 1,</span><br><span class="line">    fast_forward INT CHECK (fast_forward IN (0,1)) NOT NULL DEFAULT 0,</span><br><span class="line">    backend INT CHECK (backend IN (0,1)) NOT NULL DEFAULT 1,</span><br><span class="line">    frontend INT CHECK (frontend IN (0,1)) NOT NULL DEFAULT 1,</span><br><span class="line">    max_connections INT CHECK (max_connections &gt;=0) NOT NULL DEFAULT 10000,</span><br><span class="line">    PRIMARY KEY (username, backend),</span><br><span class="line">    UNIQUE (username, frontend))</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.000 sec)</span><br><span class="line">  </span><br><span class="line">ERROR: No query specified</span><br><span class="line">  </span><br><span class="line">MySQL [(none)]&gt; select * from mysql_users;</span><br><span class="line">+-----------+------------+--------+---------+-------------------+----------------+---------------+------------------------+--------------+---------+----------+-----------------+</span><br><span class="line">| username  | password   | active | use_ssl | default_hostgroup | default_schema | schema_locked | transaction_persistent | fast_forward | backend | frontend | max_connections |</span><br><span class="line">+-----------+------------+--------+---------+-------------------+----------------+---------------+------------------------+--------------+---------+----------+-----------------+</span><br><span class="line">| proxysql  | proxysql   | 1      | 0       | 2                 | NULL           | 0             | 1                      | 0            | 1       | 1        | 10000           |</span><br><span class="line">| root      | passwd     | 1      | 0       | 10                | NULL           | 0             | 1                      | 0            | 1       | 1        | 10000           |</span><br><span class="line">| sqlsender | P@ssword1! | 1      | 0       | 10                | NULL           | 0             | 1                      | 0            | 1       | 1        | 10000           |</span><br><span class="line">+-----------+------------+--------+---------+-------------------+----------------+---------------+------------------------+--------------+---------+----------+-----------------+</span><br><span class="line">3 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.000 sec)</span><br><span class="line">  </span><br><span class="line">MySQL [(none)]&gt; select username,password,transaction_persistent,active,backend,frontend,max_connections from runtime_mysql_users;</span><br><span class="line">+-----------+-------------------------------------------+------------------------+--------+---------+----------+-----------------+</span><br><span class="line">| username  | password                                  | transaction_persistent | active | backend | frontend | max_connections |</span><br><span class="line">+-----------+-------------------------------------------+------------------------+--------+---------+----------+-----------------+</span><br><span class="line">| proxysql  | *BF27B4C7AAD278126E228AA8427806E870F64F39 | 1                      | 1      | 0       | 1        | 10000           |</span><br><span class="line">| root      | *59C70DA2F3E3A5BDF46B68F5C8B8F25762BCCEF0 | 1                      | 1      | 0       | 1        | 10000           |</span><br><span class="line">| sqlsender | *50572A5FABC7DA9CEE5EB5977EDDE59E38967422 | 1                      | 1      | 0       | 1        | 10000           |</span><br><span class="line">| proxysql  | *BF27B4C7AAD278126E228AA8427806E870F64F39 | 1                      | 1      | 1       | 0        | 10000           |</span><br><span class="line">| root      | *59C70DA2F3E3A5BDF46B68F5C8B8F25762BCCEF0 | 1                      | 1      | 1       | 0        | 10000           |</span><br><span class="line">| sqlsender | *50572A5FABC7DA9CEE5EB5977EDDE59E38967422 | 1                      | 1      | 1       | 0        | 10000           |</span><br><span class="line">+-----------+-------------------------------------------+------------------------+--------+---------+----------+-----------------+</span><br><span class="line">6 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.001 sec)</span><br></pre></td></tr></table></figure><p><strong>-</strong> username, password: 连接后端db的用户密码。<br>这个密码你可以插入明文，也可以插入hash加密后的密文，proxysql会检查你插入的时候密码是否以 * 开头来判断，而且密文要在其它地方使用 PASSWORD()生成。但到 runtime_mysql_users 里，都统一变成了密文，所以可以明文插入，再 SAVE MYSQL USERS TO MEM，此时看到的也是HASH密文。<br><strong>-</strong> active: 是否生效该用户。<br><strong>-</strong> default_hostgroup: 这个用户的请求没有匹配到规则时，默认发到这个 hostgroup，默认0<br><strong>-</strong> default_schema: 这个用户连接时没有指定 database name 时，默认使用的schema<br>注意表面上看默认为NULL，但实际上受到变量 mysql-default_schema 的影响，默认为 information_schema。关于这个参考我所提的 issue #988<br><strong>-</strong> transaction_persistent: 如果设置为1，连接上ProxySQL的会话后，如果在一个hostgroup上开启了事务，那么后续的sql都继续维持在这个hostgroup上，不伦是否会匹配上其它路由规则，直到事务结束。<br>虽然默认是0，但我建议还是设成1，虽然一般来说由于前段应用的空值，为0出问题的情况几乎很小。作者也在考虑默认设成 1，refer this issue #793<br><strong>-</strong> frontend, backend: 目前版本这两个都需要使用默认的1，将来有可能会把 Client -&gt; ProxySQL (frontend) 与 ProxySQL -&gt; BackendDB (backend)的认证分开。从 runtime_mysql_users 表内容看到，记录数比 mysql_users 多了一倍，就是把前端认证与后端认证独立出来的结果。<br><strong>-</strong> fast_forward: 忽略查询重写/缓存层，直接把这个用户的请求透传到后端DB。相当于只用它的连接池功能，一般不用，路由规则 .* 就行了。</p><p>表 mysql_replication_hostgroups</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">MySQL [(none)]&gt; show create table mysql_replication_hostgroups\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">       table: mysql_replication_hostgroups</span><br><span class="line">Create Table: CREATE TABLE mysql_replication_hostgroups (</span><br><span class="line">    writer_hostgroup INT CHECK (writer_hostgroup&gt;=0) NOT NULL PRIMARY KEY,</span><br><span class="line">    reader_hostgroup INT NOT NULL CHECK (reader_hostgroup&lt;&gt;writer_hostgroup AND reader_hostgroup&gt;0),</span><br><span class="line">    comment VARCHAR NOT NULL DEFAULT <span class="string">''</span>, UNIQUE (reader_hostgroup))</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.001 sec)</span><br><span class="line">  </span><br><span class="line">ERROR: No query specified</span><br><span class="line">  </span><br><span class="line">MySQL [(none)]&gt; select * from mysql_replication_hostgroups;</span><br><span class="line">+------------------+------------------+---------+</span><br><span class="line">| writer_hostgroup | reader_hostgroup | comment |</span><br><span class="line">+------------------+------------------+---------+</span><br><span class="line">| 10               | 20               | 1       |</span><br><span class="line">+------------------+------------------+---------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.000 sec)</span><br></pre></td></tr></table></figure><p>定义 hostgroup 的主从关系。ProxySQL monitor 模块会监控 HG 后端所有servers 的 <code>read_only</code> 变量，如果发现从库的 read_only 变为0、主库变为1，则认为角色互换了，自动改写 mysql_servers 表里面 hostgroup 关系，达到自动 Failover 效果。</p><p>表 mysql_query_rules<br>mysql_query_rules 是ProxySQL非常核心一个表，定义查询路由规则</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">MySQL [(none)]&gt; show create table mysql_query_rules\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">       table: mysql_query_rules</span><br><span class="line">Create Table: CREATE TABLE mysql_query_rules (</span><br><span class="line">    rule_id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,</span><br><span class="line">    active INT CHECK (active IN (0,1)) NOT NULL DEFAULT 0,</span><br><span class="line">    username VARCHAR,</span><br><span class="line">    schemaname VARCHAR,</span><br><span class="line">    flagIN INT NOT NULL DEFAULT 0,</span><br><span class="line">    client_addr VARCHAR,</span><br><span class="line">    proxy_addr VARCHAR,</span><br><span class="line">    proxy_port INT,</span><br><span class="line">    digest VARCHAR,</span><br><span class="line">    match_digest VARCHAR,</span><br><span class="line">    match_pattern VARCHAR,</span><br><span class="line">    negate_match_pattern INT CHECK (negate_match_pattern IN (0,1)) NOT NULL DEFAULT 0,</span><br><span class="line">    re_modifiers VARCHAR DEFAULT <span class="string">'CASELESS'</span>,</span><br><span class="line">    flagOUT INT,</span><br><span class="line">    replace_pattern VARCHAR,</span><br><span class="line">    destination_hostgroup INT DEFAULT NULL,</span><br><span class="line">    cache_ttl INT CHECK(cache_ttl &gt; 0),</span><br><span class="line">    reconnect INT CHECK (reconnect IN (0,1)) DEFAULT NULL,</span><br><span class="line">    timeout INT UNSIGNED,</span><br><span class="line">    retries INT CHECK (retries&gt;=0 AND retries &lt;=1000),</span><br><span class="line">    delay INT UNSIGNED,</span><br><span class="line">    next_query_flagIN INT UNSIGNED,</span><br><span class="line">    mirror_flagOUT INT UNSIGNED,</span><br><span class="line">    mirror_hostgroup INT UNSIGNED,</span><br><span class="line">    error_msg VARCHAR,</span><br><span class="line">    OK_msg VARCHAR,</span><br><span class="line">    sticky_conn INT CHECK (sticky_conn IN (0,1)),</span><br><span class="line">    multiplex INT CHECK (multiplex IN (0,1,2)),</span><br><span class="line">    <span class="built_in">log</span> INT CHECK (<span class="built_in">log</span> IN (0,1)),</span><br><span class="line">    apply INT CHECK(apply IN (0,1)) NOT NULL DEFAULT 0,</span><br><span class="line">    comment VARCHAR)</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.001 sec)</span><br><span class="line">  </span><br><span class="line">ERROR: No query specified</span><br><span class="line">  </span><br><span class="line">MySQL [(none)]&gt; select * from mysql_query_rules;</span><br><span class="line">+---------+--------+----------+------------+--------+-------------+------------+------------+--------+----------------------+---------------+----------------------+--------------+---------+-----------------+-----------------------+-----------+-----------+---------+---------+-------+-------------------+----------------+------------------+-----------+--------+-------------+-----------+-----+-------+---------+</span><br><span class="line">| rule_id | active | username | schemaname | flagIN | client_addr | proxy_addr | proxy_port | digest | match_digest         | match_pattern | negate_match_pattern | re_modifiers | flagOUT | replace_pattern | destination_hostgroup | cache_ttl | reconnect | timeout | retries | delay | next_query_flagIN | mirror_flagOUT | mirror_hostgroup | error_msg | OK_msg | sticky_conn | multiplex | <span class="built_in">log</span> | apply | comment |</span><br><span class="line">+---------+--------+----------+------------+--------+-------------+------------+------------+--------+----------------------+---------------+----------------------+--------------+---------+-----------------+-----------------------+-----------+-----------+---------+---------+-------+-------------------+----------------+------------------+-----------+--------+-------------+-----------+-----+-------+---------+</span><br><span class="line">| 1       | 1      | NULL     | NULL       | 0      | NULL        | NULL       | NULL       | NULL   | ^SELECT.*FOR UPDATE$ | NULL          | 0                    | CASELESS     | NULL    | NULL            | 10                    | NULL      | NULL      | NULL    | NULL    | NULL  | NULL              | NULL           | NULL             | NULL      | NULL   | NULL        | NULL      | NULL | 1     | NULL    |</span><br><span class="line">| 2       | 1      | NULL     | NULL       | 0      | NULL        | NULL       | NULL       | NULL   | ^SELECT              | NULL          | 0                    | CASELESS     | NULL    | NULL            | 20                    | NULL      | NULL      | NULL    | NULL    | NULL  | NULL              | NULL           | NULL             | NULL      | NULL   | NULL        | NULL      | NULL | 1     | NULL    |</span><br><span class="line">+---------+--------+----------+------------+--------+-------------+------------+------------+--------+----------------------+---------------+----------------------+--------------+---------+-----------------+-----------------------+-----------+-----------+---------+---------+-------+-------------------+----------------+------------------+-----------+--------+-------------+-----------+-----+-------+---------+</span><br><span class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.000 sec)</span><br></pre></td></tr></table></figure><p><strong>-</strong> rule_id: 表主键，自增。规则处理是以 rule_id 的顺序进行。<br><strong>-</strong> active: 只有 active=1 的规则才会参与匹配。<br><strong>-</strong> username: 如果非 NULL，只有连接用户是 username 的值才会匹配。<br><strong>-</strong> schemaname: 如果非 NULL，只有查询连接使用的db是 schemaname 的值才会匹配。<br> 注意如果是 NULL，不代表连接没有使用schema，而是不伦任何schema都进一步匹配。<br><strong>-</strong> flagIN, flagOUT, apply: 用来定义路由链 chains of rules。<br> <strong>-</strong> 首先会检查 flagIN=0 的规则，以rule_id的顺序；如果都没匹配上，则走这个用户的 default_hostgroup。<br> <strong>-</strong> 当匹配一条规则后，会检查 flagOUT。<br> <strong>-</strong> 如果不为NULL，并且 flagIN != flagOUT ，则进入以flagIN为上一个flagOUT值的新规则链。<br> <strong>-</strong> 如果不为NULL，并且 flagIN = flagOUT，则应用这条规则。<br> <strong>-</strong> 如果为NULL，或者 apply=1，则结束，应用这条规则。<br> <strong>-</strong> 如果最终没有匹配到，则找到这个用户的 default_hostgroup。<br><strong>-</strong> client_addr: 匹配客户端来源IP<br><strong>-</strong> proxy_addr, proxy_port: 匹配本地proxysql的IP、端口。我目前没有想到它的应用场景，可能是把proxysql监听在多个接口上，分发到不同的业务？<br><strong>-</strong> digest: 精确的匹配一类查询。<br><strong>-</strong> match_digest: 正则匹配一类查询。query digest 是指对查询去掉具体值后进行“模糊化”后的查询，类似 pt-fingerprint / pt-query-digest 的效果。<br><strong>-</strong> match_pattern: 正则匹配查询。</p><p>以上都是匹配查询的规则，1.3.5版本使用的正则引擎只有 RE2 ，1.4版本可以通过变量 mysql-query_processor_regex 设置 RE2 或者 PCRE，且1.4开始默认是PCRE。<br>推荐用 match_digest 。关于每条查询都会计算digest对性能的影响，计算query digest确实会有性能损失，但是这却是proxysql里面非常重要的特性，主要是两点：<br> <strong>-</strong> proxysql无法知道连接复用(multipexing)是否必须被自动禁用，比如连接里面有variables/tmp tables/lock table等特殊命令，是不能复用的。<br> <strong>-</strong> 完整的查询去匹配正则的效率，一般没有参数化后的查询匹配效率高，因为有很长的字符串内容需要处理。再者，SELECT * FROM randomtable WHERE comment LIKE ‘%INTO sbtest1 % FROM sbtest2 %’字符串里有类似这样的语句，很难排除误匹配。<br><strong>-</strong> negate_match_pattern: 反向匹配，相当于对 match_digest/match_pattern 的匹配取反。<br><strong>-</strong> re_modifiers: 修改正则匹配的参数，比如默认的：忽略大小写CASELESS、禁用GLOBAL.</p><p><strong>上面都是匹配规则，下面是匹配后的行为</strong><br><strong>-</strong> replace_pattern: 查询重写，默认为空，不rewrite。<br><strong>-</strong> rewrite规则要遵守 RE2::Replace 。<br>destination_hostgroup: 路由查询到这个 hostgroup。当然如果用户显式 start transaction 且 transaction_persistent=1，那么即使匹配到了，也依然按照事务里第一条sql的路由规则去走。<br><strong>-</strong> cache_ttl: 查询结果缓存的毫秒数。<br>proxysql这个 Query Cache 与 MySQL 自带的query cache不是同一个。proxysql query cache也不会关心后端数据是否被修改，它所做的就是针对某些特定种类的查询结果进行缓存，比如一些历史数据的count结果。一般不设。<br><strong>-</strong> timeout: 这一类查询执行的最大时间（毫秒），超时则自动kill。<br>这是对后端DB的保护机制，相当于阿里云RDS loose_max_statement_time 变量的功能，但是注意不同的是，阿里云这个变量的时间时不包括DML操作出现InnoDB行锁等待的时间，而ProxySQL的这个 timeout 是计算从发送sql到等待响应的时间。默认mysql-default_query_timeout给的是 10h .<br><strong>-</strong> retries: 语句在执行时失败时，重试次数。默认由 mysql-query_retries_on_failure变量指定，为1 。<br> 个人建议把它设成0，即不重试。因为执行失败，对select而言很少见，主要是dml，但自己重试对数据不放心。<br><strong>-</strong> delay: 查询延迟执行，这是ProxySQL提供的限流机制，会让其它的查询优先执行。<br> 默认值 mysql-default_query_delay，为0。我们一般不用，其实还是要配合应用端使用，比如这边延迟执行，但上层等待你返回，那前端不就堵住了，没准出现雪崩效应。<br><strong>-</strong> mirror_flagOUT,mirror_hostgroup<br>这两个高级了，目前这部分文档不全，功能是SQL镜像。顾名思义，就是把匹配到的SQL除了发送到 destination_hostgroup，同时镜像一份到这里的hostgroup，比如我们的测试库。比如这种场景，数据库要从5.6升级到5.7，要验证现有查询语句对5.7的适用情况，就可以把生产流量镜像到5.7新库上验证。<br><strong>-</strong> error_msg: 默认为NULL，如果指定了则这个查询直接被 block 掉，马上返回这个错误信息。<br>这个功能也很实用，比如线上突然冒出一个 “坏查询”，应用端不方便马上发版解决，我们就可以在这配置一个规则，把查询屏蔽掉，想正常的mysql报错那样抛异常。下一篇文章有演示。<br><strong>-</strong> multiplex: 连接是否复用。<br><strong>-</strong> log: 是否记录查询日志。可以看到log是否记录的对象是根据规则。<br>要开启日志记录，需要设置变量 mysql-eventslog_filename 来指定文件名，然后这个 log 标记为1。但是目前proxysql记录的日志是二进制格式，需要特定的工具才能读取： eventslog_reader_sample 。这个工具在源码目录 tools下面。</p><p>proxysql对后端server健康检查</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">MySQL [monitor]&gt; show variables like <span class="string">"mysql-monitor%"</span>;</span><br><span class="line">+-----------------------------------------------------+------------+</span><br><span class="line">| Variable_name                                       | Value      |</span><br><span class="line">+-----------------------------------------------------+------------+</span><br><span class="line">| mysql-monitor_enabled                               | <span class="literal">true</span>       |</span><br><span class="line">| mysql-monitor_connect_timeout                       | 600        |</span><br><span class="line">| mysql-monitor_ping_max_failures                     | 3          |</span><br><span class="line">| mysql-monitor_ping_timeout                          | 1000       |</span><br><span class="line">| mysql-monitor_read_only_max_timeout_count           | 3          |</span><br><span class="line">| mysql-monitor_replication_lag_interval              | 10000      |</span><br><span class="line">| mysql-monitor_replication_lag_timeout               | 1000       |</span><br><span class="line">| mysql-monitor_groupreplication_healthcheck_interval | 5000       |</span><br><span class="line">| mysql-monitor_groupreplication_healthcheck_timeout  | 800        |</span><br><span class="line">| mysql-monitor_replication_lag_use_percona_heartbeat |            |</span><br><span class="line">| mysql-monitor_query_interval                        | 60000      |</span><br><span class="line">| mysql-monitor_query_timeout                         | 100        |</span><br><span class="line">| mysql-monitor_slave_lag_when_null                   | 60         |</span><br><span class="line">| mysql-monitor_wait_timeout                          | <span class="literal">true</span>       |</span><br><span class="line">| mysql-monitor_writer_is_also_reader                 | <span class="literal">true</span>       |</span><br><span class="line">| mysql-monitor_username                              | monitor    |</span><br><span class="line">| mysql-monitor_password                              | P@ssword1! |</span><br><span class="line">| mysql-monitor_history                               | 600000     |</span><br><span class="line">| mysql-monitor_connect_interval                      | 60000      |</span><br><span class="line">| mysql-monitor_ping_interval                         | 10000      |</span><br><span class="line">| mysql-monitor_read_only_interval                    | 1500       |</span><br><span class="line">| mysql-monitor_read_only_timeout                     | 500        |</span><br><span class="line">+-----------------------------------------------------+------------+</span><br><span class="line">22 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.001 sec)</span><br></pre></td></tr></table></figure><h2 id="ProxySQL配置后端DB-server"><a href="#ProxySQL配置后端DB-server" class="headerlink" title="ProxySQL配置后端DB server"></a><strong>ProxySQL配置后端DB server</strong></h2><p><strong>两种方式，区别在于</strong></p><p>1) 一种是在往mysql_servers表中添加server时就为其划分好hostgroup_id（例如0表示写组，1表示读组）<br>2) 另一种往mysql_servers表中添加server时不区分hostgroup_id（例如全部设为0），然后通过mysql_replication_hostgroups表中的值，<br>根据proxysql检测到的各server的read_only变量值来自动为后端server设置hostgroup_id</p><p><strong>这里强烈推荐用第一种方式</strong><br>因为第一种是完全由我们控制的;而第二种假如我们误将读server的read_only属性设置为0，则proxysql会将其重新分配到写组，这绝对是不期望的。</p><p><strong>ProxySQL下添加与修改配置</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">1) 添加配置</span><br><span class="line">需要添加配置时，直接操作的是MEMORAY，例如：添加一个程序用户，在mysql_users表中执行一个插入操作：</span><br><span class="line">MySQL [(none)]&gt; insert into mysql_users(username,password,active,default_hostgroup,transaction_persistent) values(<span class="string">'myadmin'</span>,<span class="string">'mypass'</span>,1,0,1);</span><br><span class="line">  </span><br><span class="line">这样就完成了一个用户的添加。要让这个insert生效，还需要执行如下操作：</span><br><span class="line">MySQL [(none)]&gt;load mysql users to runtime;</span><br><span class="line">表示将修改后的配置(MEMORY层)用到实际生产环境（RUNTIME层）</span><br><span class="line">  </span><br><span class="line">如果想保存这个设置永久生效，还需要执行如下操作：</span><br><span class="line">MySQL [(none)]&gt;save mysql users to disk;</span><br><span class="line">表示将memoery中的配置保存到磁盘中去。</span><br><span class="line">  </span><br><span class="line">除了上面两个操作，还可以执行如下操作：</span><br><span class="line">MySQL [(none)]&gt;load mysql users to memory;</span><br><span class="line">表示将磁盘中持久化的配置拉一份到memory中来。</span><br><span class="line">  </span><br><span class="line">MySQL [(none)]&gt;load mysql users from config;</span><br><span class="line">表示将配置文件中的配置加载到memeory中。</span><br><span class="line">  </span><br><span class="line">2) 持久化配置</span><br><span class="line">以上SQL命令是对mysql_users进行的操作，同理，还可以对mysql_servers表、mysql_query_rules表、global_variables表等执行类似的操作。</span><br><span class="line">如对mysql_servers表插入完成数据后，要执行保存和加载操作，可执行如下SQL命令：</span><br><span class="line">MySQL [(none)]&gt; load mysql servers to runtime;</span><br><span class="line">MySQL [(none)]&gt; save mysql servers to disk;</span><br><span class="line">  </span><br><span class="line">对mysql_query_rules表插入完成数据后，要执行保存和加载操作，可执行如下SQL命令：</span><br><span class="line">MySQL [(none)]&gt; load mysql query rules to runtime;</span><br><span class="line">MySQL [(none)]&gt; save mysql query rules to disk;</span><br><span class="line">  </span><br><span class="line">对global_variables表插入完成数据后，要执行保存和加载操作，可执行如下SQL命令：</span><br><span class="line">  </span><br><span class="line">以下命令加载或保存mysql variables（global_variables）:</span><br><span class="line">MySQL [(none)]&gt;load mysql variables to runtime;</span><br><span class="line">MySQL [(none)]&gt;save mysql variables to disk;</span><br><span class="line">  </span><br><span class="line">以下命令加载或保存admin variables（select * from global_variables <span class="built_in">where</span> variable_name like <span class="string">'admin-%'</span>）:</span><br><span class="line">MySQL [(none)]&gt; load admin variables to runtime;</span><br><span class="line">MySQL [(none)]&gt;save admin variables to disk;</span><br></pre></td></tr></table></figure><h2 id="实战功能验证"><a href="#实战功能验证" class="headerlink" title="实战功能验证"></a>实战功能验证</h2><p>针对GTID模式的主从同步，另两个从库都要设置read_only=on<br>接下来通过实战操作来全面了解一下 ProxySQL 的特性和使用场景。</p><p><img src="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@master/articles/8307f670/1.png" alt></p><h3 id="实验环境"><a href="#实验环境" class="headerlink" title="实验环境"></a><strong>实验环境</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">172.16.60.211    mysql-master       安装Mysql5.7</span><br><span class="line">172.16.60.212    mysql-slave1       安装Mysql5.7</span><br><span class="line">172.16.60.213    mysql-slave2       安装Mysql5.7</span><br><span class="line">172.16.60.214    mysql-proxy        安装ProxySQL，Mysql-client</span><br><span class="line"> </span><br><span class="line">系统都是CentOS7.5，MySQL版本是5.7，准备一主两从架构(基于GTID的同步,两个从库都要开启read_only=on)来配合ProxySQL。</span><br><span class="line">[root@mysql-master ~]<span class="comment"># cat /etc/redhat-release</span></span><br><span class="line">CentOS Linux release 7.5.1804 (Core)</span><br><span class="line"> </span><br><span class="line">1) 三个节点各自设置主机名</span><br><span class="line">[root@mysql-master ~]<span class="comment"># hostnamectl --static set-hostname mysql-master</span></span><br><span class="line">[root@mysql-master ~]<span class="comment"># hostname</span></span><br><span class="line">mysql-master</span><br><span class="line">  </span><br><span class="line">[root@mysql-slave1 ~]<span class="comment"># hostnamectl --static set-hostname mysql-slave1</span></span><br><span class="line">[root@mysql-slave1 ~]<span class="comment"># hostname</span></span><br><span class="line">mysql-slave</span><br><span class="line"> </span><br><span class="line">[root@mysql-slave2 ~]<span class="comment"># hostnamectl --static set-hostname mysql-slave2</span></span><br><span class="line">[root@mysql-slave2 ~]<span class="comment"># hostname</span></span><br><span class="line">mysql-slave</span><br><span class="line"> </span><br><span class="line">[root@mysql-proxy ~]<span class="comment"># hostnamectl --static set-hostname mysql-proxy</span></span><br><span class="line">[root@mysql-proxy ~]<span class="comment"># hostname</span></span><br><span class="line">mysql-proxy</span><br><span class="line">  </span><br><span class="line">2) 所有节点关闭selinux和iptables防火墙</span><br><span class="line">[root@mysql-master ~]<span class="comment"># setenforce 0</span></span><br><span class="line">[root@mysql-master ~]<span class="comment"># cat /etc/sysconfig/selinux |grep "SELINUX=disabled"</span></span><br><span class="line">SELINUX=disabled</span><br><span class="line">  </span><br><span class="line">[root@mysql-master ~]<span class="comment"># iptables -F</span></span><br><span class="line">[root@mysql-master ~]<span class="comment"># systemctl disable firewalld</span></span><br><span class="line">[root@mysql-master ~]<span class="comment"># systemctl stop firewalld </span></span><br><span class="line">[root@mysql-master ~]<span class="comment"># firewall-cmd --state</span></span><br><span class="line">not running</span><br></pre></td></tr></table></figure><h3 id="安装Mysql-5-7-在三个mysql节点上安装"><a href="#安装Mysql-5-7-在三个mysql节点上安装" class="headerlink" title="安装Mysql 5.7  (在三个mysql节点上安装)"></a><strong>安装Mysql 5.7 (在三个mysql节点上安装)</strong></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">在三个mysql节点机上使用yum方式安装Mysql5.7，参考：https://www.cnblogs.com/kevingrace/p/8340690.html</span><br><span class="line">     </span><br><span class="line">安装MySQL yum资源库</span><br><span class="line">[root@mysql-master ~]<span class="comment"># yum localinstall https://dev.mysql.com/get/mysql57-community-release-el7-8.noarch.rpm</span></span><br><span class="line">     </span><br><span class="line">安装MySQL 5.7</span><br><span class="line">[root@mysql-master ~]<span class="comment"># yum install -y mysql-community-server</span></span><br><span class="line">     </span><br><span class="line">启动MySQL服务器和MySQL的自动启动</span><br><span class="line">[root@mysql-master ~]<span class="comment"># systemctl start mysqld.service</span></span><br><span class="line">[root@mysql-master ~]<span class="comment"># systemctl enable mysqld.service</span></span><br><span class="line">     </span><br><span class="line">设置登录密码</span><br><span class="line">由于MySQL从5.7开始不允许首次安装后使用空密码进行登录！为了加强安全性，系统会随机生成一个密码以供管理员首次登录使用，</span><br><span class="line">这个密码记录在/var/<span class="built_in">log</span>/mysqld.log文件中，使用下面的命令可以查看此密码：</span><br><span class="line">[root@mysql-master ~]<span class="comment"># cat /var/log/mysqld.log|grep 'A temporary password'</span></span><br><span class="line">2019-01-11T05:53:17.824073Z 1 [Note] A temporary password is generated <span class="keyword">for</span> root@localhost: TaN.k:*Qw2xs</span><br><span class="line">     </span><br><span class="line">使用上面查看的密码TaN.k:*Qw2xs 登录mysql，并重置密码为123456</span><br><span class="line">[root@mysql-master ~]<span class="comment"># mysql -p                 #输入默认的密码：TaN.k:*Qw2xs</span></span><br><span class="line">.............</span><br><span class="line">mysql&gt; <span class="built_in">set</span> global validate_password_policy=0;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">     </span><br><span class="line">mysql&gt; <span class="built_in">set</span> global validate_password_length=1;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">     </span><br><span class="line">mysql&gt; <span class="built_in">set</span> password=password(<span class="string">"123456"</span>);</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.00 sec)</span><br><span class="line">     </span><br><span class="line">mysql&gt; flush privileges;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">     </span><br><span class="line">查看mysql版本</span><br><span class="line">[root@mysql-master ~]<span class="comment"># mysql -p123456</span></span><br><span class="line">........</span><br><span class="line">mysql&gt; select version();</span><br><span class="line">+-----------+</span><br><span class="line">| version() |</span><br><span class="line">+-----------+</span><br><span class="line">| 5.7.24    |</span><br><span class="line">+-----------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line">    </span><br><span class="line">=====================================================================</span><br><span class="line">温馨提示</span><br><span class="line">mysql5.7通过上面默认安装后，执行语句可能会报错：</span><br><span class="line">ERROR 1819 (HY000): Your password does not satisfy the current policy requirements</span><br><span class="line">    </span><br><span class="line">这个报错与Mysql 密码安全策略validate_password_policy的值有关，validate_password_policy可以取0、1、2三个值：</span><br><span class="line">解决办法：</span><br><span class="line"><span class="built_in">set</span> global validate_password_policy=0;</span><br><span class="line"><span class="built_in">set</span> global validate_password_length=1;</span><br></pre></td></tr></table></figure><h3 id="配置Mysql基于GTID的主从同步"><a href="#配置Mysql基于GTID的主从同步" class="headerlink" title="*配置Mysql基于GTID的主从同步  *"></a>*<em>配置Mysql基于GTID的主从同步 *</em></h3><p>在mysql-master 和 mysql-slave1、mysql-slave2节点上</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br></pre></td><td class="code"><pre><span class="line">1) 主数据库mysql-master (172.16.60.211)的配置操作</span><br><span class="line">[root@mysql-master ~]<span class="comment"># &gt;/etc/my.cnf</span></span><br><span class="line">[root@mysql-master ~]<span class="comment"># vim /etc/my.cnf</span></span><br><span class="line">[mysqld]</span><br><span class="line">datadir = /var/lib/mysql</span><br><span class="line">socket = /var/lib/mysql/mysql.sock</span><br><span class="line">        </span><br><span class="line">symbolic-links = 0</span><br><span class="line">        </span><br><span class="line"><span class="built_in">log</span>-error = /var/<span class="built_in">log</span>/mysqld.log</span><br><span class="line">pid-file = /var/run/mysqld/mysqld.pid</span><br><span class="line">    </span><br><span class="line"><span class="comment">#GTID:</span></span><br><span class="line">server_id = 1</span><br><span class="line">gtid_mode = on</span><br><span class="line">enforce_gtid_consistency = on</span><br><span class="line">      </span><br><span class="line"><span class="comment">#binlog</span></span><br><span class="line">log_bin = master-bin</span><br><span class="line"><span class="built_in">log</span>-slave-updates = 1</span><br><span class="line">binlog_format = row</span><br><span class="line">sync-master-info = 1    </span><br><span class="line">sync_binlog = 1        </span><br><span class="line">     </span><br><span class="line"><span class="comment">#relay log</span></span><br><span class="line">skip_slave_start = 1</span><br><span class="line"> </span><br><span class="line">配置完成之后，别忘了重启Mysql</span><br><span class="line">[root@mysql-master ~]<span class="comment"># systemctl restart mysqld</span></span><br><span class="line"> </span><br><span class="line">登录mysql，查看一下master状态， 发现多了一项<span class="string">"Executed_Gtid_Set "</span></span><br><span class="line">[root@mysql-master ~]<span class="comment"># mysql -p123456</span></span><br><span class="line">.........</span><br><span class="line">mysql&gt; show master status;</span><br><span class="line">+-------------------+----------+--------------+------------------+------------------------------------------+</span><br><span class="line">| File              | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set                        |</span><br><span class="line">+-------------------+----------+--------------+------------------+------------------------------------------+</span><br><span class="line">| master-bin.000002 |      550 |              |                  | fc39b161-22ca-11e9-a638-005056ac6820:1-2 |</span><br><span class="line">+-------------------+----------+--------------+------------------+------------------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"> </span><br><span class="line">mysql&gt; show global variables like <span class="string">'%uuid%'</span>;</span><br><span class="line">+---------------+--------------------------------------+</span><br><span class="line">| Variable_name | Value                                |</span><br><span class="line">+---------------+--------------------------------------+</span><br><span class="line">| server_uuid   | fc39b161-22ca-11e9-a638-005056ac6820 |</span><br><span class="line">+---------------+--------------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"> </span><br><span class="line">mysql&gt; show global variables like <span class="string">'%gtid%'</span>;</span><br><span class="line">+----------------------------------+------------------------------------------+</span><br><span class="line">| Variable_name                    | Value                                    |</span><br><span class="line">+----------------------------------+------------------------------------------+</span><br><span class="line">| binlog_gtid_simple_recovery      | ON                                       |</span><br><span class="line">| enforce_gtid_consistency         | ON                                       |</span><br><span class="line">| gtid_executed                    | fc39b161-22ca-11e9-a638-005056ac6820:1-2 |</span><br><span class="line">| gtid_executed_compression_period | 1000                                     |</span><br><span class="line">| gtid_mode                        | ON                                       |</span><br><span class="line">| gtid_owned                       |                                          |</span><br><span class="line">| gtid_purged                      |                                          |</span><br><span class="line">| session_track_gtids              | OFF                                      |</span><br><span class="line">+----------------------------------+------------------------------------------+</span><br><span class="line">8 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"> </span><br><span class="line">主库执行从库复制授权</span><br><span class="line">mysql&gt; grant replication slave,replication client on *.* to slave@<span class="string">'172.16.60.212'</span> identified by <span class="string">"slave@123"</span>;</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.09 sec)</span><br><span class="line"> </span><br><span class="line">mysql&gt; grant replication slave,replication client on *.* to slave@<span class="string">'172.16.60.213'</span> identified by <span class="string">"slave@123"</span>;</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.03 sec)</span><br><span class="line"> </span><br><span class="line">mysql&gt; flush privileges;</span><br><span class="line">Query OK, 0 rows affected (0.03 sec)</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">mysql&gt; show grants <span class="keyword">for</span> slave@<span class="string">'172.16.60.212'</span>;</span><br><span class="line">+-------------------------------------------------------------------------------+</span><br><span class="line">| Grants <span class="keyword">for</span> slave@172.16.60.212                                                |</span><br><span class="line">+-------------------------------------------------------------------------------+</span><br><span class="line">| GRANT REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO <span class="string">'slave'</span>@<span class="string">'172.16.60.212'</span> |</span><br><span class="line">+-------------------------------------------------------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"> </span><br><span class="line">mysql&gt; show grants <span class="keyword">for</span> slave@<span class="string">'172.16.60.213'</span>;</span><br><span class="line">+-------------------------------------------------------------------------------+</span><br><span class="line">| Grants <span class="keyword">for</span> slave@172.16.60.213                                                |</span><br><span class="line">+-------------------------------------------------------------------------------+</span><br><span class="line">| GRANT REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO <span class="string">'slave'</span>@<span class="string">'172.16.60.213'</span> |</span><br><span class="line">+-------------------------------------------------------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"> </span><br><span class="line">在主数据库机器上创建一个测试库kevin（为了测试效果）</span><br><span class="line">mysql&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">+--------------------+</span><br><span class="line">4 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"> </span><br><span class="line">mysql&gt; CREATE DATABASE kevin CHARACTER SET utf8 COLLATE utf8_general_ci; </span><br><span class="line">Query OK, 1 row affected (0.02 sec)</span><br><span class="line"> </span><br><span class="line">mysql&gt; use kevin;</span><br><span class="line">Database changed</span><br><span class="line">mysql&gt; create table <span class="keyword">if</span> not exists haha (id int(10) PRIMARY KEY AUTO_INCREMENT,name varchar(50) NOT NULL);</span><br><span class="line">Query OK, 0 rows affected (0.17 sec)</span><br><span class="line"> </span><br><span class="line">mysql&gt; insert into kevin.haha values(1,<span class="string">"congcong"</span>),(2,<span class="string">"huihui"</span>),(3,<span class="string">"grace"</span>); </span><br><span class="line">Query OK, 3 rows affected (0.16 sec)</span><br><span class="line">Records: 3  Duplicates: 0  Warnings: 0</span><br><span class="line"> </span><br><span class="line">mysql&gt; select * from kevin.haha;</span><br><span class="line">+----+----------+</span><br><span class="line">| id | name     |</span><br><span class="line">+----+----------+</span><br><span class="line">|  1 | congcong |</span><br><span class="line">|  2 | huihui   |</span><br><span class="line">|  3 | grace    |</span><br><span class="line">+----+----------+</span><br><span class="line">3 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"> </span><br><span class="line">2) 从数据库mysql-slave1 (172.16.60.212)的配置操作</span><br><span class="line">与主服务器配置大概一致，除了server_id不一致外，从服务器还可以在配置文件里面添加：<span class="string">"read_only＝on"</span> ,</span><br><span class="line">使从服务器只能进行读取操作，此参数对超级用户无效，并且不会影响从服务器的复制；</span><br><span class="line">[root@mysql-slave1 ~]<span class="comment"># &gt;/etc/my.cnf</span></span><br><span class="line">[root@mysql-slave1 ~]<span class="comment"># vim /etc/my.cnf</span></span><br><span class="line">[mysqld]</span><br><span class="line">datadir = /var/lib/mysql</span><br><span class="line">socket = /var/lib/mysql/mysql.sock</span><br><span class="line">        </span><br><span class="line">symbolic-links = 0</span><br><span class="line">        </span><br><span class="line"><span class="built_in">log</span>-error = /var/<span class="built_in">log</span>/mysqld.log</span><br><span class="line">pid-file = /var/run/mysqld/mysqld.pid</span><br><span class="line">    </span><br><span class="line"><span class="comment">#GTID:</span></span><br><span class="line">server_id = 2</span><br><span class="line">gtid_mode = on</span><br><span class="line">enforce_gtid_consistency = on</span><br><span class="line">      </span><br><span class="line"><span class="comment">#binlog</span></span><br><span class="line">log_bin = master-bin</span><br><span class="line"><span class="built_in">log</span>-slave-updates = 1</span><br><span class="line">binlog_format = row</span><br><span class="line">sync-master-info = 1</span><br><span class="line">sync_binlog = 1</span><br><span class="line">      </span><br><span class="line"><span class="comment">#relay log</span></span><br><span class="line">skip_slave_start = 1</span><br><span class="line">read_only = on</span><br><span class="line"> </span><br><span class="line">配置完成之后，别忘了重启Mysql</span><br><span class="line">[root@mysql-slave1 ~]<span class="comment"># systemctl restart mysqld</span></span><br><span class="line"> </span><br><span class="line">接着登录mysql，做主从同步</span><br><span class="line">[root@mysql-slave1 ~]<span class="comment"># mysql -p123456</span></span><br><span class="line">........</span><br><span class="line">mysql&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| <span class="built_in">test</span>               |</span><br><span class="line">+--------------------+</span><br><span class="line">4 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line">   </span><br><span class="line">在从数据库里，使用change master 配置主从复制</span><br><span class="line">mysql&gt; stop slave;</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.00 sec)</span><br><span class="line"> </span><br><span class="line">mysql&gt; change master to master_host=<span class="string">'172.16.60.211'</span>,master_user=<span class="string">'slave'</span>,master_password=<span class="string">'slave@123'</span>,master_auto_position=1;</span><br><span class="line">Query OK, 0 rows affected, 2 warnings (0.24 sec)</span><br><span class="line"> </span><br><span class="line">mysql&gt; start slave;</span><br><span class="line">Query OK, 0 rows affected (0.02 sec)</span><br><span class="line"> </span><br><span class="line">mysql&gt; show slave status \G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting <span class="keyword">for</span> master to send event</span><br><span class="line">                  Master_Host: 172.16.60.211</span><br><span class="line">                  Master_User: slave</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: master-bin.000002</span><br><span class="line">          Read_Master_Log_Pos: 2069</span><br><span class="line">               Relay_Log_File: mysql-slave1-relay-bin.000002</span><br><span class="line">                Relay_Log_Pos: 2284</span><br><span class="line">        Relay_Master_Log_File: master-bin.000002</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">............</span><br><span class="line">............</span><br><span class="line">           Retrieved_Gtid_Set: fc39b161-22ca-11e9-a638-005056ac6820:1-8</span><br><span class="line">            Executed_Gtid_Set: 2afbc2f5-22cb-11e9-b9c0-00505688047c:1-2,</span><br><span class="line">fc39b161-22ca-11e9-a638-005056ac6820:1-8</span><br><span class="line">                Auto_Position: 1</span><br><span class="line">         Replicate_Rewrite_DB:</span><br><span class="line">                 Channel_Name:</span><br><span class="line">           Master_TLS_Version:</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"> </span><br><span class="line">ERROR:</span><br><span class="line">No query specified</span><br><span class="line"> </span><br><span class="line">查看从库的gtid</span><br><span class="line">mysql&gt; show global variables like <span class="string">'%gtid%'</span>;</span><br><span class="line">+----------------------------------+------------------------------------------------------------------------------------+</span><br><span class="line">| Variable_name                    | Value                                                                              |</span><br><span class="line">+----------------------------------+------------------------------------------------------------------------------------+</span><br><span class="line">| binlog_gtid_simple_recovery      | ON                                                                                 |</span><br><span class="line">| enforce_gtid_consistency         | ON                                                                                 |</span><br><span class="line">| gtid_executed                    | 2afbc2f5-22cb-11e9-b9c0-00505688047c:1-2,</span><br><span class="line">fc39b161-22ca-11e9-a638-005056ac6820:1-8 |</span><br><span class="line">| gtid_executed_compression_period | 1000                                                                               |</span><br><span class="line">| gtid_mode                        | ON                                                                                 |</span><br><span class="line">| gtid_owned                       |                                                                                    |</span><br><span class="line">| gtid_purged                      | 2afbc2f5-22cb-11e9-b9c0-00505688047c:1-2                                           |</span><br><span class="line">| session_track_gtids              | OFF                                                                                |</span><br><span class="line">+----------------------------------+------------------------------------------------------------------------------------+</span><br><span class="line">8 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.01 sec)</span><br><span class="line"> </span><br><span class="line">接着查看从数据库的数据，发现kevin库已经同步过来了!</span><br><span class="line">mysql&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| kevin              |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">+--------------------+</span><br><span class="line">5 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"> </span><br><span class="line">mysql&gt; select * from kevin.haha;</span><br><span class="line">+----+----------+</span><br><span class="line">| id | name     |</span><br><span class="line">+----+----------+</span><br><span class="line">|  1 | congcong |</span><br><span class="line">|  2 | huihui   |</span><br><span class="line">|  3 | grace    |</span><br><span class="line">+----+----------+</span><br><span class="line">3 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"> </span><br><span class="line">3) 从数据库mysql-slave2 (172.16.60.213)的配置操作</span><br><span class="line">[root@mysql-slave2 ~]<span class="comment"># &gt;/etc/my.cnf</span></span><br><span class="line">[root@mysql-slave2 ~]<span class="comment"># vim /etc/my.cnf</span></span><br><span class="line">[mysqld]</span><br><span class="line">datadir = /var/lib/mysql</span><br><span class="line">socket = /var/lib/mysql/mysql.sock</span><br><span class="line">        </span><br><span class="line">symbolic-links = 0</span><br><span class="line">        </span><br><span class="line"><span class="built_in">log</span>-error = /var/<span class="built_in">log</span>/mysqld.log</span><br><span class="line">pid-file = /var/run/mysqld/mysqld.pid</span><br><span class="line">    </span><br><span class="line"><span class="comment">#GTID:</span></span><br><span class="line">server_id = 3</span><br><span class="line">gtid_mode = on</span><br><span class="line">enforce_gtid_consistency = on</span><br><span class="line">      </span><br><span class="line"><span class="comment">#binlog</span></span><br><span class="line">log_bin = master-bin</span><br><span class="line"><span class="built_in">log</span>-slave-updates = 1</span><br><span class="line">binlog_format = row</span><br><span class="line">sync-master-info = 1</span><br><span class="line">sync_binlog = 1</span><br><span class="line">      </span><br><span class="line"><span class="comment">#relay log</span></span><br><span class="line">skip_slave_start = 1</span><br><span class="line">read_only = on</span><br><span class="line"> </span><br><span class="line">重启mysqld</span><br><span class="line">[root@mysql-slave2 ~]<span class="comment">#  systemctl restart mysqld </span></span><br><span class="line"> </span><br><span class="line">登录mysql，做主从复制</span><br><span class="line">[root@mysql-slave2 ~]<span class="comment"># mysql -p123456</span></span><br><span class="line">.........</span><br><span class="line">mysql&gt; stop slave;</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.00 sec)</span><br><span class="line"> </span><br><span class="line">mysql&gt; change master to master_host=<span class="string">'172.16.60.211'</span>,master_user=<span class="string">'slave'</span>,master_password=<span class="string">'slave@123'</span>,master_auto_position=1;</span><br><span class="line">Query OK, 0 rows affected, 2 warnings (0.17 sec)</span><br><span class="line"> </span><br><span class="line">mysql&gt; start slave;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"> </span><br><span class="line">mysql&gt; show slave status \G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting <span class="keyword">for</span> master to send event</span><br><span class="line">                  Master_Host: 172.16.60.211</span><br><span class="line">                  Master_User: slave</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: master-bin.000002</span><br><span class="line">          Read_Master_Log_Pos: 2069</span><br><span class="line">               Relay_Log_File: mysql-slave2-relay-bin.000002</span><br><span class="line">                Relay_Log_Pos: 2284</span><br><span class="line">        Relay_Master_Log_File: master-bin.000002</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">..........</span><br><span class="line">..........</span><br><span class="line">           Retrieved_Gtid_Set: fc39b161-22ca-11e9-a638-005056ac6820:1-8</span><br><span class="line">            Executed_Gtid_Set: 26e410b4-22cb-11e9-be44-005056880888:1-2,</span><br><span class="line">fc39b161-22ca-11e9-a638-005056ac6820:1-8</span><br><span class="line">                Auto_Position: 1</span><br><span class="line">         Replicate_Rewrite_DB:</span><br><span class="line">                 Channel_Name:</span><br><span class="line">           Master_TLS_Version:</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"> </span><br><span class="line">ERROR:</span><br><span class="line">No query specified</span><br><span class="line"> </span><br><span class="line">查看从库的gtid</span><br><span class="line">mysql&gt; show global variables like <span class="string">'%gtid%'</span>;</span><br><span class="line">+----------------------------------+------------------------------------------------------------------------------------+</span><br><span class="line">| Variable_name                    | Value                                                                              |</span><br><span class="line">+----------------------------------+------------------------------------------------------------------------------------+</span><br><span class="line">| binlog_gtid_simple_recovery      | ON                                                                                 |</span><br><span class="line">| enforce_gtid_consistency         | ON                                                                                 |</span><br><span class="line">| gtid_executed                    | 26e410b4-22cb-11e9-be44-005056880888:1-2,</span><br><span class="line">fc39b161-22ca-11e9-a638-005056ac6820:1-8 |</span><br><span class="line">| gtid_executed_compression_period | 1000                                                                               |</span><br><span class="line">| gtid_mode                        | ON                                                                                 |</span><br><span class="line">| gtid_owned                       |                                                                                    |</span><br><span class="line">| gtid_purged                      | 26e410b4-22cb-11e9-be44-005056880888:1-2                                           |</span><br><span class="line">| session_track_gtids              | OFF                                                                                |</span><br><span class="line">+----------------------------------+------------------------------------------------------------------------------------+</span><br><span class="line">8 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.01 sec)</span><br><span class="line"> </span><br><span class="line">接着查看从数据库的数据，发现kevin库已经同步过来了!</span><br><span class="line">mysql&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| kevin              |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">+--------------------+</span><br><span class="line">5 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"> </span><br><span class="line">mysql&gt; select * from kevin.haha;</span><br><span class="line">+----+----------+</span><br><span class="line">| id | name     |</span><br><span class="line">+----+----------+</span><br><span class="line">|  1 | congcong |</span><br><span class="line">|  2 | huihui   |</span><br><span class="line">|  3 | grace    |</span><br><span class="line">+----+----------+</span><br><span class="line">3 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"> </span><br><span class="line">4）再回到主数据库mysql-master (172.16.60.211)上</span><br><span class="line"> </span><br><span class="line">查看master状态，发现已经有两个slave节点正常存在同步关系了</span><br><span class="line">mysql&gt; show slave hosts;</span><br><span class="line">+-----------+------+------+-----------+--------------------------------------+</span><br><span class="line">| Server_id | Host | Port | Master_id | Slave_UUID                           |</span><br><span class="line">+-----------+------+------+-----------+--------------------------------------+</span><br><span class="line">|         3 |      | 3306 |         1 | 26e410b4-22cb-11e9-be44-005056880888 |</span><br><span class="line">|         2 |      | 3306 |         1 | 2afbc2f5-22cb-11e9-b9c0-00505688047c |</span><br><span class="line">+-----------+------+------+-----------+--------------------------------------+</span><br><span class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"> </span><br><span class="line">5）测试数据同步</span><br><span class="line">在主数据库mysql-master (172.16.60.211)上更新数据</span><br><span class="line">mysql&gt; insert into kevin.haha values(10,<span class="string">"heifei"</span>),(11,<span class="string">"huoqiu"</span>),(12,<span class="string">"chengxihu"</span>);</span><br><span class="line">Query OK, 3 rows affected (0.05 sec)</span><br><span class="line">Records: 3  Duplicates: 0  Warnings: 0</span><br><span class="line"> </span><br><span class="line">然后在两个slave从数据库上查看，发现已正常同步过来了</span><br><span class="line">mysql&gt; select * from kevin.haha;</span><br><span class="line">+----+-----------+</span><br><span class="line">| id | name      |</span><br><span class="line">+----+-----------+</span><br><span class="line">|  1 | congcong  |</span><br><span class="line">|  2 | huihui    |</span><br><span class="line">|  3 | grace     |</span><br><span class="line">| 10 | heifei    |</span><br><span class="line">| 11 | huoqiu    |</span><br><span class="line">| 12 | chengxihu |</span><br><span class="line">+----+-----------+</span><br><span class="line">6 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure><h3 id="安装配置ProxySQL"><a href="#安装配置ProxySQL" class="headerlink" title="安装配置ProxySQL"></a><strong>安装配置ProxySQL</strong></h3><p>已经在上面第一步中介绍了安装方法，这里采用rpm包方式安装，安装过程省略……..</p><h4 id="ProxySQL实现读写分离"><a href="#ProxySQL实现读写分离" class="headerlink" title="ProxySQL实现读写分离"></a><strong>ProxySQL实现读写分离</strong></h4><p><strong>向ProxySQL中添加MySQL节点</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">使用insert语句添加主机到mysql_servers表中，其中：hostgroup_id 为10表示写组，为20表示读组。</span><br><span class="line">  </span><br><span class="line">[root@mysql-proxy ~]<span class="comment"># mysql -uadmin -padmin -P6032 -h127.0.0.1</span></span><br><span class="line">............</span><br><span class="line">MySQL [(none)]&gt; insert into mysql_servers(hostgroup_id,hostname,port) values(10,<span class="string">'172.16.60.211'</span>,3306);</span><br><span class="line">Query OK, 1 row affected (0.000 sec)</span><br><span class="line">  </span><br><span class="line">MySQL [(none)]&gt; insert into mysql_servers(hostgroup_id,hostname,port) values(10,<span class="string">'172.16.60.212'</span>,3306);</span><br><span class="line">Query OK, 1 row affected (0.000 sec)</span><br><span class="line">  </span><br><span class="line">MySQL [(none)]&gt; insert into mysql_servers(hostgroup_id,hostname,port) values(10,<span class="string">'172.16.60.213'</span>,3306);</span><br><span class="line">Query OK, 1 row affected (0.000 sec)</span><br><span class="line"> </span><br><span class="line">==========================================================================================================</span><br><span class="line">如果在插入过程中，出现报错：</span><br><span class="line">ERROR 1045 (<span class="comment">#2800): UNIQUE constraint failed: mysql_servers.hostgroup_id, mysql_servers.hostname, mysql_servers.port</span></span><br><span class="line"> </span><br><span class="line">说明可能之前就已经定义了其他配置，可以清空这张表 或者 删除对应host的配置</span><br><span class="line">MySQL [(none)]&gt; select * from mysql_servers;</span><br><span class="line">MySQL [(none)]&gt; delete from mysql_servers;</span><br><span class="line">Query OK, 6 rows affected (0.000 sec)</span><br><span class="line">=========================================================================================================</span><br><span class="line">  </span><br><span class="line">查看这3个节点是否插入成功，以及它们的状态。</span><br><span class="line">MySQL [(none)]&gt; select * from mysql_servers\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">       hostgroup_id: 10</span><br><span class="line">           hostname: 172.16.60.211</span><br><span class="line">               port: 3306</span><br><span class="line">             status: ONLINE</span><br><span class="line">             weight: 1</span><br><span class="line">        compression: 0</span><br><span class="line">    max_connections: 1000</span><br><span class="line">max_replication_lag: 0</span><br><span class="line">            use_ssl: 0</span><br><span class="line">     max_latency_ms: 0</span><br><span class="line">            comment:</span><br><span class="line">*************************** 2. row ***************************</span><br><span class="line">       hostgroup_id: 10</span><br><span class="line">           hostname: 172.16.60.212</span><br><span class="line">               port: 3306</span><br><span class="line">             status: ONLINE</span><br><span class="line">             weight: 1</span><br><span class="line">        compression: 0</span><br><span class="line">    max_connections: 1000</span><br><span class="line">max_replication_lag: 0</span><br><span class="line">            use_ssl: 0</span><br><span class="line">     max_latency_ms: 0</span><br><span class="line">            comment:</span><br><span class="line">*************************** 3. row ***************************</span><br><span class="line">       hostgroup_id: 10</span><br><span class="line">           hostname: 172.16.60.213</span><br><span class="line">               port: 3306</span><br><span class="line">             status: ONLINE</span><br><span class="line">             weight: 1</span><br><span class="line">        compression: 0</span><br><span class="line">    max_connections: 1000</span><br><span class="line">max_replication_lag: 0</span><br><span class="line">            use_ssl: 0</span><br><span class="line">     max_latency_ms: 0</span><br><span class="line">            comment:</span><br><span class="line">6 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.000 sec)</span><br><span class="line">  </span><br><span class="line">ERROR: No query specified</span><br><span class="line">  </span><br><span class="line">如上修改后，加载到RUNTIME，并保存到disk</span><br><span class="line">MySQL [(none)]&gt; load mysql servers to runtime;</span><br><span class="line">Query OK, 0 rows affected (0.006 sec)</span><br><span class="line">  </span><br><span class="line">MySQL [(none)]&gt; save mysql servers to disk;</span><br><span class="line">Query OK, 0 rows affected (0.348 sec)</span><br></pre></td></tr></table></figure><p><strong>监控后端MySQL节点</strong><br>添加Mysql节点之后，还需要监控这些后端节点。对于后端是主从复制的环境来说，这是必须的，因为ProxySQL需要通过每个节点的read_only值来自动调整<br>它们是属于读组还是写组。</p><p>首先在后端master主数据节点上创建一个用于监控的用户名(只需在master上创建即可，因为会复制到slave上)，这个用户名只需具有USAGE权限即可。如果还需<br>要监控复制结构中slave是否严重延迟于master(这个俗语叫做”拖后腿”，术语叫做”replication lag”)，则还需具备replication client权限。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line">在mysql-master主数据库节点行执行：</span><br><span class="line">[root@mysql-master ~]<span class="comment"># mysql -p123456</span></span><br><span class="line">..........</span><br><span class="line"> </span><br><span class="line">mysql&gt; create user monitor@<span class="string">'172.16.60.%'</span> identified by <span class="string">'P@ssword1!'</span>;</span><br><span class="line">Query OK, 0 rows affected (0.03 sec)</span><br><span class="line"> </span><br><span class="line">mysql&gt; grant replication client on *.* to monitor@<span class="string">'172.16.60.%'</span>;</span><br><span class="line">Query OK, 0 rows affected (0.02 sec)</span><br><span class="line"> </span><br><span class="line">mysql&gt; flush privileges;</span><br><span class="line">Query OK, 0 rows affected (0.02 sec)</span><br><span class="line"> </span><br><span class="line">然后回到mysql-proxy代理层节点上配置监控</span><br><span class="line">[root@mysql-proxy ~]<span class="comment"># mysql -uadmin -padmin -P6032 -h127.0.0.1</span></span><br><span class="line">..........</span><br><span class="line">MySQL [(none)]&gt; <span class="built_in">set</span> mysql-monitor_username=<span class="string">'monitor'</span>;</span><br><span class="line">Query OK, 1 row affected (0.000 sec)</span><br><span class="line"> </span><br><span class="line">MySQL [(none)]&gt; <span class="built_in">set</span> mysql-monitor_password=<span class="string">'P@ssword1!'</span>;</span><br><span class="line">Query OK, 1 row affected (0.000 sec)</span><br><span class="line"> </span><br><span class="line">修改后，加载到RUNTIME，并保存到disk</span><br><span class="line">MySQL [(none)]&gt; load mysql variables to runtime;</span><br><span class="line">Query OK, 0 rows affected (0.001 sec)</span><br><span class="line"> </span><br><span class="line">MySQL [(none)]&gt; save mysql variables to disk;</span><br><span class="line">Query OK, 94 rows affected (0.079 sec)</span><br><span class="line"> </span><br><span class="line">验证监控结果：ProxySQL监控模块的指标都保存在monitor库的<span class="built_in">log</span>表中。</span><br><span class="line">  </span><br><span class="line">以下是连接是否正常的监控(对connect指标的监控)：</span><br><span class="line">注意：可能会有很多connect_error，这是因为没有配置监控信息时的错误，配置后如果connect_error的结果为NULL则表示正常。</span><br><span class="line">MySQL [(none)]&gt; select * from mysql_server_connect_log;</span><br><span class="line">+---------------+------+------------------+-------------------------+---------------+</span><br><span class="line">| hostname      | port | time_start_us    | connect_success_time_us | connect_error |</span><br><span class="line">+---------------+------+------------------+-------------------------+---------------+</span><br><span class="line">| 172.16.60.211 | 3306 | 1548665195883957 | 762                     | NULL          |</span><br><span class="line">| 172.16.60.212 | 3306 | 1548665195894099 | 399                     | NULL          |</span><br><span class="line">| 172.16.60.213 | 3306 | 1548665195904266 | 483                     | NULL          |</span><br><span class="line">| 172.16.60.211 | 3306 | 1548665255883715 | 824                     | NULL          |</span><br><span class="line">| 172.16.60.212 | 3306 | 1548665255893942 | 656                     | NULL          |</span><br><span class="line">| 172.16.60.211 | 3306 | 1548665495884125 | 615                     | NULL          |</span><br><span class="line">| 172.16.60.212 | 3306 | 1548665495894254 | 441                     | NULL          |</span><br><span class="line">| 172.16.60.213 | 3306 | 1548665495904479 | 638                     | NULL          |</span><br><span class="line">| 172.16.60.211 | 3306 | 1548665512917846 | 487                     | NULL          |</span><br><span class="line">| 172.16.60.212 | 3306 | 1548665512928071 | 994                     | NULL          |</span><br><span class="line">| 172.16.60.213 | 3306 | 1548665512938268 | 613                     | NULL          |</span><br><span class="line">+---------------+------+------------------+-------------------------+---------------+</span><br><span class="line">20 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.000 sec)</span><br><span class="line"> </span><br><span class="line">以下是对心跳信息的监控(对ping指标的监控)</span><br><span class="line">MySQL [(none)]&gt; select * from mysql_server_ping_log;</span><br><span class="line">+---------------+------+------------------+----------------------+------------+</span><br><span class="line">| hostname      | port | time_start_us    | ping_success_time_us | ping_error |</span><br><span class="line">+---------------+------+------------------+----------------------+------------+</span><br><span class="line">| 172.16.60.211 | 3306 | 1548665195883407 | 98                   | NULL       |</span><br><span class="line">| 172.16.60.212 | 3306 | 1548665195885128 | 119                  | NULL       |</span><br><span class="line">...........</span><br><span class="line">| 172.16.60.213 | 3306 | 1548665415889362 | 106                  | NULL       |</span><br><span class="line">| 172.16.60.213 | 3306 | 1548665562898295 | 97                   | NULL       |</span><br><span class="line">+---------------+------+------------------+----------------------+------------+</span><br><span class="line">110 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.001 sec)</span><br><span class="line"> </span><br><span class="line">read_only日志此时也为空(正常来说，新环境配置时，这个只读日志是为空的)</span><br><span class="line">MySQL [(none)]&gt; select * from mysql_server_read_only_log;</span><br><span class="line">Empty <span class="built_in">set</span> (0.000 sec)</span><br><span class="line"> </span><br><span class="line">replication_lag的监控日志为空</span><br><span class="line">MySQL [(none)]&gt; select * from mysql_server_replication_lag_log;</span><br><span class="line">Empty <span class="built_in">set</span> (0.000 sec)</span><br><span class="line"> </span><br><span class="line">指定写组的id为10，读组的id为20。</span><br><span class="line">MySQL [(none)]&gt; insert into mysql_replication_hostgroups values(10,20,1);</span><br><span class="line">Query OK, 1 row affected (0.000 sec)</span><br><span class="line"> </span><br><span class="line">在该配置加载到RUNTIME生效之前，先查看下各mysql server所在的组。</span><br><span class="line">MySQL [(none)]&gt; select hostgroup_id,hostname,port,status,weight from mysql_servers;</span><br><span class="line">+--------------+---------------+------+--------+--------+</span><br><span class="line">| hostgroup_id | hostname      | port | status | weight |</span><br><span class="line">+--------------+---------------+------+--------+--------+</span><br><span class="line">| 10           | 172.16.60.211 | 3306 | ONLINE | 1      |</span><br><span class="line">| 10           | 172.16.60.212 | 3306 | ONLINE | 1      |</span><br><span class="line">| 10           | 172.16.60.213 | 3306 | ONLINE | 1      |</span><br><span class="line">+--------------+---------------+------+--------+--------+</span><br><span class="line">3 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.000 sec)</span><br><span class="line"> </span><br><span class="line">3个节点都在hostgroup_id=10的组中。</span><br><span class="line">现在，将刚才mysql_replication_hostgroups表的修改加载到RUNTIME生效。</span><br><span class="line">MySQL [(none)]&gt; load mysql servers to runtime;</span><br><span class="line">Query OK, 0 rows affected (0.003 sec)</span><br><span class="line"> </span><br><span class="line">MySQL [(none)]&gt; save mysql servers to disk;</span><br><span class="line">Query OK, 0 rows affected (0.361 sec)</span><br><span class="line"> </span><br><span class="line">一加载，Monitor模块就会开始监控后端的read_only值，当监控到read_only值后，就会按照read_only的值将某些节点自动移动到读/写组。</span><br><span class="line">例如，此处所有节点都在id=10的写组，slave1和slave2都是slave，它们的read_only=1，这两个节点将会移动到id=20的组。</span><br><span class="line">如果一开始这3节点都在id=20的读组，那么移动的将是Master节点，会移动到id=10的写组。</span><br><span class="line">  </span><br><span class="line">现在看结果</span><br><span class="line">MySQL [(none)]&gt; select hostgroup_id,hostname,port,status,weight from mysql_servers;</span><br><span class="line">+--------------+---------------+------+--------+--------+</span><br><span class="line">| hostgroup_id | hostname      | port | status | weight |</span><br><span class="line">+--------------+---------------+------+--------+--------+</span><br><span class="line">| 10           | 172.16.60.211 | 3306 | ONLINE | 1      |</span><br><span class="line">| 20           | 172.16.60.212 | 3306 | ONLINE | 1      |</span><br><span class="line">| 20           | 172.16.60.213 | 3306 | ONLINE | 1      |</span><br><span class="line">+--------------+---------------+------+--------+--------+</span><br><span class="line">3 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.000 sec)</span><br><span class="line"> </span><br><span class="line">MySQL [(none)]&gt; select * from mysql_server_read_only_log;</span><br><span class="line">+---------------+------+------------------+-----------------+-----------+-------+</span><br><span class="line">| hostname      | port | time_start_us    | success_time_us | read_only | error |</span><br><span class="line">+---------------+------+------------------+-----------------+-----------+-------+</span><br><span class="line">| 172.16.60.212 | 3306 | 1548665728919212 | 1684            | 1         | NULL  |</span><br><span class="line">| 172.16.60.211 | 3306 | 1548665728918753 | 3538            | 0         | NULL  |</span><br><span class="line">| 172.16.60.213 | 3306 | 1548665728919782 | 3071            | 1         | NULL  |</span><br></pre></td></tr></table></figure><p><strong>配置mysql_users</strong><br>上面的所有配置都是关于后端MySQL节点的，现在可以配置关于SQL语句的，包括：发送SQL语句的用户、SQL语句的路由规则、SQL查询的缓存、SQL语句的重写等等。本小节是SQL请求所使用的用户配置，例如root用户。这要求我们需要先在后端MySQL节点添加好相关用户。这里以root和sqlsender两个用户名为例.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line">首先，在mysql-master主数据库节点上执行：(只需master执行即可，会复制给两个slave)</span><br><span class="line">[root@mysql-master ~]<span class="comment"># mysql -p123456</span></span><br><span class="line">.........</span><br><span class="line">mysql&gt; grant all on *.* to root@<span class="string">'172.16.60.%'</span> identified by <span class="string">'passwd'</span>;</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.04 sec)</span><br><span class="line"> </span><br><span class="line">mysql&gt; grant all on *.* to sqlsender@<span class="string">'172.16.60.%'</span> identified by <span class="string">'P@ssword1!'</span>;</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.03 sec)</span><br><span class="line"> </span><br><span class="line">mysql&gt; flush privileges;</span><br><span class="line">Query OK, 0 rows affected (0.03 sec)</span><br><span class="line"> </span><br><span class="line">然后回到mysql-proxy代理层节点，配置mysql_users表，将刚才的两个用户添加到该表中。</span><br><span class="line">admin&gt; insert into mysql_users(username,password,default_hostgroup) values(<span class="string">'root'</span>,<span class="string">'passwd'</span>,10);</span><br><span class="line">Query OK, 1 row affected (0.001 sec)</span><br><span class="line">  </span><br><span class="line">admin&gt; insert into mysql_users(username,password,default_hostgroup) values(<span class="string">'sqlsender'</span>,<span class="string">'P@ssword1!'</span>,10);</span><br><span class="line">Query OK, 1 row affected (0.000 sec)</span><br><span class="line">  </span><br><span class="line">admin&gt; load mysql users to runtime;</span><br><span class="line">Query OK, 0 rows affected (0.001 sec)</span><br><span class="line">  </span><br><span class="line">admin&gt; save mysql users to disk;</span><br><span class="line">Query OK, 0 rows affected (0.108 sec)</span><br><span class="line">  </span><br><span class="line">mysql_users表有不少字段，最主要的三个字段为username、password和default_hostgroup：</span><br><span class="line">-  username：前端连接ProxySQL，以及ProxySQL将SQL语句路由给MySQL所使用的用户名。</span><br><span class="line">-  password：用户名对应的密码。可以是明文密码，也可以是<span class="built_in">hash</span>密码。如果想使用<span class="built_in">hash</span>密码，可以先在某个MySQL节点上执行</span><br><span class="line">   select password(PASSWORD)，然后将加密结果复制到该字段。</span><br><span class="line">-  default_hostgroup：该用户名默认的路由目标。例如，指定root用户的该字段值为10时，则使用root用户发送的SQL语句默认</span><br><span class="line">   情况下将路由到hostgroup_id=10组中的某个节点。</span><br><span class="line"> </span><br><span class="line">admin&gt; select * from mysql_users\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">              username: root</span><br><span class="line">              password: passwd</span><br><span class="line">                active: 1</span><br><span class="line">               use_ssl: 0</span><br><span class="line">     default_hostgroup: 10</span><br><span class="line">        default_schema: NULL</span><br><span class="line">         schema_locked: 0</span><br><span class="line">transaction_persistent: 1</span><br><span class="line">          fast_forward: 0</span><br><span class="line">               backend: 1</span><br><span class="line">              frontend: 1</span><br><span class="line">       max_connections: 10000</span><br><span class="line">*************************** 2. row ***************************</span><br><span class="line">              username: sqlsender</span><br><span class="line">              password: P@ssword1!</span><br><span class="line">                active: 1</span><br><span class="line">               use_ssl: 0</span><br><span class="line">     default_hostgroup: 10</span><br><span class="line">        default_schema: NULL</span><br><span class="line">         schema_locked: 0</span><br><span class="line">transaction_persistent: 1</span><br><span class="line">          fast_forward: 0</span><br><span class="line">               backend: 1</span><br><span class="line">              frontend: 1</span><br><span class="line">       max_connections: 10000</span><br><span class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.000 sec)</span><br><span class="line">  </span><br><span class="line">虽然这里没有详细介绍mysql_users表，但上面标注了<span class="string">"注意本行"</span>的两个字段必须要引起注意。只有active=1的用户才是有效的用户。</span><br><span class="line">至于transaction_persistent字段，当它的值为1时，表示事务持久化：当某连接使用该用户开启了一个事务后，那么在事务提交/回滚之前，</span><br><span class="line">所有的语句都路由到同一个组中，避免语句分散到不同组。在以前的版本中，默认值为0，不知道从哪个版本开始，它的默认值为1。</span><br><span class="line">我们期望的值为1，所以在继续下面的步骤之前，先查看下这个值，如果为0，则执行下面的语句修改为1。</span><br><span class="line"> </span><br><span class="line">MySQL [(none)]&gt; update mysql_users <span class="built_in">set</span> transaction_persistent=1 <span class="built_in">where</span> username=<span class="string">'root'</span>;</span><br><span class="line">Query OK, 1 row affected (0.000 sec)</span><br><span class="line"> </span><br><span class="line">MySQL [(none)]&gt; update mysql_users <span class="built_in">set</span> transaction_persistent=1 <span class="built_in">where</span> username=<span class="string">'sqlsender'</span>;</span><br><span class="line">Query OK, 1 row affected (0.000 sec)</span><br><span class="line"> </span><br><span class="line">MySQL [(none)]&gt; load mysql users to runtime;</span><br><span class="line">Query OK, 0 rows affected (0.001 sec)</span><br><span class="line"> </span><br><span class="line">MySQL [(none)]&gt; save mysql users to disk;</span><br><span class="line">Query OK, 0 rows affected (0.123 sec)</span><br><span class="line"> </span><br><span class="line">然后，分别使用root用户和sqlsender用户测试下它们是否能路由到默认的hostgroup_id=10(它是一个写组)读、写数据。</span><br><span class="line">下面是通过转发端口6033连接的，连接的是转发到后端真正的数据库!</span><br><span class="line">[root@mysql-proxy ~]<span class="comment"># mysql -uroot -ppasswd -P6033 -h127.0.0.1 -e "select @@server_id"</span></span><br><span class="line">+-------------+</span><br><span class="line">| @@server_id |</span><br><span class="line">+-------------+</span><br><span class="line">|           1 |</span><br><span class="line">+-------------+</span><br><span class="line">[root@mysql-proxy ~]<span class="comment"># mysql -uroot -ppasswd -P6033 -h127.0.0.1 -e "create database proxy_test"</span></span><br><span class="line">[root@mysql-proxy ~]<span class="comment"># mysql -uroot -ppasswd -P6033 -h127.0.0.1 -e "show databases;"</span></span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| kevin              |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| proxy_test         |</span><br><span class="line">| sys                |</span><br><span class="line">+--------------------+</span><br><span class="line">[root@mysql-proxy ~]<span class="comment"># mysql -usqlsender -pP@ssword1! -P6033 -h127.0.0.1 -e 'use proxy_test;create table t(id int);'</span></span><br><span class="line">[root@mysql-proxy ~]<span class="comment"># mysql -usqlsender -pP@ssword1! -P6033 -h127.0.0.1 -e 'show tables from proxy_test;'</span></span><br><span class="line">+----------------------+</span><br><span class="line">| Tables_in_proxy_test |</span><br><span class="line">+----------------------+</span><br><span class="line">| t                    |</span><br><span class="line">+----------------------+</span><br><span class="line">[root@mysql-proxy ~]<span class="comment"># mysql -usqlsender -pP@ssword1! -P6033 -h127.0.0.1 -e 'show databases;'           </span></span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| kevin              |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| proxy_test         |</span><br><span class="line">| sys                |</span><br><span class="line">+--------------------+</span><br><span class="line"> </span><br><span class="line">然后再删除上面这个测试库</span><br><span class="line">[root@mysql-proxy ~]<span class="comment"># mysql -usqlsender -pP@ssword1! -P6033 -h127.0.0.1 -e 'drop database proxy_test;'</span></span><br><span class="line">[root@mysql-proxy ~]<span class="comment"># mysql -usqlsender -pP@ssword1! -P6033 -h127.0.0.1 -e 'show databases;'         </span></span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| kevin              |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">+--------------------+</span><br></pre></td></tr></table></figure><p><strong>读写分离：配置路由规则</strong><br>ProxySQL的路由规则非常灵活，可以基于用户、基于schema以及基于每个语句实现路由规则的定制。本案例作为一个入门配置，实现一个最简单的语句级路由规则，从而实现读写分离。</p><p><strong>必须注意:</strong> 这只是实验，实际的路由规则绝不应该仅根据所谓的读、写操作进行分离，而是从各项指标中找出压力大、执行频繁的语句单独写规则、做缓存等等。和查询规则有关的表有两个:mysql_query_rules和mysql_query_rules_fast_routing，后者是前者的扩展表，1.4.7之后才支持该快速路由表。本案例只介绍第一个表。插入两个规则，目的是将select语句分离到hostgroup_id=20的读组，但由于select语句中有一个特殊语句SELECT…FOR UPDATE它会申请写锁，所以应该路由到hostgroup_id=10的写组.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">[root@mysql-proxy ~]<span class="comment"># mysql -uadmin -padmin -P6032 -h127.0.0.1                       </span></span><br><span class="line">............</span><br><span class="line">MySQL [(none)]&gt; insert into mysql_query_rules(rule_id,active,match_digest,destination_hostgroup,apply) VALUES (1,1,<span class="string">'^SELECT.*FOR UPDATE$'</span>,10,1), (2,1,<span class="string">'^SELECT'</span>,20,1);</span><br><span class="line">Query OK, 2 rows affected (0.000 sec)</span><br><span class="line"> </span><br><span class="line">MySQL [(none)]&gt; load mysql query rules to runtime;</span><br><span class="line">Query OK, 0 rows affected (0.000 sec)</span><br><span class="line"> </span><br><span class="line">MySQL [(none)]&gt; save mysql query rules to disk;</span><br><span class="line">Query OK, 0 rows affected (0.272 sec)</span><br><span class="line"> </span><br><span class="line">需要注意： select ... <span class="keyword">for</span> update规则的rule_id必须要小于普通的select规则的rule_id，因为ProxySQL是根据rule_id的顺序进行规则匹配的。</span><br><span class="line">    </span><br><span class="line">再来测试下，读操作是否路由给了hostgroup_id=20的读组, 如下发现server_id为2和3的节点 (即slave从节点)在读组内</span><br><span class="line">[root@mysql-proxy ~]<span class="comment"># mysql -uroot -ppasswd -P6033 -h127.0.0.1 -e 'select @@server_id'</span></span><br><span class="line">+-------------+</span><br><span class="line">| @@server_id |</span><br><span class="line">+-------------+</span><br><span class="line">|           3 |</span><br><span class="line">+-------------+</span><br><span class="line">[root@mysql-proxy ~]<span class="comment"># mysql -uroot -ppasswd -P6033 -h127.0.0.1 -e 'select @@server_id'</span></span><br><span class="line">+-------------+</span><br><span class="line">| @@server_id |</span><br><span class="line">+-------------+</span><br><span class="line">|           3 |</span><br><span class="line">+-------------+</span><br><span class="line">[root@mysql-proxy ~]<span class="comment"># mysql -uroot -ppasswd -P6033 -h127.0.0.1 -e 'select @@server_id'</span></span><br><span class="line">+-------------+</span><br><span class="line">| @@server_id |</span><br><span class="line">+-------------+</span><br><span class="line">|           2 |</span><br><span class="line">+-------------+</span><br><span class="line"> </span><br><span class="line">读操作已经路由给读组，再看看写操作。这里以事务持久化进行测试。</span><br><span class="line">[root@mysql-proxy ~]<span class="comment"># mysql -uroot -ppasswd -P6033 -h127.0.0.1 -e 'start transaction;select @@server_id;commit;select @@server_id;'</span></span><br><span class="line">+-------------+</span><br><span class="line">| @@server_id |</span><br><span class="line">+-------------+</span><br><span class="line">|           1 |</span><br><span class="line">+-------------+</span><br><span class="line">+-------------+</span><br><span class="line">| @@server_id |</span><br><span class="line">+-------------+</span><br><span class="line">|           3 |</span><br><span class="line">+-------------+</span><br><span class="line">[root@mysql-proxy ~]<span class="comment"># mysql -uroot -ppasswd -P6033 -h127.0.0.1 -e 'start transaction;select @@server_id;commit;select @@server_id;'</span></span><br><span class="line">+-------------+</span><br><span class="line">| @@server_id |</span><br><span class="line">+-------------+</span><br><span class="line">|           1 |</span><br><span class="line">+-------------+</span><br><span class="line">+-------------+</span><br><span class="line">| @@server_id |</span><br><span class="line">+-------------+</span><br><span class="line">|           2 |</span><br><span class="line"> </span><br><span class="line">显然，一切都按照预期进行。最后，如果想查看路由的信息，可查询stats库中的stats_mysql_query_digest表。</span><br><span class="line">以下是该表的一个输出格式示例(和本案例无关)。</span><br><span class="line">[root@mysql-proxy ~]<span class="comment"># mysql -uadmin -padmin -P6032 -h127.0.0.1                       </span></span><br><span class="line">............</span><br><span class="line">MySQL [(none)]&gt; SELECT hostgroup hg, sum_time, count_star, digest_text FROM stats_mysql_query_digest ORDER BY sum_time DESC;</span><br><span class="line">+----+----------+------------+----------------------------------+</span><br><span class="line">| hg | sum_time | count_star | digest_text                      |</span><br><span class="line">+----+----------+------------+----------------------------------+</span><br><span class="line">| 10 | 283841   | 1          | drop database proxy_test         |</span><br><span class="line">| 10 | 161020   | 1          | create table t(id int)           |</span><br><span class="line">| 10 | 36002    | 1          | create database proxy_test       |</span><br><span class="line">| 20 | 2719     | 5          | select @@server_id               |</span><br><span class="line">| 10 | 1250     | 3          | select @@server_id               |</span><br><span class="line">| 10 | 1102     | 2          | show databases                   |</span><br><span class="line">| 10 | 789      | 2          | start transaction                |</span><br><span class="line">| 10 | 655      | 1          | SELECT DATABASE()                |</span><br><span class="line">| 10 | 629      | 1          | show databases                   |</span><br><span class="line">| 10 | 564      | 1          | show tables from proxy_test      |</span><br><span class="line">| 10 | 286      | 2          | commit                           |</span><br><span class="line">| 10 | 0        | 8          | select @@version_comment <span class="built_in">limit</span> ? |</span><br><span class="line">| 10 | 0        | 5          | select @@version_comment <span class="built_in">limit</span> ? |</span><br><span class="line">+----+----------+------------+----------------------------------+</span><br><span class="line">13 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.002 sec)</span><br></pre></td></tr></table></figure><p><strong>测试读写分离效果</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">由于读写操作都记录在proxysql的stats_mysql_query_digest表内。</span><br><span class="line">为了测试读写分离的效果，可以先清空此表中之前的记录 (即之前在实现读写分配路由配置之前的记录)</span><br><span class="line"> </span><br><span class="line">下面这个命令是专门清空stats_mysql_query_digest表的  (使用<span class="string">"delete from stats_mysql_query_digest"</span>  清空不掉!)</span><br><span class="line">MySQL [(none)]&gt; SELECT 1 FROM stats_mysql_query_digest_reset LIMIT 1;</span><br><span class="line">+---+</span><br><span class="line">| 1 |</span><br><span class="line">+---+</span><br><span class="line">| 1 |</span><br><span class="line">+---+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.002 sec)</span><br><span class="line"> </span><br><span class="line">MySQL [(none)]&gt; select hostgroup,username,digest_text,count_star from stats_mysql_query_digest;             </span><br><span class="line">Empty <span class="built_in">set</span> (0.001 sec)</span><br><span class="line"> </span><br><span class="line">在mysql-proxy代理层节点，通过proxysql进行数据写入，并查看</span><br><span class="line">[root@mysql-proxy ~]<span class="comment"># mysql -uroot -ppasswd -P6033 -h127.0.0.1 -e 'select * from kevin.haha;'</span></span><br><span class="line">+----+-----------+</span><br><span class="line">| id | name      |</span><br><span class="line">+----+-----------+</span><br><span class="line">|  1 | congcong  |</span><br><span class="line">|  2 | huihui    |</span><br><span class="line">|  3 | grace     |</span><br><span class="line">| 11 | huoqiu    |</span><br><span class="line">| 12 | chengxihu |</span><br><span class="line">| 21 | zhongguo  |</span><br><span class="line">+----+-----------+</span><br><span class="line">[root@mysql-proxy ~]<span class="comment"># mysql -uroot -ppasswd -P6033 -h127.0.0.1 -e 'delete from kevin.haha where id &gt; 3;'</span></span><br><span class="line">[root@mysql-proxy ~]<span class="comment"># mysql -uroot -ppasswd -P6033 -h127.0.0.1 -e 'insert into kevin.haha values(21,"zhongguo"),(22,"xianggang"),(23,"taiwan");'</span></span><br><span class="line">[root@mysql-proxy ~]<span class="comment"># mysql -uroot -ppasswd -P6033 -h127.0.0.1 -e 'update kevin.haha set name="hangzhou" where id=22 ;'                </span></span><br><span class="line">[root@mysql-proxy ~]<span class="comment"># mysql -uroot -ppasswd -P6033 -h127.0.0.1 -e 'select * from kevin.haha;'                                          </span></span><br><span class="line">+----+----------+</span><br><span class="line">| id | name     |</span><br><span class="line">+----+----------+</span><br><span class="line">|  1 | congcong |</span><br><span class="line">|  2 | huihui   |</span><br><span class="line">|  3 | grace    |</span><br><span class="line">| 21 | zhongguo |</span><br><span class="line">| 22 | hangzhou |</span><br><span class="line">| 23 | taiwan   |</span><br><span class="line">+----+----------+</span><br><span class="line"> </span><br><span class="line">在mysql-master主数据库和mysql-slave1、mysql-slave2从数据上查看</span><br><span class="line">[root@mysql-master ~]<span class="comment"># mysql -p123456</span></span><br><span class="line">.........</span><br><span class="line">mysql&gt; select * from kevin.haha;</span><br><span class="line">+----+----------+</span><br><span class="line">| id | name     |</span><br><span class="line">+----+----------+</span><br><span class="line">|  1 | congcong |</span><br><span class="line">|  2 | huihui   |</span><br><span class="line">|  3 | grace    |</span><br><span class="line">| 21 | zhongguo |</span><br><span class="line">| 22 | hangzhou |</span><br><span class="line">| 23 | taiwan   |</span><br><span class="line">+----+----------+</span><br><span class="line">6 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"> </span><br><span class="line">发现在客户端通过proxysql插件更新的数据，已经写到mysql-master主数据库上，并同步到mysql-slave1和mysql-slave2两个从数据库上了！</span><br><span class="line"> </span><br><span class="line">最后在proxysql管理端查看读写分离</span><br><span class="line">[root@mysql-proxy ~]<span class="comment"># mysql -uadmin -padmin -h127.0.0.1 -P6032           </span></span><br><span class="line">............</span><br><span class="line">............</span><br><span class="line">MySQL [(none)]&gt; select hostgroup,username,digest_text,count_star from stats_mysql_query_digest;</span><br><span class="line">+-----------+----------+------------------------------------------------+------------+</span><br><span class="line">| hostgroup | username | digest_text                                    | count_star |</span><br><span class="line">+-----------+----------+------------------------------------------------+------------+</span><br><span class="line">| 10        | root     | insert into kevin.haha values(?,?),(?,?),(?,?) | 1          |</span><br><span class="line">| 10        | root     | delete from kevin.haha <span class="built_in">where</span> id &gt; ?            | 1          |</span><br><span class="line">| 10        | root     | update kevin.haha <span class="built_in">set</span> name=? <span class="built_in">where</span> id=?        | 1          |</span><br><span class="line">| 20        | root     | select * from kevin.haha                       | 2          |</span><br><span class="line">| 10        | root     | select @@version_comment <span class="built_in">limit</span> ?               | 5          |</span><br><span class="line">+-----------+----------+------------------------------------------------+------------+</span><br><span class="line">5 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.001 sec)</span><br><span class="line"> </span><br><span class="line">从上述结果就可以看出proxysql实现的读写分离配置是成功的，读请求是转发到group20的读组内，写请求转发到group10的写组内!!</span><br></pre></td></tr></table></figure><h4 id="负载均衡测试-加权轮询"><a href="#负载均衡测试-加权轮询" class="headerlink" title="负载均衡测试  (加权轮询)"></a><strong>负载均衡测试 (加权轮询)</strong></h4><p>如上已经配置好一主(mysql-master，在hostgroup10写组内)、两从(mysql-slave1和mysql-slave2，在hostgroup20读组内) ，并且已经在”mysql_query_rules”表中配置了路由规则，即写操作转发到hostgroup10组，读操作转发到hostgroup20组.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line">MySQL [(none)]&gt; select * from mysql_query_rules;           </span><br><span class="line">+---------+--------+----------+------------+--------+-------------+------------+------------+--------+----------------------+---------------+----------------------+--------------+---------+-----------------+-----------------------+-----------+-----------+---------+---------+-------+-------------------+----------------+------------------+-----------+--------+-------------+-----------+-----+-------+---------+</span><br><span class="line">| rule_id | active | username | schemaname | flagIN | client_addr | proxy_addr | proxy_port | digest | match_digest         | match_pattern | negate_match_pattern | re_modifiers | flagOUT | replace_pattern | destination_hostgroup | cache_ttl | reconnect | timeout | retries | delay | next_query_flagIN | mirror_flagOUT | mirror_hostgroup | error_msg | OK_msg | sticky_conn | multiplex | <span class="built_in">log</span> | apply | comment |</span><br><span class="line">+---------+--------+----------+------------+--------+-------------+------------+------------+--------+----------------------+---------------+----------------------+--------------+---------+-----------------+-----------------------+-----------+-----------+---------+---------+-------+-------------------+----------------+------------------+-----------+--------+-------------+-----------+-----+-------+---------+</span><br><span class="line">| 1       | 1      | NULL     | NULL       | 0      | NULL        | NULL       | NULL       | NULL   | ^SELECT.*FOR UPDATE$ | NULL          | 0                    | CASELESS     | NULL    | NULL            | 10                    | NULL      | NULL      | NULL    | NULL    | NULL  | NULL              | NULL           | NULL             | NULL      | NULL   | NULL        | NULL      | NULL | 1     | NULL    |</span><br><span class="line">| 2       | 1      | NULL     | NULL       | 0      | NULL        | NULL       | NULL       | NULL   | ^SELECT              | NULL          | 0                    | CASELESS     | NULL    | NULL            | 20                    | NULL      | NULL      | NULL    | NULL    | NULL  | NULL              | NULL           | NULL             | NULL      | NULL   | NULL        | NULL      | NULL | 1     | NULL    |</span><br><span class="line">+---------+--------+----------+------------+--------+-------------+------------+------------+--------+----------------------+---------------+----------------------+--------------+---------+-----------------+-----------------------+-----------+-----------+---------+---------+-------+-------------------+----------------+------------------+-----------+--------+-------------+-----------+-----+-------+---------+</span><br><span class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.000 sec)</span><br><span class="line">  </span><br><span class="line">由于hostgroup10写组内只要一个节点(mysql-master节点)，hostgroup20读组内有两个节点(mysql-slave1、mysql-slave2)</span><br><span class="line">所以这里只能测试读节点的负载均衡</span><br><span class="line">  </span><br><span class="line">[root@mysql-proxy ~]<span class="comment"># mysql -uroot -ppasswd -P6033 -h127.0.0.1 -e "select @@hostname"</span></span><br><span class="line">+--------------+</span><br><span class="line">| @@hostname   |</span><br><span class="line">+--------------+</span><br><span class="line">| mysql-slave1 |</span><br><span class="line">+--------------+</span><br><span class="line">[root@mysql-proxy ~]<span class="comment"># mysql -uroot -ppasswd -P6033 -h127.0.0.1 -e "select @@hostname"</span></span><br><span class="line">+--------------+</span><br><span class="line">| @@hostname   |</span><br><span class="line">+--------------+</span><br><span class="line">| mysql-slave1 |</span><br><span class="line">+--------------+</span><br><span class="line">[root@mysql-proxy ~]<span class="comment"># mysql -uroot -ppasswd -P6033 -h127.0.0.1 -e "select @@hostname"</span></span><br><span class="line">+--------------+</span><br><span class="line">| @@hostname   |</span><br><span class="line">+--------------+</span><br><span class="line">| mysql-slave1 |</span><br><span class="line">+--------------+</span><br><span class="line">[root@mysql-proxy ~]<span class="comment"># mysql -uroot -ppasswd -P6033 -h127.0.0.1 -e "select @@hostname"</span></span><br><span class="line">+--------------+</span><br><span class="line">| @@hostname   |</span><br><span class="line">+--------------+</span><br><span class="line">| mysql-slave2 |</span><br><span class="line">+--------------+</span><br><span class="line">[root@mysql-proxy ~]<span class="comment"># mysql -uroot -ppasswd -P6033 -h127.0.0.1 -e "select @@hostname"</span></span><br><span class="line">+--------------+</span><br><span class="line">| @@hostname   |</span><br><span class="line">+--------------+</span><br><span class="line">| mysql-slave2 |</span><br><span class="line">+--------------+</span><br><span class="line">[root@mysql-proxy ~]<span class="comment"># mysql -uroot -ppasswd -P6033 -h127.0.0.1 -e "select @@hostname"</span></span><br><span class="line">+--------------+</span><br><span class="line">| @@hostname   |</span><br><span class="line">+--------------+</span><br><span class="line">| mysql-slave2 |</span><br><span class="line">+--------------+</span><br><span class="line">  </span><br><span class="line">再实验下mysql -e跟多条语句，看看如何</span><br><span class="line">[root@mysql-proxy ~]<span class="comment"># mysql -uroot -ppasswd -P6033 -h127.0.0.1 -e "select @@hostname;select @@hostname;select @@hostname"</span></span><br><span class="line">+--------------+</span><br><span class="line">| @@hostname   |</span><br><span class="line">+--------------+</span><br><span class="line">| mysql-slave1 |</span><br><span class="line">+--------------+</span><br><span class="line">+--------------+</span><br><span class="line">| @@hostname   |</span><br><span class="line">+--------------+</span><br><span class="line">| mysql-slave1 |</span><br><span class="line">+--------------+</span><br><span class="line">+--------------+</span><br><span class="line">| @@hostname   |</span><br><span class="line">+--------------+</span><br><span class="line">| mysql-slave1 |</span><br><span class="line">+--------------+</span><br><span class="line">[root@mysql-proxy ~]<span class="comment"># mysql -uroot -ppasswd -P6033 -h127.0.0.1 -e "select @@hostname;select @@hostname;select @@hostname"</span></span><br><span class="line">+--------------+</span><br><span class="line">| @@hostname   |</span><br><span class="line">+--------------+</span><br><span class="line">| mysql-slave2 |</span><br><span class="line">+--------------+</span><br><span class="line">+--------------+</span><br><span class="line">| @@hostname   |</span><br><span class="line">+--------------+</span><br><span class="line">| mysql-slave2 |</span><br><span class="line">+--------------+</span><br><span class="line">+--------------+</span><br><span class="line">| @@hostname   |</span><br><span class="line">+--------------+</span><br><span class="line">| mysql-slave2 |</span><br><span class="line">+--------------+</span><br><span class="line">[root@mysql-proxy ~]<span class="comment"># mysql -uroot -ppasswd -P6033 -h127.0.0.1 -e "select @@hostname;select @@hostname;select @@hostname"</span></span><br><span class="line">+--------------+</span><br><span class="line">| @@hostname   |</span><br><span class="line">+--------------+</span><br><span class="line">| mysql-slave1 |</span><br><span class="line">+--------------+</span><br><span class="line">+--------------+</span><br><span class="line">| @@hostname   |</span><br><span class="line">+--------------+</span><br><span class="line">| mysql-slave1 |</span><br><span class="line">+--------------+</span><br><span class="line">+--------------+</span><br><span class="line">| @@hostname   |</span><br><span class="line">+--------------+</span><br><span class="line">| mysql-slave1 |</span><br><span class="line">+--------------+</span><br><span class="line">[root@mysql-proxy ~]<span class="comment"># mysql -uroot -ppasswd -P6033 -h127.0.0.1 -e "select @@hostname;select @@hostname;select @@hostname"</span></span><br><span class="line">+--------------+</span><br><span class="line">| @@hostname   |</span><br><span class="line">+--------------+</span><br><span class="line">| mysql-slave1 |</span><br><span class="line">+--------------+</span><br><span class="line">+--------------+</span><br><span class="line">| @@hostname   |</span><br><span class="line">+--------------+</span><br><span class="line">| mysql-slave1 |</span><br><span class="line">+--------------+</span><br><span class="line">+--------------+</span><br><span class="line">| @@hostname   |</span><br><span class="line">+--------------+</span><br><span class="line">| mysql-slave1 |</span><br><span class="line">+--------------+</span><br><span class="line">[root@mysql-proxy ~]<span class="comment"># mysql -uroot -ppasswd -P6033 -h127.0.0.1 -e "select @@hostname;select @@hostname;select @@hostname"</span></span><br><span class="line">+--------------+</span><br><span class="line">| @@hostname   |</span><br><span class="line">+--------------+</span><br><span class="line">| mysql-slave2 |</span><br><span class="line">+--------------+</span><br><span class="line">+--------------+</span><br><span class="line">| @@hostname   |</span><br><span class="line">+--------------+</span><br><span class="line">| mysql-slave2 |</span><br><span class="line">+--------------+</span><br><span class="line">+--------------+</span><br><span class="line">| @@hostname   |</span><br><span class="line">+--------------+</span><br><span class="line">| mysql-slave2 |</span><br><span class="line">+--------------+</span><br><span class="line">  </span><br><span class="line">由以上结果可能会猜想并可印证：</span><br><span class="line">在一个client的一个链接周期内，所有query路由到同一台后端!</span><br><span class="line">即在同一个client的链接周期内，query路由不会转发到同组内的不同后端节点机上，只能转发到同一台后端节点机上!</span><br><span class="line">  </span><br><span class="line">但是这只是个假象!!!   是因为正好用到了select @ 语句。</span><br><span class="line">如官网所介绍:  sends a query that implicitly disables multiplexing. For example, <span class="keyword">if</span> you run “SELECT @a” , ProxySQL will <span class="built_in">disable</span></span><br><span class="line">multiplexing <span class="keyword">for</span> that client and will always use the same backend connection</span><br><span class="line">  </span><br><span class="line">最后可以知道: proxysql的负载方式目前仅为加权轮询一种（经验证所确认），并无其他机制!</span><br><span class="line"> </span><br><span class="line">===============================================================================</span><br><span class="line">可以编写一个负载均衡的shell测试脚本:</span><br><span class="line">[root@mysql-proxy ~]<span class="comment"># which mysql</span></span><br><span class="line">/usr/bin/mysql</span><br><span class="line">[root@mysql-proxy ~]<span class="comment"># vim /opt/test_proxysql_lb.sh</span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"> </span><br><span class="line">i=0</span><br><span class="line"><span class="keyword">while</span>((<span class="variable">$i</span>&lt;200))</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">        /usr/bin/mysql -uroot -ppasswd -P6033 -h127.0.0.1 -e <span class="string">"select @@hostname;"</span> &gt;&gt; /tmp/test_proxy_sql_lb.txt</span><br><span class="line">        <span class="built_in">let</span> <span class="string">"i++"</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"<span class="variable">$i</span>"</span></span><br><span class="line">        sleep 0.1</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"> </span><br><span class="line">执行测试脚本:</span><br><span class="line">[root@mysql-proxy ~]<span class="comment"># sh -x /opt/test_proxysql_lb.sh &gt; /dev/null 2&gt;&amp;1</span></span><br><span class="line"> </span><br><span class="line">执行后检查结果</span><br><span class="line">[root@mysql-proxy ~]<span class="comment"># grep "mysql-slave1" /tmp/test_proxy_sql_lb.txt|wc -l</span></span><br><span class="line">86</span><br><span class="line">[root@mysql-proxy ~]<span class="comment"># grep "mysql-slave2" /tmp/test_proxy_sql_lb.txt|wc -l</span></span><br><span class="line">114</span><br><span class="line"> </span><br><span class="line">以上查询结果符合预期</span><br></pre></td></tr></table></figure><h4 id="开启ProxySQL的Web统计功能"><a href="#开启ProxySQL的Web统计功能" class="headerlink" title="开启ProxySQL的Web统计功能"></a><strong>开启ProxySQL的Web统计功能</strong></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">首先打开web功能</span><br><span class="line">[root@mysql-proxy ~]<span class="comment">#  mysql -uadmin -padmin -h127.0.0.1 -P6032 </span></span><br><span class="line">............</span><br><span class="line">............</span><br><span class="line">MySQL [(none)]&gt; update global_variables <span class="built_in">set</span> variable_value=<span class="string">'true'</span> <span class="built_in">where</span> variable_name=<span class="string">'admin-web_enabled'</span>;</span><br><span class="line">Query OK, 1 row affected (0.001 sec)</span><br><span class="line"> </span><br><span class="line">MySQL [(none)]&gt; LOAD ADMIN VARIABLES TO RUNTIME;</span><br><span class="line">Query OK, 0 rows affected (0.001 sec)</span><br><span class="line"> </span><br><span class="line">MySQL [(none)]&gt; SAVE ADMIN VARIABLES TO DISK;</span><br><span class="line">Query OK, 31 rows affected (0.070 sec)</span><br><span class="line"> </span><br><span class="line">然后查看端口和登录web界面的用户名和密码，用户名和密码与<span class="built_in">stat</span>账户一致：</span><br><span class="line">MySQL [(none)]&gt; select * from global_variables <span class="built_in">where</span> variable_name LIKE <span class="string">'admin-web%'</span> or variable_name LIKE <span class="string">'admin-stats%'</span>;</span><br><span class="line">+-----------------------------------+----------------+</span><br><span class="line">| variable_name                     | variable_value |</span><br><span class="line">+-----------------------------------+----------------+</span><br><span class="line">| admin-stats_credentials           | stats:stats    |                <span class="comment">#账户密码</span></span><br><span class="line">| admin-stats_mysql_connections     | 60             |</span><br><span class="line">| admin-stats_mysql_connection_pool | 60             |</span><br><span class="line">| admin-stats_mysql_query_cache     | 60             |</span><br><span class="line">| admin-stats_system_cpu            | 60             |</span><br><span class="line">| admin-stats_system_memory         | 60             |</span><br><span class="line">| admin-web_enabled                 | <span class="literal">true</span>           |</span><br><span class="line">| admin-web_port                    | 6080           |                     <span class="comment">#端口</span></span><br><span class="line">+-----------------------------------+----------------+</span><br><span class="line">8 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.003 sec)</span><br></pre></td></tr></table></figure><p>查看web端口是否正常打开</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@mysql-proxy ~]<span class="comment"># lsof -i:6080</span></span><br><span class="line">COMMAND    PID USER   FD   TYPE   DEVICE SIZE/OFF NODE NAME</span><br><span class="line">proxysql 22324 root   27u  IPv4 23010645      0t0  TCP *:6080 (LISTEN)</span><br></pre></td></tr></table></figure><p>访问<a href="http://172.16.60.214:6080并使用stats:stats登录即可查看一些统计信息。" rel="noopener external nofollow noreferrer" target="_blank">http://172.16.60.214:6080并使用stats:stats登录即可查看一些统计信息。</a></p><p><img src="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@master/articles/8307f670/2.png" alt></p><h4 id="scheduler打印proxysql状态到日志"><a href="#scheduler打印proxysql状态到日志" class="headerlink" title="scheduler打印proxysql状态到日志"></a><strong>scheduler打印proxysql状态到日志</strong></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@mysql-proxy ~]<span class="comment"># mkdir -p /opt/proxysql/log</span></span><br><span class="line">[root@mysql-proxy ~]<span class="comment"># vim /opt/proxysql/log/status.sh</span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">DATE=`date <span class="string">"+%Y-%m-%d %H:%M:%S"</span>`</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"&#123;\"dateTime\":\"<span class="variable">$DATE</span>\",\"status\":\"running\"&#125;"</span> &gt;&gt; /opt/proxysql/<span class="built_in">log</span>/status_log</span><br><span class="line"> </span><br><span class="line">[root@mysql-proxy ~]<span class="comment"># chmod 777 /opt/proxysql/log/status.sh</span></span><br><span class="line"> </span><br><span class="line">然后在proxysql插入一条scheduler (定义每分钟打印一次，即60000毫秒)</span><br><span class="line">[root@mysql-proxy ~]<span class="comment"># mysql -uadmin -padmin -h127.0.0.1 -P6032</span></span><br><span class="line">............</span><br><span class="line">............</span><br><span class="line">MySQL [(none)]&gt; insert into scheduler(active,interval_ms,filename) values (1,60000,<span class="string">'/opt/proxysql/log/status.sh'</span>);</span><br><span class="line">Query OK, 1 row affected (0.000 sec)</span><br><span class="line"> </span><br><span class="line">MySQL [(none)]&gt; LOAD SCHEDULER TO RUNTIME;</span><br><span class="line">Query OK, 0 rows affected (0.001 sec)</span><br><span class="line"> </span><br><span class="line">MySQL [(none)]&gt; SAVE SCHEDULER TO DISK;</span><br><span class="line">Query OK, 0 rows affected (0.105 sec)</span><br><span class="line"> </span><br><span class="line">然后查看日志就可以看到proxysql 的运行结果了：</span><br><span class="line">[root@mysql-proxy ~]<span class="comment"># tail -f /opt/proxysql/log/status_log</span></span><br><span class="line">&#123;<span class="string">"dateTime"</span>:<span class="string">"2019-02-19 14:24:03"</span>,<span class="string">"status"</span>:<span class="string">"running"</span>&#125;</span><br><span class="line">&#123;<span class="string">"dateTime"</span>:<span class="string">"2019-02-19 14:25:03"</span>,<span class="string">"status"</span>:<span class="string">"running"</span>&#125;</span><br><span class="line">&#123;<span class="string">"dateTime"</span>:<span class="string">"2019-02-19 14:26:03"</span>,<span class="string">"status"</span>:<span class="string">"running"</span>&#125;</span><br><span class="line">&#123;<span class="string">"dateTime"</span>:<span class="string">"2019-02-19 14:27:03"</span>,<span class="string">"status"</span>:<span class="string">"running"</span>&#125;</span><br></pre></td></tr></table></figure></div><script src="https://my.openwrite.cn/js/readmore.js" type="text/javascript"></script><script>var isMobile=navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i);if(!isMobile){var btw=new BTWPlugin;btw.init({id:"vip-container",blogId:"19128-1606361858239-837",name:"运维随笔",qrcode:"https://wandouduoduo.github.io/about/index/gongzhonghao.jpg",keyword:"yunwei"})}</script></div><div><div><div style="text-align:center;color:#ccc;font-size:14px">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div></div></div><div><div class="my_post_copyright"><script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script><script src="https://cdn.bootcss.com/jquery/2.0.0/jquery.min.js"></script><script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script><p><span>本文标题:</span><a href="/articles/8307f670.html">生产mysql数据库集群优化<二>--proxysql安装及优化</二></a></p><p><span>文章作者:</span><a href="/" title="访问 豌豆多多 的个人博客">豌豆多多</a></p><p><span>发布时间:</span>2021年06月23日 - 14:06</p><p><span>最后更新:</span>2021年06月23日 - 14:06</p><p><span>原始链接:</span><a href="/articles/8307f670.html" title="生产mysql数据库集群优化<二>--proxysql安装及优化">https://wandouduoduo.github.io/articles/8307f670.html</a><span class="copy-path" title="点击复制文章链接"><i class="fa fa-clipboard" data-clipboard-text="https://wandouduoduo.github.io/articles/8307f670.html" aria-label="复制成功！"></i></span></p><p><span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license external nofollow noreferrer" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">署名-非商业性使用-禁止演绎 4.0 国际</a> 转载请保留原文链接及作者。</p></div><script>var clipboard=new Clipboard(".fa-clipboard");$(".fa-clipboard").click(function(){clipboard.on("success",function(){swal({title:"",text:"复制成功",icon:"success",showConfirmButton:!0})})})</script></div><div><div style="padding:10px 0;margin:20px auto;width:90%;text-align:center"><div>原创技术分享，您的支持将鼓励我继续创作</div> <button id="rewardButton" disable="enable" onclick='var qr=document.getElementById("QR");"none"===qr.style.display?qr.style.display="block":qr.style.display="none"'> <span>打赏</span></button><div id="QR" style="display:none"><div id="wechat" style="display:inline-block"> <img id="wechat_qr" src="//cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io/images/wechatpay.png" alt="豌豆多多 微信支付"><p>微信支付</p></div><div id="alipay" style="display:inline-block"> <img id="alipay_qr" src="//cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io/images/alipay.jpg" alt="豌豆多多 支付宝"><p>支付宝</p></div></div></div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/Mysql/" rel="tag"><i class="fa fa-tag"></i> Mysql</a></div><div class="post-widgets"><div class="social_share"><div><div class="bdsharebuttonbox"><a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a><a href="#" class="bds_douban" data-cmd="douban" title="分享到豆瓣网"></a><a href="#" class="bds_sqq" data-cmd="sqq" title="分享到QQ好友"></a><a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a><a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a><a href="#" class="bds_tieba" data-cmd="tieba" title="分享到百度贴吧"></a><a href="#" class="bds_twi" data-cmd="twi" title="分享到Twitter"></a><a href="#" class="bds_fbook" data-cmd="fbook" title="分享到Facebook"></a><a href="#" class="bds_more" data-cmd="more"></a><a class="bds_count" data-cmd="count"></a></div><script>window._bd_share_config={common:{bdText:"",bdMini:"2",bdMiniList:!1,bdPic:""},share:{bdSize:"16",bdStyle:"0"},image:{viewList:["tsina","douban","sqq","qzone","weixin","twi","fbook"],viewText:"分享到：",viewSize:"16"}}</script><script>with(document)(getElementsByTagName("head")[0]||body).appendChild(createElement("script")).src="/static/api/js/share.js?cdnversion="+~(-new Date/36e5)</script></div></div></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/articles/2f5e57e1.html" rel="next" title="生产mysql数据库集群优化<一>--选型proxysql"><i class="fa fa-chevron-left"></i> 生产mysql数据库集群优化<一>--选型proxysql</一></a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"></div></div></footer></div></article></div></div><div class="comments" id="gitalk-container"></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap"> 文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap"> 站点概览</li></ul><div class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" src="/images/yunwei.png" alt="豌豆多多"><p class="site-author-name" itemprop="name">豌豆多多</p><p class="site-description motion-element" itemprop="description">资深运维架构师豌豆多多的呕心笔记</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">206</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/index.html"><span class="site-state-item-count">44</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/index.html"><span class="site-state-item-count">65</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/wandouduoduo" title="GitHub &rarr; https://github.com/wandouduoduo" rel="noopener external nofollow noreferrer" target="_blank"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:wandouduoduo@163.com" title="E-Mail &rarr; mailto:wandouduoduo@163.com" rel="noopener external nofollow noreferrer" target="_blank"><i class="fa fa-fw fa-envelope"></i> E-Mail</a></span><span class="links-of-author-item"><a href="https://gitee.com/wandouduoduo" title="Gitee &rarr; https://gitee.com/wandouduoduo" rel="noopener external nofollow noreferrer" target="_blank"><i class="fa fa-fw fa-heartbeat"></i> Gitee</a></span><span class="links-of-author-item"><a href="https://weibo.com/u/1989032071/home?topnav=1&wvr=6" title="微博 &rarr; https://weibo.com/u/1989032071/home?topnav=1&wvr=6" rel="noopener external nofollow noreferrer" target="_blank"><i class="fa fa-fw fa-weibo"></i> 微博</a></span></div><div class="links-of-blogroll motion-element links-of-blogroll-inline"><div class="links-of-blogroll-title"><i class="fa fa-fw fa-link"></i> 友情链接</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"> <a href="https://www.runoob.com/" title="https://www.runoob.com/" rel="noopener external nofollow noreferrer" target="_blank">菜鸟教程</a></li><li class="links-of-blogroll-item"> <a href="https://code.ziqiangxuetang.com/" title="https://code.ziqiangxuetang.com/" rel="noopener external nofollow noreferrer" target="_blank">自强学堂</a></li><li class="links-of-blogroll-item"> <a href="http://www.ttlsa.com/" title="http://www.ttlsa.com/" rel="noopener external nofollow noreferrer" target="_blank">运维生存时间</a></li><li class="links-of-blogroll-item"> <a href="http://www.zsythink.net/" title="http://www.zsythink.net/" rel="noopener external nofollow noreferrer" target="_blank">朱双印博客</a></li><li class="links-of-blogroll-item"> <a href="https://me.jinchuang.org/" title="https://me.jinchuang.org/" rel="noopener external nofollow noreferrer" target="_blank">靳闯博客</a></li><li class="links-of-blogroll-item"> <a href="http://bingdang.github.io/" title="http://bingdang.github.io/" rel="noopener external nofollow noreferrer" target="_blank">运维饼铛</a></li></ul></div></div></div><div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#ProxySQL-安装-两种方式"><span class="nav-number">1.</span> <span class="nav-text">ProxySQL 安装 (两种方式)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ProxySQL配置"><span class="nav-number">2.</span> <span class="nav-text">ProxySQL配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ProxySQL配置后端DB-server"><span class="nav-number">3.</span> <span class="nav-text">ProxySQL配置后端DB server</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#实战功能验证"><span class="nav-number">4.</span> <span class="nav-text">实战功能验证</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#实验环境"><span class="nav-number">4.1.</span> <span class="nav-text">实验环境</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装Mysql-5-7-在三个mysql节点上安装"><span class="nav-number">4.2.</span> <span class="nav-text">安装Mysql 5.7 (在三个mysql节点上安装)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置Mysql基于GTID的主从同步"><span class="nav-number">4.3.</span> <span class="nav-text">*配置Mysql基于GTID的主从同步 *</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装配置ProxySQL"><span class="nav-number">4.4.</span> <span class="nav-text">安装配置ProxySQL</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ProxySQL实现读写分离"><span class="nav-number">4.4.1.</span> <span class="nav-text">ProxySQL实现读写分离</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#负载均衡测试-加权轮询"><span class="nav-number">4.4.2.</span> <span class="nav-text">负载均衡测试 (加权轮询)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#开启ProxySQL的Web统计功能"><span class="nav-number">4.4.3.</span> <span class="nav-text">开启ProxySQL的Web统计功能</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#scheduler打印proxysql状态到日志"><span class="nav-number">4.4.4.</span> <span class="nav-text">scheduler打印proxysql状态到日志</span></a></li></ol></li></ol></li></ol></div></div></div><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span id="scrollpercent"><span>0</span>%</span></div><script type="text/javascript" charset="utf-8" src="/js/tagcloud.js"></script><script type="text/javascript" charset="utf-8" src="/js/tagcanvas.js"></script><div class="widget-wrap"><div id="myCanvasContainer" class="widget tagcloud"><canvas width="250" height="250" id="resCanvas" style=""><ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Ai/">Ai</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Ansible/">Ansible</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Aplayer/">Aplayer</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Apollo/">Apollo</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cat/">Cat</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Centos/">Centos</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cloud/">Cloud</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cmdb/">Cmdb</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Confd/">Confd</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Confluence/">Confluence</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Dns/">Dns</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/">Docker</a><span class="tag-list-count">18</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Elk/">Elk</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Experiences/">Experiences</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Flask/">Flask</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Git/">Git</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GlusterFS/">GlusterFS</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Go/">Go</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Haproxy/">Haproxy</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hexo/">Hexo</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Http/">Http</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Iptables/">Iptables</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/">Java</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Jenkins/">Jenkins</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Jumperserver/">Jumperserver</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/K8s/">K8s</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kafka/">Kafka</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kali/">Kali</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Keepalived/">Keepalived</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a><span class="tag-list-count">22</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Lvs/">Lvs</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mail/">Mail</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mesos/">Mesos</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MongoDB/">MongoDB</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mysql/">Mysql</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Network/">Network</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nexus/">Nexus</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nginx/">Nginx</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Open-falcon/">Open-falcon</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Openldap/">Openldap</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Opensips/">Opensips</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Openssl/">Openssl</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Openvpn/">Openvpn</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PostgreSQL/">PostgreSQL</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Prometheus/">Prometheus</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python/">Python</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis/">Redis</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redmine/">Redmine</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RocketChat/">RocketChat</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Samba/">Samba</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Saturn/">Saturn</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Selenium/">Selenium</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Sentry/">Sentry</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Shell/">Shell</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Sql/">Sql</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Stackstorm/">Stackstorm</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Supervisor/">Supervisor</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Tomcat/">Tomcat</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Uwsgi/">Uwsgi</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Web/">Web</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Wiki/">Wiki</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Windows/">Windows</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Xxl-job/">Xxl-job</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Zabbix/">Zabbix</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Zookeeper/">Zookeeper</a><span class="tag-list-count">1</span></li></ul></canvas></div></div></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; 2020 – <span itemprop="copyrightYear">2021</span><span class="with-love" id="animate"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">豌豆多多</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-area-chart"></i></span> <span class="post-meta-item-text">站点总字数：</span> <span title="站点总字数">459k</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span class="post-meta-item-text">站点阅读时长 &asymp;</span> <span title="站点阅读时长">6:57</span></div><div class="theme-info"><div class="powered-by"></div> <span class="post-count">博客全站共475.4k字</span></div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script> <span class="post-meta-item-icon"><i class="fa fa-user">访问人数:</i></span><span class="site-uv" title="总访客量"><span class="busuanzi-value" id="busuanzi_value_site_uv"></span></span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-eye">总阅读量:</i></span><span class="site-pv" title="总访问量"><span class="busuanzi-value" id="busuanzi_value_site_pv"></span></span></div></div></footer></div><script>"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script color="255,255,255" opacity="1" zindex="-1" count="150" src="//cdn.jsdelivr.net/gh/theme-next/theme-next-canvas-nest@1/canvas-nest.min.js"></script><script src="//cdn.jsdelivr.net/npm/jquery@2/dist/jquery.min.js"></script><script src="//cdn.jsdelivr.net/npm/velocity-animate@1/velocity.min.js"></script><script src="//cdn.jsdelivr.net/npm/velocity-animate@1/velocity.ui.min.js"></script><script src="/js/src/utils.js?v=6.7.0"></script><script src="/js/src/motion.js?v=6.7.0"></script><script src="/js/src/affix.js?v=6.7.0"></script><script src="/js/src/schemes/pisces.js?v=6.7.0"></script><script src="/js/src/scrollspy.js?v=6.7.0"></script><script src="/js/src/post-details.js?v=6.7.0"></script><script src="/js/src/bootstrap.js?v=6.7.0"></script><script src="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"><script src="//cdn.jsdelivr.net/npm/js-md5@0.7.3/src/md5.min.js"></script><script>var gitalk=new Gitalk({clientID:"ad83725549e82facce82",clientSecret:"b67c2056b52d0447f1d78f413f268a5b853e8a6e",repo:"wandouduoduo.github.io",owner:"wandouduoduo",admin:["wandouduoduo"],id:md5(location.pathname),distractionFreeMode:"true"});gitalk.render("gitalk-container")</script><script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><style>.copy-btn{display:inline-block;padding:6px 12px;font-size:13px;font-weight:700;line-height:20px;color:#333;white-space:nowrap;vertical-align:middle;cursor:pointer;background-color:#eee;background-image:linear-gradient(#fcfcfc,#eee);border:1px solid #d5d5d5;border-radius:3px;user-select:none;outline:0}.highlight-wrap .copy-btn{transition:opacity .3s ease-in-out;opacity:0;padding:2px 6px;position:absolute;right:4px;top:8px}.highlight-wrap .copy-btn:focus,.highlight-wrap:hover .copy-btn{opacity:1}.highlight-wrap{position:relative}</style><script>$(".highlight").each(function(e,t){var n=$("<div>").addClass("highlight-wrap");$(t).after(n),n.append($("<button>").addClass("copy-btn").append("复制").on("click",function(e){var t=$(this).parent().find(".code").find(".line").map(function(e,t){return $(t).text()}).toArray().join("\n"),n=document.createElement("textarea"),o=document.createRange(),a=window.getSelection(),i=window.pageYOffset||document.documentElement.scrollTop;n.style.top=i+"px",n.style.position="absolute",n.style.opacity="0",n.value=t,n.textContent=t,n.contentEditable=!0,n.readOnly=!1,document.body.appendChild(n),o.selectNode(n),a.removeAllRanges(),a.addRange(o),n.setSelectionRange(0,t.length),document.execCommand("copy")?$(this).text("复制成功"):$(this).text("复制失败"),n.blur(),$(this).blur()})).on("mouseleave",function(e){var t=$(this).find(".copy-btn");setTimeout(function(){t.text("复制")},300)}).append(t)})</script><style>#selectionCopyright{position:absolute;display:none;background:rgba(244,67,54,.7);color:#fff;border-radius:6px;box-shadow:none;border:none;font-size:14px}#selectionCopyright a{color:#fff;border-color:#fff}#selectionCopyright::before{content:"";width:0;height:0;border-style:solid;border-width:6px 8px 6px 0;border-color:transparent rgba(244,67,54,.7) transparent transparent;position:absolute;left:-8px;top:50%;transform:translateY(-50%)}</style> <button id="selectionCopyright" disabled="disabled">本文发表于[<a href="http://wandouduoduo.github.io/">豌豆多多</a>]分享请注明来源！</button><script>function selectText(){return document.selection?document.selection.createRange().text:window.getSelection().toString()}var content=document.getElementById("content"),scTip=document.getElementById("selectionCopyright");content.onmouseup=function(e){var t=(e=e||window.event).clientX,n=e.clientY,c=Math.max(document.body.scrollLeft,document.documentElement.scrollLeft),o=Math.max(document.body.scrollTop,document.documentElement.scrollTop);0<selectText().length?setTimeout(function(){scTip.style.display="inline-block",scTip.style.left=t+c+15+"px",scTip.style.top=n+o-15+"px"},100):scTip.style.display="none"},content.onclick=function(e){(e=e||window.event).cancelBubble=!0},document.onclick=function(){scTip.style.display="none"}</script><canvas class="fireworks" style="position:fixed;left:0;top:0;z-index:1;pointer-events:none"></canvas><script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script><script type="text/javascript" src="/js/src/fireworks.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,debug:!1,model:{jsonPath:"https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@v1.0/live2dw/assets/shizuku.model.json"},display:{position:"right",width:150,height:300},mobile:{show:!0},log:!1})</script></body></html>