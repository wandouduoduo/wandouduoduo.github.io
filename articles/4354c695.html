<!DOCTYPE html><html class="theme-next gemini" lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><script src="/lib/pace/pace.min.js?v=1.0.2"></script><link rel="stylesheet" href="/lib/pace/pace-theme-flash.min.css?v=1.0.2"><meta name="google-site-verification" content="igfxU5A6c_28PmCJ5Zw1kMMKNCL3wvbBMwUqfOJ4kKg"><script data-ad-client="ca-pub-6677803223619857" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><meta name="baidu-site-verification" content="OcDLC8tSiQ"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2"><link rel="stylesheet" href="/css/main.css?v=6.7.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.7.0"><link rel="icon" type="image/png" sizes="32x32" href="/images/next-favicon-32.png?v=6.7.0"><link rel="icon" type="image/png" sizes="16x16" href="/images/next-favicon-16.png?v=6.7.0"><link rel="mask-icon" href="/images/logo.svg?v=6.7.0" color="#222"><script id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Gemini",version:"6.7.0",sidebar:{position:"left",display:"post",offset:12,b2t:!1,scrollpercent:!1,onmobile:!1},fancybox:!1,fastclick:!1,lazyload:!1,tabs:!0,motion:{enable:!1,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><meta name="description" content="官方介绍监控系统是整个运维环节，乃至整个产品生命周期中最重要的一环，事前及时预警发现故障，事后提供翔实的数据用于追查定位问题。监控系统作为一个成熟的运维产品，业界有很多开源的实现可供选择。当公司刚刚起步，业务规模较小，运维团队也刚刚建立的初期，选择一款开源的监控系统，是一个省时省力，效率最高的方案。之后，随着业务规模的持续快速增长，监控的对象也越来越多，越来越复杂，监控系统的使用对象也从最初少数的"><meta name="keywords" content="Open-falcon"><meta property="og:type" content="article"><meta property="og:title" content="分布式开源监控系统open-falcon安装使用笔记"><meta property="og:url" content="https://wandouduoduo.netlify.com/articles/4354c695.html"><meta property="og:site_name" content="豌豆多多"><meta property="og:description" content="官方介绍监控系统是整个运维环节，乃至整个产品生命周期中最重要的一环，事前及时预警发现故障，事后提供翔实的数据用于追查定位问题。监控系统作为一个成熟的运维产品，业界有很多开源的实现可供选择。当公司刚刚起步，业务规模较小，运维团队也刚刚建立的初期，选择一款开源的监控系统，是一个省时省力，效率最高的方案。之后，随着业务规模的持续快速增长，监控的对象也越来越多，越来越复杂，监控系统的使用对象也从最初少数的"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://wandouduoduo.netlify.com/articles/4354c695/1.png"><meta property="og:image" content="https://wandouduoduo.netlify.com/articles/4354c695/2.png"><meta property="og:image" content="https://wandouduoduo.netlify.com/articles/4354c695/3.jpg"><meta property="og:image" content="https://wandouduoduo.netlify.com/articles/4354c695/4.png"><meta property="og:image" content="https://wandouduoduo.netlify.com/articles/4354c695/5.png"><meta property="og:image" content="https://wandouduoduo.netlify.com/articles/4354c695/6.png"><meta property="og:image" content="https://wandouduoduo.netlify.com/articles/4354c695/7.png"><meta property="og:image" content="https://wandouduoduo.netlify.com/articles/4354c695/8.png"><meta property="og:updated_time" content="2019-11-01T02:49:00.484Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="分布式开源监控系统open-falcon安装使用笔记"><meta name="twitter:description" content="官方介绍监控系统是整个运维环节，乃至整个产品生命周期中最重要的一环，事前及时预警发现故障，事后提供翔实的数据用于追查定位问题。监控系统作为一个成熟的运维产品，业界有很多开源的实现可供选择。当公司刚刚起步，业务规模较小，运维团队也刚刚建立的初期，选择一款开源的监控系统，是一个省时省力，效率最高的方案。之后，随着业务规模的持续快速增长，监控的对象也越来越多，越来越复杂，监控系统的使用对象也从最初少数的"><meta name="twitter:image" content="https://wandouduoduo.netlify.com/articles/4354c695/1.png"><link rel="alternate" href="/atom.xml" title="豌豆多多" type="application/atom+xml"><link rel="canonical" href="https://wandouduoduo.netlify.com/articles/4354c695.html"><script id="page.configurations">CONFIG.page={sidebar:""}</script><title>分布式开源监控系统open-falcon安装使用笔记 | 豌豆多多</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-title,.use-motion .comments,.use-motion .menu-item,.use-motion .motion-element,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .logo,.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div> <a href="https://github.com/wandouduoduo" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewbox="0 0 250 250" style="fill:#fd6c6c;color:#fff;position:absolute;top:0;border:0;right:0" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"/></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">豌豆多多</span><span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">Senior O & M Architect</p></div><div class="site-nav-toggle"> <button aria-label="切换导航栏"><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>分类</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i></span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"> <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://wandouduoduo.netlify.com/articles/4354c695.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="WanDouDuoDuo"><meta itemprop="description" content="沪漂资深运维架构师的呕心笔记"><meta itemprop="image" content="/images/me.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="豌豆多多"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">分布式开源监控系统open-falcon安装使用笔记</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2019-05-29 18:22:45" itemprop="dateCreated datePublished" datetime="2019-05-29T18:22:45+08:00">2019-05-29</time> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i></span> <span class="post-meta-item-text">更新于</span> <time title="修改时间：2019-11-01 10:49:00" itemprop="dateModified" datetime="2019-11-01T10:49:00+08:00">2019-11-01</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/监控技术/" itemprop="url" rel="index"><span itemprop="name">监控技术</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/监控技术/Open-falcon/" itemprop="url" rel="index"><span itemprop="name">Open-falcon</span></a></span></span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-eye"></i> 阅读次数：<span class="busuanzi-value" id="busuanzi_value_page_pv"></span></span><div class="post-symbolscount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i></span> <span class="post-meta-item-text">本文字数：</span> <span title="本文字数">54k</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span title="阅读时长">49 分钟</span></div></div></header><div class="post-body" itemprop="articleBody"><h2 id="官方介绍"><a href="#官方介绍" class="headerlink" title="官方介绍"></a>官方介绍</h2><p>监控系统是整个运维环节，乃至整个产品生命周期中最重要的一环，事前及时预警发现故障，事后提供翔实的数据用于追查定位问题。监控系统作为一个成熟的运维产品，业界有很多开源的实现可供选择。当公司刚刚起步，业务规模较小，运维团队也刚刚建立的初期，选择一款开源的监控系统，是一个省时省力，效率最高的方案。之后，随着业务规模的持续快速增长，监控的对象也越来越多，越来越复杂，监控系统的使用对象也从最初少数的几个SRE，扩大为更多的DEVS，SRE。这时候，监控系统的容量和用户的“使用效率”成了最为突出的问题。</p><p>​ 监控系统业界有很多杰出的开源监控系统。我们在早期，一直在用zabbix，不过随着业务的快速发展，以及互联网公司特有的一些需求，现有的开源的监控系统在性能、扩展性、和用户的使用效率方面，已经无法支撑了。</p><p>​ 因此，我们在过去的一年里，从互联网公司的一些需求出发，从各位SRE、SA、DEVS的使用经验和反馈出发，结合业界的一些大的互联网公司做监控，用监控的一些思考出发，设计开发了小米的监控系统：Open-Falcon。</p><a id="more"></a><h2 id="特点："><a href="#特点：" class="headerlink" title="特点："></a>特点：</h2><ul><li><p><strong>数据采集免配置</strong>：agent自发现、支持Plugin、主动推送模式</p></li><li><p><strong>容量水平扩展</strong>：生产环境每秒50万次数据收集、告警、存储、绘图，可持续水平扩展。</p></li><li><p><strong>告警策略自发现</strong>：Web界面、支持策略模板、模板继承和覆盖、多种告警方式、支持回调动作。</p></li><li><p><strong>告警设置人性化</strong>：支持最大告警次数、告警级别设置、告警恢复通知、告警暂停、不同时段不同阈值、支持维护周期，支持告警合并。</p></li><li><p><strong>历史数据高效查询</strong>：秒级返回上百个指标一年的历史数据。</p></li><li><p><strong>Dashboard人性化</strong>：多维度的数据展示，用户自定义Dashboard等功能。</p></li><li><p><strong>架构设计高可用</strong>：整个系统无核心单点，易运维，易部署</p></li></ul><h2 id="架构图："><a href="#架构图：" class="headerlink" title="架构图："></a><strong>架构图：</strong></h2><p>官网架构图</p><p><img src="/articles/4354c695/1.png" alt></p><p>其中虚线所在的aggregator组件还在设计开发阶段。</p><p>网友画的</p><p><img src="/articles/4354c695/2.png" alt></p><h2 id="监控指标"><a href="#监控指标" class="headerlink" title="监控指标"></a>监控指标</h2><p>每台服务器，都有安装falcon-agent，falcon-agent是一个golang开发的daemon程序，用于自发现的采集单机的各种数据和指标，这些指标包括不限于以下几个方面，共计200多项指标。</p><ul><li>CPU相关</li><li>磁盘相关</li><li>IO</li><li>Load</li><li>内存相关</li><li>网络相关</li><li>端口存活、进程存活</li><li>ntp offset（插件）</li><li>某个进程资源消耗（插件）</li><li>netstat、ss 等相关统计项采集</li><li>机器内核配置参数</li></ul><p>只要安装了falcon-agent的机器，就会自动开始采集各项指标，主动上报，不需要用户在server做任何配置（这和zabbix有很大的不同），这样做的好处，就是用户维护方便，覆盖率高。当然这样做也会server端造成较大的压力，不过open-falcon的服务端组件单机性能足够高，同时都可以水平扩展，所以自动多采集足够多的数据，反而是一件好事情，对于SRE和DEV来讲，事后追查问题，不再是难题。</p><p>另外，falcon-agent提供了一个proxy-gateway，用户可以方便的通过http接口，push数据到本机的gateway，gateway会帮忙高效率的转发到server端。</p><p>falcon-agent，可以在我们的github上找到 : <a href="https://github.com/open-falcon/agent" target="_blank" rel="noopener">https://github.com/open-falcon/agent</a></p><h2 id="数据流程图："><a href="#数据流程图：" class="headerlink" title="数据流程图："></a><strong>数据流程图：</strong></h2><p><img src="/articles/4354c695/3.jpg" alt></p><h2 id="安装准备"><a href="#安装准备" class="headerlink" title="安装准备"></a>安装准备</h2><h3 id="系统环境：centos7-6"><a href="#系统环境：centos7-6" class="headerlink" title="系统环境：centos7.6"></a>系统环境：centos7.6</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#源更新</span><br><span class="line">yum -y update</span><br><span class="line">#安装常用系统工具</span><br><span class="line">yum -y install wget telnet git net-tools deltarpm epel-release</span><br><span class="line">#关闭防火墙</span><br><span class="line">sed -i &quot;s/SELINUX=enforcing/SELINUX=disabled/g&quot; /etc/selinux/config</span><br><span class="line">setenforce 0</span><br><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl disable firewalld</span><br></pre></td></tr></table></figure><h3 id="安装一些系统常用软件"><a href="#安装一些系统常用软件" class="headerlink" title="安装一些系统常用软件"></a>安装一些系统常用软件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install gcc gcc-c++ autoconf libjpeg libjpeg-devel libpng libpng-devel freetype freetype-devel libxml2 libxml2-devel zlib zlib-devel glibc glibc-devel glib2 glib2-devel bzip2 bzip2-devel zip unzip ncurses ncurses-devel curl curl-devel e2fsprogs e2fsprogs-devel krb5-devel libidn libidn-devel openssl openssh openssl-devel libxslt-devel libevent-devel ntp  libtool-ltdl bison libtool vim-enhanced python wget lsof iptraf strace lrzsz kernel-devel kernel-headers pam-devel Tcl/Tk  cmake  ncurses-devel bison setuptool popt-devel net-snmp screen perl-devel pcre-devel net-snmp screen tcpdump rsync sysstat man iptables sudo idconfig git system-config-network-tui bind-utils update arpscan tmux elinks numactl iftop  bwm-ng</span><br></pre></td></tr></table></figure><h3 id="安装pip"><a href="#安装pip" class="headerlink" title="安装pip"></a>安装pip</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">wget https://bootstrap.pypa.io/get-pip.py --no-check-certificate</span><br><span class="line"></span><br><span class="line">python get-pip.py</span><br><span class="line"></span><br><span class="line">#使用国内豆瓣源</span><br><span class="line"></span><br><span class="line">mkdir /root/.pip</span><br><span class="line"></span><br><span class="line">vi /root/.pip/pip.conf</span><br><span class="line"></span><br><span class="line">[global]</span><br><span class="line"></span><br><span class="line">index-url = [http://pypi.douban.com/simple](http://pypi.douban.com/simple)</span><br><span class="line">trusted-host = pypi.douban.com</span><br></pre></td></tr></table></figure><h3 id="安装数据库"><a href="#安装数据库" class="headerlink" title="安装数据库"></a>安装数据库</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget http://dev.mysql.com/get/mysql-community-release-el7-5.noarch.rpm</span><br><span class="line">rpm -ivh mysql-community-release-el7-5.noarch.rpm</span><br><span class="line">yum install mysql-community-server</span><br><span class="line">systemctl start mysql</span><br><span class="line">systemctl enable mysqld</span><br></pre></td></tr></table></figure><h3 id="安装redis"><a href="#安装redis" class="headerlink" title="安装redis"></a>安装redis</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install redis</span><br><span class="line">systemctl start redis</span><br><span class="line">systemctl enable redis</span><br></pre></td></tr></table></figure><h3 id="安装go环境（若使用编译好的二进制文件，此步骤可忽略）"><a href="#安装go环境（若使用编译好的二进制文件，此步骤可忽略）" class="headerlink" title="安装go环境（若使用编译好的二进制文件，此步骤可忽略）"></a>安装go环境<strong>（若使用编译好的二进制文件，此步骤可忽略）</strong></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install golang</span><br><span class="line">go version</span><br><span class="line">go version go1.6.3 linux/amd64</span><br></pre></td></tr></table></figure><h3 id="初始化数据库"><a href="#初始化数据库" class="headerlink" title="初始化数据库"></a>初始化数据库</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mkdir /opt/openfalcon</span><br><span class="line">cd /opt/openfalcon</span><br><span class="line">git clone https://github.com/open-falcon/scripts.git</span><br><span class="line">#导入表结构</span><br><span class="line">cd scripts</span><br><span class="line">mysql -h localhost -u root --password=&quot;&quot; &lt; db_schema/graph-db-schema.sql</span><br><span class="line">mysql -h localhost -u root --password=&quot;&quot; &lt; db_schema/dashboard-db-schema.sql</span><br><span class="line">mysql -h localhost -u root --password=&quot;&quot; &lt; db_schema/portal-db-schema.sql</span><br><span class="line">mysql -h localhost -u root --password=&quot;&quot; &lt; db_schema/links-db-schema.sql</span><br><span class="line">mysql -h localhost -u root --password=&quot;&quot; &lt; db_schema/uic-db-schema.sql</span><br></pre></td></tr></table></figure><h3 id="下载编译好的组件"><a href="#下载编译好的组件" class="headerlink" title="下载编译好的组件"></a>下载编译好的组件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mkdir /opt/openfalcon/tmp</span><br><span class="line">cd /opt/openfalcon/tmp</span><br><span class="line"></span><br><span class="line">wget https://github.com/open-falcon/of-release/releases/download/v0.1.0/open-falcon-v0.1.0.tar.gz</span><br><span class="line"></span><br><span class="line">tar -zxf https://github.com/open-falcon/of-release/releases/download/v0.1.0/open-falcon-v0.1.0.tar.gz</span><br><span class="line"></span><br><span class="line">rm -rf https://github.com/open-falcon/of-release/releases/download/v0.1.0/open-falcon-v0.1.0.tar.gz</span><br><span class="line"></span><br><span class="line">cd /opt/openfalcon</span><br><span class="line"></span><br><span class="line">for x in `find ./tmp/ -name &quot;*.tar.gz&quot;`;do app=`echo $x|cut -d&apos;-&apos; -f2`;mkdir -p $app;tar -zxf $x -C $app; done</span><br></pre></td></tr></table></figure><h2 id="开始安装"><a href="#开始安装" class="headerlink" title="开始安装"></a>开始安装</h2><h3 id="第一部分：绘图组件安装"><a href="#第一部分：绘图组件安装" class="headerlink" title="第一部分：绘图组件安装"></a><strong>第一部分：绘图组件安装</strong></h3><h5 id="组件列表："><a href="#组件列表：" class="headerlink" title="组件列表："></a><strong>组件列表：</strong></h5><table><thead><tr><th align="center"><strong>组件名称</strong></th><th><strong>用途</strong></th><th><strong>服务端口</strong></th><th><strong>备注</strong></th></tr></thead><tbody><tr><td align="center">Agent</td><td>部署在目标机器采集机器监控项</td><td>http: 1988</td><td></td></tr><tr><td align="center">Transfer</td><td>数据接收端，转发数据到后端Graph和Judge</td><td>http: 6060 rpc: 8433 socket: 4444</td><td></td></tr><tr><td align="center">Graph</td><td>操作rrd文件存储监控数据</td><td>http: 6070 rpc: 6071</td><td>1.可部署多实例做集群 2.需要连接数据库graph</td></tr><tr><td align="center">Query</td><td>查询各个Graph数据，提供统一http查询接口</td><td>http: 9966</td><td></td></tr><tr><td align="center">Dashboard</td><td>查询监控历史趋势图的web端</td><td>http: 8081</td><td>1.需要python虚拟环境 2.需要连接数据库dashborad、graph</td></tr><tr><td align="center">Task</td><td>负责一些定时任务，索引全量更新、垃圾索引清理、自身组件监控等</td><td>http: 8002</td><td>1.需要连接数据库graph</td></tr></tbody></table><h5 id="安装Agent"><a href="#安装Agent" class="headerlink" title="安装Agent"></a><strong>安装Agent</strong></h5><p>agent用于采集机器负载监控指标，比如cpu.idle、load.1min、disk.io.util等等，每隔60秒push给Transfer。agent与Transfer建立了长连接，数据发送速度比较快，agent提供了一个http接口/v1/push用于接收用户手工push的一些数据，然后通过长连接迅速转发给Transfer。</p><p>每台机器上，都需要部署agent。修改配置并启动</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cd/opt/openfalcon/agent/</span><br><span class="line">mv cfg.example.json cfg.json</span><br><span class="line"></span><br><span class="line">vim cfg.json</span><br><span class="line">修改 transfer这个配置项的enabled为 true，表示开启向transfer发送数据的功能</span><br><span class="line">修改 transfer这个配置项的addr为：[&quot;127.0.0.1:8433&quot;] (改地址为transfer组件的监听地址, 为列表形式，可配置多个transfer实例的地址，用逗号分隔)</span><br><span class="line">#默认情况下（所有组件都在同一台服务器上），保持cfg.json不变即可</span><br><span class="line">#cfg.json中的各配置项，可以参考 https://github.com/open-falcon/agent/blob/master/README.md</span><br><span class="line"></span><br><span class="line">#启动</span><br><span class="line">./control start</span><br><span class="line">#查看日志</span><br><span class="line">./control tail</span><br></pre></td></tr></table></figure><h5 id="安装Transfer"><a href="#安装Transfer" class="headerlink" title="安装Transfer"></a><strong>安装Transfer</strong></h5><p>transfer默认监听在:8433端口上，agent会通过jsonrpc的方式来push数据上来。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/openfalcon/transfer/</span><br><span class="line">mv cfg.example.json cfg.json</span><br><span class="line"># 默认情况下（所有组件都在同一台服务器上），保持cfg.json不变即可</span><br><span class="line"># cfg.json中的各配置项，可以参考 https://github.com/open-falcon/transfer/blob/master/README.md</span><br><span class="line"># 如有必要，请酌情修改cfg.json</span><br><span class="line"></span><br><span class="line"># 启动transfer</span><br><span class="line">./control start</span><br><span class="line"># 校验服务,这里假定服务开启了6060的http监听端口。检验结果为ok表明服务正常启动。</span><br><span class="line">curl -s &quot;http://127.0.0.1:6060/health&quot;</span><br><span class="line">#查看日志</span><br><span class="line">./control tail</span><br></pre></td></tr></table></figure><h5 id="安装Graph"><a href="#安装Graph" class="headerlink" title="安装Graph"></a><strong>安装Graph</strong></h5><p>graph组件是存储绘图数据、历史数据的组件。transfer会把接收到的数据，转发给graph。</p><p>#创建存储数据目录</p><p>mkdir -p /opt/openfalcon/data/6070</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/openfalcon/graph/</span><br><span class="line">mv cfg.example.json cfg.json</span><br><span class="line"># 默认情况下（所有组件都在同一台服务器上），绘图数据我改为了/opt/openfalcon/data/6070，还有就是数据库密码需要加上</span><br><span class="line"># cfg.json中的各配置项，可以参考 https://github.com/open-falcon/graph/blob/master/README.md</span><br><span class="line"></span><br><span class="line"># 启动</span><br><span class="line">./control start</span><br><span class="line"># 查看日志</span><br><span class="line">./control tail</span><br><span class="line"># 校验服务,这里假定服务开启了6071的http监听端口。检验结果为ok表明服务正常启动。</span><br><span class="line">curl -s &quot;http://127.0.0.1:6071/health&quot;</span><br></pre></td></tr></table></figure><h5 id="安装Query"><a href="#安装Query" class="headerlink" title="安装Query"></a><strong>安装Query</strong></h5><p>query组件，绘图数据的查询接口，query组件收到用户的查询请求后，会从后端的多个graph，查询相应的数据，聚合后，再返回给用户。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cd/opt/openfalcon/query/</span><br><span class="line">mv cfg.example.json cfg.json</span><br><span class="line"># 默认情况下（所有组件都在同一台服务器上），保持cfg.json不变即可</span><br><span class="line"># cfg.json中的各配置项，可以参考 https://github.com/open-falcon/query/blob/master/README.md</span><br><span class="line"></span><br><span class="line"># 启动</span><br><span class="line">./control start</span><br><span class="line"># 查看日志</span><br><span class="line">./control tail</span><br></pre></td></tr></table></figure><h5 id="安装Dashboard"><a href="#安装Dashboard" class="headerlink" title="安装Dashboard"></a><strong>安装Dashboard</strong></h5><p>dashboard是面向用户的查询界面，在这里，用户可以看到push到graph中的所有数据，并查看其趋势图。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#安装依赖和虚拟环境</span><br><span class="line">yum install -y python-virtualenv mysql-devel</span><br><span class="line">cd /opt/openfalcon/dashboard/</span><br><span class="line">virtualenv ./env</span><br><span class="line">./env/bin/pip install -r pip_requirements.txt</span><br><span class="line"></span><br><span class="line">#配置</span><br><span class="line"># config的路径为 $WORKSPACE/dashboard/rrd/config.py，里面有数据库相关的配置信息，如有必要，请修改。默认情况下(所有组件都在同一台服务器上)，保持默认配置即可</span><br><span class="line"># 数据库表结构初始化，请参考前面的 环境准备 阶段</span><br><span class="line"></span><br><span class="line">#启动</span><br><span class="line">./control start</span><br><span class="line">#浏览器访问</span><br><span class="line">http://IP:8081</span><br><span class="line">#查看日志</span><br><span class="line">./control tail</span><br></pre></td></tr></table></figure><h5 id="安装Task"><a href="#安装Task" class="headerlink" title="安装Task"></a><strong>安装Task</strong></h5><p>task是监控系统一个必要的辅助模块。定时任务，实现了如下几个功能：</p><ul><li><p>index更新。包括图表索引的全量更新 和 垃圾索引清理。</p></li><li><p>falcon服务组件的自身状态数据采集。定时任务了采集了transfer、graph、task这三个服务的内部状态数据。</p></li><li><p>falcon自检控任务。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/openfalcon/task</span><br><span class="line"># #修改配置, 配置项含义见下文</span><br><span class="line">mv cfg.example.json cfg.json</span><br><span class="line"></span><br><span class="line"># 默认情况下（所有组件都在同一台服务器上），保持cfg.json不变即可</span><br><span class="line"># cfg.json中的各配置项，可以参考 https://github.com/open-falcon/query/blob/master/README.md</span><br><span class="line"></span><br><span class="line"># 启动服务</span><br><span class="line">./control start</span><br><span class="line"># 校验服务,这里假定服务开启了8002的http监听端口。检验结果为ok表明服务正常启动。</span><br><span class="line">curl -s &quot;127.0.0.1:8002/health&quot;</span><br></pre></td></tr></table></figure></li></ul><h3 id="第二部分：报警组件安装"><a href="#第二部分：报警组件安装" class="headerlink" title="第二部分：报警组件安装"></a><strong>第二部分：报警组件安装</strong></h3><h5 id="组件列表：-1"><a href="#组件列表：-1" class="headerlink" title="组件列表："></a><strong>组件列表：</strong></h5><table><thead><tr><th align="center"><strong>组件名称</strong></th><th align="center"><strong>用途</strong></th><th align="center"><strong>服务端口</strong></th><th align="center"><strong>备注</strong></th></tr></thead><tbody><tr><td align="center">Sender</td><td align="center">报警发送模块，控制并发度，提供发送的缓冲queue</td><td align="center">http: 6066</td><td align="center"></td></tr><tr><td align="center">UIC（fe）</td><td align="center">用户组管理，单点登录</td><td align="center">http: 80</td><td align="center">1.需要连接数据库：uic</td></tr><tr><td align="center">Portal</td><td align="center">配置报警策略，管理机器分组的web端</td><td align="center">http: 5050</td><td align="center">1.需要连接数据库：falcon_portal 2.需要python虚拟环境</td></tr><tr><td align="center">HBS</td><td align="center">HeartBeat Server，心跳服务器</td><td align="center">http: 6031rpc: 6030</td><td align="center">1.需要连接数据库：falcon_portal</td></tr><tr><td align="center">Judge</td><td align="center">报警判断模块</td><td align="center">http: 6081 rpc: 6080</td><td align="center">1.可部署多实例</td></tr><tr><td align="center">Links</td><td align="center">报警合并依赖的web端，存放报警详情</td><td align="center">http: 5090</td><td align="center">1.需要连接数据库：falcon_links 2.需要python虚拟环境</td></tr><tr><td align="center">Alarm</td><td align="center">报警事件处理器</td><td align="center">http: 9912</td><td align="center"></td></tr><tr><td align="center">mail-provider</td><td align="center">报警邮件http api</td><td align="center">http: 4000</td><td align="center">小米提供</td></tr><tr><td align="center">sms-provider</td><td align="center">报警短信http api</td><td align="center">http: 4040</td><td align="center">自行编写</td></tr><tr><td align="center">Nodata</td><td align="center">检测监控数据的上报异常</td><td align="center">http: 6090</td><td align="center">1.需要连接数据库：falcon_portal</td></tr><tr><td align="center">Aggregator</td><td align="center">集群聚合模块——聚合某集群下的所有机器的某个指标的值，提供一种集群视角的监控体验。</td><td align="center"></td><td align="center"></td></tr></tbody></table><h5 id="报警准备：mail-provider-amp-sms-provider"><a href="#报警准备：mail-provider-amp-sms-provider" class="headerlink" title="报警准备：mail-provider &amp; sms-provider"></a>报警准备：mail-provider &amp; sms-provider</h5><p>监控系统产生报警事件之后需要发送报警邮件或者报警短信，各个公司可能有自己的邮件服务器，有自己的邮件发送方法；有自己的短信通道，有自己的短信发送方法。falcon为了适配各个公司，在接入方案上做了一个规范，需要各公司提供http的短信和邮件发送接口。</p><p>短信发送http接口：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">method: post</span><br><span class="line">params:</span><br><span class="line">  - content: 短信内容</span><br><span class="line">  - tos: 使用逗号分隔的多个手机号</span><br></pre></td></tr></table></figure><p>falcon将这样调用该接口：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">url=您公司提供的http短信接口</span><br><span class="line">curl  $url-d&quot;content=xxx&amp;tos=18611112222,18611112223&quot;</span><br></pre></td></tr></table></figure><p>邮件发送http接口：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">method: post</span><br><span class="line">params:</span><br><span class="line">  - content: 邮件内容</span><br><span class="line">  - subject: 邮件标题</span><br><span class="line">  - tos: 使用逗号分隔的多个邮件地址</span><br></pre></td></tr></table></figure><p>falcon将这样调用该接口：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">url=您公司提供的http邮件接口</span><br><span class="line">curl -X POST $url-d&quot;content=xxx&amp;tos=ulric.qin@gmail.com,user@example.com&amp;subject=xxx&quot;</span><br></pre></td></tr></table></figure><h5 id="安装使用mail-provider"><a href="#安装使用mail-provider" class="headerlink" title="安装使用mail-provider"></a><strong>安装使用mail-provider</strong></h5><p>这里使用小米提供的mail-provider，我是通过网友编译好的二级制包安装的，也可自行编译。</p><p>github地址： <a href="https://github.com/open-falcon/mail-provider" target="_blank" rel="noopener">https://github.com/open-falcon/mail-provider</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/open-falcon/mail-provider</span><br><span class="line"></span><br><span class="line">tar xf mail-provider-master.tar.gz </span><br><span class="line"></span><br><span class="line">rm -rf mail-provider-master.tar.gz </span><br><span class="line"></span><br><span class="line">mv mail-provider-master mail-provider</span><br><span class="line"></span><br><span class="line">cd mail-provider/</span><br><span class="line"></span><br><span class="line">#修改配置文件cfg.conf</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    &quot;debug&quot;: true,</span><br><span class="line"></span><br><span class="line">    &quot;http&quot;: &#123;</span><br><span class="line"></span><br><span class="line">        &quot;listen&quot;: &quot;0.0.0.0:4000&quot;,</span><br><span class="line"></span><br><span class="line">        &quot;token&quot;: &quot;&quot;</span><br><span class="line"></span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    &quot;smtp&quot;: &#123;</span><br><span class="line"></span><br><span class="line">        &quot;addr&quot;: &quot;smtp.exmail.qq.com:25&quot;,</span><br><span class="line"></span><br><span class="line">        &quot;username&quot;: &quot;xxxx@abc.com&quot;,</span><br><span class="line"></span><br><span class="line">        &quot;password&quot;: &quot;12345&quot;,</span><br><span class="line"></span><br><span class="line">        &quot;from&quot;: &quot;xxxx@abc.com&quot;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">#启动</span><br><span class="line">./control start</span><br><span class="line"></span><br><span class="line">#测试邮件接口是否正常，收到邮件证明API 正常。</span><br><span class="line">curl http://127.0.0.1:4000/sender/mail -d &quot;tos=29235373@qq.com&amp;subject=xxxx&amp;content=yyyy&quot;</span><br></pre></td></tr></table></figure><h5 id="建立sms-provider"><a href="#建立sms-provider" class="headerlink" title="建立sms-provider"></a>建立sms-provider</h5><p>这里我自己写了个基于python的http server 作为短信接口http api</p><p>vim http_sms.py</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">#coding=utf-8</span><br><span class="line">‘‘‘</span><br><span class="line">Created on ``2016``-``10``-``17</span><br><span class="line">@author``: chenguomin  qq:``29235373</span><br><span class="line">@explain``: 实现GET方法和POST方法请求</span><br><span class="line">‘‘‘</span><br><span class="line">from`  `BaseHTTPServer ``import` `HTTPServer,BaseHTTPRequestHandler</span><br><span class="line">import` `urllib</span><br><span class="line">import` `urllib2</span><br><span class="line">def` `send_message(tos,txt):</span><br><span class="line">‘‘‘</span><br><span class="line">此函数主要用于调用我公司内部的短信API(get方式)，大伙可自行修改。</span><br><span class="line">比如：需要加用户名密码,MD5，token的自行查看短信平台提供商手册，如何调用短信API。</span><br><span class="line">下面提供一个url供大家参考。</span><br><span class="line">‘‘‘</span><br><span class="line">    ``#url  =  &quot;http://www.sms.com:4000/sendsms?uid=16888&amp;pwd=123456&amp;mobile=%s&amp;msg=%s&quot; % (tos, txt)         </span><br><span class="line">    ``url ``=` `&quot;http://192.168.20.88:8080/SendSms/sendsms?mobile=%s&amp;content=%s&quot;` `%` `(tos, txt)</span><br><span class="line">    ``req ``=` `urllib2.Request(url)</span><br><span class="line">    ``res_data ``=` `urllib2.urlopen(req)</span><br><span class="line">    ``res ``=` `res_data.read()</span><br><span class="line">    ``print` `res</span><br><span class="line">class` `ServerHTTP(BaseHTTPRequestHandler):</span><br><span class="line">    ``def` `do_GET(``self``):</span><br><span class="line">        ``path ``=` `self``.path</span><br><span class="line">        ``print` `path</span><br><span class="line">        ``#拆分url(也可根据拆分的url获取Get提交才数据),可以将不同的path和参数加载不同的html页面，或调用不同的方法返回不同的数据，来实现简单的网站或接口</span><br><span class="line">        ``query ``=` `urllib.splitquery(path)</span><br><span class="line">        ``print` `query</span><br><span class="line">        ``self``.send_response(``200``)</span><br><span class="line">        ``self``.send_header(``&quot;Content-type&quot;``,``&quot;text/html&quot;``)</span><br><span class="line">        ``self``.send_header(``&quot;test&quot;``,``&quot;This is test!&quot;``)</span><br><span class="line">        ``self``.end_headers()</span><br><span class="line">        ``buf ``=` `‘‘‘‘‘&lt;!DOCTYPE HTML&gt;</span><br><span class="line">                ``&lt;html&gt;</span><br><span class="line">                ``&lt;head&gt;&lt;title&gt;Get page&lt;``/``title&gt;&lt;``/``head&gt;</span><br><span class="line">                ``&lt;body&gt;</span><br><span class="line">                ``&lt;form action``=``&quot;post_page&quot;` `method``=``&quot;post&quot;``&gt;</span><br><span class="line">                  ``mobile: &lt;``input` `type``=``&quot;text&quot;` `name``=``&quot;tos&quot;` `/``&gt;&lt;br ``/``&gt;</span><br><span class="line">                  ``content: &lt;``input` `type``=``&quot;text&quot;` `name``=``&quot;content&quot;` `/``&gt;&lt;br ``/``&gt;</span><br><span class="line">                  ``&lt;``input` `type``=``&quot;submit&quot;` `value``=``&quot;POST&quot;` `/``&gt;</span><br><span class="line">                ``&lt;``/``form&gt;</span><br><span class="line">                ``&lt;``/``body&gt;</span><br><span class="line">                ``&lt;``/``html&gt;‘‘‘</span><br><span class="line">        ``self``.wfile.write(buf)</span><br><span class="line">    ``def` `do_POST(``self``):</span><br><span class="line">        ``path ``=` `self``.path</span><br><span class="line">        ``print` `path</span><br><span class="line">        ``#获取post提交的数据</span><br><span class="line">        ``datas ``=` `self``.rfile.read(``int``(``self``.headers[‘content``-``length‘]))</span><br><span class="line">        ``datas ``=` `urllib.unquote(datas).decode(``&quot;utf-8&quot;``, ‘ignore‘)</span><br><span class="line">        ``mobile ``=` `datas.split(‘&amp;‘)[``0``].replace(``&quot;tos=&quot;``,&quot;``&quot;).replace(‘&quot;``‘,‘‘)</span><br><span class="line">        ``content ``=` `datas.split(‘&amp;‘)[``1``].replace(``&quot;content=&quot;``,&quot;``&quot;).replace(‘&quot;``‘,‘‘)</span><br><span class="line">        ``mm ``=` `mobile.split(‘,‘)</span><br><span class="line">        ``for` `i ``in` `mm:</span><br><span class="line">                ``print` `i</span><br><span class="line">                ``send_message(i,content)</span><br><span class="line">                ``self``.send_response(``200``)</span><br><span class="line">                ``self``.end_headers()</span><br><span class="line">                ``buf ``=` `‘‘‘‘‘&lt;!DOCTYPE HTML&gt;</span><br><span class="line">                ``&lt;html&gt;</span><br><span class="line">                ``&lt;head&gt;&lt;title&gt;Post page&lt;``/``title&gt;&lt;``/``head&gt;</span><br><span class="line">                ``&lt;body&gt;Tos:``%``s  &lt;br ``/``&gt;Content:``%``s&lt;``/``body&gt;</span><br><span class="line">                ``&lt;``/``html&gt;‘‘‘``%` `(mobile, content)</span><br><span class="line">                ``self``.wfile.write(buf)</span><br><span class="line">def` `start_server(port):</span><br><span class="line">    ``http_server ``=` `HTTPServer((‘‘, ``int``(port)), ServerHTTP)</span><br><span class="line">    ``http_server.serve_forever()</span><br><span class="line">if` `__name__ ``=``=` `&quot;__main__&quot;``:</span><br><span class="line">    ``#端口可自定义，不冲突就可以，这里设置为：4040</span><br><span class="line">    ``start_server(``4040``)</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#运行python http server</span><br><span class="line">nohup python http_sms.py &amp;</span><br><span class="line"></span><br><span class="line">#验证：在浏览器访问，提供了简单的页面测试，只有get，post方法。</span><br><span class="line">http://ip:4040/</span><br><span class="line">#也可以在命令行使用curl测试</span><br><span class="line">curl http://192.168.20.99:4040/ -d &quot;tos=1358888888,1868888888&amp;content=testmsg&quot;</span><br><span class="line">#openfalcon的sender是post方式传递数据给http api的，所以我需要获取sender post过来的tos和content参数，再发送到公司内部的sms api。</span><br></pre></td></tr></table></figure><h5 id="安装alarm"><a href="#安装alarm" class="headerlink" title="安装alarm"></a>安装alarm</h5><p>alarm模块是处理报警event的，judge产生的报警event写入redis，alarm从redis读取，这个模块被业务搞得很糟乱，各个公司可以根据自己公司的需求重写</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/openfalcon/alarm/</span><br><span class="line">mv cfg.example.json cfg.json</span><br><span class="line"></span><br><span class="line"># vi cfg.json</span><br><span class="line"># 把redis配置成与judge同一个</span><br><span class="line">./control start</span><br></pre></td></tr></table></figure><p>微信告警版本可到我的github拉取</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/chensambb/open-falcon-alarm-by-weixin/</span><br></pre></td></tr></table></figure><h5 id="安装sender"><a href="#安装sender" class="headerlink" title="安装sender"></a>安装sender</h5><p>调用各个公司提供的mail-provider和sms-provider，按照某个并发度，从redis中读取邮件、短信并发送，alarm生成的报警短信和报警邮件都是直接写入redis即可，sender来发送。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/openfalcon/sender/</span><br><span class="line">mv cfg.example.json cfg.json</span><br><span class="line"></span><br><span class="line"># vi cfg.json</span><br><span class="line"># redis地址需要和后面的alarm、judge使用同一个</span><br><span class="line"># queue维持默认</span><br><span class="line"># worker是最多同时有多少个线程玩命得调用短信、邮件发送接口</span><br><span class="line"># api要给出sms-provider和mail-provider的接口地址</span><br><span class="line"></span><br><span class="line">#我们现在调用上面的短信和邮件api</span><br><span class="line">&#123;</span><br><span class="line">	&quot;debug&quot;: true,</span><br><span class="line">	&quot;http&quot;: &#123;</span><br><span class="line">		&quot;enabled&quot;: true,</span><br><span class="line">		&quot;listen&quot;: &quot;0.0.0.0:6066&quot;</span><br><span class="line">	&#125;,</span><br><span class="line">	&quot;redis&quot;: &#123;</span><br><span class="line">		&quot;addr&quot;: &quot;127.0.0.1:6379&quot;,</span><br><span class="line">		&quot;maxIdle&quot;: 5</span><br><span class="line">	&#125;,</span><br><span class="line">	&quot;queue&quot;: &#123;</span><br><span class="line">		&quot;sms&quot;: &quot;/sms&quot;,</span><br><span class="line">		&quot;mail&quot;: &quot;/mail&quot;</span><br><span class="line">	&#125;,</span><br><span class="line">	&quot;worker&quot;: &#123;</span><br><span class="line">		&quot;sms&quot;: 10,</span><br><span class="line">		&quot;mail&quot;: 50</span><br><span class="line">	&#125;,</span><br><span class="line">	&quot;api&quot;: &#123;</span><br><span class="line">		&quot;sms&quot;: &quot;http://127.0.0.1:4040/&quot;,</span><br><span class="line">		&quot;mail&quot;: &quot;http://127.0.0.1:4000/sender/mail&quot;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#启动</span><br><span class="line">./control start</span><br></pre></td></tr></table></figure><h5 id="安装fe"><a href="#安装fe" class="headerlink" title="安装fe"></a>安装fe</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/openfalcon/fe</span><br><span class="line">mv cfg.example.json cfg.json</span><br><span class="line"># 请基于cfg.example.json 酌情修改相关配置项</span><br><span class="line"></span><br><span class="line"># 启动</span><br><span class="line">./control start</span><br><span class="line"># 查看日志</span><br><span class="line">./control tail</span><br><span class="line"># 停止服务</span><br><span class="line">./control stop</span><br></pre></td></tr></table></figure><h5 id="安装portal"><a href="#安装portal" class="headerlink" title="安装portal"></a>安装portal</h5><p>portal是用于配置报警策略的地方</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">yum install -y python-virtualenv  # run as root</span><br><span class="line"></span><br><span class="line">cd/opt/openfalcon/portal/</span><br><span class="line">virtualenv ./env</span><br><span class="line"></span><br><span class="line">./env/bin/pip install -r pip_requirements.txt</span><br><span class="line"># vi frame/config.py</span><br><span class="line"># 1. 修改DB配置</span><br><span class="line"># 2. SECRET_KEY设置为一个随机字符串</span><br><span class="line"># 3. UIC_ADDRESS有两个，internal配置为FE模块的内网地址，portal通常是和UIC在一个网段的,内网地址相互访问速度快。external是终端用户通过浏览器访问的UIC地址，很重要！</span><br><span class="line"># 4. 其他配置可以使用默认的</span><br><span class="line"></span><br><span class="line">#启动</span><br><span class="line">./control start</span><br><span class="line">#验证</span><br><span class="line">portal默认监听在5050端口，浏览器访问即可</span><br></pre></td></tr></table></figure><h5 id="安装HBS-heartbeat-Server"><a href="#安装HBS-heartbeat-Server" class="headerlink" title="安装HBS(heartbeat Server)"></a>安装HBS(heartbeat Server)</h5><p>心跳服务器，只依赖Portal的DB</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cd  /opt/openfalcon/hbs/</span><br><span class="line">mv cfg.example.json cfg.json</span><br><span class="line"></span><br><span class="line"># vi cfg.json </span><br><span class="line">#把数据库配置配置为portal的db</span><br><span class="line"></span><br><span class="line">#启动</span><br><span class="line">./control start</span><br></pre></td></tr></table></figure><p>如果先安装的绘图组件又来安装报警组件，那应该已经安装过agent了，hbs启动之后会监听一个http端口，一个rpc端口，agent要和hbs通信，重新去修改agent的配置cfg.json，把heartbeat那项enabled设置为true，并配置上hbs的rpc地址，<code>./control restart</code>重启agent，之后agent就可以和hbs心跳了</p><h5 id="安装judge"><a href="#安装judge" class="headerlink" title="安装judge"></a>安装judge</h5><p>报警判断模块，judge依赖于HBS，所以得先搭建HBS</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/openfalcon/judge/</span><br><span class="line">mv cfg.example.json cfg.json</span><br><span class="line"># vi cfg.json</span><br><span class="line"># remain: 这个配置指定了judge内存中针对某个数据存多少个点，比如host01这个机器的cpu.idle的值在内存中最多存多少个，</span><br><span class="line"># 配置报警的时候比如all(#3)，这个#后面的数字不能超过remain-1</span><br><span class="line"># hbs: 配置为hbs的地址，interval默认是60s，表示每隔60s从hbs拉取一次策略</span><br><span class="line"># alarm: 报警event写入alarm中配置的redis</span><br><span class="line"># minInterval表示连续两个报警之间至少相隔的秒数，维持默认即可</span><br><span class="line"></span><br><span class="line">#启动</span><br><span class="line">./control start</span><br></pre></td></tr></table></figure><h5 id="安装Links"><a href="#安装Links" class="headerlink" title="安装Links"></a>安装Links</h5><p>Links是为报警合并功能写的组件。如果你不想使用报警合并功能，这个组件是无需安装的。</p><p>Links个Python的项目，无需像Go的项目那样去做编译。不过Go的项目是静态编译的，编译好了之后二进制无依赖，拿到其他机器也可以跑起来，Python的项目就需要安装一些依赖库了。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 我们使用virtualenv来管理Python环境，yum安装需切到root账号</span><br><span class="line"># yum install -y python-virtualenv</span><br><span class="line"></span><br><span class="line">cd /opt/openfalcon/links/</span><br><span class="line">virtualenv ./env</span><br><span class="line"></span><br><span class="line">./env/bin/pip install -r pip_requirements.txt</span><br><span class="line">#安装完依赖的lib之后就可以用control脚本启动了，log在var目录。不过启动之前要先把配置文件修改成相应配置。另外，监听的端口在gunicorn.conf中配置。</span><br><span class="line">#启动</span><br><span class="line">./control start</span><br></pre></td></tr></table></figure><h5 id="安装Nodata"><a href="#安装Nodata" class="headerlink" title="安装Nodata"></a>安装Nodata</h5><p>nodata用于检测监控数据的上报异常。nodata和实时报警judge模块协同工作，过程为: 配置了nodata的采集项超时未上报数据，nodata生成一条默认的模拟数据；用户配置相应的报警策略，收到mock数据就产生报警。采集项上报异常检测，作为judge模块的一个必要补充，能够使judge的实时报警功能更加可靠、完善。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/openfalcon/nodata</span><br><span class="line">mv cfg.example.json cfg.json</span><br><span class="line">vim cfg.json</span><br><span class="line"></span><br><span class="line"># 启动服务</span><br><span class="line">./control start</span><br><span class="line"># 校验服务,这里假定服务开启了6090的http监听端口。检验结果为ok表明服务正常启动。</span><br><span class="line">curl -s &quot;127.0.0.1:6090/health&quot;</span><br><span class="line"># 停止服务</span><br><span class="line">./control stop</span><br></pre></td></tr></table></figure><h5 id="安装Aggregator"><a href="#安装Aggregator" class="headerlink" title="安装Aggregator"></a>安装Aggregator</h5><p>集群聚合模块。聚合某集群下的所有机器的某个指标的值，提供一种集群视角的监控体验。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/openfalcon/aggregator</span><br><span class="line"># 修改配置, 配置项含义见下文</span><br><span class="line">mv cfg.example.json cfg.json</span><br><span class="line">vim cfg.json</span><br><span class="line"></span><br><span class="line"># 启动服务</span><br><span class="line">./control start</span><br><span class="line"># 校验服务，看端口是否在监听ss -tln</span><br><span class="line"># 检查log</span><br><span class="line">./control tail</span><br><span class="line"># 停止服务</span><br><span class="line">./control stop</span><br></pre></td></tr></table></figure><h2 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h2><p>参考<a href="http://book.open-falcon.org/zh/usage/index.html" target="_blank" rel="noopener">官方book</a></p><h5 id="查看监控数据"><a href="#查看监控数据" class="headerlink" title="查看监控数据"></a>查看监控数据</h5><p>我们说agent只要部署到机器上，并且配置好了heartbeat和transfer就自动采集数据了，我们就可以去dashboard上面搜索监控数据查看了。dashboard是个web项目，浏览器访问之。左侧输入endpoint搜索，endpoint是什么？应该用什么搜索？对于agent采集的数据，endpoint都是机器名，去目标机器上执行<code>hostname</code>，看到的输出就是endpoint，拿着hostname去搜索。</p><p>搜索到了吧？嗯，选中前面的复选框，点击“查看counter列表”，可以列出隶属于这个endpoint的counter，counter是什么？<code>counter=${metric}/sorted(${tags})</code></p><p>假如我们要查看cpu.idle，在counter搜索框中输入cpu并回车。看到cpu.idle了吧，点击，会看到一个新页面，图表中就是这个机器的cpu.idle的近一小时数据了，想看更长时间的？右上角有个小三角，展开菜单，可以选择更长的时间跨度</p><p><img src="/articles/4354c695/4.png" alt></p><p><img src="/articles/4354c695/5.png" alt></p><h5 id="配置报警策略"><a href="#配置报警策略" class="headerlink" title="配置报警策略"></a>配置报警策略</h5><p>上节我们已经了解到如何查看监控数据了，如果数据达到阈值，比如cpu.idle太小的时候，我们应该如何配置告警呢？</p><p>falcon的报警接收人不是一个具体的手机号，也不是一个具体的邮箱，因为手机号、邮箱都是容易发生变化的，如果变化了去修改所有相关配置那就太麻烦了。我们把用户的联系信息维护在一个叫UIC(新用户推荐使用Go版本的UIC，即：falcon-fe项目)的系统里，以后如果要修改手机号、邮箱，只要在UIC中修改一次即可。报警接收人也不是单个的人，而是一个组（UIC中称为Team），比如falcon这个系统的任何组件出问题了，都应该发报警给falcon的运维和开发人员，发给falcon这个团队，这样一来，新员工入职只要加入falcon这个Team即可；员工离职，只要从falcon这个Team删掉即可。</p><p>浏览器访问UIC，如果启用了LDAP，那就用LDAP账号登陆，如果没有启用，那就注册一个或者找管理员帮忙开通。创建一个Team，名称姑且叫falcon，把自己加进去，待会用来做测试。</p><h5 id="创建HostGroup"><a href="#创建HostGroup" class="headerlink" title="创建HostGroup"></a>创建HostGroup</h5><p>比如我们要对falcon-judge这个组件做端口监控，那首先创建一个HostGroup，把所有部署了falcon-judge这个模块的机器都塞进去，以后要扩容或下线机器的时候直接从这个HostGroup增删机器即可，报警策略会自动生效、失效。咱们为这个HostGroup取名为：sa.dev.falcon.judge，这个名称有讲究，sa是我们部门，dev是我们组，falcon是项目名，judge是组件名，传达出了很多信息，这样命名比较容易管理，推荐大家这么做。</p><p>在往组里加机器的时候如果报错，需要检查portal的数据库中host表，看里边是否有相关机器。那host表中的机器从哪里来呢？agent有个heartbeat(hbs)的配置，agent每分钟会发心跳给hbs，把自己的ip、hostname、agent version等信息告诉hbs，hbs负责写入host表。如果host表中没数据，需要检查这条链路是否通畅。</p><h5 id="创建策略模板"><a href="#创建策略模板" class="headerlink" title="创建策略模板"></a>创建策略模板</h5><p>portal最上面有个Templates链接，这就是策略模板管理的入口。我们进去之后创建一个模板，名称姑且也叫：sa.dev.falcon.judge，与HostGroup名称相同，在里边配置一个端口监控，通常进程监控有两种手段，一个是进程本身是否存活，一个是端口是否在监听，此处我们使用端口监控。</p><p><img src="/articles/4354c695/6.png" alt></p><p>右上角那个加号按钮是用于增加策略的，一个模板中可以有多个策略，此处我们只添加了一个。下面可以配置报警接收人，此处填写的是falcon，这是之前在UIC中创建的Team。</p><h5 id="将HostGroup与模板绑定"><a href="#将HostGroup与模板绑定" class="headerlink" title="将HostGroup与模板绑定"></a>将HostGroup与模板绑定</h5><p>一个模板是可以绑定到多个HostGroup的，现在我们重新回到HostGroups页面，找到sa.dev.falcon.judge这个HostGroup，右侧有几个超链接，点击【templates】进入一个新页面，输入模板名称，绑定一下就行了。</p><h5 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h5><p>上面步骤做完了，也就配置完了。如果judge组件宕机，端口不再监听了，就会报警。不过大家不要为了测试报警效果，直接把judge组件给干掉了，因为judge本身就是负责判断报警的，把它干掉了，那就没法判断了……所以说falcon现在并不完善，没法用来监控本身的组件。为了测试，大家可以修改一下端口监控的策略配置，改成一个没有在监听的端口，这样就触发报警了。</p><p>上面的策略只是对falcon-judge做了端口监控，那如果我们要对falcon这个项目的所有机器加一些负载监控，应该如何做呢？</p><ol><li>创建一个HostGroup：sa.dev.falcon，把所有falcon的机器都塞进去</li><li>创建一个模板：sa.dev.falcon.common，添加一些像cpu.idle,load.1min等策略</li><li>将sa.dev.falcon.common绑定到sa.dev.falcon这个HostGroup</li></ol><p>附：sa.dev.falcon.common的配置样例</p><p><img src="/articles/4354c695/7.png" alt></p><p>大家可能不知道各个指标分别叫什么，自己push的数据肯定知道自己的metric了，agent push的数据可以参考：<a href="https://github.com/open-falcon/agent/tree/master/funcs" target="_blank" rel="noopener">https://github.com/open-falcon/agent/tree/master/funcs</a></p><h5 id="如何配置策略表达式"><a href="#如何配置策略表达式" class="headerlink" title="如何配置策略表达式"></a>如何配置策略表达式</h5><p>策略表达式，即expression，具体可以参考<a href="http://book.open-falcon.org/zh/philosophy/tags-and-hostgroup.html" target="_blank" rel="noopener">HostGroup与Tags设计理念</a>，这里只是举个例子：</p><p><img src="/articles/4354c695/8.png" alt></p><p>上例中的配置传达出的意思是：falcon-judge这个模块的所有实例，如果qps连续3次大于1000，就报警给falcon这个报警组。</p><p>expression无需绑定到HostGroup。</p></div><div><div><div style="text-align:center;color:#ccc;font-size:14px">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div></div></div><div><div class="my_post_copyright"><script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script><script src="https://cdn.bootcss.com/jquery/2.0.0/jquery.min.js"></script><script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script><p><span>本文标题:</span><a href="/articles/4354c695.html">分布式开源监控系统open-falcon安装使用笔记</a></p><p><span>文章作者:</span><a href="/" title="访问 WanDouDuoDuo 的个人博客">WanDouDuoDuo</a></p><p><span>发布时间:</span>2019年05月29日 - 18:05</p><p><span>最后更新:</span>2019年11月01日 - 10:11</p><p><span>原始链接:</span><a href="/articles/4354c695.html" title="分布式开源监控系统open-falcon安装使用笔记">https://wandouduoduo.netlify.com/articles/4354c695.html</a><span class="copy-path" title="点击复制文章链接"><i class="fa fa-clipboard" data-clipboard-text="https://wandouduoduo.netlify.com/articles/4354c695.html" aria-label="复制成功！"></i></span></p><p><span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">署名-非商业性使用-禁止演绎 4.0 国际</a> 转载请保留原文链接及作者。</p></div><script>var clipboard=new Clipboard(".fa-clipboard");$(".fa-clipboard").click(function(){clipboard.on("success",function(){swal({title:"",text:"复制成功",icon:"success",showConfirmButton:!0})})})</script></div><div><div style="padding:10px 0;margin:20px auto;width:90%;text-align:center"><div>原创技术分享，您的支持将鼓励我继续创作</div> <button id="rewardButton" disable="enable" onclick='var qr=document.getElementById("QR");"none"===qr.style.display?qr.style.display="block":qr.style.display="none"'> <span>打赏</span></button><div id="QR" style="display:none"><div id="wechat" style="display:inline-block"> <img id="wechat_qr" src="/images/wechatpay.png" alt="WanDouDuoDuo 微信支付"><p>微信支付</p></div><div id="alipay" style="display:inline-block"> <img id="alipay_qr" src="/images/alipay.jpg" alt="WanDouDuoDuo 支付宝"><p>支付宝</p></div></div></div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/Open-falcon/" rel="tag"><i class="fa fa-tag"></i> Open-falcon</a></div><div class="post-widgets"><div class="social_share"><div><div class="bdsharebuttonbox"><a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a><a href="#" class="bds_douban" data-cmd="douban" title="分享到豆瓣网"></a><a href="#" class="bds_sqq" data-cmd="sqq" title="分享到QQ好友"></a><a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a><a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a><a href="#" class="bds_tieba" data-cmd="tieba" title="分享到百度贴吧"></a><a href="#" class="bds_twi" data-cmd="twi" title="分享到Twitter"></a><a href="#" class="bds_fbook" data-cmd="fbook" title="分享到Facebook"></a><a href="#" class="bds_more" data-cmd="more"></a><a class="bds_count" data-cmd="count"></a></div><script>window._bd_share_config={common:{bdText:"",bdMini:"2",bdMiniList:!1,bdPic:""},share:{bdSize:"16",bdStyle:"0"},image:{viewList:["tsina","douban","sqq","qzone","weixin","twi","fbook"],viewText:"分享到：",viewSize:"16"}}</script><script>with(document)(getElementsByTagName("head")[0]||body).appendChild(createElement("script")).src="/static/api/js/share.js?cdnversion="+~(-new Date/36e5)</script></div></div></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/articles/1071f0bc.html" rel="next" title="hexo最新next主题个性化炫酷教程"><i class="fa fa-chevron-left"></i> hexo最新next主题个性化炫酷教程</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"> <a href="/articles/9655b613.html" rel="prev" title="阿里Java神级诊断工具arthas">阿里Java神级诊断工具arthas<i class="fa fa-chevron-right"></i></a></div></div></footer></div></article></div></div><div class="comments" id="gitalk-container"></div><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><ins class="adsbygoogle" style="display:inline-block;width:200px;height:200px" data-ad-client="ca-pub-6677803223619857" data-ad-slot="8792470846"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap"> 文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap"> 站点概览</li></ul><div class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" src="/images/me.jpg" alt="WanDouDuoDuo"><p class="site-author-name" itemprop="name">WanDouDuoDuo</p><p class="site-description motion-element" itemprop="description">沪漂资深运维架构师的呕心笔记</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">131</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/index.html"><span class="site-state-item-count">36</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/index.html"><span class="site-state-item-count">45</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/wandouduoduo" title="GitHub &rarr; https://github.com/wandouduoduo" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:wandouduoduo@163.com" title="E-Mail &rarr; mailto:wandouduoduo@163.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i> E-Mail</a></span><span class="links-of-author-item"><a href="https://gitee.com/wandouduoduo" title="Gitee &rarr; https://gitee.com/wandouduoduo" rel="noopener" target="_blank"><i class="fa fa-fw fa-heartbeat"></i> Gitee</a></span><span class="links-of-author-item"><a href="https://weibo.com/u/1989032071/home?topnav=1&wvr=6" title="微博 &rarr; https://weibo.com/u/1989032071/home?topnav=1&wvr=6" rel="noopener" target="_blank"><i class="fa fa-fw fa-weibo"></i> 微博</a></span></div><div class="links-of-blogroll motion-element links-of-blogroll-inline"><div class="links-of-blogroll-title"><i class="fa fa-fw fa-link"></i> 友情链接</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"> <a href="https://www.runoob.com/" title="https://www.runoob.com/" rel="noopener" target="_blank">菜鸟教程</a></li><li class="links-of-blogroll-item"> <a href="https://code.ziqiangxuetang.com/" title="https://code.ziqiangxuetang.com/" rel="noopener" target="_blank">自强学堂</a></li><li class="links-of-blogroll-item"> <a href="http://www.zsythink.net/" title="http://www.zsythink.net/" rel="noopener" target="_blank">朱双印博客</a></li><li class="links-of-blogroll-item"> <a href="http://www.ypk1226.com/" title="http://www.ypk1226.com/" rel="noopener" target="_blank">于佩康博客</a></li><li class="links-of-blogroll-item"> <a href="https://www.dgstack.cn/" title="https://www.dgstack.cn/" rel="noopener" target="_blank">逗哥架构师之路</a></li></ul></div></div></div><div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#官方介绍"><span class="nav-number">1.</span> <span class="nav-text">官方介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#特点："><span class="nav-number">2.</span> <span class="nav-text">特点：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#架构图："><span class="nav-number">3.</span> <span class="nav-text">架构图：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#监控指标"><span class="nav-number">4.</span> <span class="nav-text">监控指标</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#数据流程图："><span class="nav-number">5.</span> <span class="nav-text">数据流程图：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装准备"><span class="nav-number">6.</span> <span class="nav-text">安装准备</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#系统环境：centos7-6"><span class="nav-number">6.1.</span> <span class="nav-text">系统环境：centos7.6</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装一些系统常用软件"><span class="nav-number">6.2.</span> <span class="nav-text">安装一些系统常用软件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装pip"><span class="nav-number">6.3.</span> <span class="nav-text">安装pip</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装数据库"><span class="nav-number">6.4.</span> <span class="nav-text">安装数据库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装redis"><span class="nav-number">6.5.</span> <span class="nav-text">安装redis</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装go环境（若使用编译好的二进制文件，此步骤可忽略）"><span class="nav-number">6.6.</span> <span class="nav-text">安装go环境（若使用编译好的二进制文件，此步骤可忽略）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#初始化数据库"><span class="nav-number">6.7.</span> <span class="nav-text">初始化数据库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#下载编译好的组件"><span class="nav-number">6.8.</span> <span class="nav-text">下载编译好的组件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#开始安装"><span class="nav-number">7.</span> <span class="nav-text">开始安装</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#第一部分：绘图组件安装"><span class="nav-number">7.1.</span> <span class="nav-text">第一部分：绘图组件安装</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#组件列表："><span class="nav-number">7.1.0.1.</span> <span class="nav-text">组件列表：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#安装Agent"><span class="nav-number">7.1.0.2.</span> <span class="nav-text">安装Agent</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#安装Transfer"><span class="nav-number">7.1.0.3.</span> <span class="nav-text">安装Transfer</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#安装Graph"><span class="nav-number">7.1.0.4.</span> <span class="nav-text">安装Graph</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#安装Query"><span class="nav-number">7.1.0.5.</span> <span class="nav-text">安装Query</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#安装Dashboard"><span class="nav-number">7.1.0.6.</span> <span class="nav-text">安装Dashboard</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#安装Task"><span class="nav-number">7.1.0.7.</span> <span class="nav-text">安装Task</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#第二部分：报警组件安装"><span class="nav-number">7.2.</span> <span class="nav-text">第二部分：报警组件安装</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#组件列表：-1"><span class="nav-number">7.2.0.1.</span> <span class="nav-text">组件列表：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#报警准备：mail-provider-amp-sms-provider"><span class="nav-number">7.2.0.2.</span> <span class="nav-text">报警准备：mail-provider &amp; sms-provider</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#安装使用mail-provider"><span class="nav-number">7.2.0.3.</span> <span class="nav-text">安装使用mail-provider</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#建立sms-provider"><span class="nav-number">7.2.0.4.</span> <span class="nav-text">建立sms-provider</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#安装alarm"><span class="nav-number">7.2.0.5.</span> <span class="nav-text">安装alarm</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#安装sender"><span class="nav-number">7.2.0.6.</span> <span class="nav-text">安装sender</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#安装fe"><span class="nav-number">7.2.0.7.</span> <span class="nav-text">安装fe</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#安装portal"><span class="nav-number">7.2.0.8.</span> <span class="nav-text">安装portal</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#安装HBS-heartbeat-Server"><span class="nav-number">7.2.0.9.</span> <span class="nav-text">安装HBS(heartbeat Server)</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#安装judge"><span class="nav-number">7.2.0.10.</span> <span class="nav-text">安装judge</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#安装Links"><span class="nav-number">7.2.0.11.</span> <span class="nav-text">安装Links</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#安装Nodata"><span class="nav-number">7.2.0.12.</span> <span class="nav-text">安装Nodata</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#安装Aggregator"><span class="nav-number">7.2.0.13.</span> <span class="nav-text">安装Aggregator</span></a></li></ol></li></ol><li class="nav-item nav-level-2"><a class="nav-link" href="#使用方法"><span class="nav-number">8.</span> <span class="nav-text">使用方法</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#查看监控数据"><span class="nav-number">8.0.0.1.</span> <span class="nav-text">查看监控数据</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#配置报警策略"><span class="nav-number">8.0.0.2.</span> <span class="nav-text">配置报警策略</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#创建HostGroup"><span class="nav-number">8.0.0.3.</span> <span class="nav-text">创建HostGroup</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#创建策略模板"><span class="nav-number">8.0.0.4.</span> <span class="nav-text">创建策略模板</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#将HostGroup与模板绑定"><span class="nav-number">8.0.0.5.</span> <span class="nav-text">将HostGroup与模板绑定</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#补充"><span class="nav-number">8.0.0.6.</span> <span class="nav-text">补充</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#如何配置策略表达式"><span class="nav-number">8.0.0.7.</span> <span class="nav-text">如何配置策略表达式</span></a></li></ol></li></div></div></div><script type="text/javascript" charset="utf-8" src="/js/tagcloud.js"></script><script type="text/javascript" charset="utf-8" src="/js/tagcanvas.js"></script><div class="widget-wrap"><div id="myCanvasContainer" class="widget tagcloud"><canvas width="250" height="250" id="resCanvas" style=""><ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Ai/">Ai</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Ansible/">Ansible</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cloud/">Cloud</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cmdb/">Cmdb</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Confd/">Confd</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Confluence/">Confluence</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Dns/">Dns</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/">Docker</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Elasticsearch/">Elasticsearch</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Elk/">Elk</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Experiences/">Experiences</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Flask/">Flask</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Git/">Git</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GlusterFS/">GlusterFS</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Go/">Go</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Haproxy/">Haproxy</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hexo/">Hexo</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Http/">Http</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Iptables/">Iptables</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/">Java</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Jenkins/">Jenkins</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kali/">Kali</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Keepalived/">Keepalived</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MongoDB/">MongoDB</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mysql/">Mysql</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Network/">Network</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nginx/">Nginx</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Open-falcon/">Open-falcon</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Openldap/">Openldap</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PostgreSQL/">PostgreSQL</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Prometheus/">Prometheus</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python/">Python</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis/">Redis</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RocketChat/">RocketChat</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Sentry/">Sentry</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Shell/">Shell</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Stackstorm/">Stackstorm</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Supervisor/">Supervisor</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Tomcat/">Tomcat</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Uwsgi/">Uwsgi</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Web/">Web</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Windows/">Windows</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Zabbix/">Zabbix</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Zookeeper/">Zookeeper</a><span class="tag-list-count">1</span></li></ul></canvas></div></div><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><ins class="adsbygoogle" style="display:inline-block;width:200px;height:200px" data-ad-client="ca-pub-6677803223619857" data-ad-slot="8792470846"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; 2019 – <span itemprop="copyrightYear">2020</span><span class="with-love" id="animate"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">WanDouDuoDuo</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-area-chart"></i></span> <span class="post-meta-item-text">站点总字数：</span> <span title="站点总字数">709k</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span class="post-meta-item-text">站点阅读时长 &asymp;</span> <span title="站点阅读时长">10:45</span></div><div class="theme-info"><div class="powered-by"></div> <span class="post-count">博客全站共294.2k字</span></div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script> <span class="post-meta-item-icon"><i class="fa fa-user">访问人数:</i></span><span class="site-uv" title="总访客量"><span class="busuanzi-value" id="busuanzi_value_site_uv"></span></span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-eye">总阅读量:</i></span><span class="site-pv" title="总访问量"><span class="busuanzi-value" id="busuanzi_value_site_pv"></span></span></div><div><script type="text/javascript">var cnzz_protocol="https:"==document.location.protocol?"https://":"http://";document.write(unescape("%3Cspan id='cnzz_stat_icon_1277740757'%3E%3C/span%3E%3Cscript src='"+cnzz_protocol+"s23.cnzz.com/z_stat.php%3Fid%3D1277740757%26online%3D1%26show%3Dline' type='text/javascript'%3E%3C/script%3E"))</script></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script>"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script color="255,255,255" opacity="1" zindex="-1" count="150" src="/lib/canvas-nest/canvas-nest.min.js"></script><script src="/lib/jquery/index.js?v=2.1.3"></script><script src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script src="/js/src/utils.js?v=6.7.0"></script><script src="/js/src/motion.js?v=6.7.0"></script><script src="/js/src/affix.js?v=6.7.0"></script><script src="/js/src/schemes/pisces.js?v=6.7.0"></script><script src="/js/src/scrollspy.js?v=6.7.0"></script><script src="/js/src/post-details.js?v=6.7.0"></script><script src="/js/src/bootstrap.js?v=6.7.0"></script><script src="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css"><script src="//cdn.jsdelivr.net/npm/js-md5@0.7.3/src/md5.min.js"></script><script>var gitalk=new Gitalk({clientID:"ad83725549e82facce82",clientSecret:"b67c2056b52d0447f1d78f413f268a5b853e8a6e",repo:"wandouduoduo.github.io",owner:"wandouduoduo",admin:["wandouduoduo"],id:md5(location.pathname),distractionFreeMode:"true"});gitalk.render("gitalk-container")</script><script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><style>.copy-btn{display:inline-block;padding:6px 12px;font-size:13px;font-weight:700;line-height:20px;color:#333;white-space:nowrap;vertical-align:middle;cursor:pointer;background-color:#eee;background-image:linear-gradient(#fcfcfc,#eee);border:1px solid #d5d5d5;border-radius:3px;user-select:none;outline:0}.highlight-wrap .copy-btn{transition:opacity .3s ease-in-out;opacity:0;padding:2px 6px;position:absolute;right:4px;top:8px}.highlight-wrap .copy-btn:focus,.highlight-wrap:hover .copy-btn{opacity:1}.highlight-wrap{position:relative}</style><script>$(".highlight").each(function(e,t){var n=$("<div>").addClass("highlight-wrap");$(t).after(n),n.append($("<button>").addClass("copy-btn").append("复制").on("click",function(e){var t=$(this).parent().find(".code").find(".line").map(function(e,t){return $(t).text()}).toArray().join("\n"),n=document.createElement("textarea"),o=document.createRange(),a=window.getSelection(),i=window.pageYOffset||document.documentElement.scrollTop;n.style.top=i+"px",n.style.position="absolute",n.style.opacity="0",n.value=t,n.textContent=t,n.contentEditable=!0,n.readOnly=!1,document.body.appendChild(n),o.selectNode(n),a.removeAllRanges(),a.addRange(o),n.setSelectionRange(0,t.length),document.execCommand("copy")?$(this).text("复制成功"):$(this).text("复制失败"),n.blur(),$(this).blur()})).on("mouseleave",function(e){var t=$(this).find(".copy-btn");setTimeout(function(){t.text("复制")},300)}).append(t)})</script><canvas class="fireworks" style="position:fixed;left:0;top:0;z-index:1;pointer-events:none"></canvas><script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script><script type="text/javascript" src="/js/src/fireworks.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,debug:!1,model:{jsonPath:"/live2dw/assets/shizuku.model.json"},display:{position:"right",width:150,height:300},mobile:{show:!0},log:!1})</script></body></html>