<!DOCTYPE html><html class="theme-next gemini" lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><script src="//cdn.jsdelivr.net/npm/pace-js@1/pace.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/pace-js@1/themes/blue/pace-theme-minimal.css"><meta name="google-site-verification" content="27nKwb_oPifd-peB2Juh7eiKE-ZIpIcPp7ug9xPLKh4"><script data-ad-client="ca-pub-6677803223619857" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>
  window.onload = function() {
          setTimeout(function() {
                  let script = document.createElement("script");
                  script.setAttribute("async", "");
                  script.src = "//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js";
                  document.body.appendChild(script);
          }, 2e3);
  }
  </script><meta name="baidu-site-verification" content="2U3NKVcqUGdR2dZr"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4/css/font-awesome.min.css"><link rel="stylesheet" href="/css/main.css?v=6.7.0"><link rel="icon" type="image/png" sizes="32x32" href="//cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io/images/next-favicon-32.png?v=6.7.0"><link rel="icon" type="image/png" sizes="16x16" href="//cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io/images/next-favicon-16.png?v=6.7.0"><script id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Gemini",version:"6.7.0",sidebar:{position:"left",display:"post",offset:12,b2t:!0,scrollpercent:!0,onmobile:!1},fancybox:!1,fastclick:!1,lazyload:!1,tabs:!0,motion:{enable:!1,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><meta name="description" content="通过本文掌握什么是负载均衡及负载均衡的作用和意义；了解lvs负载均衡的三种模式；了解lvs-DR负载均衡部署方法；掌握nginx实现负载均衡的方法；掌握lvs+nginx负载均衡拓扑结构。"><meta name="keywords" content="Lvs"><meta property="og:type" content="article"><meta property="og:title" content="lvs负载均衡实战"><meta property="og:url" content="https://wandouduoduo.github.io/articles/17e1663a.html"><meta property="og:site_name" content="运维随笔"><meta property="og:description" content="通过本文掌握什么是负载均衡及负载均衡的作用和意义；了解lvs负载均衡的三种模式；了解lvs-DR负载均衡部署方法；掌握nginx实现负载均衡的方法；掌握lvs+nginx负载均衡拓扑结构。"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@master/articles/17e1663a/1.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@master/articles/17e1663a/2.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@master/articles/17e1663a/3.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@master/articles/17e1663a/4.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@master/articles/17e1663a/5.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@master/articles/17e1663a/6.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@master/articles/17e1663a/7.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@master/articles/17e1663a/31.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@master/articles/17e1663a/8.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@master/articles/17e1663a/9.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@master/articles/17e1663a/10.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@master/articles/17e1663a/11.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@master/articles/17e1663a/12.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@master/articles/17e1663a/13.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@master/articles/17e1663a/14.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@master/articles/17e1663a/15.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@master/articles/17e1663a/16.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@master/articles/17e1663a/17.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@master/articles/17e1663a/18.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@master/articles/17e1663a/19.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@master/articles/17e1663a/20.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@master/articles/17e1663a/21.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@master/articles/17e1663a/22.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@master/articles/17e1663a/23.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@master/articles/17e1663a/24.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@master/articles/17e1663a/25.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@master/articles/17e1663a/26.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@master/articles/17e1663a/27.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@master/articles/17e1663a/28.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@master/articles/17e1663a/29.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@master/articles/17e1663a/30.png"><meta property="og:updated_time" content="2021-04-20T07:35:26.203Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="lvs负载均衡实战"><meta name="twitter:description" content="通过本文掌握什么是负载均衡及负载均衡的作用和意义；了解lvs负载均衡的三种模式；了解lvs-DR负载均衡部署方法；掌握nginx实现负载均衡的方法；掌握lvs+nginx负载均衡拓扑结构。"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@master/articles/17e1663a/1.png"><link rel="alternate" href="/atom.xml" title="运维随笔" type="application/atom+xml"><link rel="canonical" href="https://wandouduoduo.github.io/articles/17e1663a.html"><script id="page.configurations">CONFIG.page={sidebar:""}</script><title>lvs负载均衡实战 | 运维随笔</title><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?a40bcdb5c2cd18d8294a08372dea701b";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-title,.use-motion .comments,.use-motion .menu-item,.use-motion .motion-element,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .logo,.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN"><link rel="stylesheet" href="/dist/APlayer.min.css"><div id="aplayer"></div><script type="text/javascript" src="/dist/APlayer.min.js"></script><script type="text/javascript" src="/dist/music.js"></script><div class="container sidebar-position-left page-post-detail"><div class="headband"></div> <a href="https://github.com/wandouduoduo" rel="external nofollow noreferrer" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewbox="0 0 250 250" style="fill:#fd6c6c;color:#fff;position:absolute;top:0;border:0;right:0" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"/></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">运维随笔</span><span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">SRE & Devops & Architect</h1></div><div class="site-nav-toggle"> <button aria-label="切换导航栏"><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>分类</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于</a></li><li class="menu-item menu-item-tools"><a href="/tools/" rel="section"><i class="menu-item-icon fa fa-fw fa-heartbeat"></i><br>工具</a></li><li class="menu-item menu-item-search"><a href="javascript:;" rel="external nofollow noreferrer" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i></span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"> <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://wandouduoduo.github.io/articles/17e1663a.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="豌豆多多"><meta itemprop="description" content="资深运维架构师豌豆多多的呕心笔记"><meta itemprop="image" content="/images/yunwei.png"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="运维随笔"></span><header class="post-header"><h2 class="post-title" itemprop="name headline">lvs负载均衡实战</h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2021-04-19 14:23:22" itemprop="dateCreated datePublished" datetime="2021-04-19T14:23:22+08:00">2021-04-19</time> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i></span> <span class="post-meta-item-text">更新于</span> <time title="修改时间：2021-04-20 15:35:26" itemprop="dateModified" datetime="2021-04-20T15:35:26+08:00">2021-04-20</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/运维技术/" itemprop="url" rel="index"><span itemprop="name">运维技术</span></a></span></span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-eye"></i> 阅读次数：<span class="busuanzi-value" id="busuanzi_value_page_pv"></span></span><div class="post-symbolscount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i></span> <span class="post-meta-item-text">本文字数：</span> <span title="本文字数">52k</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span title="阅读时长">47 分钟</span></div></div></header><div class="post-body" itemprop="articleBody"><div id="vip-container"><p>通过本文掌握什么是负载均衡及负载均衡的作用和意义；了解lvs负载均衡的三种模式；了解lvs-DR负载均衡部署方法；掌握nginx实现负载均衡的方法；掌握lvs+nginx负载均衡拓扑结构。</p><a id="more"></a><h2 id="负载均衡方案"><a href="#负载均衡方案" class="headerlink" title="负载均衡方案"></a>负载均衡方案</h2><h3 id="什么是负载均衡"><a href="#什么是负载均衡" class="headerlink" title="什么是负载均衡"></a>什么是负载均衡</h3><p> 一台普通服务器的处理能力是有限的，假如能达到每秒几万个到几十万个请求，但却无法在一秒钟内处理上百万个甚至更多的请求。但若能将多台这样的服务器组成一个系统，并通过软件技术将所有请求平均分配给所有服务器，那么这个系统就完全拥有每秒钟处理几百万个甚至更多请求的能力。这就是负载均衡最初的基本设计思想。</p><p>负载均衡是由多台服务器以对称的方式组成一个服务器集合，每台服务器都具有等价的地位，都可以单独对外提供服务而无须其他服务器的辅助。通过某种负载分担技术，将外部发送来的请求按照某种策略分配到服务器集合的某一台服务器上，而接收到请求的服务器独立地回应客户的请求。负载均衡解决了大量并发访问服务问题，其目的就是用最少的投资获得接近于大型主机的性能。</p><p> <img src="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@master/articles/17e1663a/1.png" alt="img"></p><h3 id="相关技术"><a href="#相关技术" class="headerlink" title="相关技术"></a>相关技术</h3><h4 id="基于DNS的负载均衡"><a href="#基于DNS的负载均衡" class="headerlink" title="基于DNS的负载均衡"></a>基于DNS的负载均衡</h4><p>DNS（Domain Name System，域名系统），因特网上作为域名和IP地址相互映射的一个分布式数据库，能够使用户更方便的访问互联网，而不用去记住能够被机器直接读取的IP数串。通过主机名，最终得到该主机名对应的IP地址的过程叫做域名解析（或主机名解析）。DNS协议运行在UDP协议之上，使用端口号53。</p><p>DNS负载均衡技术是最早的负载均衡解决方案，它是通过DNS服务中的随机名字解析来实现的，在DNS服务器中，可以为多个不同的地址配置同一个名字，而最终查询这个名字的客户机将在解析这个名字时得到其中的一个地址。因此，对于同一个名字，不同的客户机会得到不同的地址，它们也就访问不同地址上的Web服务器，从而达到负载均衡的目的。</p><p>如下图：</p><p> <img src="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@master/articles/17e1663a/2.png" alt="img"></p><p><strong>优点</strong></p><p>实现简单、实施容易、成本低、适用于大多数TCP/IP应用；</p><p><strong>缺点</strong></p><p>1、 负载分配不均匀，DNS服务器将Http请求平均地分配到后台的Web服务器上，而不考虑每个Web服务器当前的负载情况；如果后台的Web服务器的配置和处理能力不同，最慢的Web服务器将成为系统的瓶颈，处理能力强的服务器不能充分发挥作用；</p><p>2、可靠性低，如果后台的某台Web服务器出现故障，DNS服务器仍然会把DNS请求分配到这台故障服务器上，导致不能响应客户端。</p><p>3、变更生效时间长，如果更改NDS有可能造成相当一部分客户不能享受Web服务，并且由于DNS缓存的原因，所造成的后果要持续相当长一段时间(一般DNS的刷新周期约为24小时)。</p><h4 id="基于四层交换技术的负载均衡"><a href="#基于四层交换技术的负载均衡" class="headerlink" title="基于四层交换技术的负载均衡"></a>基于四层交换技术的负载均衡</h4><p>基于四层交换技术的负载均衡是通过报文中的目标地址和端口，再加上负载均衡设备设置的服务器选择方式，决定最终选择的内部服务器与请求客户端建立TCP连接，然后发送Client请求的数据。</p><p>如下图：</p><p>​ <img src="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@master/articles/17e1663a/3.png" alt="img"></p><p>client发送请求至4层负载均衡器，4层负载均衡器根据负载策略把client发送的报文目标地址(原来是负载均衡设备的IP地址)修改为后端服务器（可以是web服务器、邮件服务等）IP地址，这样client就可以直接跟后端服务器建立TCP连接并发送数据。</p><p>具有代表意义的产品：LVS（开源软件），F5（硬件）</p><p><strong>优点</strong></p><p>性能高、支持各种网络协议</p><p><strong>缺点</strong></p><p>对网络依赖较大，负载智能化方面没有7层负载好（比如不支持对url个性化负载），F5硬件性能很高但成本也高需要人民币几十万，对于小公司就望而却步了。</p><h4 id="基于七层交换技术的负载均衡"><a href="#基于七层交换技术的负载均衡" class="headerlink" title="基于七层交换技术的负载均衡"></a>基于七层交换技术的负载均衡</h4><p>基于七层交换技术的负载均衡也称内容交换，也就是主要通过报文中的真正有意义的应用层内容，再加上负载均衡设备设置的服务器选择方式，决定最终选择的服务器。</p><p>如下图：</p><p> <img src="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@master/articles/17e1663a/4.png" alt="img"></p><p>七层负载均衡服务器起了一个代理服务器的作用，client要访问webserver要先与七层负载设备进行三次握手后建立TCP连接，把要访问的报文信息发送给七层负载均衡；然后七层负载均衡再根据设置的均衡规则选择特定的webserver，然后通过三次握手与此台webserver建立TCP连接，然后webserver把需要的数据发送给七层负载均衡设备，负载均衡设备再把数据发送给client。</p><p>具有代表意义的产品：nginx（软件）、apache（软件）</p><p><strong>优点</strong></p><p>对网络依赖少，负载智能方案多（比如可根据不同的url进行负载）</p><p><strong>缺点</strong></p><p>网络协议有限，nginx和apache支持http负载，性能没有4层负载高</p><h3 id="确定使用四层-七层负载结合方案"><a href="#确定使用四层-七层负载结合方案" class="headerlink" title="确定使用四层+七层负载结合方案"></a>确定使用四层+七层负载结合方案</h3><p>四层负载使用lvs软件或F5硬件实现。</p><p>七层负载使用nginx实现。</p><p>如下图是lvs+nginx的拓扑结构：</p><p> <img src="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@master/articles/17e1663a/5.png" alt="img"></p><h3 id="nginx集群背景"><a href="#nginx集群背景" class="headerlink" title="nginx集群背景"></a>nginx集群背景</h3><p>在keepalived+nginx的主备容灾高可用的架构中，nginx是作为外部访问系统的唯一入口，理论上一台nginx的最大并发量可以高达50000，但是当并发量更大的时候，keepalived+nginx的高可用机制是没办法满足需求的，因为keepalived+nginx的架构中确确实实是一台nginx在工作，只有当master宕机或异常时候，备份机才会上位。那么如何解决更大的高并发问题呢，也许会问能不能搭建nginx集群，直接对外提供访问？</p><p>很显然这是欠妥当的，因为当nginx作为外部的唯一访问入口，没办法直接以集群的形式对外提供服务，没有那么多的公网ip资源可用，既太浪费也不友好。但是在内网环境下，是可以用nginx集群（nginx横向扩展服务集合）的，当然总得有一个对外入口，所以需要在nginx集群之上，在加一层负载均衡器，作为系统的唯一入口。</p><h2 id="lvs实现四层负载DR模式"><a href="#lvs实现四层负载DR模式" class="headerlink" title="lvs实现四层负载DR模式"></a>lvs实现四层负载DR模式</h2><h3 id="什么是lvs"><a href="#什么是lvs" class="headerlink" title="什么是lvs"></a>什么是lvs</h3><p>LVS是Linux Virtual Server的简写，意即Linux虚拟服务器，是一个虚拟的服务器集群系统。本项目在1998年5月由章文嵩博士成立，是中国国内最早出现的自由软件项目之一。</p><h3 id="lvs实现负载的三种方式"><a href="#lvs实现负载的三种方式" class="headerlink" title="lvs实现负载的三种方式"></a>lvs实现负载的三种方式</h3><p>运行 lPVS软件的服务器，在整个负载均衡集群中承担一调度角色 软件的服务器，（即 向真实服务器分配从客户端过来的请求。LVS中的调度方法有三种 ：NAT（Network Address Translation网络地址转换）、TUN（tunnel 隧道）、DR（direct route 直接路由）</p><h3 id="LVS-DR-模式"><a href="#LVS-DR-模式" class="headerlink" title="LVS-DR 模式"></a>LVS-DR 模式</h3><p> <img src="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@master/articles/17e1663a/6.png" alt="img"></p><p>请求由LVS接受，由真实提供服务的服务器(RealServer, RS)直接返回给用户，返回的时候不经过LVS。</p><p>DR模式下需要LVS服务器和RS绑定同一个VIP， 一个请求过来时，LVS只需要将网络帧的MAC地址修改为某一台RS的MAC，该包就会被转发到相应的RS处理，注意此时的源IP和目标IP都没变，RS收到LVS转发来的包，发现MAC是自己的，发现IP也是自己的，于是这个包被合法地接受，而当RS返回响应时，只要直接向源IP(即用户的IP)返回即可，不再经过LVS。</p><p>DR模式下，lvs接收请求输入，将请求转发给RS，由RS输出响应给用户，性能非常高。</p><p>它的不足之处是要求负载均衡器与RS在一个物理段上。</p><h3 id="LVS-NAT模式"><a href="#LVS-NAT模式" class="headerlink" title="LVS-NAT模式"></a>LVS-NAT模式</h3><p> <img src="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@master/articles/17e1663a/7.png" alt="img"></p><p>NAT(Network Address Translation)是一种外网和内网地址映射的技术。NAT模式下，LVS需要作为RS的网关，当网络包到达LVS时，LVS做目标地址转换(DNAT)，将目标IP改为RS的IP。RS接收到包以后，处理完，返回响应时，源IP是RS IP，目标IP是客户端的IP，这时RS的包通过网关(LVS)中转，LVS会做源地址转换(SNAT)，将包的源地址改为VIP，对于客户端只知道是LVS直接返回给它的。</p><p>NAT模式请求和响应都需要经过lvs，性能没有DR模式好。</p><h3 id="LVS-TUN模式"><a href="#LVS-TUN模式" class="headerlink" title="LVS-TUN模式"></a>LVS-TUN模式</h3><p><img src="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@master/articles/17e1663a/31.png" alt="img"></p><p>TUN模式是通过ip隧道技术减轻lvs调度服务器的压力，许多Internet服务（例如WEB服务器）的请求包很短小，而应答包通常很大，负载均衡器只负责将请求包分发给物理服务器，而物理服务器将应答包直接发给用户。所以，负载均衡器能处理很巨大的请求量。相比NAT性能要高的多，比DR模式的优点是不限制负载均衡器与RS在一个物理段上。但是它的不足需要所有的服务器（lvs、RS）支持”IP Tunneling”(IP Encapsulation)协议。</p><h2 id="lvs-DR实战"><a href="#lvs-DR实战" class="headerlink" title="lvs-DR实战"></a>lvs-DR实战</h2><p>vip：192.168.101.100</p><p>lvs-director：192.168.101.8</p><p>nginx1：192.168.101.3</p><p>nginx2：192.168.101.4</p><h3 id="lvs调度服务器Director安装"><a href="#lvs调度服务器Director安装" class="headerlink" title="lvs调度服务器Director安装"></a>lvs调度服务器Director安装</h3><h4 id="安装lvs"><a href="#安装lvs" class="headerlink" title="安装lvs"></a>安装lvs</h4><p>在192.168.101.8上安装lvs</p><p>centos6.5自带lvs，检查linux内核是否集成lvs模块：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">modprobe -l | grep ipvs</span><br></pre></td></tr></table></figure><p> <img src="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@master/articles/17e1663a/8.png" alt="img"></p><h4 id="安装lvs的管理工具ipvsadm"><a href="#安装lvs的管理工具ipvsadm" class="headerlink" title="安装lvs的管理工具ipvsadm"></a>安装lvs的管理工具ipvsadm</h4><ul><li>安装依赖</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y gcc gcc-c++ makepcre pcre-devel kernel-devel openssl-devel libnl-devel popt*</span><br></pre></td></tr></table></figure><ul><li>安装ipvsadm</li></ul><p>将ipvsadm-1.26.tar.gz拷贝至/usr/local/下</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span></span><br><span class="line">tar -zxvf ipvsadm-1.26.tar.gz</span><br><span class="line"><span class="built_in">cd</span> ipvsadm-1.26</span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line">或者</span><br><span class="line">yum install ipvsadm -y</span><br></pre></td></tr></table></figure><p>校验是否安装成功：</p><p> <img src="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@master/articles/17e1663a/9.png" alt="img"></p><h4 id="真实服务器Real-Server安装"><a href="#真实服务器Real-Server安装" class="headerlink" title="真实服务器Real Server安装"></a>真实服务器Real Server安装</h4><p>在192.168.101.3和192.168.101.4上安装nginx。</p><p><strong>nginx配置文件</strong></p><p>创建nginx-lvs.conf，http内容如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line"></span><br><span class="line">    include       mime.types;</span><br><span class="line"></span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line"></span><br><span class="line">        listen       80;</span><br><span class="line"></span><br><span class="line">        server_name  localhost;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line"></span><br><span class="line">            root   html;</span><br><span class="line"></span><br><span class="line">            index  index.html index.htm;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="Director-Server配置"><a href="#Director-Server配置" class="headerlink" title="Director Server配置"></a>Director Server配置</h3><h4 id="在eth0上绑定虚拟ip"><a href="#在eth0上绑定虚拟ip" class="headerlink" title="在eth0上绑定虚拟ip"></a>在eth0上绑定虚拟ip</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ifconfig eth0:0 192.168.101.100 broadcast 192.168.101.100 netmask 255.255.255.255 up</span><br></pre></td></tr></table></figure><p>此处在eth0设备上绑定了一个虚拟设备eth0:0，同时设置了一个虚拟IP是<em>192.168.101.100</em>，然后指定广播地址也为<em>192.168.101.100</em>，需要特别注意的是，虚拟ip地址的广播地址是它本身，子网掩码是255.255.255.255。</p><p> <img src="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@master/articles/17e1663a/10.png" alt="img"></p><h4 id="添加路由规则"><a href="#添加路由规则" class="headerlink" title="添加路由规则"></a>添加路由规则</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">route add -host 192.168.101.100 dev eth0:0</span><br></pre></td></tr></table></figure><h4 id="启用系统的包转发功能"><a href="#启用系统的包转发功能" class="headerlink" title="启用系统的包转发功能"></a>启用系统的包转发功能</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"1"</span> &gt;/proc/sys/net/ipv4/ip_forward</span><br></pre></td></tr></table></figure><p>参数值为1时启用ip转发，为0时禁止ip转发。</p><h4 id="清除原有转发规则"><a href="#清除原有转发规则" class="headerlink" title="清除原有转发规则"></a>清除原有转发规则</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipvsadm --clear</span><br></pre></td></tr></table></figure><h4 id="添加虚拟IP规则"><a href="#添加虚拟IP规则" class="headerlink" title="添加虚拟IP规则"></a>添加虚拟IP规则</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipvsadm -A -t 192.168.101.100:80 -s rr</span><br></pre></td></tr></table></figure><p> -s rr表示采用轮询策略。</p><p>:80表示负载转发的端口是80</p><h4 id="在虚拟IP中添加服务规则"><a href="#在虚拟IP中添加服务规则" class="headerlink" title="在虚拟IP中添加服务规则"></a>在虚拟IP中添加服务规则</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ipvsadm -a -t 192.168.101.100:80 -r 192.168.101.3:80 -g</span><br><span class="line">ipvsadm -a -t 192.168.101.100:80 -r 192.168.101.4:80 -g</span><br></pre></td></tr></table></figure><p>在新加虚拟IP记录中添加两条新的Real Server记录，-g表示指定LVS 的工作模式为直接路由模式。</p><p>lvs进行负载转发需要保证lvs负载的端口要和nginx服务的端口的一致，这里都为80。</p><h4 id="重启lvs"><a href="#重启lvs" class="headerlink" title="重启lvs"></a>重启lvs</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipvsadm</span><br></pre></td></tr></table></figure><p> <img src="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@master/articles/17e1663a/11.png" alt="img"></p><h3 id="Real-Server配置"><a href="#Real-Server配置" class="headerlink" title="Real Server配置"></a>Real Server配置</h3><p>在lvs的DR和TUn模式下，用户的访问请求到达真实服务器后，是直接返回给用户的，而不再经过前端的Director Server，因此，就需要在每个Real server节点上增加虚拟的VIP地址，这样数据才能直接返回给用户。</p><h4 id="在回环设备上绑定了一个虚拟IP地址"><a href="#在回环设备上绑定了一个虚拟IP地址" class="headerlink" title="在回环设备上绑定了一个虚拟IP地址"></a>在回环设备上绑定了一个虚拟IP地址</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ifconfig lo:0 192.168.101.100 broadcast 192.168.101.100 netmask 255.255.255.255 up</span><br><span class="line">/sbin/route add -host 192.168.101.100 dev lo:0</span><br></pre></td></tr></table></figure><p> <img src="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@master/articles/17e1663a/12.png" alt="img"></p><h4 id="关闭arp解析"><a href="#关闭arp解析" class="headerlink" title="关闭arp解析"></a>关闭arp解析</h4><p>arp_announce ：定义不同级别：当ARP请求通过某个端口进来是否利用这个接口来回应。</p><p>​ 0 -利用本地的任何地址，不管配置在哪个接口上去响应ARP请求；</p><p>​ 1 - 避免使用另外一个接口上的mac地址去响应ARP请求；</p><p>​ 2 - 尽可能使用能够匹配到ARP请求的最佳地址。</p><p>arp_ignore：当ARP请求发过来后发现自己正是请求的地址是否响应；</p><p>​ 0 - 利用本地的任何地址，不管配置在哪个接口上去响应ARP请求；</p><p>​ 1 - 哪个接口上接受ARP请求，就从哪个端口上回应。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"1"</span> &gt;/proc/sys/net/ipv4/conf/lo/arp_ignore</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"2"</span> &gt;/proc/sys/net/ipv4/conf/lo/arp_announce </span><br><span class="line"><span class="built_in">echo</span> <span class="string">"1"</span> &gt;/proc/sys/net/ipv4/conf/all/arp_ignore</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"2"</span> &gt;/proc/sys/net/ipv4/conf/all/arp_announce </span><br><span class="line"></span><br><span class="line">sysctl -p <span class="comment">#使用修改生效</span></span><br></pre></td></tr></table></figure><p> <img src="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@master/articles/17e1663a/13.png" alt="img"></p><h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><h4 id="预期目标"><a href="#预期目标" class="headerlink" title="预期目标"></a>预期目标</h4><p>由于lvs设置为rr轮询策略，当访问虚IP <a href="http://192.168.101.100，每次刷新请求通过lvs负载到不同的服务器。" rel="noopener external nofollow noreferrer" target="_blank">http://192.168.101.100，每次刷新请求通过lvs负载到不同的服务器。</a></p><h4 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h4><p>1、测试时需要在nginx的http中设置keepalive_timeout 0; 取消使用http持久连接模式，保证每次客户端发起请求都需要向服务端建立连接，这样做是为了每次刷新页面都要经过lvs负载转发。</p><p>2、lvs进行负载转发需要保证lvs负载的端口要和nginx服务的端口的一致，这里都为80。</p><p>keepalive_timeout说明：</p><p>在nginx中keepalive_timeout的默认值是75秒，默认使用http持久连接模式，可使客户端到服务器端的连接持续有效，当出现对服务器的后继请求时，可避免建立或重新建立连接。生产环境建议keepalive_timeout不要设置为0。</p><h4 id="测试过程"><a href="#测试过程" class="headerlink" title="测试过程"></a>测试过程</h4><p>修改192.168.101.3和192.168.101.4下html目录中index.html的内容使之个性化。</p><p>第一次请求：<a href="http://192.168.101.100" rel="noopener external nofollow noreferrer" target="_blank">http://192.168.101.100</a></p><p> <img src="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@master/articles/17e1663a/14.png" alt="img"></p><p>刷新，相当于第二次请求：</p><p> <img src="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@master/articles/17e1663a/15.png" alt="img"></p><p>依次交替测试，发现每次请求被负载到不同的nginx上。</p><p>任意停止掉一个nginx，请求<a href="http://192.168.101.100继续可以浏览，由于lvs采用轮询策略如果其中一个nginx请求不可到达则去请求另外的nginx。" rel="noopener external nofollow noreferrer" target="_blank">http://192.168.101.100继续可以浏览，由于lvs采用轮询策略如果其中一个nginx请求不可到达则去请求另外的nginx。</a></p><h3 id="脚本封装"><a href="#脚本封装" class="headerlink" title="脚本封装"></a>脚本封装</h3><p>为了方便配置启动lvs将上边Director Server和Real Server的配置过程封装在shell脚本中。</p><h4 id="Director-Server配置-1"><a href="#Director-Server配置-1" class="headerlink" title="Director Server配置"></a>Director Server配置</h4><p>在/etc/init.d下创建lvsdr，内容如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="comment"># 定义虚拟ip</span></span><br><span class="line">VIP=192.168.101.100 <span class="comment">#虚拟 ip根据需求修改</span></span><br><span class="line"><span class="comment"># 定义realserver,并已空格分开，根据需求修改</span></span><br><span class="line">RIPS=<span class="string">"192.168.101.3 192.168.101.4"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义提供服务的端口</span></span><br><span class="line">SERVICE=80</span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用init.d脚本的标准库</span></span><br><span class="line">. /etc/rc.d/init.d/<span class="built_in">functions</span></span><br><span class="line"><span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span></span><br><span class="line">        start)</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"Start LVS of DR Mode"</span></span><br><span class="line">        <span class="comment"># 开启ip转发</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"1"</span> &gt; /proc/sys/net/ipv4/ip_forward</span><br><span class="line">        <span class="comment"># 绑定虚拟ip</span></span><br><span class="line">        ifconfig eth0:0 <span class="variable">$VIP</span> broadcast <span class="variable">$VIP</span> netmask 255.255.255.255 up</span><br><span class="line">        route add -host <span class="variable">$VIP</span> dev eth0:0</span><br><span class="line">        <span class="comment"># 清除lvs规则</span></span><br><span class="line">        ipvsadm -C</span><br><span class="line">        <span class="comment"># 添加一条虚拟服务器记录</span></span><br><span class="line">    <span class="comment"># -p指定一定的时间内将相同的客户端分配到同一台后端服务器</span></span><br><span class="line">    <span class="comment"># 用于解决session的问题,测试时或有别的解决方案时建议去掉</span></span><br><span class="line">        ipvsadm -A -t <span class="variable">$VIP</span>:<span class="variable">$SERVICE</span> -s rr</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 添加真实服务器记录</span></span><br><span class="line">        <span class="keyword">for</span> RIP <span class="keyword">in</span> <span class="variable">$RIPS</span></span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="variable">$RIP</span>:<span class="variable">$SERVICE</span>;</span><br><span class="line">                ipvsadm -a -t <span class="variable">$VIP</span>:<span class="variable">$SERVICE</span> -r <span class="variable">$RIP</span>:<span class="variable">$SERVICE</span> -g</span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line">        <span class="comment"># 设置tcp tcpfin  udp的超时连接值</span></span><br><span class="line">        ipvsadm --<span class="built_in">set</span> 30 120 300</span><br><span class="line">        ipvsadm</span><br><span class="line">        ;;</span><br><span class="line"></span><br><span class="line">        stop)</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"Stop LVS DR"</span></span><br><span class="line">        ifconfig eth0:0 down</span><br><span class="line">        ipvsadm -C</span><br><span class="line">        ;;</span><br><span class="line">        *)</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"Usage:<span class="variable">$0</span> &#123;start ¦ stop&#125;"</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">esac</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#修改脚本权限：</span></span><br><span class="line">chmod +x /etc/init.d/lvsdr</span><br><span class="line"><span class="comment">#启动Director server：</span></span><br><span class="line">service lvsdr start</span><br><span class="line"><span class="comment">#停止Director server：</span></span><br><span class="line">service lvsdr stop</span><br></pre></td></tr></table></figure><h4 id="Real-Server配置-1"><a href="#Real-Server配置-1" class="headerlink" title="Real Server配置"></a>Real Server配置</h4><p>在/etc/init.d下创建lvsdr，内容如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">VIP=192.168.101.100 <span class="comment">#虚拟ip，根据需求修改</span></span><br><span class="line">. /etc/rc.d/init.d/<span class="built_in">functions</span></span><br><span class="line"><span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span></span><br><span class="line">        start)</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"lo:0 port starting"</span></span><br><span class="line">        <span class="comment"># 为了相应lvs调度器转发过来的包,需在本地lo接口上绑定vip</span></span><br><span class="line">        ifconfig lo:0 <span class="variable">$VIP</span> broadcast <span class="variable">$VIP</span> netmask 255.255.255.255 up</span><br><span class="line">        <span class="comment"># 限制arp请求</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"1"</span> &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"2"</span> &gt; /proc/sys/net/ipv4/conf/lo/arp_announce</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"1"</span> &gt; /proc/sys/net/ipv4/conf/all/arp_ignore</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"2"</span> &gt; /proc/sys/net/ipv4/conf/all/arp_announce</span><br><span class="line">        ;;</span><br><span class="line">        stop)</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"lo:0 port closing"</span></span><br><span class="line">        ifconfig lo:0 down</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"0"</span> &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"0"</span> &gt; /proc/sys/net/ipv4/conf/lo/arp_announce</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"0"</span> &gt; /proc/sys/net/ipv4/conf/all/arp_ignore</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"0"</span> &gt; /proc/sys/net/ipv4/conf/all/arp_announce</span><br><span class="line">        ;;</span><br><span class="line">        *)</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"Usage: <span class="variable">$0</span> &#123;start ¦ stop&#125;"</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">esac</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#修改脚本权限：</span></span><br><span class="line">chmod +x /etc/init.d/lvsdr</span><br><span class="line"><span class="comment">#启动real server：</span></span><br><span class="line">service lvsdr start</span><br><span class="line"><span class="comment">#停止real server：</span></span><br><span class="line">service lvsdr stop</span><br></pre></td></tr></table></figure><h2 id="lvs四层-nginx七层负载均衡"><a href="#lvs四层-nginx七层负载均衡" class="headerlink" title="lvs四层+nginx七层负载均衡"></a>lvs四层+nginx七层负载均衡</h2><h3 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h3><p>lvs采用DR模式基本上没有性能瓶颈，用户请求输入至lvs经过负载转发到后台服务上，通过后台服务输出响应给用户。nginx的负载性能远没有lvs好，lvs四层+nginx七层负载的好处是最前端是lvs接收请求进行负载转发，由多个nginx共同完成七层负载，这样nginx的负载性能就可以线性扩展。</p><h3 id="准备环境"><a href="#准备环境" class="headerlink" title="准备环境"></a>准备环境</h3><p>vip：192.168.101.100</p><p>lvs-director：192.168.101.8</p><p>nginx1：192.168.101.3 安装nginx</p><p>nginx2：192.168.101.4 安装nginx</p><p>tomcat1：192.168.101.5 安装tomcat</p><p>tomcat2：192.168.101.6 安装tomcat</p><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><h4 id="Director-Server配置-2"><a href="#Director-Server配置-2" class="headerlink" title="Director Server配置"></a>Director Server配置</h4><p>vip：192.168.101.100</p><p>lvs-director：192.168.101.8</p><p>参考lvs四层负载DR模式进行配置</p><h4 id="Real-Server配置-2"><a href="#Real-Server配置-2" class="headerlink" title="Real Server配置"></a>Real Server配置</h4><p>nginx1：192.168.101.3 安装nginx</p><p>nginx2：192.168.101.4 安装nginx</p><p>参考lvs四层负载DR模式进行配置，需要修改nginx的配置文件使每个nginx对两个tomcat进行负载，如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    include       mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line">    sendfile        on;</span><br><span class="line"></span><br><span class="line">   upstream tomcat_server_pool&#123;</span><br><span class="line">        server 192.168.101.5:8080 weight=10;</span><br><span class="line">        server 192.168.101.6:8080 weight=10;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen 80;</span><br><span class="line">        server_name localhost;</span><br><span class="line">        location / &#123;</span><br><span class="line">                 proxy_pass http://tomcat_server_pool;</span><br><span class="line">                 index index.jsp index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h3><p>请求<a href="http://192.168.101.100，lvs负载到不同的nginx上，如果停止任意一台nginx或停止任意一台tomcat不影响访问。" rel="noopener external nofollow noreferrer" target="_blank">http://192.168.101.100，lvs负载到不同的nginx上，如果停止任意一台nginx或停止任意一台tomcat不影响访问。</a></p><h2 id="lvs高可用-了解"><a href="#lvs高可用-了解" class="headerlink" title="lvs高可用(了解)"></a>lvs高可用(了解)</h2><h3 id="什么是高可用"><a href="#什么是高可用" class="headerlink" title="什么是高可用"></a>什么是高可用</h3><p>lvs作为负载均衡器，所有请求都先到达lvs，可见lvs处于非常重要的位置，如果lvs服务器宕机后端web服务将无法提供服务，影响严重。</p><p>为了屏蔽负载均衡服务器的宕机，需要建立一个备份机。主服务器和备份机上都运行高可用（High Availability）监控程序，通过传送诸如“I am alive”这样的信息来监控对方的运行状况。当备份机不能在一定的时间内收到这样的信息时，它就接管主服务器的服务IP并继续提供负载均衡服务；当备份管理器又从主管理器收到“I am alive”这样的信息时，它就释放服务IP地址，这样的主服务器就开始再次提供负载均衡服务。</p><h3 id="keepalived-lvs实现主备"><a href="#keepalived-lvs实现主备" class="headerlink" title="keepalived+lvs实现主备"></a>keepalived+lvs实现主备</h3><h4 id="什么是keepalived"><a href="#什么是keepalived" class="headerlink" title="什么是keepalived"></a>什么是keepalived</h4><p>keepalived是集群管理中保证集群高可用的一个服务软件，用来防止单点故障。</p><p>Keepalived的作用是检测web服务器的状态，如果有一台web服务器死机，或工作出现故障，Keepalived将检测到，并将有故障的web服务器从系统中剔除，当web服务器工作正常后Keepalived自动将web服务器加入到服务器群中，这些工作全部自动完成，不需要人工干涉，需要人工做的只是修复故障的web服务器。</p><h4 id="keepalived工作原理"><a href="#keepalived工作原理" class="headerlink" title="keepalived工作原理"></a>keepalived工作原理</h4><p>keepalived是以VRRP协议为实现基础的，VRRP全称Virtual Router Redundancy Protocol，即虚拟路由冗余协议。</p><p>虚拟路由冗余协议，可以认为是实现路由器高可用的协议，即将N台提供相同功能的路由器组成一个路由器组，这个组里面有一个master和多个backup，master上面有一个对外提供服务的vip（该路由器所在局域网内其他机器的默认路由为该vip），master会发组播，当backup收不到VRRP包时就认为master宕掉了，这时就需要根据VRRP的优先级来选举一个backup当master。这样的话就可以保证路由器的高可用了。</p><p>keepalived主要有三个模块，分别是core、check和VRRP。core模块为keepalived的核心，负责主进程的启动、维护以及全局配置文件的加载和解析。check负责健康检查，包括常见的各种检查方式。VRRP模块是来实现VRRP协议的。</p><h4 id="keepalived-lvs实现主备过程"><a href="#keepalived-lvs实现主备过程" class="headerlink" title="keepalived+lvs实现主备过程"></a>keepalived+lvs实现主备过程</h4><p><strong>初始状态</strong></p><p> <img src="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@master/articles/17e1663a/16.png" alt="img"></p><p><strong>主机宕机</strong></p><p> <img src="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@master/articles/17e1663a/17.png" alt="img"></p><p><strong>主机恢复</strong></p><p> <img src="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@master/articles/17e1663a/18.png" alt="img"></p><h3 id="准备环境-1"><a href="#准备环境-1" class="headerlink" title="准备环境"></a>准备环境</h3><p>vip：192.168.101.100</p><p>lvs-director：192.168.101.8 主lvs</p><p>lvs-director：192.168.101.9 备lvs</p><p>nginx1：192.168.101.3 安装nginx</p><p>nginx2：192.168.101.4 安装nginx</p><p>tomcat1：192.168.101.5 安装tomcat</p><p>tomcat2：192.168.101.6 安装tomcat</p><h3 id="安装keepalived"><a href="#安装keepalived" class="headerlink" title="安装keepalived"></a>安装keepalived</h3><p>分别在主备lvs上安装keepalived，参考“<a href="https://www.cnblogs.com/arjenlee/p/9256068.html" rel="noopener external nofollow noreferrer" target="_blank">安装手册</a>”进行安装：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install keepalived -y</span><br></pre></td></tr></table></figure><h3 id="配置keepalived"><a href="#配置keepalived" class="headerlink" title="配置keepalived"></a>配置keepalived</h3><h4 id="主lvs"><a href="#主lvs" class="headerlink" title="主lvs"></a>主lvs</h4><p>修改主lvs下/etc/keepalived/keepalived.conf文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">    #xxxx@itcast.com                                   # 发生故障时发送的邮箱</span><br><span class="line">   &#125;</span><br><span class="line">   #notification_email_from xxxx@itcast.com             # 使用哪个邮箱发送</span><br><span class="line">   #smtp_server xxx.com                                  # 发件服务器</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id LVS_DEVEL</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER             # 标示为主lvs</span><br><span class="line">    interface eth0           # HA检测端口</span><br><span class="line">    virtual_router_id 51     # 主备的virtual_router_id 必须相同</span><br><span class="line">    priority 100             # 优先级,备lvs要比主lvs稍小</span><br><span class="line">    advert_int 1             # VRRP Multicast 广播周期秒数</span><br><span class="line">    authentication &#123;         # 定义认证</span><br><span class="line">        auth_type PASS       # 认证方式为口令认证</span><br><span class="line">        auth_pass 1111       # 定义口令</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;      # 定义vip</span><br><span class="line">        192.168.101.100        # 多个vip可换行添加</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">virtual_server 192.168.101.100 80 &#123;</span><br><span class="line">    delay_loop 6       # 每隔6秒查看realserver状态</span><br><span class="line">    lb_algo wlc        # 调度算法为加权最小连接数</span><br><span class="line">    lb_kind DR         # lvs工作模式为DR(直接路由)模式</span><br><span class="line">    nat_mask 255.255.255.0</span><br><span class="line">    persistence_timeout 50  # 同一IP 的连接50秒内被分配到同一台realserver(测试时建议改为0)</span><br><span class="line">    protocol TCP            # 用TCP监测realserver的状态</span><br><span class="line"></span><br><span class="line">    real_server 192.168.101.3 80 &#123;       # 定义realserver</span><br><span class="line">        weight 3                       # 定义权重</span><br><span class="line">        TCP_CHECK &#123;  # 注意TCP_CHECK和&#123;之间的空格,如果没有的话只会添加第一个realserver</span><br><span class="line">            connect_timeout 3          # 三秒无响应超时</span><br><span class="line">            nb_get_retry 3</span><br><span class="line">            delay_before_retry 3</span><br><span class="line">            connect_port 80</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    real_server 192.168.101.4 80 &#123;</span><br><span class="line">        weight 3</span><br><span class="line">        TCP_CHECK &#123;</span><br><span class="line">            connect_timeout 3</span><br><span class="line">            nb_get_retry 3</span><br><span class="line">            delay_before_retry 3</span><br><span class="line">            connect_port 80</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="备lvs"><a href="#备lvs" class="headerlink" title="备lvs"></a>备lvs</h4><p>修改备lvs下/etc/keepalived/keepalived.conf文件</p><p><strong>配置备</strong>lvs<strong>时需要注意：需要修改state**</strong>为BACKUP , priority<strong><strong>比MASTER</strong></strong>低，virtual_router_id<strong><strong>和master</strong></strong>的值一致**</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">    #xxxx@itcast.com                                   # 发生故障时发送的邮箱</span><br><span class="line">   &#125;</span><br><span class="line">   #notification_email_from xxxx@itcast.com             # 使用哪个邮箱发送</span><br><span class="line">   #smtp_server xxx.com                                  # 发件服务器</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id LVS_DEVEL</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP             # 标示为备lvs</span><br><span class="line">    interface eth0           # HA检测端口</span><br><span class="line">    virtual_router_id 51     # 主备的virtual_router_id 必须相同</span><br><span class="line">    priority 99              # 优先级,备lvs要比主lvs稍小</span><br><span class="line">    advert_int 1             # VRRP Multicast 广播周期秒数</span><br><span class="line">    authentication &#123;         # 定义认证</span><br><span class="line">        auth_type PASS       # 认证方式为口令认证</span><br><span class="line">        auth_pass 1111       # 定义口令</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;      # 定义vip</span><br><span class="line">        192.168.101.100        # 多个vip可换行添加</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">virtual_server 192.168.101.100 80 &#123;</span><br><span class="line">    delay_loop 6       # 每隔6秒查看realserver状态</span><br><span class="line">    lb_algo wlc        # 调度算法为加权最小连接数</span><br><span class="line">    lb_kind DR         # lvs工作模式为DR(直接路由)模式</span><br><span class="line">    nat_mask 255.255.255.0</span><br><span class="line">    persistence_timeout 50  # 同一IP 的连接50秒内被分配到同一台realserver(测试时建议改为0)</span><br><span class="line">    protocol TCP            # 用TCP监测realserver的状态</span><br><span class="line"></span><br><span class="line">    real_server 192.168.101.3 80 &#123;       # 定义realserver</span><br><span class="line">        weight 3                       # 定义权重</span><br><span class="line">        TCP_CHECK &#123;  # 注意TCP_CHECK和&#123;之间的空格,如果没有的话只会添加第一个realserver</span><br><span class="line">            connect_timeout 3          # 三秒无响应超时</span><br><span class="line">            nb_get_retry 3</span><br><span class="line">            delay_before_retry 3</span><br><span class="line">            connect_port 80</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    real_server 192.168.101.4 80 &#123;</span><br><span class="line">        weight 3</span><br><span class="line">        TCP_CHECK &#123;</span><br><span class="line">            connect_timeout 3</span><br><span class="line">            nb_get_retry 3</span><br><span class="line">            delay_before_retry 3</span><br><span class="line">            connect_port 80</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="测试-2"><a href="#测试-2" class="headerlink" title="测试"></a>测试</h3><h4 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h4><ul><li>director Server启动：</li></ul><p><strong>注意：使用keepalived就不用手动配置启动lvs，在主、备lvs上启动keepalived即可。</strong></p><p>主备lvs（192.168.101.8、192.168.101.9）都启动keepalived。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service keepalived start</span><br></pre></td></tr></table></figure><ul><li>real server启动：</li></ul><p>192.168.101.3、192.168.101.4启动nginx和lvs的realserver配置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/nginx/sbin</span><br><span class="line">./nginx -c /usr/<span class="built_in">local</span>/nginx/conf/nginx-lvs.conf</span><br></pre></td></tr></table></figure><p> 启动lvs的realserver配置：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service lvsdr start</span><br></pre></td></tr></table></figure><p> <strong>注意：real server的lvs配置需要使用lvsdr脚本。</strong></p><ul><li>tomcat 启动</li></ul><p>略</p><h4 id="初始状态"><a href="#初始状态" class="headerlink" title="初始状态"></a>初始状态</h4><p>查看主lvs的eth0设置：</p><p>vip绑定在主lvs的eth0上。</p><p> <img src="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@master/articles/17e1663a/19.png" alt="img"></p><p>查询lvs状态：</p><p> <img src="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@master/articles/17e1663a/20.png" alt="img"></p><p>查看备lvs的eth0设置：</p><p>vip没有绑定在备lvs的eth0上。</p><p> <img src="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@master/articles/17e1663a/21.png" alt="img"></p><p>访问<a href="http://192.168.101.100，可以正常负载。" rel="noopener external nofollow noreferrer" target="_blank">http://192.168.101.100，可以正常负载。</a></p><h4 id="主机宕机"><a href="#主机宕机" class="headerlink" title="主机宕机"></a>主机宕机</h4><p>将主lvs的keepalived停止或将主lvs关机(相当于模拟宕机)，查看主lvs的eth0：</p><p>eth0没有绑定vip</p><p> <img src="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@master/articles/17e1663a/22.png" alt="img"></p><p>查看备lvs的eth0：</p><p>vip已经漂移到备lvs。</p><p> <img src="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@master/articles/17e1663a/23.png" alt="img"></p><p>访问<a href="http://192.168.101.100，可以正常负载。" rel="noopener external nofollow noreferrer" target="_blank">http://192.168.101.100，可以正常负载。</a></p><h4 id="主机恢复"><a href="#主机恢复" class="headerlink" title="主机恢复"></a>主机恢复</h4><p>将主lvs的keepalived启动。</p><p>查看主lvs的eth0：</p><p>查看备lvs的eth0：</p><p>vip漂移到主lvs。</p><p> <img src="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@master/articles/17e1663a/24.png" alt="img"></p><p>查看备lvs的eth0：</p><p>eth0没有绑定vip</p><p> <img src="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@master/articles/17e1663a/25.png" alt="img"></p><p>访问<a href="http://192.168.101.100，可以正常负载。" rel="noopener external nofollow noreferrer" target="_blank">http://192.168.101.100，可以正常负载。</a></p><h3 id="keepalived-lvs实现双主"><a href="#keepalived-lvs实现双主" class="headerlink" title="keepalived+lvs实现双主"></a>keepalived+lvs实现双主</h3><p>上边主备方案是当前只有一台lvs工作，这造成资源浪费，可以采用双主结构，让两台lvs当前都进行工作，采用dns轮询方式，当用户访问域名通过dns轮询每台lvs，双主结构需要两个vip，这两个vip要绑定域名。</p><p> 同样，在每台lvs上安装keepalived软件，当keepalived检测到其中一个lvs宕机则将宕机的vip漂移到活动lvs上，当lvs恢复则vip又重新漂移回来。</p><h4 id="初始状态-1"><a href="#初始状态-1" class="headerlink" title="初始状态"></a>初始状态</h4><p>每台lvs绑定一个vip，共两个vip，DNS设置域名对应这两个vip，通过DNS轮询每次解析到不同的vip上即解析到不同的lvs上。</p><p> <img src="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@master/articles/17e1663a/26.png" alt="img"></p><h4 id="其中一个主机宕机"><a href="#其中一个主机宕机" class="headerlink" title="其中一个主机宕机"></a>其中一个主机宕机</h4><p>其中一个主机宕机，每台lvs上安装的keepalived程序会检测到对方宕机，将宕机一方的vip漂移至活动的lvs服务器上，这样DNS轮询全部到一台lvs继续对外提供服务。</p><p> <img src="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@master/articles/17e1663a/27.png" alt="img"></p><h4 id="主机恢复-1"><a href="#主机恢复-1" class="headerlink" title="主机恢复"></a>主机恢复</h4><p>当主机恢复又回到初始状态，每个vip绑定在不同的lvs上。</p><p> <img src="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@master/articles/17e1663a/28.png" alt="img"></p><h2 id="lvs扩展的思考"><a href="#lvs扩展的思考" class="headerlink" title="lvs扩展的思考"></a>lvs扩展的思考</h2><p>前端使用1到2台lvs作为负载基本可以满足中小型网站的并发要求，当lvs的负载成为瓶颈此时就需要对lvs进行优化、扩展。</p><ul><li><strong>方案1：LVS-ospf集群</strong></li></ul><p>​ OSPF(Open Shortest Path First开放式最短路径优先）是一个内部网关协议(Interior Gateway Protocol，简称IGP），用于在单一自治系统（autonomous system,AS）内决策路由。</p><p>LVS（DR）通过ospfd，做lvs集群，实现一个VIP，多台LVS同时工作提供服务，这种方案需要依赖三层交换机设备实现。</p><p> <img src="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@master/articles/17e1663a/29.png" alt="img"></p><p>用户请求（VIP：42.xx.xx.100）到达三层交换机之后，通过对原地址、端口和目的地址、端口的hash，将链接分配到集群中的某一台LVS上，LVS通过内网（10.101.10.x）向后端转发请求，后端再将数据返回给用户。</p><p>LVS-ospf集群模式的最大优势就在于：</p><p>1.LVS调度机自由伸缩，横向线性扩展（最大8台，受限于三层设备允许的等价路由数目maximum load-balancing）；</p><p>2.LVS机器同时工作，不存在备机，提高利用率；</p><p>3.做到了真正的高可用，某台LVS机器宕机后，不会影响服务</p><ul><li><strong>方案2：DNS轮询</strong></li></ul><p>上面讲的是一组双主结构，可以采用多组双主结构达到横向扩展lvs的目的，此方案需要每台lvs都绑定一个vip（公网ip），DNS设置域名轮询多个vip，如下图：</p><p> <img src="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@master/articles/17e1663a/30.png" alt="img"></p><ul><li><strong>方案3：使用硬件负载均衡设置</strong></li></ul><p>​ 如果资金允许可以购买硬件设置来完成负载均衡，性能不错的有F5、Array等都可以满足超高并发的要求。</p></div><script src="https://my.openwrite.cn/js/readmore.js" type="text/javascript"></script><script>var isMobile=navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i);if(!isMobile){var btw=new BTWPlugin;btw.init({id:"vip-container",blogId:"19128-1606361858239-837",name:"运维随笔",qrcode:"https://wandouduoduo.github.io/about/index/gongzhonghao.jpg",keyword:"yunwei"})}</script></div><div><div><div style="text-align:center;color:#ccc;font-size:14px">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div></div></div><div><div class="my_post_copyright"><script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script><script src="https://cdn.bootcss.com/jquery/2.0.0/jquery.min.js"></script><script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script><p><span>本文标题:</span><a href="/articles/17e1663a.html">lvs负载均衡实战</a></p><p><span>文章作者:</span><a href="/" title="访问 豌豆多多 的个人博客">豌豆多多</a></p><p><span>发布时间:</span>2021年04月19日 - 14:04</p><p><span>最后更新:</span>2021年04月20日 - 15:04</p><p><span>原始链接:</span><a href="/articles/17e1663a.html" title="lvs负载均衡实战">https://wandouduoduo.github.io/articles/17e1663a.html</a><span class="copy-path" title="点击复制文章链接"><i class="fa fa-clipboard" data-clipboard-text="https://wandouduoduo.github.io/articles/17e1663a.html" aria-label="复制成功！"></i></span></p><p><span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license external nofollow noreferrer" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">署名-非商业性使用-禁止演绎 4.0 国际</a> 转载请保留原文链接及作者。</p></div><script>var clipboard=new Clipboard(".fa-clipboard");$(".fa-clipboard").click(function(){clipboard.on("success",function(){swal({title:"",text:"复制成功",icon:"success",showConfirmButton:!0})})})</script></div><div><div style="padding:10px 0;margin:20px auto;width:90%;text-align:center"><div>原创技术分享，您的支持将鼓励我继续创作</div> <button id="rewardButton" disable="enable" onclick='var qr=document.getElementById("QR");"none"===qr.style.display?qr.style.display="block":qr.style.display="none"'> <span>打赏</span></button><div id="QR" style="display:none"><div id="wechat" style="display:inline-block"> <img id="wechat_qr" src="//cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io/images/wechatpay.png" alt="豌豆多多 微信支付"><p>微信支付</p></div><div id="alipay" style="display:inline-block"> <img id="alipay_qr" src="//cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io/images/alipay.jpg" alt="豌豆多多 支付宝"><p>支付宝</p></div></div></div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/Lvs/" rel="tag"><i class="fa fa-tag"></i> Lvs</a></div><div class="post-widgets"><div class="social_share"><div><div class="bdsharebuttonbox"><a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a><a href="#" class="bds_douban" data-cmd="douban" title="分享到豆瓣网"></a><a href="#" class="bds_sqq" data-cmd="sqq" title="分享到QQ好友"></a><a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a><a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a><a href="#" class="bds_tieba" data-cmd="tieba" title="分享到百度贴吧"></a><a href="#" class="bds_twi" data-cmd="twi" title="分享到Twitter"></a><a href="#" class="bds_fbook" data-cmd="fbook" title="分享到Facebook"></a><a href="#" class="bds_more" data-cmd="more"></a><a class="bds_count" data-cmd="count"></a></div><script>window._bd_share_config={common:{bdText:"",bdMini:"2",bdMiniList:!1,bdPic:""},share:{bdSize:"16",bdStyle:"0"},image:{viewList:["tsina","douban","sqq","qzone","weixin","twi","fbook"],viewText:"分享到：",viewSize:"16"}}</script><script>with(document)(getElementsByTagName("head")[0]||body).appendChild(createElement("script")).src="/static/api/js/share.js?cdnversion="+~(-new Date/36e5)</script></div></div></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/articles/8b98d1d.html" rel="next" title="k8s网络flannel和calico网络模式对比"><i class="fa fa-chevron-left"></i> k8s网络flannel和calico网络模式对比</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"> <a href="/articles/c34eeebc.html" rel="prev" title="kafka之扩容和缩容">kafka之扩容和缩容<i class="fa fa-chevron-right"></i></a></div></div></footer></div></article></div></div><div class="comments" id="gitalk-container"></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap"> 文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap"> 站点概览</li></ul><div class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" src="/images/yunwei.png" alt="豌豆多多"><p class="site-author-name" itemprop="name">豌豆多多</p><p class="site-description motion-element" itemprop="description">资深运维架构师豌豆多多的呕心笔记</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">209</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/index.html"><span class="site-state-item-count">44</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/index.html"><span class="site-state-item-count">66</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/wandouduoduo" title="GitHub &rarr; https://github.com/wandouduoduo" rel="noopener external nofollow noreferrer" target="_blank"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:wandouduoduo@163.com" title="E-Mail &rarr; mailto:wandouduoduo@163.com" rel="noopener external nofollow noreferrer" target="_blank"><i class="fa fa-fw fa-envelope"></i> E-Mail</a></span><span class="links-of-author-item"><a href="https://gitee.com/wandouduoduo" title="Gitee &rarr; https://gitee.com/wandouduoduo" rel="noopener external nofollow noreferrer" target="_blank"><i class="fa fa-fw fa-heartbeat"></i> Gitee</a></span><span class="links-of-author-item"><a href="https://weibo.com/u/1989032071/home?topnav=1&wvr=6" title="微博 &rarr; https://weibo.com/u/1989032071/home?topnav=1&wvr=6" rel="noopener external nofollow noreferrer" target="_blank"><i class="fa fa-fw fa-weibo"></i> 微博</a></span></div><div class="links-of-blogroll motion-element links-of-blogroll-inline"><div class="links-of-blogroll-title"><i class="fa fa-fw fa-link"></i> 友情链接</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"> <a href="https://www.runoob.com/" title="https://www.runoob.com/" rel="noopener external nofollow noreferrer" target="_blank">菜鸟教程</a></li><li class="links-of-blogroll-item"> <a href="https://code.ziqiangxuetang.com/" title="https://code.ziqiangxuetang.com/" rel="noopener external nofollow noreferrer" target="_blank">自强学堂</a></li><li class="links-of-blogroll-item"> <a href="http://www.ttlsa.com/" title="http://www.ttlsa.com/" rel="noopener external nofollow noreferrer" target="_blank">运维生存时间</a></li><li class="links-of-blogroll-item"> <a href="http://www.zsythink.net/" title="http://www.zsythink.net/" rel="noopener external nofollow noreferrer" target="_blank">朱双印博客</a></li><li class="links-of-blogroll-item"> <a href="https://me.jinchuang.org/" title="https://me.jinchuang.org/" rel="noopener external nofollow noreferrer" target="_blank">靳闯博客</a></li><li class="links-of-blogroll-item"> <a href="http://bingdang.github.io/" title="http://bingdang.github.io/" rel="noopener external nofollow noreferrer" target="_blank">运维饼铛</a></li></ul></div></div></div><div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#负载均衡方案"><span class="nav-number">1.</span> <span class="nav-text">负载均衡方案</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#什么是负载均衡"><span class="nav-number">1.1.</span> <span class="nav-text">什么是负载均衡</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#相关技术"><span class="nav-number">1.2.</span> <span class="nav-text">相关技术</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#基于DNS的负载均衡"><span class="nav-number">1.2.1.</span> <span class="nav-text">基于DNS的负载均衡</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#基于四层交换技术的负载均衡"><span class="nav-number">1.2.2.</span> <span class="nav-text">基于四层交换技术的负载均衡</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#基于七层交换技术的负载均衡"><span class="nav-number">1.2.3.</span> <span class="nav-text">基于七层交换技术的负载均衡</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#确定使用四层-七层负载结合方案"><span class="nav-number">1.3.</span> <span class="nav-text">确定使用四层+七层负载结合方案</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#nginx集群背景"><span class="nav-number">1.4.</span> <span class="nav-text">nginx集群背景</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#lvs实现四层负载DR模式"><span class="nav-number">2.</span> <span class="nav-text">lvs实现四层负载DR模式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#什么是lvs"><span class="nav-number">2.1.</span> <span class="nav-text">什么是lvs</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#lvs实现负载的三种方式"><span class="nav-number">2.2.</span> <span class="nav-text">lvs实现负载的三种方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#LVS-DR-模式"><span class="nav-number">2.3.</span> <span class="nav-text">LVS-DR 模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#LVS-NAT模式"><span class="nav-number">2.4.</span> <span class="nav-text">LVS-NAT模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#LVS-TUN模式"><span class="nav-number">2.5.</span> <span class="nav-text">LVS-TUN模式</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#lvs-DR实战"><span class="nav-number">3.</span> <span class="nav-text">lvs-DR实战</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#lvs调度服务器Director安装"><span class="nav-number">3.1.</span> <span class="nav-text">lvs调度服务器Director安装</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#安装lvs"><span class="nav-number">3.1.1.</span> <span class="nav-text">安装lvs</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#安装lvs的管理工具ipvsadm"><span class="nav-number">3.1.2.</span> <span class="nav-text">安装lvs的管理工具ipvsadm</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#真实服务器Real-Server安装"><span class="nav-number">3.1.3.</span> <span class="nav-text">真实服务器Real Server安装</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Director-Server配置"><span class="nav-number">3.2.</span> <span class="nav-text">Director Server配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#在eth0上绑定虚拟ip"><span class="nav-number">3.2.1.</span> <span class="nav-text">在eth0上绑定虚拟ip</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#添加路由规则"><span class="nav-number">3.2.2.</span> <span class="nav-text">添加路由规则</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#启用系统的包转发功能"><span class="nav-number">3.2.3.</span> <span class="nav-text">启用系统的包转发功能</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#清除原有转发规则"><span class="nav-number">3.2.4.</span> <span class="nav-text">清除原有转发规则</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#添加虚拟IP规则"><span class="nav-number">3.2.5.</span> <span class="nav-text">添加虚拟IP规则</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#在虚拟IP中添加服务规则"><span class="nav-number">3.2.6.</span> <span class="nav-text">在虚拟IP中添加服务规则</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#重启lvs"><span class="nav-number">3.2.7.</span> <span class="nav-text">重启lvs</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Real-Server配置"><span class="nav-number">3.3.</span> <span class="nav-text">Real Server配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#在回环设备上绑定了一个虚拟IP地址"><span class="nav-number">3.3.1.</span> <span class="nav-text">在回环设备上绑定了一个虚拟IP地址</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#关闭arp解析"><span class="nav-number">3.3.2.</span> <span class="nav-text">关闭arp解析</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#测试"><span class="nav-number">3.4.</span> <span class="nav-text">测试</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#预期目标"><span class="nav-number">3.4.1.</span> <span class="nav-text">预期目标</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#注意事项"><span class="nav-number">3.4.2.</span> <span class="nav-text">注意事项</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#测试过程"><span class="nav-number">3.4.3.</span> <span class="nav-text">测试过程</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#脚本封装"><span class="nav-number">3.5.</span> <span class="nav-text">脚本封装</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Director-Server配置-1"><span class="nav-number">3.5.1.</span> <span class="nav-text">Director Server配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Real-Server配置-1"><span class="nav-number">3.5.2.</span> <span class="nav-text">Real Server配置</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#lvs四层-nginx七层负载均衡"><span class="nav-number">4.</span> <span class="nav-text">lvs四层+nginx七层负载均衡</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#需求"><span class="nav-number">4.1.</span> <span class="nav-text">需求</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#准备环境"><span class="nav-number">4.2.</span> <span class="nav-text">准备环境</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置"><span class="nav-number">4.3.</span> <span class="nav-text">配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Director-Server配置-2"><span class="nav-number">4.3.1.</span> <span class="nav-text">Director Server配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Real-Server配置-2"><span class="nav-number">4.3.2.</span> <span class="nav-text">Real Server配置</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#测试-1"><span class="nav-number">4.4.</span> <span class="nav-text">测试</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#lvs高可用-了解"><span class="nav-number">5.</span> <span class="nav-text">lvs高可用(了解)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#什么是高可用"><span class="nav-number">5.1.</span> <span class="nav-text">什么是高可用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#keepalived-lvs实现主备"><span class="nav-number">5.2.</span> <span class="nav-text">keepalived+lvs实现主备</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#什么是keepalived"><span class="nav-number">5.2.1.</span> <span class="nav-text">什么是keepalived</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#keepalived工作原理"><span class="nav-number">5.2.2.</span> <span class="nav-text">keepalived工作原理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#keepalived-lvs实现主备过程"><span class="nav-number">5.2.3.</span> <span class="nav-text">keepalived+lvs实现主备过程</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#准备环境-1"><span class="nav-number">5.3.</span> <span class="nav-text">准备环境</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装keepalived"><span class="nav-number">5.4.</span> <span class="nav-text">安装keepalived</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置keepalived"><span class="nav-number">5.5.</span> <span class="nav-text">配置keepalived</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#主lvs"><span class="nav-number">5.5.1.</span> <span class="nav-text">主lvs</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#备lvs"><span class="nav-number">5.5.2.</span> <span class="nav-text">备lvs</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#测试-2"><span class="nav-number">5.6.</span> <span class="nav-text">测试</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#启动"><span class="nav-number">5.6.1.</span> <span class="nav-text">启动</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#初始状态"><span class="nav-number">5.6.2.</span> <span class="nav-text">初始状态</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#主机宕机"><span class="nav-number">5.6.3.</span> <span class="nav-text">主机宕机</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#主机恢复"><span class="nav-number">5.6.4.</span> <span class="nav-text">主机恢复</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#keepalived-lvs实现双主"><span class="nav-number">5.7.</span> <span class="nav-text">keepalived+lvs实现双主</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#初始状态-1"><span class="nav-number">5.7.1.</span> <span class="nav-text">初始状态</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#其中一个主机宕机"><span class="nav-number">5.7.2.</span> <span class="nav-text">其中一个主机宕机</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#主机恢复-1"><span class="nav-number">5.7.3.</span> <span class="nav-text">主机恢复</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#lvs扩展的思考"><span class="nav-number">6.</span> <span class="nav-text">lvs扩展的思考</span></a></li></ol></div></div></div><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span id="scrollpercent"><span>0</span>%</span></div><script type="text/javascript" charset="utf-8" src="/js/tagcloud.js"></script><script type="text/javascript" charset="utf-8" src="/js/tagcanvas.js"></script><div class="widget-wrap"><div id="myCanvasContainer" class="widget tagcloud"><canvas width="250" height="250" id="resCanvas" style=""><ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Ai/">Ai</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Ansible/">Ansible</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Aplayer/">Aplayer</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Apollo/">Apollo</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cat/">Cat</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Centos/">Centos</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cloud/">Cloud</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cmdb/">Cmdb</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Confd/">Confd</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Confluence/">Confluence</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Dns/">Dns</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/">Docker</a><span class="tag-list-count">18</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Elk/">Elk</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Experiences/">Experiences</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Flask/">Flask</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Git/">Git</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GlusterFS/">GlusterFS</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Go/">Go</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Haproxy/">Haproxy</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hexo/">Hexo</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Http/">Http</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Iptables/">Iptables</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/">Java</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Jenkins/">Jenkins</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Jumperserver/">Jumperserver</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/K8s/">K8s</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kafka/">Kafka</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kali/">Kali</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Keepalived/">Keepalived</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a><span class="tag-list-count">24</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Lvs/">Lvs</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mail/">Mail</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mesos/">Mesos</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MongoDB/">MongoDB</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mysql/">Mysql</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Network/">Network</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nexus/">Nexus</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nginx/">Nginx</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Open-falcon/">Open-falcon</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Openldap/">Openldap</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Opensips/">Opensips</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Openssl/">Openssl</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Openvpn/">Openvpn</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PostgreSQL/">PostgreSQL</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Prometheus/">Prometheus</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python/">Python</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis/">Redis</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redmine/">Redmine</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RocketChat/">RocketChat</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Samba/">Samba</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Saturn/">Saturn</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Selenium/">Selenium</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Sentry/">Sentry</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Shell/">Shell</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Sql/">Sql</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Stackstorm/">Stackstorm</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Supervisor/">Supervisor</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Tcpdump/">Tcpdump</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Tomcat/">Tomcat</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Uwsgi/">Uwsgi</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Web/">Web</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Wiki/">Wiki</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Windows/">Windows</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Xxl-job/">Xxl-job</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Zabbix/">Zabbix</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Zookeeper/">Zookeeper</a><span class="tag-list-count">1</span></li></ul></canvas></div></div></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; 2020 – <span itemprop="copyrightYear">2021</span><span class="with-love" id="animate"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">豌豆多多</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-area-chart"></i></span> <span class="post-meta-item-text">站点总字数：</span> <span title="站点总字数">470k</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span class="post-meta-item-text">站点阅读时长 &asymp;</span> <span title="站点阅读时长">7:07</span></div><div class="theme-info"><div class="powered-by"></div> <span class="post-count">博客全站共483.9k字</span></div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script> <span class="post-meta-item-icon"><i class="fa fa-user">访问人数:</i></span><span class="site-uv" title="总访客量"><span class="busuanzi-value" id="busuanzi_value_site_uv"></span></span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-eye">总阅读量:</i></span><span class="site-pv" title="总访问量"><span class="busuanzi-value" id="busuanzi_value_site_pv"></span></span></div></div></footer></div><script>"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script color="255,255,255" opacity="1" zindex="-1" count="150" src="//cdn.jsdelivr.net/gh/theme-next/theme-next-canvas-nest@1/canvas-nest.min.js"></script><script src="//cdn.jsdelivr.net/npm/jquery@2/dist/jquery.min.js"></script><script src="//cdn.jsdelivr.net/npm/velocity-animate@1/velocity.min.js"></script><script src="//cdn.jsdelivr.net/npm/velocity-animate@1/velocity.ui.min.js"></script><script src="/js/src/utils.js?v=6.7.0"></script><script src="/js/src/motion.js?v=6.7.0"></script><script src="/js/src/affix.js?v=6.7.0"></script><script src="/js/src/schemes/pisces.js?v=6.7.0"></script><script src="/js/src/scrollspy.js?v=6.7.0"></script><script src="/js/src/post-details.js?v=6.7.0"></script><script src="/js/src/bootstrap.js?v=6.7.0"></script><script src="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"><script src="//cdn.jsdelivr.net/npm/js-md5@0.7.3/src/md5.min.js"></script><script>var gitalk=new Gitalk({clientID:"ad83725549e82facce82",clientSecret:"b67c2056b52d0447f1d78f413f268a5b853e8a6e",repo:"wandouduoduo.github.io",owner:"wandouduoduo",admin:["wandouduoduo"],id:md5(location.pathname),distractionFreeMode:"true"});gitalk.render("gitalk-container")</script><script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><style>.copy-btn{display:inline-block;padding:6px 12px;font-size:13px;font-weight:700;line-height:20px;color:#333;white-space:nowrap;vertical-align:middle;cursor:pointer;background-color:#eee;background-image:linear-gradient(#fcfcfc,#eee);border:1px solid #d5d5d5;border-radius:3px;user-select:none;outline:0}.highlight-wrap .copy-btn{transition:opacity .3s ease-in-out;opacity:0;padding:2px 6px;position:absolute;right:4px;top:8px}.highlight-wrap .copy-btn:focus,.highlight-wrap:hover .copy-btn{opacity:1}.highlight-wrap{position:relative}</style><script>$(".highlight").each(function(e,t){var n=$("<div>").addClass("highlight-wrap");$(t).after(n),n.append($("<button>").addClass("copy-btn").append("复制").on("click",function(e){var t=$(this).parent().find(".code").find(".line").map(function(e,t){return $(t).text()}).toArray().join("\n"),n=document.createElement("textarea"),o=document.createRange(),a=window.getSelection(),i=window.pageYOffset||document.documentElement.scrollTop;n.style.top=i+"px",n.style.position="absolute",n.style.opacity="0",n.value=t,n.textContent=t,n.contentEditable=!0,n.readOnly=!1,document.body.appendChild(n),o.selectNode(n),a.removeAllRanges(),a.addRange(o),n.setSelectionRange(0,t.length),document.execCommand("copy")?$(this).text("复制成功"):$(this).text("复制失败"),n.blur(),$(this).blur()})).on("mouseleave",function(e){var t=$(this).find(".copy-btn");setTimeout(function(){t.text("复制")},300)}).append(t)})</script><style>#selectionCopyright{position:absolute;display:none;background:rgba(244,67,54,.7);color:#fff;border-radius:6px;box-shadow:none;border:none;font-size:14px}#selectionCopyright a{color:#fff;border-color:#fff}#selectionCopyright::before{content:"";width:0;height:0;border-style:solid;border-width:6px 8px 6px 0;border-color:transparent rgba(244,67,54,.7) transparent transparent;position:absolute;left:-8px;top:50%;transform:translateY(-50%)}</style> <button id="selectionCopyright" disabled="disabled">本文发表于[<a href="http://wandouduoduo.github.io/">豌豆多多</a>]分享请注明来源！</button><script>function selectText(){return document.selection?document.selection.createRange().text:window.getSelection().toString()}var content=document.getElementById("content"),scTip=document.getElementById("selectionCopyright");content.onmouseup=function(e){var t=(e=e||window.event).clientX,n=e.clientY,c=Math.max(document.body.scrollLeft,document.documentElement.scrollLeft),o=Math.max(document.body.scrollTop,document.documentElement.scrollTop);0<selectText().length?setTimeout(function(){scTip.style.display="inline-block",scTip.style.left=t+c+15+"px",scTip.style.top=n+o-15+"px"},100):scTip.style.display="none"},content.onclick=function(e){(e=e||window.event).cancelBubble=!0},document.onclick=function(){scTip.style.display="none"}</script><canvas class="fireworks" style="position:fixed;left:0;top:0;z-index:1;pointer-events:none"></canvas><script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script><script type="text/javascript" src="/js/src/fireworks.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,debug:!1,model:{jsonPath:"https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@v1.0/live2dw/assets/shizuku.model.json"},display:{position:"right",width:150,height:300},mobile:{show:!0},log:!1})</script></body></html>