<!DOCTYPE html><html class="theme-next gemini" lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><script src="/lib/pace/pace.min.js?v=1.0.2"></script><link rel="stylesheet" href="/lib/pace/pace-theme-flash.min.css?v=1.0.2"><meta name="google-site-verification" content="igfxU5A6c_28PmCJ5Zw1kMMKNCL3wvbBMwUqfOJ4kKg"><script data-ad-client="ca-pub-6677803223619857" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><meta name="baidu-site-verification" content="OcDLC8tSiQ"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2"><link rel="stylesheet" href="/css/main.css?v=6.7.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.7.0"><link rel="icon" type="image/png" sizes="32x32" href="/images/next-favicon-32.png?v=6.7.0"><link rel="icon" type="image/png" sizes="16x16" href="/images/next-favicon-16.png?v=6.7.0"><link rel="mask-icon" href="/images/logo.svg?v=6.7.0" color="#222"><script id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Gemini",version:"6.7.0",sidebar:{position:"left",display:"post",offset:12,b2t:!1,scrollpercent:!1,onmobile:!1},fancybox:!1,fastclick:!1,lazyload:!1,tabs:!0,motion:{enable:!1,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><meta name="description" content="目的为什么要做日志分析平台？ 随着业务量的增长，每天业务服务器将会产生上亿条的日志，单个日志文件达几个GB，这时我们发现用Linux自带工具，cat grep awk 分析越来越力不从心了，而且除了服务器日志，还有程序报错日志，分布在不同的服务器，查阅繁琐。 待解决的痛点: 1、大量不同种类的日志成为了运维人员的负担，不方便管理; 2、单个日志文件巨大，无法使用常用的文本工具分析，检索困难; 3、"><meta name="keywords" content="Elk"><meta property="og:type" content="article"><meta property="og:title" content="ELK日志系统最新版本详细教程"><meta property="og:url" content="https://wandouduoduo.netlify.com/articles/944dc498.html"><meta property="og:site_name" content="豌豆多多"><meta property="og:description" content="目的为什么要做日志分析平台？ 随着业务量的增长，每天业务服务器将会产生上亿条的日志，单个日志文件达几个GB，这时我们发现用Linux自带工具，cat grep awk 分析越来越力不从心了，而且除了服务器日志，还有程序报错日志，分布在不同的服务器，查阅繁琐。 待解决的痛点: 1、大量不同种类的日志成为了运维人员的负担，不方便管理; 2、单个日志文件巨大，无法使用常用的文本工具分析，检索困难; 3、"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://wandouduoduo.netlify.com/articles/944dc498/1.png"><meta property="og:image" content="https://wandouduoduo.netlify.com/articles/944dc498/2.png"><meta property="og:image" content="https://wandouduoduo.netlify.com/articles/944dc498/50.png"><meta property="og:image" content="https://wandouduoduo.netlify.com/articles/944dc498/3.png"><meta property="og:image" content="https://wandouduoduo.netlify.com/articles/944dc498/4.png"><meta property="og:image" content="https://wandouduoduo.netlify.com/articles/944dc498/5.png"><meta property="og:image" content="https://wandouduoduo.netlify.com/articles/944dc498/6.png"><meta property="og:image" content="https://wandouduoduo.netlify.com/articles/944dc498/7.png"><meta property="og:image" content="https://wandouduoduo.netlify.com/articles/944dc498/8.png"><meta property="og:image" content="https://wandouduoduo.netlify.com/articles/944dc498/9.png"><meta property="og:image" content="https://wandouduoduo.netlify.com/articles/944dc498/10.png"><meta property="og:image" content="https://wandouduoduo.netlify.com/articles/944dc498/11.png"><meta property="og:image" content="https://wandouduoduo.netlify.com/articles/944dc498/12.png"><meta property="og:image" content="https://wandouduoduo.netlify.com/articles/944dc498/13.png"><meta property="og:image" content="https://wandouduoduo.netlify.com/articles/944dc498/14.png"><meta property="og:image" content="https://wandouduoduo.netlify.com/articles/944dc498/15.png"><meta property="og:image" content="https://wandouduoduo.netlify.com/articles/944dc498/16.png"><meta property="og:image" content="https://wandouduoduo.netlify.com/articles/944dc498/17.png"><meta property="og:image" content="https://wandouduoduo.netlify.com/articles/944dc498/18.png"><meta property="og:image" content="https://wandouduoduo.netlify.com/articles/944dc498/19.png"><meta property="og:image" content="https://wandouduoduo.netlify.com/articles/944dc498/20.png"><meta property="og:image" content="https://wandouduoduo.netlify.com/articles/944dc498/21.png"><meta property="og:image" content="https://wandouduoduo.netlify.com/articles/944dc498/22.png"><meta property="og:image" content="https://wandouduoduo.netlify.com/articles/944dc498/23.png"><meta property="og:image" content="https://wandouduoduo.netlify.com/articles/944dc498/24.png"><meta property="og:image" content="https://wandouduoduo.netlify.com/articles/944dc498/25.png"><meta property="og:image" content="https://wandouduoduo.netlify.com/articles/944dc498/26.png"><meta property="og:image" content="https://wandouduoduo.netlify.com/articles/944dc498/27.png"><meta property="og:image" content="https://wandouduoduo.netlify.com/articles/944dc498/28.png"><meta property="og:image" content="https://wandouduoduo.netlify.com/articles/944dc498/29.png"><meta property="og:image" content="https://wandouduoduo.netlify.com/articles/944dc498/30.png"><meta property="og:image" content="https://wandouduoduo.netlify.com/articles/944dc498/31.png"><meta property="og:image" content="https://wandouduoduo.netlify.com/articles/944dc498/32.png"><meta property="og:image" content="https://wandouduoduo.netlify.com/articles/944dc498/33.png"><meta property="og:image" content="https://wandouduoduo.netlify.com/articles/944dc498/34.png"><meta property="og:image" content="https://wandouduoduo.netlify.com/articles/944dc498/35.png"><meta property="og:image" content="https://wandouduoduo.netlify.com/articles/944dc498/36.png"><meta property="og:image" content="https://wandouduoduo.netlify.com/articles/944dc498/37.png"><meta property="og:image" content="https://wandouduoduo.netlify.com/articles/944dc498/38.png"><meta property="og:image" content="https://wandouduoduo.netlify.com/articles/944dc498/39.png"><meta property="og:image" content="https://wandouduoduo.netlify.com/articles/944dc498/40.png"><meta property="og:image" content="https://wandouduoduo.netlify.com/articles/944dc498/41.png"><meta property="og:image" content="https://wandouduoduo.netlify.com/articles/944dc498/42.png"><meta property="og:image" content="https://wandouduoduo.netlify.com/articles/944dc498/43.png"><meta property="og:image" content="https://wandouduoduo.netlify.com/articles/944dc498/44.png"><meta property="og:image" content="https://wandouduoduo.netlify.com/articles/944dc498/45.png"><meta property="og:image" content="https://wandouduoduo.netlify.com/articles/944dc498/46.png"><meta property="og:image" content="https://wandouduoduo.netlify.com/articles/944dc498/47.png"><meta property="og:image" content="https://wandouduoduo.netlify.com/articles/944dc498/48.png"><meta property="og:image" content="https://wandouduoduo.netlify.com/articles/944dc498/49.png"><meta property="og:updated_time" content="2020-06-17T02:42:06.279Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="ELK日志系统最新版本详细教程"><meta name="twitter:description" content="目的为什么要做日志分析平台？ 随着业务量的增长，每天业务服务器将会产生上亿条的日志，单个日志文件达几个GB，这时我们发现用Linux自带工具，cat grep awk 分析越来越力不从心了，而且除了服务器日志，还有程序报错日志，分布在不同的服务器，查阅繁琐。 待解决的痛点: 1、大量不同种类的日志成为了运维人员的负担，不方便管理; 2、单个日志文件巨大，无法使用常用的文本工具分析，检索困难; 3、"><meta name="twitter:image" content="https://wandouduoduo.netlify.com/articles/944dc498/1.png"><link rel="alternate" href="/atom.xml" title="豌豆多多" type="application/atom+xml"><link rel="canonical" href="https://wandouduoduo.netlify.com/articles/944dc498.html"><script id="page.configurations">CONFIG.page={sidebar:""}</script><title>ELK日志系统最新版本详细教程 | 豌豆多多</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-title,.use-motion .comments,.use-motion .menu-item,.use-motion .motion-element,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .logo,.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN"><link rel="stylesheet" href="/dist/APlayer.min.css"><div id="aplayer"></div><script type="text/javascript" src="/dist/APlayer.min.js"></script><script type="text/javascript" src="/dist/music.js"></script><div class="container sidebar-position-left page-post-detail"><div class="headband"></div> <a href="https://github.com/wandouduoduo" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewbox="0 0 250 250" style="fill:#fd6c6c;color:#fff;position:absolute;top:0;border:0;right:0" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"/></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">豌豆多多</span><span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">Senior O & M Architect</p></div><div class="site-nav-toggle"> <button aria-label="切换导航栏"><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>分类</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i></span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"> <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://wandouduoduo.netlify.com/articles/944dc498.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="WanDouDuoDuo"><meta itemprop="description" content="沪漂资深运维架构师的呕心笔记"><meta itemprop="image" content="/images/me.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="豌豆多多"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">ELK日志系统最新版本详细教程</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2019-06-10 17:41:46" itemprop="dateCreated datePublished" datetime="2019-06-10T17:41:46+08:00">2019-06-10</time> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i></span> <span class="post-meta-item-text">更新于</span> <time title="修改时间：2020-06-17 10:42:06" itemprop="dateModified" datetime="2020-06-17T10:42:06+08:00">2020-06-17</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/运维技术/" itemprop="url" rel="index"><span itemprop="name">运维技术</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/运维技术/服务部署/" itemprop="url" rel="index"><span itemprop="name">服务部署</span></a></span></span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-eye"></i> 阅读次数：<span class="busuanzi-value" id="busuanzi_value_page_pv"></span></span><div class="post-symbolscount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i></span> <span class="post-meta-item-text">本文字数：</span> <span title="本文字数">98k</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span title="阅读时长">1:29</span></div></div></header><div class="post-body" itemprop="articleBody"><div id="vip-container"><h2 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h2><p>为什么要做日志分析平台？</p><p>随着业务量的增长，每天业务服务器将会产生上亿条的日志，单个日志文件达几个GB，这时我们发现用Linux自带工具，cat grep awk 分析越来越力不从心了，而且除了服务器日志，还有程序报错日志，分布在不同的服务器，查阅繁琐。</p><p><strong>待解决的痛点:</strong></p><p>1、大量不同种类的日志成为了运维人员的负担，不方便管理;</p><p>2、单个日志文件巨大，无法使用常用的文本工具分析，检索困难;</p><p>3、日志分布在多台不同的服务器上，业务一旦出现故障，需要一台台查看日志。</p><p>为了解决以上困扰: 接下来我们要一步步构建这个日志分析平台，架构图如下:</p><a id="more"></a><p>架构图的构建考虑：</p><p>1，考虑既能收集日志，又是轻量级的，所耗服务器资源和负载较低。选用filebeat</p><p>2, 考虑到高可用和日志数据的安全，加入缓存中间件集群。选用kafka和zookeeper</p><p>3, 在kafka集群前面加入logstash进行导入，是为了横向扩展kafka的broker。试想下，添加或减少kafka broker集群节点，需要每台机器上更改filebeat的配置，那就头疼了。</p><p>4，在kafka集群后面添加logstash转发层，是为了可以根据kafka集群topic的使用情况横向扩展，负载较高的topic可以适当增加logstash进行处理。</p><p>5，es集群负责存储，kibana前端展示和搜索。</p><h2 id="架构图："><a href="#架构图：" class="headerlink" title="架构图："></a>架构图：</h2><p><img src="/articles/944dc498/1.png" alt="img"></p><p><strong>架构解读 : （整个架构从左到右，总共分为5层）</strong></p><p><strong>第一层、数据采集层</strong></p><p>最左边的是业务服务器集群，上面安装了filebeat做日志采集，同时把采集的日志分别发送给两个logstash服务。</p><p><strong>第二层、数据处理层，数据缓存层</strong></p><p>logstash服务把接受到的日志经过格式处理，转存到本地的kafka broker+zookeeper 集群中。</p><p><strong>第三层、数据转发层</strong></p><p>这个单独的Logstash节点会实时去kafka broker集群拉数据，转发至ES DataNode。</p><p><strong>第四层、数据持久化存储</strong></p><p>ES DataNode 会把收到的数据，写磁盘，建索引库。</p><p><strong>第五层、数据检索，数据展示</strong></p><p>ES Master + Kibana 主要协调ES集群，处理数据检索请求，数据展示。</p><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><p>操作系统环境 : CentOS 7.2</p><p>各服务器角色分配 :</p><p>3台服务器：</p><p>IP : 10.10.0.193</p><p>IP : 10.10.0.194</p><p>IP : 10.10.0.195</p><table><thead><tr><th><strong>IP</strong></th><th><strong>角色</strong></th><th><strong>所属集群</strong></th></tr></thead><tbody><tr><td>10.10.0.193 10.10.0.194</td><td>nginx+filebeat nginx+filebeat</td><td>业务服务器集群</td></tr><tr><td>10.10.0.193</td><td>Logstash+Kafka+ZooKeeper</td><td>缓存集群</td></tr><tr><td>10.10.0.194</td><td>Logstash+Kafka+ZooKeeper</td><td></td></tr><tr><td>10.10.0.195</td><td>Kafka+ZooKeeper</td><td></td></tr><tr><td>10.10.0.195</td><td>Logstash</td><td>数据转发</td></tr><tr><td>10.10.0.193</td><td>ES DataNode</td><td>Elasticsearch 集群</td></tr><tr><td>10.10.0.194</td><td>ES DataNode</td><td></td></tr><tr><td>10.10.0.195</td><td>ES Master+Kibana</td><td></td></tr></tbody></table><h2 id="软件包版本和下载网站"><a href="#软件包版本和下载网站" class="headerlink" title="软件包版本和下载网站:"></a>软件包版本和下载网站:</h2><p>jdk-8u161-linux-x64.rpm</p><p>node-v8.10.0-linux-x64.tar.xz</p><p>nginx-1.12.2.tar.gz</p><p>logstash-6.2.2.tar.gz</p><p>filebeat-6.2.2-x86_64.rpm</p><p>kafka_2.11-1.0.1.tgz</p><p>zookeeper-3.4.10.tar.gz</p><p>elasticsearch-6.2.2.tar.gz</p><p>kibana-6.2.2-linux-x86_64.tar.gz</p><p>jdk下载：<a href="http://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html" target="_blank" rel="noopener">http://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html</a></p><p>nodejs下载：<a href="https://nodejs.org/en/download/" target="_blank" rel="noopener">https://nodejs.org/en/download/</a></p><p>nginx下载：<a href="http://nginx.org/en/download.html" target="_blank" rel="noopener">http://nginx.org/en/download.html</a></p><p>filebeat,logstash,elasticsearch,kibana下载：<a href="https://www.elastic.co/cn/downloads" target="_blank" rel="noopener">https://www.elastic.co/cn/downloads</a></p><p>kafka下载：<a href="http://kafka.apache.org/downloads" target="_blank" rel="noopener">http://kafka.apache.org/downloads</a></p><p>zookeeper下载：<a href="http://zookeeper.apache.org/releases.html#download" target="_blank" rel="noopener">http://zookeeper.apache.org/releases.html#download</a></p><h2 id="安装部署Elasticsearch集群"><a href="#安装部署Elasticsearch集群" class="headerlink" title="安装部署Elasticsearch集群"></a><strong>安装部署Elasticsearch集群</strong></h2><p>ES Master节点 10.10.0.195</p><h3 id="安装jdk1-8，elasticsearch"><a href="#安装jdk1-8，elasticsearch" class="headerlink" title="安装jdk1.8，elasticsearch"></a>安装jdk1.8，elasticsearch</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 安装命令</span></span><br><span class="line">yum install jdk-8u161-linux-x64.rpm -y</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建es用户（从5.0后root不能启动被限制）</span></span><br><span class="line">groupadd es </span><br><span class="line">useradd es </span><br><span class="line">passwd es</span><br><span class="line">更改用户 es 的密码 。  </span><br><span class="line">新的 密码：  </span><br><span class="line">重新输入新的 密码：  </span><br><span class="line">passwd： 所有的身份验证令牌已经成功更新</span><br><span class="line"><span class="meta">#</span><span class="bash">解压包</span></span><br><span class="line">tar -xzvf elasticsearch-6.2.2.tar.gz -C /opt/</span><br><span class="line">mv /opt/elasticsearch-6.2.2  /opt/elasticsearch</span><br><span class="line"><span class="meta">#</span><span class="bash">更改权限</span></span><br><span class="line">chown -R es:es /opt/elasticsearch</span><br></pre></td></tr></table></figure><p>验证jdk：</p><p><img src="/articles/944dc498/2.png" alt="img"></p><h3 id="系统调优，JVM调优"><a href="#系统调优，JVM调优" class="headerlink" title="系统调优，JVM调优"></a><strong>系统调优，JVM调优</strong></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 配置系统最大打开文件描述符数</span></span><br><span class="line">vim /etc/sysctl.conf</span><br><span class="line">vm.max_map_count=262144</span><br><span class="line"><span class="meta">#</span><span class="bash">配置生效</span></span><br><span class="line">sysctl -p</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置进程最大打开文件描述符</span></span><br><span class="line">vim /etc/security/limits.conf</span><br><span class="line"><span class="meta">#</span><span class="bash"> End of file</span></span><br><span class="line">* soft nofile 65536</span><br><span class="line">* hard nofile 131072</span><br><span class="line">* soft nproc 2048</span><br><span class="line">* hard nproc 4096</span><br><span class="line"><span class="meta">#</span><span class="bash">更改配置</span></span><br><span class="line">vim /etc/security/limits.d/20-nproc.conf</span><br><span class="line">*          soft    nproc     4096</span><br><span class="line">root       soft    nproc     unlimited</span><br></pre></td></tr></table></figure><h3 id="编写ES-Master节点配置文件"><a href="#编写ES-Master节点配置文件" class="headerlink" title="编写ES Master节点配置文件"></a><strong>编写ES Master节点配置文件</strong></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">vim /opt/elasticsearch/config/elasticsearch.yml</span><br><span class="line"> </span><br><span class="line"><span class="meta">#</span><span class="bash"> ---------------------------------- Cluster -----------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Use a descriptive name <span class="keyword">for</span> your cluster:</span></span><br><span class="line"> </span><br><span class="line">cluster.name: sunelk</span><br><span class="line"> </span><br><span class="line"><span class="meta">#</span><span class="bash"> ------------------------------------ Node ------------------------------------</span></span><br><span class="line">node.name: node-195</span><br><span class="line">node.master: true</span><br><span class="line">node.data: false</span><br><span class="line">node.ingest: false   </span><br><span class="line">search.remote.connect: false</span><br><span class="line"> </span><br><span class="line"><span class="meta">#</span><span class="bash"> ----------------------------------- Paths ------------------------------------</span></span><br><span class="line">path.data: /home/es/elasticsearch/data/</span><br><span class="line">path.logs: /home/es/elasticsearch/logs/</span><br><span class="line"> </span><br><span class="line"><span class="meta">#</span><span class="bash"> ----------------------------------- Memory -----------------------------------</span></span><br><span class="line">bootstrap.memory_lock: false</span><br><span class="line">bootstrap.system_call_filter: false</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------ Network And HTTP --------------------------</span></span><br><span class="line">network.host: 0.0.0.0</span><br><span class="line">http.port: 9200</span><br><span class="line">  </span><br><span class="line"><span class="meta">#</span><span class="bash"> --------------------------------- Discovery ------------------------------------</span></span><br><span class="line">discovery.zen.ping.unicast.hosts: ["10.10.0.193", "10.10.0.194","10.10.0.195"] </span><br><span class="line">discovery.zen.minimum_master_nodes: 2   </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">下面两行配置为haad插件配置，三台服务器一致。      </span></span><br><span class="line">http.cors.enabled: true                                                                                                                                                                                                   </span><br><span class="line">http.cors.allow-origin: "*"</span><br></pre></td></tr></table></figure><p>注: path.data、path.logs 这两个参数指定的路径，如果没有需要自己创建，还要赋予权限给es用户。（后面的ES DataNode也同样）</p><h3 id="安装head开源插件"><a href="#安装head开源插件" class="headerlink" title="安装head开源插件"></a><strong>安装head开源插件</strong></h3><p>从es6.x后要自己手动编译安装</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">安装node</span></span><br><span class="line">tar -xvf node-v8.10.0-linux-x64.tar.xz -C /opt/</span><br><span class="line">mv /opt/node-v8.10.0-linux-x64 /opt/node</span><br><span class="line"><span class="meta">#</span><span class="bash">更改环境变量</span></span><br><span class="line">vim /etc/profile</span><br><span class="line"></span><br><span class="line">export NODEJS_HOME=/opt/node</span><br><span class="line">export PATH=$PATH:$NODEJS_HOME/bin</span><br><span class="line"></span><br><span class="line">source /etc/profile</span><br><span class="line"><span class="meta">#</span><span class="bash">下载源码</span></span><br><span class="line">cd /opt/</span><br><span class="line">git clone https://github.com/mobz/elasticsearch-head.git</span><br><span class="line">chown -R es:es elasticsearch-head</span><br><span class="line">su es </span><br><span class="line">cd  elasticsearch-head</span><br><span class="line">npm install -g cnpm --registry=https://registry.npm.taobao.org</span><br><span class="line">npm install -g grunt-cli</span><br><span class="line">npm install</span><br><span class="line">npm run start</span><br><span class="line">open http://localhost:9100/</span><br></pre></td></tr></table></figure><p>访问,检测插件是否安装成功</p><p><a href="http://10.10.0.195:9100" target="_blank" rel="noopener">http://10.10.0.195:9100</a></p><p><strong>这时，ES Master已经配置好了。</strong></p><h3 id="部署ES-DataNode节点"><a href="#部署ES-DataNode节点" class="headerlink" title="部署ES DataNode节点"></a>部署ES DataNode节点</h3><p>ES DataNode节点 是10.10.0.193和10.10.0.194</p><p>安装和系统调优方法同上，插件不用安装，只是配置文件不同。</p><p><strong>编写配置文件</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">vim /opt/elasticsearch/config/elasticsearch.yml</span><br><span class="line"> </span><br><span class="line"><span class="meta">#</span><span class="bash"> ---------------------------------- Cluster -----------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Use a descriptive name <span class="keyword">for</span> your cluster:</span></span><br><span class="line"> </span><br><span class="line">cluster.name: sunelk</span><br><span class="line"> </span><br><span class="line"><span class="meta">#</span><span class="bash"> ------------------------------------ Node ------------------------------------</span></span><br><span class="line">node.name: node-193</span><br><span class="line">node.master: true</span><br><span class="line">node.data: true</span><br><span class="line">node.ingest: false   </span><br><span class="line">search.remote.connect: false</span><br><span class="line"> </span><br><span class="line"><span class="meta">#</span><span class="bash"> ----------------------------------- Paths ------------------------------------</span></span><br><span class="line">path.data: /home/es/elasticsearch/data/</span><br><span class="line">path.logs: /home/es/elasticsearch/logs/</span><br><span class="line"> </span><br><span class="line"><span class="meta">#</span><span class="bash"> ----------------------------------- Memory -----------------------------------</span></span><br><span class="line">bootstrap.memory_lock: false</span><br><span class="line">bootstrap.system_call_filter: false</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------------------ Network And HTTP --------------------------</span></span><br><span class="line">network.host: 0.0.0.0</span><br><span class="line">http.port: 9200</span><br><span class="line">  </span><br><span class="line"><span class="meta">#</span><span class="bash"> --------------------------------- Discovery ------------------------------------</span></span><br><span class="line">discovery.zen.ping.unicast.hosts: ["10.10.0.193", "10.10.0.194","10.10.0.195"] </span><br><span class="line">discovery.zen.minimum_master_nodes: 2   </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">下面两行配置为haad插件配置，三台服务器一致。      </span></span><br><span class="line">http.cors.enabled: true                                                                                                                                                                                                   </span><br><span class="line">http.cors.allow-origin: "*</span><br></pre></td></tr></table></figure><p><strong>10.10.0.193 也准备好了,10.10.0.194和193配置一样，只需改下node.name</strong></p><h3 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 10.10.0.195</span></span><br><span class="line">nohup /opt/elasticsearch/bin/elasticsearch &amp;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 10.10.0.193</span></span><br><span class="line">nohup /opt/elasticsearch/bin/elasticsearch &amp;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 10.10.0.194</span></span><br><span class="line">nohup /opt/elasticsearch/bin/elasticsearch &amp;</span><br></pre></td></tr></table></figure><h3 id="访问head插件，查看集群状态"><a href="#访问head插件，查看集群状态" class="headerlink" title="访问head插件，查看集群状态"></a><strong>访问head插件，查看集群状态</strong></h3><p><img src="/articles/944dc498/50.png" alt="img"><strong>此时 Elasticsearch 集群已经准备完成</strong></p><h2 id="配置ZooKeeper集群"><a href="#配置ZooKeeper集群" class="headerlink" title="配置ZooKeeper集群"></a><strong>配置ZooKeeper集群</strong></h2><p>配置 10.10.0.193 节点</p><h3 id="安装，配置-zookeeper"><a href="#安装，配置-zookeeper" class="headerlink" title="安装，配置 zookeeper"></a><strong>安装，配置 zookeeper</strong></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> zookeeper 依赖 java，如果之前没安装过JDK，则需要安装.</span></span><br><span class="line">rpm -ivh jdk-8u161-linux-x64.rpm</span><br><span class="line"> </span><br><span class="line"><span class="meta">#</span><span class="bash"> 解压程序</span></span><br><span class="line">tar -xzvf zookeeper-3.4.10.tar.gz  -C /opt/</span><br><span class="line">mv /opt/zookeeper-3.4.10 /opt/zookeeper</span><br></pre></td></tr></table></figure><h3 id="编写配置文件"><a href="#编写配置文件" class="headerlink" title="编写配置文件"></a><strong>编写配置文件</strong></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">vim /opt/zookeeper/conf/zoo.cfg</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The number of milliseconds of each tick</span></span><br><span class="line">tickTime=2000</span><br><span class="line"><span class="meta">#</span><span class="bash"> The number of ticks that the initial </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> synchronization phase can take</span></span><br><span class="line">initLimit=10</span><br><span class="line"><span class="meta">#</span><span class="bash"> The number of ticks that can pass between </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> sending a request and getting an acknowledgement</span></span><br><span class="line">syncLimit=5</span><br><span class="line"><span class="meta">#</span><span class="bash"> the directory <span class="built_in">where</span> the snapshot is stored.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">do</span> not use /tmp <span class="keyword">for</span> storage, /tmp here is just </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> example sakes.</span></span><br><span class="line">dataDir=/tmp/zookeeper</span><br><span class="line"><span class="meta">#</span><span class="bash"> the port at <span class="built_in">which</span> the clients will connect</span></span><br><span class="line">clientPort=2181</span><br><span class="line"><span class="meta">#</span><span class="bash"> the maximum number of client connections.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> increase this <span class="keyword">if</span> you need to handle more clients</span></span><br><span class="line"><span class="meta">#</span><span class="bash">maxClientCnxns=60</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Be sure to <span class="built_in">read</span> the maintenance section of the </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> administrator guide before turning on autopurge.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> http://zookeeper.apache.org/doc/current/zookeeperAdmin.html<span class="comment">#sc_maintenance</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The number of snapshots to retain <span class="keyword">in</span> dataDir</span></span><br><span class="line"><span class="meta">#</span><span class="bash">autopurge.snapRetainCount=3</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Purge task interval <span class="keyword">in</span> hours</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Set to <span class="string">"0"</span> to <span class="built_in">disable</span> auto purge feature</span></span><br><span class="line"><span class="meta">#</span><span class="bash">autopurge.purgeInterval=1</span></span><br><span class="line">server.1=10.10.0.193:2888:3888</span><br><span class="line">server.2=10.10.0.194:2888:3888</span><br><span class="line">server.3=10.10.0.195:2888:3888</span><br></pre></td></tr></table></figure><p><strong>同步配置文件到其他两台节点</strong></p><p>注: zookeeper 集群，每个节点的配置文件都是一样的。所以直接同步过去，不需要做任何修改。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scp zoo.cfg 10.10.0.193:/opt/zookeeper/conf/</span><br><span class="line">scp zoo.cfg 10.10.0.194:/opt/zookeeper/conf/</span><br></pre></td></tr></table></figure><h3 id="创建myid文件"><a href="#创建myid文件" class="headerlink" title="创建myid文件"></a><strong>创建myid文件</strong></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 10.10.0.193</span></span><br><span class="line">echo 1 &gt;/tmp/zookeeper/myid</span><br><span class="line"> </span><br><span class="line"><span class="meta">#</span><span class="bash"> 10.10.0.194</span></span><br><span class="line">echo 2 &gt;/tmp/zookeeper/myid</span><br><span class="line"> </span><br><span class="line"><span class="meta">#</span><span class="bash"> 10.10.0.195</span></span><br><span class="line">echo 3 &gt;/tmp/zookeeper/myid</span><br></pre></td></tr></table></figure><h3 id="启动服务-amp-查看节点状态"><a href="#启动服务-amp-查看节点状态" class="headerlink" title="启动服务 &amp; 查看节点状态"></a><strong>启动服务 &amp; 查看节点状态</strong></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 10.10.0.193</span></span><br><span class="line">/opt/zookeeper/bin/zkServer.sh start</span><br><span class="line">/opt/zookeeper/bin/zkServer.sh status</span><br><span class="line"> </span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /usr/local/zookeeper/zookeeper-3.4.9/bin/../conf/zoo.cfg</span><br><span class="line">Mode: leader</span><br><span class="line"> </span><br><span class="line"><span class="meta">#</span><span class="bash"> 10.10.0.194</span></span><br><span class="line">/opt/zookeeper/bin/zkServer.sh start</span><br><span class="line">/opt/zookeeper/bin/zkServer.sh status</span><br><span class="line">  </span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /usr/local/zookeeper/zookeeper-3.4.9/bin/../conf/zoo.cfg</span><br><span class="line">Mode: follower</span><br><span class="line"> </span><br><span class="line"><span class="meta">#</span><span class="bash"> 10.10.0.195</span></span><br><span class="line">/opt/zookeeper/bin/zkServer.sh start </span><br><span class="line">/opt/zookeeper/bin/zkServer.sh status</span><br><span class="line"> </span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /usr/local/zookeeper/zookeeper-3.4.9/bin/../conf/zoo.cfg</span><br><span class="line">Mode: follower</span><br></pre></td></tr></table></figure><p><strong>此时zookeeper集群配置完成</strong></p><h2 id="配置Kafka-Broker集群"><a href="#配置Kafka-Broker集群" class="headerlink" title="配置Kafka Broker集群"></a><strong>配置Kafka Broker集群</strong></h2><p>Kafka官网: <a href="http://kafka.apache.org/" target="_blank" rel="noopener">http://kafka.apache.org/</a></p><p>配置 10.10.0.193 节点</p><h3 id="安装，配置-kafka"><a href="#安装，配置-kafka" class="headerlink" title="安装，配置 kafka"></a><strong>安装，配置 kafka</strong></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 解压程序</span></span><br><span class="line">tar -xzvf kafka_2.11-1.0.1.tgz -C /opt/</span><br><span class="line">mv /opt/kafka_2.11-1.0.1 /opt/kafka</span><br></pre></td></tr></table></figure><h3 id="编写配置文件-1"><a href="#编写配置文件-1" class="headerlink" title="编写配置文件"></a><strong>编写配置文件</strong></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">vim /opt/kafka/conf/server.properties</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">############################ Server Basics #############################</span></span></span><br><span class="line">broker.id=1</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">############################ Socket Server Settings #############################</span></span></span><br><span class="line">num.network.threads=3</span><br><span class="line"><span class="meta">#</span><span class="bash"> The number of threads doing disk I/O</span></span><br><span class="line">num.io.threads=8</span><br><span class="line"><span class="meta">#</span><span class="bash"> The send buffer (SO_SNDBUF) used by the socket server</span></span><br><span class="line">socket.send.buffer.bytes=102400</span><br><span class="line"><span class="meta">#</span><span class="bash"> The receive buffer (SO_RCVBUF) used by the socket server</span></span><br><span class="line">socket.receive.buffer.bytes=102400</span><br><span class="line"><span class="meta">#</span><span class="bash"> The maximum size of a request that the socket server will accept (protection against OOM)</span></span><br><span class="line">socket.request.max.bytes=104857600</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">############################ Log Basics #############################</span></span></span><br><span class="line">log.dirs=/opt/kafka/data</span><br><span class="line">num.partitions=6</span><br><span class="line">num.recovery.threads.per.data.dir=1</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">############################ Log Flush Policy #############################</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The number of messages to accept before forcing a flush of data to disk</span></span><br><span class="line"><span class="meta">#</span><span class="bash">log.flush.interval.messages=10000</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The maximum amount of time a message can sit <span class="keyword">in</span> a <span class="built_in">log</span> before we force a flush</span></span><br><span class="line"><span class="meta">#</span><span class="bash">log.flush.interval.ms=1000</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">############################ Log Retention Policy #############################</span></span></span><br><span class="line">log.retention.hours=60</span><br><span class="line">log.segment.bytes=1073741824</span><br><span class="line">log.retention.check.interval.ms=300000</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">############################ Zookeeper #############################</span></span></span><br><span class="line">zookeeper.connect=10.10.0.193:2181,10.10.0.194:2181,10.10.0.195:2181</span><br><span class="line">zookeeper.connection.timeout.ms=6000</span><br></pre></td></tr></table></figure><h3 id="同步配置文件到其他两台节点"><a href="#同步配置文件到其他两台节点" class="headerlink" title="同步配置文件到其他两台节点"></a><strong>同步配置文件到其他两台节点</strong></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">scp server.properties 10.10.0.194:/opt/kafka/config/</span><br><span class="line">scp server.properties 10.10.0.195:/opt/kafka/config/</span><br><span class="line"> </span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改 broker.id</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 10.10.0.194</span></span><br><span class="line">broker.id=2</span><br><span class="line"> </span><br><span class="line"><span class="meta">#</span><span class="bash"> 10.10.0.195</span></span><br><span class="line">broker.id=3</span><br></pre></td></tr></table></figure><p><strong>注: 其他两个节点的配置文件也基本相同，只有一个参数需要修改 broker.id 。 它用于唯一标识节点，所以绝对不能相同，不然会节点冲突。</strong></p><h3 id="配置主机名对应IP的解析"><a href="#配置主机名对应IP的解析" class="headerlink" title="配置主机名对应IP的解析"></a><strong>配置主机名对应IP的解析</strong></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/hosts</span><br><span class="line"> </span><br><span class="line">10.10.0.193 elk-01</span><br><span class="line">10.10.0.194 elk-02</span><br><span class="line">10.10.0.195 elk-03</span><br><span class="line"> </span><br><span class="line"># 记得同步到其他两台节点</span><br></pre></td></tr></table></figure><h3 id="启动服务-1"><a href="#启动服务-1" class="headerlink" title="启动服务"></a><strong>启动服务</strong></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">nohup /opt/kafka/bin/kafka-server-start.sh /opt/kafka/config/server.properties &amp;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 其他两台节点启动方式相同</span></span><br><span class="line"></span><br><span class="line">在kafka中创建topic</span><br><span class="line">/opt/kafka/bin/kafka-topics.sh --create --zookeeper localhost:2181 --replication-factor 1 --partitions 1 --topic nginxlog</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">可以增加topic分区,当然也可在创建时把--partitions增大</span></span><br><span class="line">/opt/kafka/bin/kafka-topics.sh --zookeeper localhost:2181  --alter --topic nginxlog --partitions 10</span><br></pre></td></tr></table></figure><p><strong>Kafka+ZooKeeper集群配置完成</strong></p><h2 id="配置位于架构图中第二层的Logstash服务"><a href="#配置位于架构图中第二层的Logstash服务" class="headerlink" title="配置位于架构图中第二层的Logstash服务"></a><strong>配置位于架构图中第二层的Logstash服务</strong></h2><p>配置 10.10.0.193节点</p><h3 id="安装，配置-logstash"><a href="#安装，配置-logstash" class="headerlink" title="安装，配置 logstash"></a><strong>安装，配置 logstash</strong></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 解压程序</span></span><br><span class="line">tar -xzvf logstash-6.2.2.tar.gz -C /opt/</span><br><span class="line">mv /opt/logstash-6.2.2 /opt/logstash</span><br></pre></td></tr></table></figure><h3 id="编写配置文件-2"><a href="#编写配置文件-2" class="headerlink" title="编写配置文件"></a><strong>编写配置文件</strong></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">vim /opt/logstash/config/logstash_in_kafka.conf</span><br><span class="line"></span><br><span class="line">input &#123;</span><br><span class="line">    beats &#123;</span><br><span class="line">    port =&gt; 5044</span><br><span class="line">    codec =&gt; "json"</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  kafka &#123;</span><br><span class="line">    bootstrap_servers =&gt; "10.10.0.193:9092,10.10.0.194:9092,10.10.0.195:9092"</span><br><span class="line">    topic_id =&gt; "nginxlog"</span><br><span class="line">    &#125;  </span><br><span class="line"><span class="meta"> #</span><span class="bash"> stdout &#123;codec =&gt; json&#125;  调试时打开</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="启动服务-2"><a href="#启动服务-2" class="headerlink" title="启动服务"></a><strong>启动服务</strong></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup /opt/logstash/bin/logstash -f /opt/logstash/config/logstash_in_kafka.conf &amp;</span><br></pre></td></tr></table></figure><p>10.10.0.194 节点的这块配置，与上述完全相同。（略）</p><p><strong>位于第二层、数据处理层的 Logstash 配置完成</strong></p><h2 id="配置数据采集层，业务服务器-Filebeat"><a href="#配置数据采集层，业务服务器-Filebeat" class="headerlink" title="配置数据采集层，业务服务器+Filebeat"></a><strong>配置数据采集层，业务服务器+Filebeat</strong></h2><h3 id="定制Nginx日志格式"><a href="#定制Nginx日志格式" class="headerlink" title="定制Nginx日志格式"></a><strong>定制Nginx日志格式</strong></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">log_format json &apos;&#123;&quot;@timestamp&quot;:&quot;$time_iso8601&quot;,&apos;</span><br><span class="line">                 &apos;&quot;slbip&quot;:&quot;$remote_addr&quot;,&apos;</span><br><span class="line">                 &apos;&quot;clientip&quot;:&quot;$http_x_forwarded_for&quot;,&apos;</span><br><span class="line">                 &apos;&quot;serverip&quot;:&quot;$server_addr&quot;,&apos;</span><br><span class="line">                 &apos;&quot;size&quot;:$body_bytes_sent,&apos;</span><br><span class="line">                 &apos;&quot;responsetime&quot;:$request_time,&apos;</span><br><span class="line">                 &apos;&quot;domain&quot;:&quot;$host&quot;,&apos;</span><br><span class="line">                 &apos;&quot;method&quot;:&quot;$request_method&quot;,&apos;</span><br><span class="line">                 &apos;&quot;requesturi&quot;:&quot;$request_uri&quot;,&apos;</span><br><span class="line">                 &apos;&quot;url&quot;:&quot;$uri&quot;,&apos;</span><br><span class="line">                 &apos;&quot;appversion&quot;:&quot;$HTTP_APP_VERSION&quot;,&apos;</span><br><span class="line">                 &apos;&quot;referer&quot;:&quot;$http_referer&quot;,&apos;</span><br><span class="line">                 &apos;&quot;agent&quot;:&quot;$http_user_agent&quot;,&apos;</span><br><span class="line">                 &apos;&quot;status&quot;:&quot;$status&quot;,&apos;</span><br><span class="line">                 &apos;&quot;devicecode&quot;:&quot;$HTTP_HA&quot;&#125;&apos;;</span><br><span class="line">                  </span><br><span class="line"># 在虚拟主机配置中调用</span><br><span class="line">access_log  /var/log/nginx/access.log json;</span><br></pre></td></tr></table></figure><h3 id="安装-Filebeat"><a href="#安装-Filebeat" class="headerlink" title="安装 Filebeat"></a><strong>安装 Filebeat</strong></h3><p>Filebeat 也是 Elasticsearch 公司的产品，在官网可以下载。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> rpm 包安装</span></span><br><span class="line">yum install filebeat-6.2.2-x86_64.rpm -y</span><br></pre></td></tr></table></figure><h3 id="编写-Filebeat-配置文件"><a href="#编写-Filebeat-配置文件" class="headerlink" title="编写 Filebeat 配置文件"></a><strong>编写 Filebeat 配置文件</strong></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br></pre></td><td class="code"><pre><span class="line">vim  /etc/filebeat/filebeat.yml</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">##################### Filebeat Configuration Example #########################</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> This file is an example configuration file highlighting only the most common</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> options. The filebeat.reference.yml file from the same directory contains all the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> supported options with more comments. You can use it as a reference.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> You can find the full configuration reference here:</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> https://www.elastic.co/guide/en/beats/filebeat/index.html</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> For more available modules and options, please see the filebeat.reference.yml sample</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> configuration file.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">=========================== Filebeat prospectors =============================</span></span><br><span class="line"></span><br><span class="line">filebeat.prospectors:</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Each - is a prospector. Most options can be <span class="built_in">set</span> at the prospector level, so</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> you can use different prospectors <span class="keyword">for</span> various configurations.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Below are the prospector specific configurations.</span></span><br><span class="line"></span><br><span class="line">- type: log</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Change to <span class="literal">true</span> to <span class="built_in">enable</span> this prospector configuration.</span></span><br><span class="line">  enabled: true</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Paths that should be crawled and fetched. Glob based paths.</span></span><br><span class="line">  paths:</span><br><span class="line">    - /var/log/nginx/access.log</span><br><span class="line">    #- c:\programdata\elasticsearch\logs\*</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Exclude lines. A list of regular expressions to match. It drops the lines that are</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> matching any regular expression from the list.</span></span><br><span class="line"><span class="meta">  #</span><span class="bash">exclude_lines: [<span class="string">'^DBG'</span>]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Include lines. A list of regular expressions to match. It exports the lines that are</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> matching any regular expression from the list.</span></span><br><span class="line"><span class="meta">  #</span><span class="bash">include_lines: [<span class="string">'^ERR'</span>, <span class="string">'^WARN'</span>]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Exclude files. A list of regular expressions to match. Filebeat drops the files that</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> are matching any regular expression from the list. By default, no files are dropped.</span></span><br><span class="line"><span class="meta">  #</span><span class="bash">exclude_files: [<span class="string">'.gz$'</span>]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Optional additional fields. These fields can be freely picked</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> to add additional information to the crawled <span class="built_in">log</span> files <span class="keyword">for</span> filtering</span></span><br><span class="line"><span class="meta">  #</span><span class="bash">fields:</span></span><br><span class="line"><span class="meta">  #</span><span class="bash">  level: debug</span></span><br><span class="line"><span class="meta">  #</span><span class="bash">  review: 1</span></span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"><span class="comment">## Multiline options</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Mutiline can be used <span class="keyword">for</span> <span class="built_in">log</span> messages spanning multiple lines. This is common</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> <span class="keyword">for</span> Java Stack Traces or C-Line Continuation</span></span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> The regexp Pattern that has to be matched. The example pattern matches all lines starting with [</span></span><br><span class="line"><span class="meta">  #</span><span class="bash">multiline.pattern: ^\[</span></span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Defines <span class="keyword">if</span> the pattern <span class="built_in">set</span> under pattern should be negated or not. Default is <span class="literal">false</span>.</span></span><br><span class="line"><span class="meta">  #</span><span class="bash">multiline.negate: <span class="literal">false</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Match can be <span class="built_in">set</span> to <span class="string">"after"</span> or <span class="string">"before"</span>. It is used to define <span class="keyword">if</span> lines should be append to a pattern</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> that was (not) matched before or after or as long as a pattern is not matched based on negate.</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Note: After is the equivalent to previous and before is the equivalent to to next <span class="keyword">in</span> Logstash</span></span><br><span class="line"><span class="meta">  #</span><span class="bash">multiline.match: after</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">============================= Filebeat modules ===============================</span></span><br><span class="line"></span><br><span class="line">filebeat.config.modules:</span><br><span class="line"><span class="meta">  #</span><span class="bash"> Glob pattern <span class="keyword">for</span> configuration loading</span></span><br><span class="line">  path: $&#123;path.config&#125;/modules.d/*.yml</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Set to <span class="literal">true</span> to <span class="built_in">enable</span> config reloading</span></span><br><span class="line">  reload.enabled: false</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Period on <span class="built_in">which</span> files under path should be checked <span class="keyword">for</span> changes</span></span><br><span class="line"><span class="meta">  #</span><span class="bash">reload.period: 10s</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">==================== Elasticsearch template setting ==========================</span></span><br><span class="line"></span><br><span class="line">setup.template.settings:</span><br><span class="line">  index.number_of_shards: 3</span><br><span class="line"><span class="meta">  #</span><span class="bash">index.codec: best_compression</span></span><br><span class="line"><span class="meta">  #</span><span class="bash">_source.enabled: <span class="literal">false</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">================================ General =====================================</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The name of the shipper that publishes the network data. It can be used to group</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> all the transactions sent by a single shipper <span class="keyword">in</span> the web interface.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">name:</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The tags of the shipper are included <span class="keyword">in</span> their own field with each</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> transaction published.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">tags: [<span class="string">"service-X"</span>, <span class="string">"web-tier"</span>]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Optional fields that you can specify to add additional information to the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> output.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">fields:</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  env: staging</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">============================== Dashboards =====================================</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> These settings control loading the sample dashboards to the Kibana index. Loading</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> the dashboards is disabled by default and can be enabled either by setting the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> options here, or by using the `-setup` CLI flag or the `setup` <span class="built_in">command</span>.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">setup.dashboards.enabled: <span class="literal">false</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The URL from <span class="built_in">where</span> to download the dashboards archive. By default this URL</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> has a value <span class="built_in">which</span> is computed based on the Beat name and version. For released</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> versions, this URL points to the dashboard archive on the artifacts.elastic.co</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> website.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">setup.dashboards.url:</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">============================== Kibana =====================================</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Starting with Beats version 6.0.0, the dashboards are loaded via the Kibana API.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> This requires a Kibana endpoint configuration.</span></span><br><span class="line">setup.kibana:</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Kibana Host</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Scheme and port can be left out and will be <span class="built_in">set</span> to the default (http and 5601)</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> In <span class="keyword">case</span> you specify and additional path, the scheme is required: http://localhost:5601/path</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> IPv6 addresses should always be defined as: https://[2001:db8::1]:5601</span></span><br><span class="line"><span class="meta">  #</span><span class="bash">host: <span class="string">"localhost:5601"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">============================= Elastic Cloud ==================================</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> These settings simplify using filebeat with the Elastic Cloud (https://cloud.elastic.co/).</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The cloud.id setting overwrites the `output.elasticsearch.hosts` and</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> `setup.kibana.host` options.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> You can find the `cloud.id` <span class="keyword">in</span> the Elastic Cloud web UI.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">cloud.id:</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The cloud.auth setting overwrites the `output.elasticsearch.username` and</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> `output.elasticsearch.password` settings. The format is `&lt;user&gt;:&lt;pass&gt;`.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">cloud.auth:</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">================================ Outputs =====================================</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Configure what output to use when sending the data collected by the beat.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">output:</span></span><br><span class="line"><span class="meta">#</span><span class="bash">  console:</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    pretty: <span class="literal">true</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">-------------------------- Elasticsearch output ------------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash">output.elasticsearch:</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Array of hosts to connect to.</span></span><br><span class="line"><span class="meta">  #</span><span class="bash">hosts: [<span class="string">"elk-01:9200"</span>]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Optional protocol and basic auth credentials.</span></span><br><span class="line"><span class="meta">  #</span><span class="bash">protocol: <span class="string">"https"</span></span></span><br><span class="line"><span class="meta">  #</span><span class="bash">username: <span class="string">"elastic"</span></span></span><br><span class="line"><span class="meta">  #</span><span class="bash">password: <span class="string">"changeme"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">----------------------------- Logstash output --------------------------------</span></span><br><span class="line">output.logstash:</span><br><span class="line"><span class="meta">  #</span><span class="bash"> The Logstash hosts</span></span><br><span class="line">  hosts: ["elk-01:5044"]</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Optional SSL. By default is off.</span></span><br><span class="line"><span class="meta">  #</span><span class="bash"> List of root certificates <span class="keyword">for</span> HTTPS server verifications</span></span><br><span class="line"><span class="meta">  #</span><span class="bash">ssl.certificate_authorities: [<span class="string">"/etc/pki/root/ca.pem"</span>]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Certificate <span class="keyword">for</span> SSL client authentication</span></span><br><span class="line"><span class="meta">  #</span><span class="bash">ssl.certificate: <span class="string">"/etc/pki/client/cert.pem"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"> Client Certificate Key</span></span><br><span class="line"><span class="meta">  #</span><span class="bash">ssl.key: <span class="string">"/etc/pki/client/cert.key"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">================================ Logging =====================================</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Sets <span class="built_in">log</span> level. The default <span class="built_in">log</span> level is info.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Available <span class="built_in">log</span> levels are: error, warning, info, debug</span></span><br><span class="line"><span class="meta">#</span><span class="bash">logging.level: debug</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> At debug level, you can selectively <span class="built_in">enable</span> logging only <span class="keyword">for</span> some components.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> To <span class="built_in">enable</span> all selectors use [<span class="string">"*"</span>]. Examples of other selectors are <span class="string">"beat"</span>,</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="string">"publish"</span>, <span class="string">"service"</span>.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">logging.selectors: [<span class="string">"*"</span>]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">============================== Xpack Monitoring ===============================</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> filebeat can <span class="built_in">export</span> internal metrics to a central Elasticsearch monitoring</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> cluster.  This requires xpack monitoring to be enabled <span class="keyword">in</span> Elasticsearch.  The</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> reporting is disabled by default.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Set to <span class="literal">true</span> to <span class="built_in">enable</span> the monitoring reporter.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">xpack.monitoring.enabled: <span class="literal">false</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Uncomment to send the metrics to Elasticsearch. Most settings from the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Elasticsearch output are accepted here as well. Any setting that is not <span class="built_in">set</span> is</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> automatically inherited from the Elasticsearch output configuration, so <span class="keyword">if</span> you</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> have the Elasticsearch output configured, you can simply uncomment the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> following line.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">xpack.monitoring.elasticsearch:</span></span><br></pre></td></tr></table></figure><h3 id="启动服务-3"><a href="#启动服务-3" class="headerlink" title="启动服务"></a><strong>启动服务</strong></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/filebeat start</span><br></pre></td></tr></table></figure><p><strong>数据采集层，Filebeat配置完成。</strong></p><p>现在业务服务器上的日志数据已经在源源不断的写入缓存了。</p><h2 id="配置位于架构图中的第三层，数据转发层"><a href="#配置位于架构图中的第三层，数据转发层" class="headerlink" title="配置位于架构图中的第三层，数据转发层"></a><strong>配置位于架构图中的第三层，数据转发层</strong></h2><p>10.10.0.195 logstash 安装过程和193/194一样，参考上面步骤。</p><h3 id="编写Logstash配置文件"><a href="#编写Logstash配置文件" class="headerlink" title="编写Logstash配置文件"></a><strong>编写Logstash配置文件</strong></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">vim /opt/logstash/config/kafka_to_es.conf</span><br><span class="line"></span><br><span class="line">input &#123;</span><br><span class="line">        kafka &#123;</span><br><span class="line">            bootstrap_servers =&gt; "10.10.0.193:9092,10.10.0.194:9092"</span><br><span class="line">            auto_offset_reset =&gt; "latest"</span><br><span class="line">            group_id =&gt; "logstash"</span><br><span class="line">            consumer_threads =&gt; 3</span><br><span class="line">            decorate_events =&gt; true</span><br><span class="line">            topics =&gt; ["nginxlog"]</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">         if [type] == "nginxlog" &#123;</span><br><span class="line">                mutate &#123;</span><br><span class="line">                remove_field =&gt;</span><br><span class="line">["slbip","kafka","domain","serverip","url","@version","offset","input_type","count","sourc</span><br><span class="line">e","fields","beat.hostname","host","tags"]</span><br><span class="line">                        &#125; </span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line"><span class="meta">#</span><span class="bash">       stdout &#123;codec =&gt; json&#125;</span></span><br><span class="line">        elasticsearch &#123;</span><br><span class="line">            hosts =&gt; ["10.10.0.193:9200","10.10.0.194:9200"]</span><br><span class="line">            timeout =&gt; 300</span><br><span class="line">            index =&gt; "nginxlog"</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="启动服务-4"><a href="#启动服务-4" class="headerlink" title="启动服务"></a><strong>启动服务</strong></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup /opt/logstash/bin/logstash -f /opt/logstash/config/kafka_to_es.conf &amp;</span><br></pre></td></tr></table></figure><p><strong>数据转发层已经配置完成</strong></p><h2 id="修改ES的索引模版配置"><a href="#修改ES的索引模版配置" class="headerlink" title="修改ES的索引模版配置"></a><strong>修改ES的索引模版配置</strong></h2><p>为什么要做这一步呢？ 因为logstash写入数据到ES时，会自动选用一个索引模版。 我们可以看一下</p><p><img src="/articles/944dc498/3.png" alt="img"></p><p>这个模版其实也挺好，不过有一个参数，我标记出来了。 “refresh_interval”:”5s” 这个参数用于控制，索引的刷新频率。 索引的刷新频率越快，你搜索到的数据就实时。 这里是5秒。 一般我们日志场景不需要这么高的实时性。 可以适当降低该参数，提高ES 索引库的写入速度。</p><p><strong>上传自定义模版</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT http://10.10.0.195:9200/_template/logstash2 -d '</span><br><span class="line">&#123;</span><br><span class="line">        "order":1,</span><br><span class="line">        "template":"logstash-*",</span><br><span class="line">        "settings":&#123;</span><br><span class="line">            "index":&#123;</span><br><span class="line">                "refresh_interval":"120s"</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        "mappings":&#123;</span><br><span class="line">            "_default_":&#123;</span><br><span class="line">                "_all":&#123;</span><br><span class="line">                    "enabled":false</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;'</span><br></pre></td></tr></table></figure><p>由于这个自定义模版，我把优先级 order 定义的比logstash模版高，而模版的匹配规则又一样，所以这个自定义模版的配置会覆盖原logstash模版。</p><p>我这里只是简单描述。 如果要详细理解其中道理，请查看我的 ES 调优篇。</p><h2 id="配置-Kibana-数据展示层"><a href="#配置-Kibana-数据展示层" class="headerlink" title="配置 Kibana 数据展示层"></a><strong>配置 Kibana 数据展示层</strong></h2><p>10.10.0.195 节点</p><p>Kibana是ELK套件中的一员，也属于elasticsearch 公司，在官网提供下载。</p><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a><strong>安装</strong></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tar -xzvf kibana-6.2.2-linux-x86_64.tar.gz -C /opt/</span><br><span class="line">mv /opt/kibana-6.2.2-linux-x86_64 /opt/kibana</span><br></pre></td></tr></table></figure><h3 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a><strong>修改配置文件</strong></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> vim /opt/kibana/config/kibana.yml</span></span><br><span class="line"> </span><br><span class="line">server.port: 5601</span><br><span class="line">server.host: 0.0.0.0</span><br><span class="line">elasticsearch.url: "http://10.10.0.195:9200"</span><br><span class="line"> </span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改这三个参数就好了</span></span><br></pre></td></tr></table></figure><h3 id="启动服务-5"><a href="#启动服务-5" class="headerlink" title="启动服务"></a><strong>启动服务</strong></h3><p><img src="/articles/944dc498/4.png" alt></p><p>打开浏览器访问: <a href="http://10.10.0.195:5601/" target="_blank" rel="noopener">http://10.10.0.195:5601/</a></p><h2 id="kibana"><a href="#kibana" class="headerlink" title="kibana"></a><strong>kibana</strong></h2><p>Kibana是一个开源的分析和可视化平台，设计用于和Elasticsearch一起工作。</p><p>你用Kibana来搜索，查看，并和存储在Elasticsearch索引中的数据进行交互。</p><p>你可以轻松地执行高级数据分析，并且以各种图标、表格和地图的形式可视化数据。</p><p>Kibana使得理解大量数据变得很容易。它简单的、基于浏览器的界面使你能够快速创建和共享动态仪表板，实时显示Elasticsearch查询的变化。</p><h3 id="安装Kibana"><a href="#安装Kibana" class="headerlink" title="安装Kibana"></a><strong>安装Kibana</strong></h3><hr><p> <img src="/articles/944dc498/5.png" alt="img"></p><p><img src="/articles/944dc498/6.png" alt></p><h3 id="Kibana配置"><a href="#Kibana配置" class="headerlink" title="Kibana配置"></a><strong>Kibana配置</strong></h3><hr><p> <a href="https://www.elastic.co/guide/en/kibana/current/settings.html" target="_blank" rel="noopener">官网文档</a></p><p> <strong>访问Kibana</strong></p><hr><p> Kibana是一个Web应用程序，你可以通过5601来访问它。例如：localhost:5601 或者 <a href="http://YOURDOMAIN.com:5601" target="_blank" rel="noopener">http://YOURDOMAIN.com:5601</a></p><p>当访问Kibana时，默认情况下，Discover页面加载时选择了默认索引模式。时间过滤器设置为最近15分钟，搜索查询设置为match-all(*)</p><h3 id="检查Kibana状态"><a href="#检查Kibana状态" class="headerlink" title="检查Kibana状态"></a><strong>检查Kibana状态</strong></h3><p><a href="http://localhost:5601/status" target="_blank" rel="noopener">http://localhost:5601/status</a></p><p><img src="/articles/944dc498/7.png" alt="img"></p><p>或者 <a href="http://192.168.101.5:5601/api/status" target="_blank" rel="noopener">http://192.168.101.5:5601/api/status</a> 返回JSON格式状态信息</p><h3 id="用Elasticsearch连接到Kibana"><a href="#用Elasticsearch连接到Kibana" class="headerlink" title="用Elasticsearch连接到Kibana"></a><strong>用Elasticsearch连接到Kibana</strong></h3><hr><p> 在你开始用Kibana之前，你需要告诉Kibana你想探索哪个Elasticsearch索引。第一次访问Kibana是，系统会提示你定义一个索引模式以匹配一个或多个索引的名字。</p><p>（提示：默认情况下，Kibana连接允许在localhost上的Elasticsearch实例。为了连接到一个不同的Elasticsearch实例，修改kabana.yml中Elasticsearch的URL，然后重启Kibana。）</p><p>为了配置你想要用Kibana访问的Elasticsearch索引：</p><p>　　1、访问Kibana UI。例如，localhost:56011 或者 <a href="http://YOURDOMAIN.com:5601" target="_blank" rel="noopener">http://YOURDOMAIN.com:5601</a></p><p>　　2、指定一个索引模式来匹配一个或多个你的Elasticsearch索引。当你指定了你的索引模式以后，任何匹配到的索引都将被展示出来。</p><p>　　（画外音：*匹配0个或多个字符； 指定索引默认是为了匹配索引，确切的说是匹配索引名字）</p><p>　　3、点击“<strong>Next Step</strong>”以选择你想要用来执行基于时间比较的包含timestamp字段的索引。如果你的索引没有基于时间的数据，那么选择“<strong>I don’t want to use the Time Filter</strong>”选项。</p><p>　　4、点击“<strong>Create index pattern</strong>”按钮来添加索引模式。第一个索引模式自动配置为默认的索引默认，以后当你有多个索引模式的时候，你就可以选择将哪一个设为默认。（提示：Management &gt; Index Patterns）</p><p><img src="/articles/944dc498/8.png" alt="img"></p><p><img src="/articles/944dc498/9.png" alt="img"></p><p><img src="/articles/944dc498/10.png" alt="img"></p><p>现在，Kibana已经连接到你的Elasticsearch数据。Kibana展示了一个只读的字段列表，这些字段是匹配到的这个索引配置的字段。</p><h2 id="使用说明之Discover"><a href="#使用说明之Discover" class="headerlink" title="使用说明之Discover"></a>使用说明之Discover</h2><hr><p>你可以从Discover页面交互式的探索你的数据。你可以访问与所选择的索引默认匹配的每个索引中的每个文档。你可以提交查询请求，过滤搜索结构，并查看文档数据。你也可以看到匹配查询请求的文档数量，以及字段值统计信息。如果你选择的索引模式配置了time字段，则文档随时间的分布将显示在页面顶部的直方图中。</p><p><img src="/articles/944dc498/11.png" alt="img"></p><p><img src="/articles/944dc498/12.png" alt="img"></p><h3 id="设置时间过滤"><a href="#设置时间过滤" class="headerlink" title="设置时间过滤"></a><strong>设置时间过滤</strong></h3><p><img src="/articles/944dc498/13.png" alt="img"></p><p><img src="/articles/944dc498/14.png" alt="img"></p><p><img src="/articles/944dc498/15.png" alt="img"></p><h3 id="搜索数据"><a href="#搜索数据" class="headerlink" title="搜索数据"></a>搜索数据</h3><p>你可以在搜索框中输入查询条件来查询当前索引模式匹配的索引。在查询的时候，你可以使用Kibana标准的查询语言（基于Lucene的查询语法）或者完全基于JSON的Elasticsearch查询语言DSL。Kibana查询语言可以使用自动完成和简化的查询语法作为实验特性，您可以在查询栏的“选项”菜单下进行选择。</p><p>当你提交一个查询请求时，直方图、文档表和字段列表都会更新，以反映搜索结果。命中（匹配到的文档）总数会显示在工具栏中。文档表格中显示了前500个命中。默认情况下，按时间倒序排列，首先显示最新的文档。你可以通过点击“Time”列来逆转排序顺序。</p><p><img src="/articles/944dc498/16.png" alt="img"></p><p><img src="/articles/944dc498/17.png" alt="img"></p><h3 id="Lucene查询语法"><a href="#Lucene查询语法" class="headerlink" title="Lucene查询语法"></a><strong>Lucene查询语法</strong></h3><p>Kibana查询语言基于Lucene查询语法。下面是一些提示，可能会帮到你：</p><ul><li>为了执行一个文本搜索，可以简单的输入一个文本字符串。例如，如果你想搜索web服务器的日志，你可以输入关键字”<strong>safari</strong>“，这样你就可以搜索到所有有关”safari”的字段</li><li>为了搜索一个特定字段的特定值，可以用字段的名称作为前缀。例如，你输入”<strong>status:200</strong>“，将会找到所有status字段的值是200的文档</li><li>为了搜索一个范围值，你可以用括号范围语法，<strong>[START_VALUE TO END_VALUE]</strong>。例如，为了找到状态码是4xx的文档，你可以输入<strong>status:[400 TO 499]</strong></li><li>为了指定更改复杂的查询条件，你可以用布尔操作符 <strong>AND</strong> , <strong>OR</strong> , 和 <strong>NOT</strong>。例如，为了找到状态码是4xx并且extension字段是php或者html的文档，你可以输入<strong>status:[400 TO 499] AND (extension:php OR extension:html)</strong></li></ul><p><img src="/articles/944dc498/18.png" alt="img"></p><p><img src="/articles/944dc498/19.png" alt="img"></p><p><img src="/articles/944dc498/20.png" alt="img"></p><h3 id="Kibana查询语法增强"><a href="#Kibana查询语法增强" class="headerlink" title="Kibana查询语法增强"></a><strong>Kibana查询语法增强</strong></h3><p><strong>新的更简单的语法</strong></p><p>如果你熟悉Kibana的旧Lucene查询语法，那么你应该对这种新的语法也不会陌生。基本原理保持不变，我们只是简单地改进了一些东西，使查询语言更易于使用。</p><p>response:200 将匹配response字段的值是200的文档</p><p>用引号引起来的一段字符串叫短语搜索。例如，message:”Quick brown fox” 将在message字段中搜索”quick brown fox”这个短语。如果没有引号，将会匹配到包含这些词的所有文档，而不管它们的顺序如何。这就意味着，会匹配到”Quick brown fox”，而不会匹配”quick fox brown”。（画外音：引号引起来作为一个整体）</p><p>查询解析器将不再基于空格进行分割。多个搜索项必须由明确的布尔运算符分隔。注意，布尔运算符不区分大小写。</p><p>在Lucene中，response:200 extension:php 等价于 response:200 and extension:php。这将匹配response字段值匹配200并且extenion字段值匹配php的文档。</p><p>如果我们把中间换成or，那么response:200 or extension:php将匹配response字段匹配200 或者 extension字段匹配php的文档。</p><p>默认情况下，and 比 or 具有更高优先级。</p><p>response:200 and extension:php or extension:css 将匹配response是200并且extension是php，或者匹配extension是css而response任意</p><p>括号可以改变这种优先级</p><p>response:200 and (extension:php or extension:css) 将匹配response是200并且extension是php或者css的文档</p><p>还有一种简写的方式：</p><p>response:(200 or 404) 将匹配response字段是200或404的文档。字符值也可以是多个，比如：tags:(success and info and security)</p><p>还可以用not</p><p>not response:200 将匹配response不是200的文档</p><p>response:200 and not (extension:php or extension:css) 将匹配response是200并且extension不是php也不是css的文档</p><p>范围检索和Lucene有一点点不同</p><p>代替 byte:&gt;1000，我们用byte &gt; 1000</p><p>&gt;, &gt;=, &lt;, &lt;= 都是有效的操作符</p><p>response:* 将匹配所有存在response字段的文档</p><p>通配符查询也是可以的。machine.os:win* 将匹配machine.os字段以win开头的文档，像”windows 7”和”windows 10”这样的值都会被匹配到。</p><p>通配符也允许我们一次搜索多个字段，例如，假设我们有machine.os和machine.os.keyword两个字段，我们想要搜索这两个字段都有”windows 10”，那么我们可以这样写”machine.os*:windows 10”</p><h3 id="刷新搜索结果"><a href="#刷新搜索结果" class="headerlink" title="刷新搜索结果"></a><strong>刷新搜索结果</strong></h3><p><img src="/articles/944dc498/21.png" alt="img"></p><h3 id="按字段过滤"><a href="#按字段过滤" class="headerlink" title="按字段过滤"></a><strong>按字段过滤</strong></h3><p><img src="/articles/944dc498/22.png" alt="img"></p><p><img src="/articles/944dc498/23.png" alt="img"></p><p>以上是控制列表显示哪些字段，还有一种方式是在查看文档数据的时候点那个像书一样的小图标</p><p><img src="/articles/944dc498/24.png" alt="img"></p><p>删除也是可以的</p><p><img src="/articles/944dc498/25.png" alt="img"></p><p>我们还可以编辑一个DSL查询语句，用于过滤筛选，例如</p><p><img src="/articles/944dc498/26.png" alt="img"></p><h3 id="查看文档数据"><a href="#查看文档数据" class="headerlink" title="查看文档数据"></a><strong>查看文档数据</strong></h3><p><img src="/articles/944dc498/27.png" alt="img"></p><p><img src="/articles/944dc498/28.png" alt="img"></p><h3 id="查看文档上下文"><a href="#查看文档上下文" class="headerlink" title="查看文档上下文"></a><strong>查看文档上下文</strong></h3><p><img src="/articles/944dc498/29.png" alt="img"></p><p><img src="/articles/944dc498/30.png" alt="img"></p><h3 id="查看字段数据统计"><a href="#查看字段数据统计" class="headerlink" title="查看字段数据统计"></a><strong>查看字段数据统计</strong></h3><p><img src="/articles/944dc498/31.png" alt="img">)<img src="/articles/944dc498/32.png" alt="img"></p><h2 id="使用说明之Visualize"><a href="#使用说明之Visualize" class="headerlink" title="使用说明之Visualize"></a><strong>使用说明之Visualize</strong></h2><hr><p> Visualize使得你可以创建在你的Elasticsearch索引中的数据的可视化效果。然后，你可以构建dashboard来展示相关可视化。</p><p>Kibana可视化是基于Elasticsearch查询的。通过用一系列的Elasticsearch聚集来提取并处理你的数据，你可以创建图片来线上你需要了解的趋势、峰值和低点。</p><h3 id="创建一个可视化"><a href="#创建一个可视化" class="headerlink" title="创建一个可视化"></a><strong>创建一个可视化</strong></h3><p>为了创建一个可视化的视图：</p><p>第1步：点击左侧导航条中的“<strong>Visualize</strong>”按钮</p><p>第2步：点击“Create new visualization”按钮或者<strong>加号(+)</strong>按钮</p><p>第3步：选择一个可视化类型</p><p>第4步：指定一个搜索查询来检索可视化数据</p><p>第5步：在可视化的构建器中选择Y轴的聚合操作。例如，sum，average，count等等</p><p>第6步：设置X轴</p><p>例如：</p><p><img src="/articles/944dc498/33.png" alt="img"></p><p><img src="/articles/944dc498/34.png" alt="img"></p><p><img src="/articles/944dc498/35.png" alt="img"></p><p><img src="/articles/944dc498/36.png" alt="img"></p><p>更多请看这里</p><p><a href="https://www.elastic.co/guide/en/kibana/current/createvis.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/kibana/current/createvis.html</a></p><p><a href="https://www.elastic.co/guide/en/kibana/current/xy-chart.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/kibana/current/xy-chart.html</a></p><p><a href="https://www.elastic.co/guide/en/kibana/current/visualize.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/kibana/current/visualize.html</a></p><h2 id="使用说明之Dashboard"><a href="#使用说明之Dashboard" class="headerlink" title="使用说明之Dashboard"></a><strong>使用说明之Dashboard</strong></h2><hr><p> Kibana仪表板显示可视化和搜索的集合。你可以安排、调整和编辑仪表板内容，然后保存仪表板以便共享它。</p><h3 id="构建一个Dashboard"><a href="#构建一个Dashboard" class="headerlink" title="构建一个Dashboard"></a><strong>构建一个Dashboard</strong></h3><p>第1步：在导航条上点击“<strong>Dashboard</strong>”</p><p>第2步：点击“Create new dashboard”或者“加号(+)”按钮</p><p>第3步：点击“Add”按钮</p><p>第4步：为了添加一个可视化，从可视化列表中选择一个，或者点击“Add new visualization”按钮新创建一个</p><p>第5步：为了添加一个已保存的查询，点击“Saved Search”选项卡，然后从列表中选择一个</p><p>第6步：当你完成添加并且调整了dashboard的内容后，去顶部菜单栏，点击“Save”，然后输入一个名字。</p><p>默认情况下，Kibana仪表板使用浅色主题。要使用深色主题，单击“选项”并选择“使用深色主题”。要将dark主题设置为默认，请转到管理&gt;Management &gt; Advanced ，并将dashboard:defaultDarkTheme设置为On。</p><p><img src="/articles/944dc498/37.png" alt="img"></p><p><img src="/articles/944dc498/38.png" alt="img"></p><p><img src="/articles/944dc498/39.png" alt="img"></p><h2 id="使用说明之Monitoring"><a href="#使用说明之Monitoring" class="headerlink" title="使用说明之Monitoring"></a><strong>使用说明之Monitoring</strong></h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Elasticsearch控制台打印日志</span><br><span class="line">[2018-08-15T14:48:26,874][INFO ][o.e.c.m.MetaDataCreateIndexService] [Px524Ts] [.monitoring-kibana-6-2018.08.15] creating index, cause [auto(bulk api)], templates [.monitoring-kibana], shards [1]/[0], mappings [doc]</span><br><span class="line"></span><br><span class="line">Kibana控制台打印日志</span><br><span class="line">log   [03:26:53.605] [info][license][xpack] Imported license information from Elasticsearch for the [monitoring] cluster: mode: basic | status: active</span><br></pre></td></tr></table></figure><p><img src="/articles/944dc498/40.png" alt="img"></p><p><img src="/articles/944dc498/41.png" alt="img"></p><p><img src="/articles/944dc498/42.png" alt="img"></p><p><img src="/articles/944dc498/43.png" alt="img"></p><p><img src="/articles/944dc498/44.png" alt="img"></p><p><a href="https://www.elastic.co/guide/en/kibana/current/elasticsearch-metrics.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/kibana/current/elasticsearch-metrics.html</a></p><h2 id="数据展示"><a href="#数据展示" class="headerlink" title="数据展示"></a><strong>数据展示</strong></h2><p><img src="/articles/944dc498/45.png" alt="img"></p><h2 id="经验心得"><a href="#经验心得" class="headerlink" title="经验心得"></a>经验心得</h2><h3 id="验证filebeat是否取得数据"><a href="#验证filebeat是否取得数据" class="headerlink" title="验证filebeat是否取得数据"></a><strong>验证filebeat是否取得数据</strong></h3><p>把配置中，output配置打开，根据启动日志，看是否有数据进入</p><p><img src="/articles/944dc498/46.png" alt="img"></p><h3 id="验证logstash是否取得数据"><a href="#验证logstash是否取得数据" class="headerlink" title="验证logstash是否取得数据"></a><strong>验证logstash是否取得数据</strong></h3><p>把配置中，output 中stdout注释打开，并暂时把kafka或es注释掉，重启logstash，根据启动日志，看是否有数据进入</p><p><img src="/articles/944dc498/47.png" alt="img"></p><h3 id="验证kafka是否取得数据"><a href="#验证kafka是否取得数据" class="headerlink" title="验证kafka是否取得数据"></a><strong>验证kafka是否取得数据</strong></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">查看kafka  topic列表</span></span><br><span class="line">/opt/kafka/bin/kafka-topics.sh --list --zookeeper localhost:2181</span><br><span class="line"><span class="meta">#</span><span class="bash">根据topic列表检查是否有数据流入</span></span><br><span class="line">/opt/kafka/bin/kafka-console-consumer.sh  --zookeeper localhost:2181 --topic nginxlog --from-beginning</span><br></pre></td></tr></table></figure><p><img src="/articles/944dc498/48.png" alt="img"></p><h3 id="验证es是否有数据存入数据"><a href="#验证es是否有数据存入数据" class="headerlink" title="验证es是否有数据存入数据"></a><strong>验证es是否有数据存入数据</strong></h3><p><strong>通过web页面或命令查看集群状态：</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">常用命令</span></span><br><span class="line">curl -XGET 'localhost:9200/_cat/indices?v&amp;pretty' #查看索引</span><br><span class="line">curl -XGET 'localhost:9200/_cat/nodes?v&amp;pretty' #查看节点状态</span><br><span class="line">curl -XGET http://localhost:9200/_cluster/health?pretty   #查看集群状态</span><br><span class="line">curl -XGET http://localhost:9200/_all  #查看所有索引信息</span><br><span class="line">curl -XDELETE 'http://localhost:9200/twitter,fgfg,ghjg/' #删除一个或多个索引 中间用，隔开 _all表示删除所有，并支持通配符*</span><br><span class="line">curl -XGET 'http://localhost:9200/twitter/_settings,_mappings' #支持参数 The available features are _settings, _mappings, _warmers and _aliases.</span><br><span class="line"></span><br><span class="line">es增删改查</span><br><span class="line">创建一个新的索引test，设置分片数为1，通过mapping初始化一个type1,type1有一个属性field1</span><br><span class="line">curl -XPUT http://localhost:9200/test -d'</span><br><span class="line">&#123;</span><br><span class="line">    "settings" : &#123;</span><br><span class="line">        "number_of_shards" : 1</span><br><span class="line">    &#125;,</span><br><span class="line">    "mappings" : &#123;</span><br><span class="line">        "type1" : &#123;</span><br><span class="line">            "properties" : &#123;</span><br><span class="line">                "field1" : &#123; "type" : "text" &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;'</span><br><span class="line">删除索引twitter</span><br><span class="line">curl -XDELETE 'http://localhost:9200/twitter</span><br><span class="line"></span><br><span class="line">查看索引</span><br><span class="line">curl -XGET 'localhost:9200/_cat/indices?v&amp;pretty'</span><br><span class="line"></span><br><span class="line">更新索引</span><br><span class="line">可以局部更新，新增字段等等</span><br><span class="line">curl -XPOST localhost:9200/索引名称/字段名/id/_update -d</span><br><span class="line">'&#123;</span><br><span class="line">  "doc": &#123; "name": "Jane Doe",'age':'30' &#125;</span><br><span class="line">&#125;'</span><br><span class="line"></span><br><span class="line">curl -u username:password -XGET '172.18.238.3:9200/_cat/indices?v&amp;pretty'</span><br></pre></td></tr></table></figure><p><img src="/articles/944dc498/49.png" alt="img"></p></div><script src="https://my.openwrite.cn/js/readmore.js" type="text/javascript"></script><script>var isMobile=navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i);if(!isMobile){var btw=new BTWPlugin;btw.init({id:"vip-container",blogId:"19128-1593691079092-122",name:"豌豆多多笔记",qrcode:"https://wandouduoduo.gitee.io/about/index/gongzhonghao.jpg",keyword:"vip"})}</script></div><div><div><div style="text-align:center;color:#ccc;font-size:14px">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div></div></div><div><div class="my_post_copyright"><script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script><script src="https://cdn.bootcss.com/jquery/2.0.0/jquery.min.js"></script><script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script><p><span>本文标题:</span><a href="/articles/944dc498.html">ELK日志系统最新版本详细教程</a></p><p><span>文章作者:</span><a href="/" title="访问 WanDouDuoDuo 的个人博客">WanDouDuoDuo</a></p><p><span>发布时间:</span>2019年06月10日 - 17:06</p><p><span>最后更新:</span>2020年06月17日 - 10:06</p><p><span>原始链接:</span><a href="/articles/944dc498.html" title="ELK日志系统最新版本详细教程">https://wandouduoduo.netlify.com/articles/944dc498.html</a><span class="copy-path" title="点击复制文章链接"><i class="fa fa-clipboard" data-clipboard-text="https://wandouduoduo.netlify.com/articles/944dc498.html" aria-label="复制成功！"></i></span></p><p><span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">署名-非商业性使用-禁止演绎 4.0 国际</a> 转载请保留原文链接及作者。</p></div><script>var clipboard=new Clipboard(".fa-clipboard");$(".fa-clipboard").click(function(){clipboard.on("success",function(){swal({title:"",text:"复制成功",icon:"success",showConfirmButton:!0})})})</script></div><div><div style="padding:10px 0;margin:20px auto;width:90%;text-align:center"><div>原创技术分享，您的支持将鼓励我继续创作</div> <button id="rewardButton" disable="enable" onclick='var qr=document.getElementById("QR");"none"===qr.style.display?qr.style.display="block":qr.style.display="none"'> <span>打赏</span></button><div id="QR" style="display:none"><div id="wechat" style="display:inline-block"> <img id="wechat_qr" src="/images/wechatpay.png" alt="WanDouDuoDuo 微信支付"><p>微信支付</p></div><div id="alipay" style="display:inline-block"> <img id="alipay_qr" src="/images/alipay.jpg" alt="WanDouDuoDuo 支付宝"><p>支付宝</p></div></div></div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/Elk/" rel="tag"><i class="fa fa-tag"></i> Elk</a></div><div class="post-widgets"><div class="social_share"><div><div class="bdsharebuttonbox"><a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a><a href="#" class="bds_douban" data-cmd="douban" title="分享到豆瓣网"></a><a href="#" class="bds_sqq" data-cmd="sqq" title="分享到QQ好友"></a><a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a><a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a><a href="#" class="bds_tieba" data-cmd="tieba" title="分享到百度贴吧"></a><a href="#" class="bds_twi" data-cmd="twi" title="分享到Twitter"></a><a href="#" class="bds_fbook" data-cmd="fbook" title="分享到Facebook"></a><a href="#" class="bds_more" data-cmd="more"></a><a class="bds_count" data-cmd="count"></a></div><script>window._bd_share_config={common:{bdText:"",bdMini:"2",bdMiniList:!1,bdPic:""},share:{bdSize:"16",bdStyle:"0"},image:{viewList:["tsina","douban","sqq","qzone","weixin","twi","fbook"],viewText:"分享到：",viewSize:"16"}}</script><script>with(document)(getElementsByTagName("head")[0]||body).appendChild(createElement("script")).src="/static/api/js/share.js?cdnversion="+~(-new Date/36e5)</script></div></div></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/articles/79cf2ce7.html" rel="next" title="python操作gitlab API接口"><i class="fa fa-chevron-left"></i> python操作gitlab API接口</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"> <a href="/articles/d05be736.html" rel="prev" title="nginx之后端节点健康检查">nginx之后端节点健康检查<i class="fa fa-chevron-right"></i></a></div></div></footer></div></article></div></div><div class="comments" id="gitalk-container"></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap"> 文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap"> 站点概览</li></ul><div class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" src="/images/me.jpg" alt="WanDouDuoDuo"><p class="site-author-name" itemprop="name">WanDouDuoDuo</p><p class="site-description motion-element" itemprop="description">沪漂资深运维架构师的呕心笔记</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">156</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/index.html"><span class="site-state-item-count">38</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/index.html"><span class="site-state-item-count">53</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/wandouduoduo" title="GitHub &rarr; https://github.com/wandouduoduo" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:wandouduoduo@163.com" title="E-Mail &rarr; mailto:wandouduoduo@163.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i> E-Mail</a></span><span class="links-of-author-item"><a href="https://gitee.com/wandouduoduo" title="Gitee &rarr; https://gitee.com/wandouduoduo" rel="noopener" target="_blank"><i class="fa fa-fw fa-heartbeat"></i> Gitee</a></span><span class="links-of-author-item"><a href="https://weibo.com/u/1989032071/home?topnav=1&wvr=6" title="微博 &rarr; https://weibo.com/u/1989032071/home?topnav=1&wvr=6" rel="noopener" target="_blank"><i class="fa fa-fw fa-weibo"></i> 微博</a></span></div><div class="links-of-blogroll motion-element links-of-blogroll-inline"><div class="links-of-blogroll-title"><i class="fa fa-fw fa-link"></i> 友情链接</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"> <a href="https://www.runoob.com/" title="https://www.runoob.com/" rel="noopener" target="_blank">菜鸟教程</a></li><li class="links-of-blogroll-item"> <a href="https://code.ziqiangxuetang.com/" title="https://code.ziqiangxuetang.com/" rel="noopener" target="_blank">自强学堂</a></li><li class="links-of-blogroll-item"> <a href="http://www.zsythink.net/" title="http://www.zsythink.net/" rel="noopener" target="_blank">朱双印博客</a></li><li class="links-of-blogroll-item"> <a href="http://www.ypk1226.com/" title="http://www.ypk1226.com/" rel="noopener" target="_blank">于佩康博客</a></li><li class="links-of-blogroll-item"> <a href="https://www.dgstack.cn/" title="https://www.dgstack.cn/" rel="noopener" target="_blank">逗哥架构师之路</a></li><li class="links-of-blogroll-item"> <a href="https://pincheng.xyz/" title="https://pincheng.xyz/" rel="noopener" target="_blank">运维饼铛</a></li><li class="links-of-blogroll-item"> <a href="https://me.jinchuang.org/" title="https://me.jinchuang.org/" rel="noopener" target="_blank">靳闯博客</a></li></ul></div></div></div><div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#目的"><span class="nav-number">1.</span> <span class="nav-text">目的</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#架构图："><span class="nav-number">2.</span> <span class="nav-text">架构图：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#环境"><span class="nav-number">3.</span> <span class="nav-text">环境</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#软件包版本和下载网站"><span class="nav-number">4.</span> <span class="nav-text">软件包版本和下载网站:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装部署Elasticsearch集群"><span class="nav-number">5.</span> <span class="nav-text">安装部署Elasticsearch集群</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#安装jdk1-8，elasticsearch"><span class="nav-number">5.1.</span> <span class="nav-text">安装jdk1.8，elasticsearch</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#系统调优，JVM调优"><span class="nav-number">5.2.</span> <span class="nav-text">系统调优，JVM调优</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#编写ES-Master节点配置文件"><span class="nav-number">5.3.</span> <span class="nav-text">编写ES Master节点配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装head开源插件"><span class="nav-number">5.4.</span> <span class="nav-text">安装head开源插件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#部署ES-DataNode节点"><span class="nav-number">5.5.</span> <span class="nav-text">部署ES DataNode节点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#启动服务"><span class="nav-number">5.6.</span> <span class="nav-text">启动服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#访问head插件，查看集群状态"><span class="nav-number">5.7.</span> <span class="nav-text">访问head插件，查看集群状态</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置ZooKeeper集群"><span class="nav-number">6.</span> <span class="nav-text">配置ZooKeeper集群</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#安装，配置-zookeeper"><span class="nav-number">6.1.</span> <span class="nav-text">安装，配置 zookeeper</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#编写配置文件"><span class="nav-number">6.2.</span> <span class="nav-text">编写配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建myid文件"><span class="nav-number">6.3.</span> <span class="nav-text">创建myid文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#启动服务-amp-查看节点状态"><span class="nav-number">6.4.</span> <span class="nav-text">启动服务 &amp; 查看节点状态</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置Kafka-Broker集群"><span class="nav-number">7.</span> <span class="nav-text">配置Kafka Broker集群</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#安装，配置-kafka"><span class="nav-number">7.1.</span> <span class="nav-text">安装，配置 kafka</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#编写配置文件-1"><span class="nav-number">7.2.</span> <span class="nav-text">编写配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#同步配置文件到其他两台节点"><span class="nav-number">7.3.</span> <span class="nav-text">同步配置文件到其他两台节点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置主机名对应IP的解析"><span class="nav-number">7.4.</span> <span class="nav-text">配置主机名对应IP的解析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#启动服务-1"><span class="nav-number">7.5.</span> <span class="nav-text">启动服务</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置位于架构图中第二层的Logstash服务"><span class="nav-number">8.</span> <span class="nav-text">配置位于架构图中第二层的Logstash服务</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#安装，配置-logstash"><span class="nav-number">8.1.</span> <span class="nav-text">安装，配置 logstash</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#编写配置文件-2"><span class="nav-number">8.2.</span> <span class="nav-text">编写配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#启动服务-2"><span class="nav-number">8.3.</span> <span class="nav-text">启动服务</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置数据采集层，业务服务器-Filebeat"><span class="nav-number">9.</span> <span class="nav-text">配置数据采集层，业务服务器+Filebeat</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#定制Nginx日志格式"><span class="nav-number">9.1.</span> <span class="nav-text">定制Nginx日志格式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装-Filebeat"><span class="nav-number">9.2.</span> <span class="nav-text">安装 Filebeat</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#编写-Filebeat-配置文件"><span class="nav-number">9.3.</span> <span class="nav-text">编写 Filebeat 配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#启动服务-3"><span class="nav-number">9.4.</span> <span class="nav-text">启动服务</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置位于架构图中的第三层，数据转发层"><span class="nav-number">10.</span> <span class="nav-text">配置位于架构图中的第三层，数据转发层</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#编写Logstash配置文件"><span class="nav-number">10.1.</span> <span class="nav-text">编写Logstash配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#启动服务-4"><span class="nav-number">10.2.</span> <span class="nav-text">启动服务</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#修改ES的索引模版配置"><span class="nav-number">11.</span> <span class="nav-text">修改ES的索引模版配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置-Kibana-数据展示层"><span class="nav-number">12.</span> <span class="nav-text">配置 Kibana 数据展示层</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#安装"><span class="nav-number">12.1.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#修改配置文件"><span class="nav-number">12.2.</span> <span class="nav-text">修改配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#启动服务-5"><span class="nav-number">12.3.</span> <span class="nav-text">启动服务</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#kibana"><span class="nav-number">13.</span> <span class="nav-text">kibana</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#安装Kibana"><span class="nav-number">13.1.</span> <span class="nav-text">安装Kibana</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Kibana配置"><span class="nav-number">13.2.</span> <span class="nav-text">Kibana配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#检查Kibana状态"><span class="nav-number">13.3.</span> <span class="nav-text">检查Kibana状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#用Elasticsearch连接到Kibana"><span class="nav-number">13.4.</span> <span class="nav-text">用Elasticsearch连接到Kibana</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用说明之Discover"><span class="nav-number">14.</span> <span class="nav-text">使用说明之Discover</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#设置时间过滤"><span class="nav-number">14.1.</span> <span class="nav-text">设置时间过滤</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#搜索数据"><span class="nav-number">14.2.</span> <span class="nav-text">搜索数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Lucene查询语法"><span class="nav-number">14.3.</span> <span class="nav-text">Lucene查询语法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Kibana查询语法增强"><span class="nav-number">14.4.</span> <span class="nav-text">Kibana查询语法增强</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#刷新搜索结果"><span class="nav-number">14.5.</span> <span class="nav-text">刷新搜索结果</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#按字段过滤"><span class="nav-number">14.6.</span> <span class="nav-text">按字段过滤</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查看文档数据"><span class="nav-number">14.7.</span> <span class="nav-text">查看文档数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查看文档上下文"><span class="nav-number">14.8.</span> <span class="nav-text">查看文档上下文</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查看字段数据统计"><span class="nav-number">14.9.</span> <span class="nav-text">查看字段数据统计</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用说明之Visualize"><span class="nav-number">15.</span> <span class="nav-text">使用说明之Visualize</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#创建一个可视化"><span class="nav-number">15.1.</span> <span class="nav-text">创建一个可视化</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用说明之Dashboard"><span class="nav-number">16.</span> <span class="nav-text">使用说明之Dashboard</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#构建一个Dashboard"><span class="nav-number">16.1.</span> <span class="nav-text">构建一个Dashboard</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用说明之Monitoring"><span class="nav-number">17.</span> <span class="nav-text">使用说明之Monitoring</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#数据展示"><span class="nav-number">18.</span> <span class="nav-text">数据展示</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#经验心得"><span class="nav-number">19.</span> <span class="nav-text">经验心得</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#验证filebeat是否取得数据"><span class="nav-number">19.1.</span> <span class="nav-text">验证filebeat是否取得数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#验证logstash是否取得数据"><span class="nav-number">19.2.</span> <span class="nav-text">验证logstash是否取得数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#验证kafka是否取得数据"><span class="nav-number">19.3.</span> <span class="nav-text">验证kafka是否取得数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#验证es是否有数据存入数据"><span class="nav-number">19.4.</span> <span class="nav-text">验证es是否有数据存入数据</span></a></li></ol></li></ol></div></div></div><script type="text/javascript" charset="utf-8" src="/js/tagcloud.js"></script><script type="text/javascript" charset="utf-8" src="/js/tagcanvas.js"></script><div class="widget-wrap"><div id="myCanvasContainer" class="widget tagcloud"><canvas width="250" height="250" id="resCanvas" style=""><ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Ai/">Ai</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Ansible/">Ansible</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Apollo/">Apollo</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cloud/">Cloud</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cmdb/">Cmdb</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Confd/">Confd</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Confluence/">Confluence</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Devops/">Devops</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Dns/">Dns</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/">Docker</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Elasticsearch/">Elasticsearch</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Elk/">Elk</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Experiences/">Experiences</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Flask/">Flask</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Git/">Git</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GlusterFS/">GlusterFS</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Go/">Go</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Haproxy/">Haproxy</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hexo/">Hexo</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Http/">Http</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Iptables/">Iptables</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/">Java</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Jenkins/">Jenkins</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/K8s/">K8s</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kali/">Kali</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Keepalived/">Keepalived</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Lvs/">Lvs</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MongoDB/">MongoDB</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mysql/">Mysql</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Network/">Network</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nexus/">Nexus</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nginx/">Nginx</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Open-falcon/">Open-falcon</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Openldap/">Openldap</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Opensips/">Opensips</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Openvpn/">Openvpn</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PostgreSQL/">PostgreSQL</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Prometheus/">Prometheus</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python/">Python</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis/">Redis</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RocketChat/">RocketChat</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Saturn/">Saturn</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Sentry/">Sentry</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Shell/">Shell</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Stackstorm/">Stackstorm</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Supervisor/">Supervisor</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Tomcat/">Tomcat</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Uwsgi/">Uwsgi</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Web/">Web</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Windows/">Windows</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Zabbix/">Zabbix</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Zookeeper/">Zookeeper</a><span class="tag-list-count">1</span></li></ul></canvas></div></div></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; 2019 – <span itemprop="copyrightYear">2020</span><span class="with-love" id="animate"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">WanDouDuoDuo</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-area-chart"></i></span> <span class="post-meta-item-text">站点总字数：</span> <span title="站点总字数">847k</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span class="post-meta-item-text">站点阅读时长 &asymp;</span> <span title="站点阅读时长">12:50</span></div><div class="theme-info"><div class="powered-by"></div> <span class="post-count">博客全站共350.4k字</span></div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script> <span class="post-meta-item-icon"><i class="fa fa-user">访问人数:</i></span><span class="site-uv" title="总访客量"><span class="busuanzi-value" id="busuanzi_value_site_uv"></span></span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-eye">总阅读量:</i></span><span class="site-pv" title="总访问量"><span class="busuanzi-value" id="busuanzi_value_site_pv"></span></span></div><div><script type="text/javascript">var cnzz_protocol="https:"==document.location.protocol?"https://":"http://";document.write(unescape("%3Cspan id='cnzz_stat_icon_1277740757'%3E%3C/span%3E%3Cscript src='"+cnzz_protocol+"s23.cnzz.com/z_stat.php%3Fid%3D1277740757%26online%3D1%26show%3Dline' type='text/javascript'%3E%3C/script%3E"))</script></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script>"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script color="255,255,255" opacity="1" zindex="-1" count="150" src="/lib/canvas-nest/canvas-nest.min.js"></script><script src="/lib/jquery/index.js?v=2.1.3"></script><script src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script src="/js/src/utils.js?v=6.7.0"></script><script src="/js/src/motion.js?v=6.7.0"></script><script src="/js/src/affix.js?v=6.7.0"></script><script src="/js/src/schemes/pisces.js?v=6.7.0"></script><script src="/js/src/scrollspy.js?v=6.7.0"></script><script src="/js/src/post-details.js?v=6.7.0"></script><script src="/js/src/bootstrap.js?v=6.7.0"></script><script src="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css"><script src="//cdn.jsdelivr.net/npm/js-md5@0.7.3/src/md5.min.js"></script><script>var gitalk=new Gitalk({clientID:"ad83725549e82facce82",clientSecret:"b67c2056b52d0447f1d78f413f268a5b853e8a6e",repo:"wandouduoduo.github.io",owner:"wandouduoduo",admin:["wandouduoduo"],id:md5(location.pathname),distractionFreeMode:"true"});gitalk.render("gitalk-container")</script><script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><style>.copy-btn{display:inline-block;padding:6px 12px;font-size:13px;font-weight:700;line-height:20px;color:#333;white-space:nowrap;vertical-align:middle;cursor:pointer;background-color:#eee;background-image:linear-gradient(#fcfcfc,#eee);border:1px solid #d5d5d5;border-radius:3px;user-select:none;outline:0}.highlight-wrap .copy-btn{transition:opacity .3s ease-in-out;opacity:0;padding:2px 6px;position:absolute;right:4px;top:8px}.highlight-wrap .copy-btn:focus,.highlight-wrap:hover .copy-btn{opacity:1}.highlight-wrap{position:relative}</style><script>$(".highlight").each(function(e,t){var n=$("<div>").addClass("highlight-wrap");$(t).after(n),n.append($("<button>").addClass("copy-btn").append("复制").on("click",function(e){var t=$(this).parent().find(".code").find(".line").map(function(e,t){return $(t).text()}).toArray().join("\n"),n=document.createElement("textarea"),o=document.createRange(),a=window.getSelection(),i=window.pageYOffset||document.documentElement.scrollTop;n.style.top=i+"px",n.style.position="absolute",n.style.opacity="0",n.value=t,n.textContent=t,n.contentEditable=!0,n.readOnly=!1,document.body.appendChild(n),o.selectNode(n),a.removeAllRanges(),a.addRange(o),n.setSelectionRange(0,t.length),document.execCommand("copy")?$(this).text("复制成功"):$(this).text("复制失败"),n.blur(),$(this).blur()})).on("mouseleave",function(e){var t=$(this).find(".copy-btn");setTimeout(function(){t.text("复制")},300)}).append(t)})</script><canvas class="fireworks" style="position:fixed;left:0;top:0;z-index:1;pointer-events:none"></canvas><script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script><script type="text/javascript" src="/js/src/fireworks.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,debug:!1,model:{jsonPath:"/live2dw/assets/shizuku.model.json"},display:{position:"right",width:150,height:300},mobile:{show:!0},log:!1})</script></body></html>