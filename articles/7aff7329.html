<!DOCTYPE html><html class="theme-next gemini" lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><script src="//cdn.jsdelivr.net/npm/pace-js@1/pace.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/pace-js@1/themes/blue/pace-theme-minimal.css"><meta name="google-site-verification" content="27nKwb_oPifd-peB2Juh7eiKE-ZIpIcPp7ug9xPLKh4"><script data-ad-client="ca-pub-6677803223619857" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>
  window.onload = function() {
          setTimeout(function() {
                  let script = document.createElement("script");
                  script.setAttribute("async", "");
                  script.src = "//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js";
                  document.body.appendChild(script);
          }, 2e3);
  }
  </script><meta name="baidu-site-verification" content="wbqyth06a2"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4/css/font-awesome.min.css"><link rel="stylesheet" href="/css/main.css?v=6.7.0"><link rel="icon" type="image/png" sizes="32x32" href="//cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io/images/next-favicon-32.png?v=6.7.0"><link rel="icon" type="image/png" sizes="16x16" href="//cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io/images/next-favicon-16.png?v=6.7.0"><script id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Gemini",version:"6.7.0",sidebar:{position:"left",display:"post",offset:12,b2t:!0,scrollpercent:!0,onmobile:!1},fancybox:!1,fastclick:!1,lazyload:!1,tabs:!0,motion:{enable:!1,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><meta name="description" content="目的本文在k8s集群中把各种工具（jdk，git, maven等）集成到jenkins，用master/slave模式实现CI/CD。 环境k8s集群    参考教程 Hubor镜像服务  参考教程 nfs/Ceph持久存储   参考教程 K8s中Jenkins实践教程"><meta name="keywords" content="K8s,Jenkins"><meta property="og:type" content="article"><meta property="og:title" content="k8s版jenkins带maven、jdk、git各种工具用master&#x2F;slave模式实现CI&#x2F;CD"><meta property="og:url" content="https://wandouduoduo.github.io/articles/7aff7329.html"><meta property="og:site_name" content="豌豆多多"><meta property="og:description" content="目的本文在k8s集群中把各种工具（jdk，git, maven等）集成到jenkins，用master/slave模式实现CI/CD。 环境k8s集群    参考教程 Hubor镜像服务  参考教程 nfs/Ceph持久存储   参考教程 K8s中Jenkins实践教程"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io/articles/7aff7329/1.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io/articles/7aff7329/2.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io/articles/7aff7329/3.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io/articles/7aff7329/4.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io/articles/7aff7329/5.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io/articles/7aff7329/6.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io/articles/7aff7329/7.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io/articles/7aff7329/8.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io/articles/7aff7329/9.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io/articles/7aff7329/10.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io/articles/7aff7329/11.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io/articles/7aff7329/12.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io/articles/7aff7329/13.png"><meta property="og:updated_time" content="2020-08-04T06:27:19.607Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="k8s版jenkins带maven、jdk、git各种工具用master&#x2F;slave模式实现CI&#x2F;CD"><meta name="twitter:description" content="目的本文在k8s集群中把各种工具（jdk，git, maven等）集成到jenkins，用master/slave模式实现CI/CD。 环境k8s集群    参考教程 Hubor镜像服务  参考教程 nfs/Ceph持久存储   参考教程 K8s中Jenkins实践教程"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io/articles/7aff7329/1.png"><link rel="alternate" href="/atom.xml" title="豌豆多多" type="application/atom+xml"><link rel="canonical" href="https://wandouduoduo.github.io/articles/7aff7329.html"><script id="page.configurations">CONFIG.page={sidebar:""}</script><title>k8s版jenkins带maven、jdk、git各种工具用master/slave模式实现CI/CD | 豌豆多多</title><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?a40bcdb5c2cd18d8294a08372dea701b";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-title,.use-motion .comments,.use-motion .menu-item,.use-motion .motion-element,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .logo,.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN"><link rel="stylesheet" href="/dist/APlayer.min.css"><div id="aplayer"></div><script type="text/javascript" src="/dist/APlayer.min.js"></script><script type="text/javascript" src="/dist/music.js"></script><div class="container sidebar-position-left page-post-detail"><div class="headband"></div> <a href="https://github.com/wandouduoduo" rel="external nofollow noreferrer" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewbox="0 0 250 250" style="fill:#fd6c6c;color:#fff;position:absolute;top:0;border:0;right:0" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"/></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">豌豆多多</span><span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">SRE & Devops & Architect</h1></div><div class="site-nav-toggle"> <button aria-label="切换导航栏"><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>分类</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于</a></li><li class="menu-item menu-item-tools"><a href="/tools/" rel="section"><i class="menu-item-icon fa fa-fw fa-heartbeat"></i><br>工具</a></li><li class="menu-item menu-item-search"><a href="javascript:;" rel="external nofollow noreferrer" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i></span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"> <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://wandouduoduo.github.io/articles/7aff7329.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="WanDouDuoDuo"><meta itemprop="description" content="沪漂资深运维架构师的呕心笔记"><meta itemprop="image" content="//cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io/images/me.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="豌豆多多"></span><header class="post-header"><h2 class="post-title" itemprop="name headline">k8s版jenkins带maven、jdk、git各种工具用master/slave模式实现CI/CD</h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-07-02 14:56:01" itemprop="dateCreated datePublished" datetime="2020-07-02T14:56:01+08:00">2020-07-02</time> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i></span> <span class="post-meta-item-text">更新于</span> <time title="修改时间：2020-08-04 14:27:19" itemprop="dateModified" datetime="2020-08-04T14:27:19+08:00">2020-08-04</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/容器编排/" itemprop="url" rel="index"><span itemprop="name">容器编排</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/容器编排/K8s/" itemprop="url" rel="index"><span itemprop="name">K8s</span></a></span></span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-eye"></i> 阅读次数：<span class="busuanzi-value" id="busuanzi_value_page_pv"></span></span><div class="post-symbolscount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i></span> <span class="post-meta-item-text">本文字数：</span> <span title="本文字数">68k</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span title="阅读时长">1:02</span></div></div></header><div class="post-body" itemprop="articleBody"><h2 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h2><p>本文在k8s集群中把各种工具（jdk，git, maven等）集成到jenkins，用master/slave模式实现CI/CD。</p><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><p>k8s集群 <a href="https://wandouduoduo.github.io/articles/87f87b20.html">参考教程</a></p><p>Hubor镜像服务 <a href="https://wandouduoduo.github.io/articles/b9ccc582.html">参考教程</a></p><p>nfs/Ceph持久存储 <a href="https://wandouduoduo.github.io/articles/3acab424.html">参考教程</a></p><p><a href="https://wandouduoduo.github.io/articles/12aa61a7.html">K8s中Jenkins实践教程</a></p><a id="more"></a><h2 id="M-S模式实现"><a href="#M-S模式实现" class="headerlink" title="M/S模式实现"></a>M/S模式实现</h2><h3 id="创建Master镜像文件"><a href="#创建Master镜像文件" class="headerlink" title="创建Master镜像文件"></a>创建Master镜像文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#编写Dockerfile：</span></span><br><span class="line"></span><br><span class="line">cat&gt;/home/jenkins-dockerfile/Dockerfile &lt;&lt;EOF</span><br><span class="line">FROM jenkinsci/jenkins</span><br><span class="line">USER root</span><br><span class="line">RUN apt-get update &amp;&amp; apt-get install -y libltdl7.*</span><br><span class="line">RUN apt-get install vim -y</span><br><span class="line">RUN apt-get install maven -y</span><br><span class="line">RUN apt-get install git -y</span><br><span class="line">ARG dockerGid=999</span><br><span class="line">RUN <span class="built_in">echo</span> <span class="string">"docker:x:<span class="variable">$&#123;dockerGid&#125;</span>:jenkins"</span> &gt;&gt; /etc/group</span><br><span class="line">RUN <span class="built_in">echo</span> <span class="string">"jenkins ALL=NOPASSWD: ALL"</span> &gt;&gt; /etc/sudoers</span><br><span class="line">RUN mkdir -p /opt/maven/repository</span><br><span class="line">RUN mkdir -p /ceph/maven/repository</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment">#该Dockerfile所做的工作为：</span></span><br><span class="line"><span class="comment">#安装Maven，git,vim</span></span><br><span class="line"><span class="comment">#配置Maven仓库位置，以便启动时挂载宿主机仓库为容器中Maven仓库</span></span><br><span class="line"><span class="comment">#设置启动用户为root把jenkins加入docker组，否则无法使用宿主机的docker</span></span><br><span class="line"><span class="comment">#安装libltdl7.* 库，否则无法使用宿主机的docker</span></span><br></pre></td></tr></table></figure><h3 id="构建Master镜像"><a href="#构建Master镜像" class="headerlink" title="构建Master镜像"></a>构建Master镜像</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t jenkinsci/jenkins:v1 /home/jenkins-dockerfile/</span><br></pre></td></tr></table></figure><h3 id="启动YAML配置文件"><a href="#启动YAML配置文件" class="headerlink" title="启动YAML配置文件"></a>启动YAML配置文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#jenkins命令空间创建</span></span><br><span class="line"></span><br><span class="line">cat &gt;namespace-jenkins.yaml&lt;&lt;EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Namespace</span><br><span class="line">metadata:</span><br><span class="line">   name: jenkins</span><br><span class="line">   labels:</span><br><span class="line">     name: jenkins</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment">#Jenkins 权限配置</span></span><br><span class="line"><span class="comment">#此处直接将jenkins-admin集成了cluster-admin权限，可根据自己具体需要进行权限的设置</span></span><br><span class="line"></span><br><span class="line">cat&gt;jenkins-account.yaml&lt;&lt;EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: jenkins</span><br><span class="line">  name: jenkins-admin</span><br><span class="line">  namespace: jenkins</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: jenkins-admin</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: jenkins</span><br><span class="line">subjects:</span><br><span class="line">  - kind: ServiceAccount</span><br><span class="line">    name: jenkins-admin</span><br><span class="line">    namespace: jenkins</span><br><span class="line">roleRef:</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#Jenkins Deployment配置</span></span><br><span class="line"><span class="comment">#此处配置简单明了，需要说明的地方是挂在卷，此处挂载了四个目录，下面分别做出挂载原因：</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#/var/jenkins_home（容器） –&gt; /ceph/jenkins_home（宿主机） </span></span><br><span class="line"><span class="comment">#我们需要将容器中的Jenkins源目录挂载导本地宿主机，因为该目录下保存了Jenkins产生的所有配置、我们的自定义配置、任务配置及详情等等信息，所以需要持久化导宿主机，以便重新启动Jenkins容器的时候能够找到相应数据，防止数据丢失。此处我们使用的ceph，保证整个kubernetes集群所有机器能够共享同一个目录。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#/opt/maven/repository（容器） –&gt; /ceph/maven/repository（宿主机） </span></span><br><span class="line"><span class="comment">#这一对挂载目录是Maven仓库的挂载目录，不管是Jenkins master容器或者是Jenkins slave目录都需要挂载该目录，以便容器中maven能够在下载编译代码时能够从该仓库中找到相应Jar包，同时也保证了数据的持久化。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#/usr/bin/docker（容器） –&gt; /usr/bin/docker（宿主机）</span></span><br><span class="line"><span class="comment">#/var/run/docker.sock（容器） –&gt; /var/run/docker.sock（宿主机） </span></span><br><span class="line"><span class="comment">#这两对挂载目录作用是能够在容器中操作宿主机docker，具体的用途是在slave容器中编辑maven代码并生成jar之后，需要生成该代码服务的docker镜像,并上传至本地私有仓库。因此需要操作宿主机docker以便完成这一系列操作</span></span><br><span class="line"></span><br><span class="line">cat&gt;jenkins-deployment.yaml&lt;&lt;EOF</span><br><span class="line">apiVersion: apps/v1beta2</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: jenkins</span><br><span class="line">  namespace: jenkins</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: jenkins</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: jenkins</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: jenkins</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: jenkins</span><br><span class="line">        image: jenkinsci/jenkins:v1</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: jenkins-home</span><br><span class="line">          mountPath: /var/jenkins_home</span><br><span class="line">        - name: maven-repository</span><br><span class="line">          mountPath: /opt/maven/repository</span><br><span class="line">        - name: docker</span><br><span class="line">          mountPath: /usr/bin/docker</span><br><span class="line">        - name: docker-sock</span><br><span class="line">          mountPath: /var/run/docker.sock</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">        - containerPort: 50000</span><br><span class="line">      volumes:</span><br><span class="line">        - name: jenkins-home</span><br><span class="line">          hostPath:</span><br><span class="line">            path: /ceph/jenkins_home</span><br><span class="line">        - name: maven-repository</span><br><span class="line">          hostPath:</span><br><span class="line">            path: /ceph/maven/repository</span><br><span class="line">        - name: docker</span><br><span class="line">          hostPath:</span><br><span class="line">            path: /usr/bin/docker</span><br><span class="line">        - name: docker-sock</span><br><span class="line">          hostPath:</span><br><span class="line">            path: /var/run/docker.sock</span><br><span class="line">      serviceAccountName: jenkins-admin</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#Jenkins Service配置</span></span><br><span class="line"><span class="comment">#该Service配置作用是能够让用户访问到Jenkins。此处开放并配置了8080、32000端口，这两个端口在Deployment 中也应该开放。此处配置的宿主机开放端口分别为：31888、32000</span></span><br><span class="line"></span><br><span class="line">cat&gt;jenkins-service.yaml&lt;&lt;EOF</span><br><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: jenkins</span><br><span class="line">  name: jenkins</span><br><span class="line">  namespace: jenkins</span><br><span class="line">  annotations:</span><br><span class="line">    prometheus.io/scrape: <span class="string">'true'</span></span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">    - name: jenkins</span><br><span class="line">      port: 8080</span><br><span class="line">      nodePort: 31888</span><br><span class="line">      targetPort: 8080</span><br><span class="line">    - name: jenkins-agent</span><br><span class="line">      port: 50000</span><br><span class="line">      nodePort: 50000</span><br><span class="line">      targetPort: 50000</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: jenkins</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="启动Jenkins-Master容器"><a href="#启动Jenkins-Master容器" class="headerlink" title="启动Jenkins Master容器"></a>启动Jenkins Master容器</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f namespace-jenkins.yaml</span><br><span class="line">kubectl apply -f jenkins-account.yaml</span><br><span class="line">kubectl apply -f jenkins-deployment.yaml</span><br><span class="line">kubectl apply -f jenkins-service.yaml</span><br></pre></td></tr></table></figure><h3 id="创建Jenkins-slave镜像文件"><a href="#创建Jenkins-slave镜像文件" class="headerlink" title="创建Jenkins slave镜像文件"></a>创建Jenkins slave镜像文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#需要使用官方镜像cnych-jenkins，其他的镜像里面都没有kubectl工具，都试过。</span></span><br><span class="line"><span class="comment">#编写Dockerfile： </span></span><br><span class="line"></span><br><span class="line">cat&gt;/home/jenkins-dockerfile/Dockerfile &lt;&lt;EOF</span><br><span class="line">FROM cnych/jenkins:jnlp</span><br><span class="line">USER root</span><br><span class="line">RUN apt-get update &amp;&amp; apt-get install -y libltdl7.*</span><br><span class="line">RUN apt-get install maven -y</span><br><span class="line">RUN apt-get install vim -y</span><br><span class="line">RUN apt-get install git -y</span><br><span class="line">ARG dockerGid=999</span><br><span class="line">RUN <span class="built_in">echo</span> <span class="string">"docker:x:<span class="variable">$&#123;dockerGid&#125;</span>:jenkins"</span> &gt;&gt; /etc/group</span><br><span class="line">RUN <span class="built_in">echo</span> <span class="string">"jenkins ALL=NOPASSWD: ALL"</span> &gt;&gt; /etc/sudoers</span><br><span class="line">RUN mkdir -p /opt/maven/repository</span><br><span class="line">RUN mkdir -p /ceph/maven/repository</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment">#该Dockerfile所做的工作为：</span></span><br><span class="line"><span class="comment">#安装Maven,git,vim</span></span><br><span class="line"><span class="comment">#配置Maven仓库位置，以便启动时挂载宿主机仓库为容器中Maven仓库</span></span><br><span class="line"><span class="comment">#设置启动用户为root</span></span><br></pre></td></tr></table></figure><h3 id="构建Slave镜像"><a href="#构建Slave镜像" class="headerlink" title="构建Slave镜像"></a>构建Slave镜像</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t cnych/jenkins:v1 /home/jenkins-dockerfile/</span><br></pre></td></tr></table></figure><h3 id="查看镜像列表"><a href="#查看镜像列表" class="headerlink" title="查看镜像列表"></a>查看镜像列表</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker images</span><br></pre></td></tr></table></figure><h3 id="浏览器访问"><a href="#浏览器访问" class="headerlink" title="浏览器访问"></a>浏览器访问</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#访问jenkins</span></span><br><span class="line">http://192.168.0.92:31888</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看密码</span></span><br><span class="line">[root@test2 ~]<span class="comment"># docker ps -l</span></span><br><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS               NAMES</span><br><span class="line">6f8a62f8a0f7        2114cb298e17        <span class="string">"/sbin/tini -- /us..."</span>   About an hour ago   Up About an hour                        k8s_jenkins_jenkins-7b46757695-4hx6f_jenkins_e8cb1035-3fe6-11e9-a258-000c2980fc47_0</span><br><span class="line"></span><br><span class="line">[root@test2 ~]<span class="comment"># docker exec 6f8a62f8a0f7 cat /var/jenkins_home/secrets/initialAdminPassword</span></span><br><span class="line">471234cd0eb44ec3bfc4015fbacd599b</span><br></pre></td></tr></table></figure><h3 id="页面配置master"><a href="#页面配置master" class="headerlink" title="页面配置master"></a>页面配置master</h3><h5 id="升级和重置密码"><a href="#升级和重置密码" class="headerlink" title="升级和重置密码"></a>升级和重置密码</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#然后会要求安装一些插件，这里选择默认安装即可，否则下一步打开是空白页</span></span><br><span class="line"><span class="comment">#设置登录用户名密码：</span></span><br><span class="line">admin/jenkins@123</span><br><span class="line"></span><br><span class="line"><span class="comment">#这时候会跳转到首页， 此时Jenkins就可以真正使用了： </span></span><br><span class="line"><span class="comment">#对jenkins进行升级</span></span><br><span class="line"><span class="comment">#重启jenkins（有点慢，等5分钟）</span></span><br><span class="line"><span class="comment">#刷新网页重新登录</span></span><br><span class="line">admin/471234cd0eb44ec3bfc4015fbacd599b</span><br><span class="line"><span class="comment">#查看更新后的版本</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#重置admin密码方法：</span></span><br><span class="line"><span class="comment">#进入首页-》系统管理-》全局安全配置</span></span><br><span class="line"><span class="comment">#把“启用安全”勾上和把Jenkins专有用户数据库勾上、允许用户注册勾上-》保存</span></span><br><span class="line"><span class="comment">#点击右上角的admin-》设置-》修改里面的密码为（jenkins@123）-》保存-》重新登录-》输入账号密码</span></span><br></pre></td></tr></table></figure><h5 id="安装插件"><a href="#安装插件" class="headerlink" title="安装插件"></a>安装插件</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Kubernetes Cli Plugin：该插件可直接在Jenkins中使用kubernetes命令行进行操作。</span></span><br><span class="line"><span class="comment">#Kubernetes plugin： 使用kubernetes则需要安装该插件</span></span><br><span class="line"><span class="comment">#Kubernetes Continuous Deploy Plugin：kubernetes部署deploymrnt.yaml 时候需要使用</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#安装步骤：</span></span><br><span class="line"><span class="comment">#进入首页-》系统管理-》插件管理-》可选插件-》输入kubernetes-》选中所有带kubernetes的插件进行安装-》安装完返回首页</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看所有带kubernetes的插件是否安装上</span></span><br><span class="line"><span class="comment">#进入首页-》系统管理-》插件管理-》已安装-》输入kubernetes查看</span></span><br><span class="line"><span class="comment">#也可登录该网站：https://plugins.jenkins.io/，查找需要的插件</span></span><br></pre></td></tr></table></figure><h5 id="增加一个kubernetes云"><a href="#增加一个kubernetes云" class="headerlink" title="增加一个kubernetes云"></a>增加一个kubernetes云</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#系统管理-&gt;系统设置，往下拉可看到云，点击新增一个云来新增一个kubernetes云</span></span><br></pre></td></tr></table></figure><p><a href="https://wandouduoduo.github.io/articles/3cfe518.html">配置jenkins连接kubernetes教程</a></p><h5 id="配置K8s-Pod-Template"><a href="#配置K8s-Pod-Template" class="headerlink" title="配置K8s Pod Template"></a>配置K8s Pod Template</h5><p>其实就是配置Jenkins的jnlp-slave</p><p>在该kubernetes云下，新增Kubernetes Pod Template，配置一个模板容器配置，如下图所示：</p><p><img src="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io/articles/7aff7329/1.png" alt></p><p><img src="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io/articles/7aff7329/2.png" alt></p><p>配置镜像，下面里面的镜像一定要写对，否则写成别的镜像，到最后编译时候就一直报错没有mvn</p><p><img src="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io/articles/7aff7329/3.png" alt></p><p>配置卷：就是deployment.yaml 里面的挂载路径</p><p><img src="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io/articles/7aff7329/4.png" alt></p><h5 id="全局配置"><a href="#全局配置" class="headerlink" title="全局配置"></a>全局配置</h5><p>点击 系统管理-&gt;全局工具配置，此处可配置配置一些常用的工具配置，比如java、ant、maven、docker</p><p><a href="https://wandouduoduo.github.io/articles/6f80621c.html">参照教程</a></p><h3 id="创建流水线任务项目"><a href="#创建流水线任务项目" class="headerlink" title="创建流水线任务项目"></a>创建流水线任务项目</h3><h5 id="新建任务项目"><a href="#新建任务项目" class="headerlink" title="新建任务项目"></a>新建任务项目</h5><p>点击新建Item –&gt; 进入任务配置界面–&gt;选择Pipeline（中文版为：流水线）–&gt;确定。则可编写Pipeline，进行任务配置</p><p><img src="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io/articles/7aff7329/5.png" alt></p><p><img src="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io/articles/7aff7329/6.png" alt></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Pipeline任务采用流式的处理方法，步骤清晰，非常适合进行任务配置。</span></span><br><span class="line"><span class="comment">#下面pipline里面的简单任务：查看slave镜像里面是否有java的家目录、查看maven的版本等操作，</span></span><br><span class="line"></span><br><span class="line">def label = <span class="string">"jnlp-slave"</span></span><br><span class="line">podTemplate(label: label, cloud: <span class="string">'kubernetes'</span>,containers: [</span><br><span class="line">    containerTemplate(name: <span class="string">'jnlp-slave'</span>, image: <span class="string">'cnych/jenkins:v1'</span>)</span><br><span class="line">  ],</span><br><span class="line">  volumes: [hostPathVolume(mounntPath:<span class="string">'/opt/maven/repository'</span>,hostPath:<span class="string">'/ceph/maven/repository'</span>),</span><br><span class="line">            hostPathVolume(mounntPath:<span class="string">'/usr/bin/docker'</span>,hostPath:<span class="string">'/usr/bin/docker'</span>),</span><br><span class="line">            hostPathVolume(mounntPath:<span class="string">'/var/run/docker.sock'</span>,hostPath:<span class="string">'/var/run/docker.sock'</span>)]) &#123;</span><br><span class="line">    node(label) &#123;</span><br><span class="line">        stage(<span class="string">'Get a Maven project'</span>) &#123;</span><br><span class="line">            container(label) &#123;</span><br><span class="line">                stage(<span class="string">'wait for exec check'</span>)&#123;</span><br><span class="line">                    sh <span class="string">'sleep 1'</span></span><br><span class="line">                    sh <span class="string">'echo $JAVA_HOME'</span></span><br><span class="line">                    sh <span class="string">'mvn -v'</span></span><br><span class="line">                &#125;</span><br><span class="line"> </span><br><span class="line">                stage(<span class="string">'get maven env'</span>) &#123;</span><br><span class="line">                    sh <span class="string">'cat /etc/resolv.conf'</span></span><br><span class="line">                    sh <span class="string">'cat /etc/issue'</span></span><br><span class="line">                    sh <span class="string">'uname -a'</span></span><br><span class="line">                    sh <span class="string">'env'</span></span><br><span class="line">                &#125;</span><br><span class="line">              </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io/articles/7aff7329/7.png" alt></p><h5 id="构建"><a href="#构建" class="headerlink" title="构建"></a>构建</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看构建前的pod个数</span></span><br><span class="line">kubectl get pod -n [namespace]</span><br></pre></td></tr></table></figure><p>页面点击立即构建</p><p><img src="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io/articles/7aff7329/8.png" alt></p><p><img src="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io/articles/7aff7329/9.png" alt></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看构建时的pod数量</span></span><br><span class="line">kubectl get pod -n [NAMEspace]  </span><br><span class="line"></span><br><span class="line"><span class="comment">#再次查看pod个数：发现消失从上边的pod个数变化中，我们可以清晰的看到 Jenkins Slave 自动创建到注销删除的过程，整个过程是自动完成的，不需要人工干预。</span></span><br></pre></td></tr></table></figure><h2 id="使用宿主机的kubectl命令"><a href="#使用宿主机的kubectl命令" class="headerlink" title="使用宿主机的kubectl命令"></a>使用宿主机的kubectl命令</h2><h3 id="镜像选择"><a href="#镜像选择" class="headerlink" title="镜像选择"></a>镜像选择</h3><p>slave镜像需要使用cnych/jenkins:jnlp，这个官方镜像里面有kubectl工具，其他的没有，都试过，上面就是用的这个镜像，所以直接下一步</p><h3 id="挂载kubectl工具"><a href="#挂载kubectl工具" class="headerlink" title="挂载kubectl工具"></a>挂载kubectl工具</h3><p>/root/.kube 目录，我们将这个目录挂载到容器的 /home/jenkins/.kube 目录下面这是为了让我们能够在 Pod 的容器中能够使用 kubectl 工具来访问我们的 Kubernetes 集群，方便我们后面在 Slave Pod 部署 Kubernetes 应用。添加一个挂在路径，如下图所示：</p><p><img src="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io/articles/7aff7329/10.png" alt></p><h3 id="pipline脚本"><a href="#pipline脚本" class="headerlink" title="pipline脚本"></a>pipline脚本</h3><p>先试试是否能使用宿主机的kubectl命令，只查看一个pod情况：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">def label = <span class="string">"jnlp-slave"</span></span><br><span class="line">podTemplate(label: label, cloud: <span class="string">'kubernetes'</span>,containers: [</span><br><span class="line">    containerTemplate(name: <span class="string">'jnlp-slave'</span>, image: <span class="string">'cnych/jenkins:v1'</span>)</span><br><span class="line">  ],</span><br><span class="line">  volumes: [hostPathVolume(mounntPath:<span class="string">'/opt/maven/repository'</span>,hostPath:<span class="string">'/ceph/maven/repository'</span>),</span><br><span class="line">            hostPathVolume(mounntPath:<span class="string">'/usr/bin/docker'</span>,hostPath:<span class="string">'/usr/bin/docker'</span>),</span><br><span class="line">            hostPathVolume(mounntPath:<span class="string">'/var/run/docker.sock'</span>,hostPath:<span class="string">'/var/run/docker.sock'</span>),</span><br><span class="line">            hostPathVolume(mounntPath:<span class="string">' /home/jenkins/.kube'</span>,hostPath:<span class="string">'/root/.kube'</span>)]) &#123;</span><br><span class="line">    node(label) &#123;</span><br><span class="line">        stage(<span class="string">'Get a Maven project'</span>) &#123;</span><br><span class="line">            container(label) &#123;</span><br><span class="line">                stage(<span class="string">'wait for exec check'</span>)&#123;</span><br><span class="line">                    sh <span class="string">'kubectl get pod -n jenkins'</span></span><br><span class="line">                &#125;</span><br><span class="line"> </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="构建，查看控制台输出"><a href="#构建，查看控制台输出" class="headerlink" title="构建，查看控制台输出"></a>构建，查看控制台输出</h3><p><img src="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io/articles/7aff7329/11.png" alt></p><h3 id="使用jenkins-salve创建nignx项目"><a href="#使用jenkins-salve创建nignx项目" class="headerlink" title="使用jenkins-salve创建nignx项目"></a>使用jenkins-salve创建nignx项目</h3><h5 id="pipline脚本-1"><a href="#pipline脚本-1" class="headerlink" title="pipline脚本"></a>pipline脚本</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">def label = <span class="string">"jnlp-slave"</span></span><br><span class="line">podTemplate(label: label, cloud: <span class="string">'kubernetes'</span>,containers: [</span><br><span class="line">    containerTemplate(name: <span class="string">'jnlp-slave'</span>, image: <span class="string">'cnych/jenkins:v1'</span>)</span><br><span class="line">  ],</span><br><span class="line">  volumes: [hostPathVolume(mounntPath:<span class="string">'/opt/maven/repository'</span>,hostPath:<span class="string">'/ceph/maven/repository'</span>),</span><br><span class="line">            hostPathVolume(mounntPath:<span class="string">'/usr/bin/docker'</span>,hostPath:<span class="string">'/usr/bin/docker'</span>),</span><br><span class="line">            hostPathVolume(mounntPath:<span class="string">'/usr/bin/docker'</span>,hostPath:<span class="string">'/usr/bin/docker'</span>),</span><br><span class="line">            hostPathVolume(mounntPath:<span class="string">' /home/jenkins/.kube'</span>,hostPath:<span class="string">'/root/.kube'</span>)]) &#123;</span><br><span class="line">    node(label) &#123;</span><br><span class="line">        stage(<span class="string">'create a pod'</span>) &#123;</span><br><span class="line">            container(label) &#123;</span><br><span class="line">                stage(<span class="string">'cat the pod'</span>)&#123;</span><br><span class="line">                    sh <span class="string">'kubectl get pod -n jenkins'</span></span><br><span class="line">                &#125;</span><br><span class="line"> </span><br><span class="line">        stage(<span class="string">'create the deploy-nginx.yaml'</span>)&#123;</span><br><span class="line"><span class="built_in">echo</span> <span class="string">'create the deploy-nginx.yaml'</span></span><br><span class="line">sh <span class="string">''</span><span class="string">'</span></span><br><span class="line"><span class="string">cat &gt;deploy-nginx.yaml&lt;&lt;EOF</span></span><br><span class="line"><span class="string">apiVersion: extensions/v1beta1</span></span><br><span class="line"><span class="string">kind: Deployment</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: http-test-dm2</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  replicas: 1</span></span><br><span class="line"><span class="string">  template:</span></span><br><span class="line"><span class="string">    metadata:</span></span><br><span class="line"><span class="string">      labels:</span></span><br><span class="line"><span class="string">        name: http-test-dm2</span></span><br><span class="line"><span class="string">    spec:</span></span><br><span class="line"><span class="string">      containers:</span></span><br><span class="line"><span class="string">      - name: http-test-con</span></span><br><span class="line"><span class="string">        image: nginx</span></span><br><span class="line"><span class="string">        imagePullPolicy: Never      </span></span><br><span class="line"><span class="string">        ports:</span></span><br><span class="line"><span class="string">        - containerPort: 80</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Service</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: http-nginx-ser</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  type: NodePort</span></span><br><span class="line"><span class="string">  ports: </span></span><br><span class="line"><span class="string">  - port: 80</span></span><br><span class="line"><span class="string">    nodePort: 31000</span></span><br><span class="line"><span class="string">    targetPort: 80</span></span><br><span class="line"><span class="string">  selector:</span></span><br><span class="line"><span class="string">    name: http-test-dm2</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiVersion: extensions/v1beta1</span></span><br><span class="line"><span class="string">kind: Ingress</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: nginx</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  rules:</span></span><br><span class="line"><span class="string">  - host: www.nginx2.com      </span></span><br><span class="line"><span class="string">    http:</span></span><br><span class="line"><span class="string">      paths:</span></span><br><span class="line"><span class="string">      - path: /</span></span><br><span class="line"><span class="string">        backend:</span></span><br><span class="line"><span class="string">          serviceName: http-nginx-ser</span></span><br><span class="line"><span class="string">          servicePort: 80</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">'</span><span class="string">''</span></span><br><span class="line">            &#125;</span><br><span class="line">                stage(<span class="string">'deploy to k8s'</span>)&#123;</span><br><span class="line">                    sh <span class="string">'kubectl create -f deploy-nginx.yaml'</span></span><br><span class="line">                    </span><br><span class="line">                &#125;</span><br><span class="line">              </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="开始构建"><a href="#开始构建" class="headerlink" title="开始构建"></a>开始构建</h5><p><img src="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io/articles/7aff7329/12.png" alt></p><h5 id="查看命名空间下的pod验证"><a href="#查看命名空间下的pod验证" class="headerlink" title="查看命名空间下的pod验证"></a>查看命名空间下的pod验证</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#多次执行下面命令，对比输出结果</span></span><br><span class="line">kubectl get pod -n jenkins</span><br></pre></td></tr></table></figure><h5 id="测试访问nginx"><a href="#测试访问nginx" class="headerlink" title="测试访问nginx"></a>测试访问nginx</h5><p>浏览器访问<a href="http://x.x.x.x:31000" rel="noopener external nofollow noreferrer" target="_blank">http://x.x.x.x:31000</a></p><p><img src="https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io/articles/7aff7329/13.png" alt></p><h5 id="编写pipline脚本"><a href="#编写pipline脚本" class="headerlink" title="编写pipline脚本"></a>编写pipline脚本</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#注意下面pipline脚本里面的 maven build步骤，里面的JAVA_HOME和mvn工具 都是jenkins-slave里面的，而不是jenkins-master里面的工具，</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#如何查看jenkins-slave里面JAVA_HOME位置：只有通过构建的时候，在pipline里面写shell命令进行查看，因为制作jenkins-slave镜像的基础</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#镜像是从官方镜像拉取的，而这个官方jenkins-slave镜像是不能独立启动的，试过，用docker无法启动，只能当slave使用。但是为什么还要用这个镜像，就是因为这个基础镜像里面包含kubectl工具， 自己之前尝试往jenkins-master镜像里面添加kubectl工具，但是失败，</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#注意：下面piplene里面的第三个stage步骤里面的JAVA_HOME路径是第一个stage步骤mvn -v 得到的结果有java路径，要填写这个，不要填写echo $JAVA_HOME得到的结果</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#先编译构建一下，然后得到mvn -v 结果后，及时暂停，然后把java路径填写到第三个stage步骤里面，从新编译打包</span></span><br><span class="line"></span><br><span class="line">def label = <span class="string">"jnlp-slave"</span></span><br><span class="line">podTemplate(label: label, cloud: <span class="string">'kubernetes'</span>,containers: [</span><br><span class="line">    containerTemplate(name: <span class="string">'jnlp-slave'</span>, image: <span class="string">'cnych/jenkins:v1'</span>)</span><br><span class="line">  ],</span><br><span class="line">  volumes: [hostPathVolume(mounntPath:<span class="string">'/opt/maven/repository'</span>,hostPath:<span class="string">'/ceph/maven/repository'</span>),</span><br><span class="line">            hostPathVolume(mounntPath:<span class="string">'/usr/bin/docker'</span>,hostPath:<span class="string">'/usr/bin/docker'</span>),</span><br><span class="line">            hostPathVolume(mounntPath:<span class="string">'/usr/bin/docker'</span>,hostPath:<span class="string">'/usr/bin/docker'</span>),</span><br><span class="line">            hostPathVolume(mounntPath:<span class="string">' /home/jenkins/.kube'</span>,hostPath:<span class="string">'/root/.kube'</span>)]) &#123;</span><br><span class="line">    node(label) &#123;</span><br><span class="line">        stage(<span class="string">'create a pod'</span>) &#123;</span><br><span class="line">            container(label) &#123;</span><br><span class="line">                stage(<span class="string">'cat the pod'</span>)&#123;</span><br><span class="line">                    sh <span class="string">'kubectl get pod -n jenkins'</span></span><br><span class="line">                    sh <span class="string">'echo $JAVA_HOME'</span></span><br><span class="line">                    sh <span class="string">'mvn -v'</span></span><br><span class="line">                &#125;</span><br><span class="line">                stage(<span class="string">'git checkout'</span>)&#123;</span><br><span class="line">            </span><br><span class="line">                <span class="built_in">echo</span> <span class="string">'git clone'</span></span><br><span class="line">                checkout([<span class="variable">$class</span>: <span class="string">'GitSCM'</span>, branches: [[name: <span class="string">'*/master'</span>]], doGenerateSubmoduleConfigurations: <span class="literal">false</span>, extensions: [], submoduleCfg: [], userRemoteConfigs: [[credentialsId: <span class="string">'c2ca4523-96d0-4fdc-a427-bfefc36a3aa5'</span>, url: <span class="string">'http://192.168.0.96:8081/root/hello.git'</span>]]])</span><br><span class="line">           </span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                stage(<span class="string">'maven build'</span>)&#123;</span><br><span class="line"></span><br><span class="line">                <span class="built_in">echo</span> <span class="string">'maven build'</span></span><br><span class="line">                    sh <span class="string">''</span><span class="string">'</span></span><br><span class="line"><span class="string">                export JAVA_HOME=/usr/local/newhope/java1.8</span></span><br><span class="line"><span class="string">                /usr/bin/mvn clean package -Dmaven.test.skip=true</span></span><br><span class="line"><span class="string">                '</span><span class="string">''</span></span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">        stage(<span class="string">'docker build and push images'</span>)&#123;</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'docker build and push images'</span></span><br><span class="line">sh <span class="string">''</span><span class="string">'</span></span><br><span class="line"><span class="string">REPOSITORY=192.168.0.98:5000/library/solo/solo:$&#123;Tag&#125;</span></span><br><span class="line"><span class="string">cat &gt;Dockerfile&lt;&lt;EOF</span></span><br><span class="line"><span class="string">FROM 192.168.0.98:5000/library/tomcat-85:latest</span></span><br><span class="line"><span class="string">RUN rm -rf /usr/local/tomcat/webapps/ROOT/</span></span><br><span class="line"><span class="string">COPY target/*.war /usr/local/tomcat/webapps/ROOT.war</span></span><br><span class="line"><span class="string">WORKDIR /usr/local/tomcat</span></span><br><span class="line"><span class="string">EXPOSE 8080</span></span><br><span class="line"><span class="string">CMD ["./bin/catalina.sh", "run"]</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string">docker build -t $REPOSITORY .</span></span><br><span class="line"><span class="string">docker login -u admin -p Harbor12345 192.168.0.98:5000</span></span><br><span class="line"><span class="string">docker push $REPOSITORY</span></span><br><span class="line"><span class="string">'</span><span class="string">''</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">        stage(<span class="string">'create the deploy-solo.yaml'</span>)&#123;</span><br><span class="line"><span class="built_in">echo</span> <span class="string">'create the deploy-solo.yaml'</span></span><br><span class="line">sh <span class="string">''</span><span class="string">'</span></span><br><span class="line"><span class="string">REPOSITORY=192.168.0.98:5000/library/solo/solo:$&#123;Tag&#125;</span></span><br><span class="line"><span class="string">cat &gt;deploy-solo.yaml&lt;&lt;EOF</span></span><br><span class="line"><span class="string">apiVersion: extensions/v1beta1</span></span><br><span class="line"><span class="string">kind: Deployment</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: http-solo-dm2</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  replicas: 1</span></span><br><span class="line"><span class="string">  template:</span></span><br><span class="line"><span class="string">    metadata:</span></span><br><span class="line"><span class="string">      labels:</span></span><br><span class="line"><span class="string">        name: http-solo-dm2</span></span><br><span class="line"><span class="string">    spec:</span></span><br><span class="line"><span class="string">      containers:</span></span><br><span class="line"><span class="string">      - name: http-solo-con</span></span><br><span class="line"><span class="string">        image: $REPOSITORY</span></span><br><span class="line"><span class="string">        imagePullPolicy: Never      </span></span><br><span class="line"><span class="string">        ports:</span></span><br><span class="line"><span class="string">        - containerPort: 80</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Service</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: http-solo-ser</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  type: NodePort</span></span><br><span class="line"><span class="string">  ports: </span></span><br><span class="line"><span class="string">  - port: 8080</span></span><br><span class="line"><span class="string">    nodePort: 33580</span></span><br><span class="line"><span class="string">    targetPort: 8080</span></span><br><span class="line"><span class="string">  selector:</span></span><br><span class="line"><span class="string">    name: http-solo-dm2</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiVersion: extensions/v1beta1</span></span><br><span class="line"><span class="string">kind: Ingress</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: solo</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  rules:</span></span><br><span class="line"><span class="string">  - host: www.solo.com      </span></span><br><span class="line"><span class="string">    http:</span></span><br><span class="line"><span class="string">      paths:</span></span><br><span class="line"><span class="string">      - path: /</span></span><br><span class="line"><span class="string">        backend:</span></span><br><span class="line"><span class="string">          serviceName: http-solo-ser</span></span><br><span class="line"><span class="string">          servicePort: 8080</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">'</span><span class="string">''</span></span><br><span class="line">            &#125;</span><br><span class="line">                stage(<span class="string">'deploy to k8s'</span>)&#123;</span><br><span class="line">                    sh <span class="string">'kubectl create -f deploy-solo.yaml'</span></span><br><span class="line">                    </span><br><span class="line">                &#125;</span><br><span class="line">              </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#上面pipline脚本做的事情如下：</span></span><br><span class="line"><span class="comment">#查看JAVA_HOME</span></span><br><span class="line"><span class="comment">#查看maven版本</span></span><br><span class="line"><span class="comment">#拉取代码：git checkout</span></span><br><span class="line"><span class="comment">#编译打包：maven build</span></span><br><span class="line"><span class="comment">#构建并推送镜像：docker build and push images</span></span><br><span class="line"><span class="comment">#创建yaml文件：create the deploy-solo.yaml</span></span><br><span class="line"><span class="comment">#部署到k8s集群里面：deploy to k8s</span></span><br></pre></td></tr></table></figure><h5 id="查看harbor仓库"><a href="#查看harbor仓库" class="headerlink" title="查看harbor仓库"></a>查看harbor仓库</h5><p><a href="http://192.168.0.98:5000" rel="noopener external nofollow noreferrer" target="_blank">http://192.168.0.98:5000</a></p><h2 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h2><h3 id="生成自定义Jenkins-master镜像"><a href="#生成自定义Jenkins-master镜像" class="headerlink" title="生成自定义Jenkins master镜像"></a>生成自定义Jenkins master镜像</h3><p>Dockerfile：</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> <span class="number">192.168</span>.<span class="number">1.184</span>:<span class="number">5000</span>/jenkins/jenkins:<span class="number">2.89</span>.<span class="number">3</span></span><br><span class="line"><span class="keyword">ENV</span> MAVEN_VERSION <span class="number">3.0</span>.<span class="number">5</span></span><br><span class="line"><span class="keyword">ENV</span> JAVA_HOME /usr/java/jdk1.<span class="number">8.0</span>_121</span><br><span class="line"><span class="keyword">ENV</span> MAVEN_HOME /opt/maven/apache-maven-$&#123;MAVEN_VERSION&#125;</span><br><span class="line"><span class="keyword">ENV</span> CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar</span><br><span class="line"></span><br><span class="line"><span class="comment"># build java</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> ./jdk1.8.0_121 <span class="variable">$&#123;JAVA_HOME&#125;</span></span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> ./libltdl.so.7 /usr/lib/libltdl.so.7</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># build maven</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> apache-maven-<span class="variable">$&#123;MAVEN_VERSION&#125;</span>-bin.tar.gz /tmp/maven/apache-maven-<span class="variable">$&#123;MAVEN_VERSION&#125;</span>-bin.tar.gz</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> settings.xml /tmp/maven/settings.xml</span></span><br><span class="line"><span class="keyword">USER</span> root:root</span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> mkdir -p /opt/maven/repository \</span></span><br><span class="line"><span class="bash">&amp;&amp; <span class="built_in">cd</span> /opt/maven \</span></span><br><span class="line"><span class="bash">&amp;&amp; tar -zxvf /tmp/maven/apache-maven-<span class="variable">$&#123;MAVEN_VERSION&#125;</span>-bin.tar.gz \</span></span><br><span class="line"><span class="bash">&amp;&amp; cp /tmp/maven/settings.xml <span class="variable">$&#123;MAVEN_HOME&#125;</span>/conf/settings.xml \</span></span><br><span class="line"><span class="bash">&amp;&amp; rm -rf /tmp/maven</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> PATH $&#123;JAVA_HOME&#125;/bin:$&#123;MAVEN_HOME&#125;/bin:$&#123;PATH&#125;</span><br></pre></td></tr></table></figure><p>该Dockerfile所做的工作为：</p><ol><li>重新安装Java环境并配置环境变量；</li><li>安装Maven并配置环境变量；</li><li>配置Maven仓库位置，以便启动时挂载宿主机仓库为容器中Maven仓库;</li><li>设置启动用户为root。</li></ol><h3 id="生成自定义Jenkins-slave镜像"><a href="#生成自定义Jenkins-slave镜像" class="headerlink" title="生成自定义Jenkins slave镜像"></a>生成自定义Jenkins slave镜像</h3><p>Dockerfile：</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> jenkinsci/jnlp-slave:latest</span><br><span class="line"><span class="keyword">ENV</span> MAVEN_VERSION <span class="number">3.0</span>.<span class="number">5</span></span><br><span class="line"><span class="keyword">ENV</span> JAVA_HOME /usr/java/jdk1.<span class="number">8.0</span>_121</span><br><span class="line"><span class="keyword">ENV</span> MAVEN_HOME /opt/maven/apache-maven-$&#123;MAVEN_VERSION&#125;</span><br><span class="line"><span class="keyword">ENV</span> CLASSPATH .:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar</span><br><span class="line"></span><br><span class="line"><span class="comment"># build java</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> ./jdk1.8.0_121 <span class="variable">$&#123;JAVA_HOME&#125;</span></span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> ./libltdl.so.7 /usr/lib/libltdl.so.7</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># build maven</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> apache-maven-<span class="variable">$&#123;MAVEN_VERSION&#125;</span>-bin.tar.gz /tmp/maven/apache-maven-<span class="variable">$&#123;MAVEN_VERSION&#125;</span>-bin.tar.gz</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> settings.xml /tmp/maven/settings.xml</span></span><br><span class="line"><span class="keyword">USER</span> root:root</span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> mkdir -p /opt/maven/repository \</span></span><br><span class="line"><span class="bash">&amp;&amp; <span class="built_in">cd</span> /opt/maven \</span></span><br><span class="line"><span class="bash">&amp;&amp; tar -zxvf /tmp/maven/apache-maven-<span class="variable">$&#123;MAVEN_VERSION&#125;</span>-bin.tar.gz \</span></span><br><span class="line"><span class="bash">&amp;&amp; cp /tmp/maven/settings.xml <span class="variable">$&#123;MAVEN_HOME&#125;</span>/conf/settings.xml \</span></span><br><span class="line"><span class="bash">&amp;&amp; rm -rf /tmp/maven \</span></span><br><span class="line"><span class="bash">&amp;&amp; apt-get -yq update \</span></span><br><span class="line"><span class="bash">&amp;&amp; apt-get -yq --no-install-recommends --no-install-suggests install sshpass \</span></span><br><span class="line"><span class="bash">&amp;&amp; apt-get clean -y</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> PATH $&#123;MAVEN_HOME&#125;/bin:$&#123;PATH&#125;</span><br></pre></td></tr></table></figure><p>该Dockerfile操作与Jenkins master的Dockerfile基本一致。不过该镜像中缺少libltdl.so.7文件，需要从宿主机中拷贝进去，该文件在slave节点容器中使用docker时会用到，因此十分重要</p></div><div><ins class="adsbygoogle" style="display:block;text-align:center" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-6677803223619857" data-ad-slot="1099922897"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script><div><div style="text-align:center;color:#ccc;font-size:14px">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div></div></div><div><div class="my_post_copyright"><script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script><script src="https://cdn.bootcss.com/jquery/2.0.0/jquery.min.js"></script><script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script><p><span>本文标题:</span><a href="/articles/7aff7329.html">k8s版jenkins带maven、jdk、git各种工具用master/slave模式实现CI/CD</a></p><p><span>文章作者:</span><a href="/" title="访问 WanDouDuoDuo 的个人博客">WanDouDuoDuo</a></p><p><span>发布时间:</span>2020年07月02日 - 14:07</p><p><span>最后更新:</span>2020年08月04日 - 14:08</p><p><span>原始链接:</span><a href="/articles/7aff7329.html" title="k8s版jenkins带maven、jdk、git各种工具用master/slave模式实现CI/CD">https://wandouduoduo.github.io/articles/7aff7329.html</a><span class="copy-path" title="点击复制文章链接"><i class="fa fa-clipboard" data-clipboard-text="https://wandouduoduo.github.io/articles/7aff7329.html" aria-label="复制成功！"></i></span></p><p><span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license external nofollow noreferrer" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">署名-非商业性使用-禁止演绎 4.0 国际</a> 转载请保留原文链接及作者。</p></div><script>var clipboard=new Clipboard(".fa-clipboard");$(".fa-clipboard").click(function(){clipboard.on("success",function(){swal({title:"",text:"复制成功",icon:"success",showConfirmButton:!0})})})</script></div><div><div style="padding:10px 0;margin:20px auto;width:90%;text-align:center"><div>原创技术分享，您的支持将鼓励我继续创作</div> <button id="rewardButton" disable="enable" onclick='var qr=document.getElementById("QR");"none"===qr.style.display?qr.style.display="block":qr.style.display="none"'> <span>打赏</span></button><div id="QR" style="display:none"><div id="wechat" style="display:inline-block"> <img id="wechat_qr" src="//cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io/images/wechatpay.png" alt="WanDouDuoDuo 微信支付"><p>微信支付</p></div><div id="alipay" style="display:inline-block"> <img id="alipay_qr" src="//cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io/images/alipay.jpg" alt="WanDouDuoDuo 支付宝"><p>支付宝</p></div></div></div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/K8s/" rel="tag"><i class="fa fa-tag"></i> K8s</a><a href="/tags/Jenkins/" rel="tag"><i class="fa fa-tag"></i> Jenkins</a></div><div class="post-widgets"><div class="social_share"><div><div class="bdsharebuttonbox"><a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a><a href="#" class="bds_douban" data-cmd="douban" title="分享到豆瓣网"></a><a href="#" class="bds_sqq" data-cmd="sqq" title="分享到QQ好友"></a><a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a><a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a><a href="#" class="bds_tieba" data-cmd="tieba" title="分享到百度贴吧"></a><a href="#" class="bds_twi" data-cmd="twi" title="分享到Twitter"></a><a href="#" class="bds_fbook" data-cmd="fbook" title="分享到Facebook"></a><a href="#" class="bds_more" data-cmd="more"></a><a class="bds_count" data-cmd="count"></a></div><script>window._bd_share_config={common:{bdText:"",bdMini:"2",bdMiniList:!1,bdPic:""},share:{bdSize:"16",bdStyle:"0"},image:{viewList:["tsina","douban","sqq","qzone","weixin","twi","fbook"],viewText:"分享到：",viewSize:"16"}}</script><script>with(document)(getElementsByTagName("head")[0]||body).appendChild(createElement("script")).src="/static/api/js/share.js?cdnversion="+~(-new Date/36e5)</script></div></div></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/articles/e09b4ef6.html" rel="next" title="CentOS7安装指定版本Docker-ce"><i class="fa fa-chevron-left"></i> CentOS7安装指定版本Docker-ce</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"> <a href="/articles/3cfe518.html" rel="prev" title="容器版Jenkins连接K8s">容器版Jenkins连接K8s<i class="fa fa-chevron-right"></i></a></div></div></footer></div></article></div></div><div class="comments" id="gitalk-container"></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap"> 文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap"> 站点概览</li></ul><div class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" src="//cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io/images/me.jpg" alt="WanDouDuoDuo"><p class="site-author-name" itemprop="name">WanDouDuoDuo</p><p class="site-description motion-element" itemprop="description">沪漂资深运维架构师的呕心笔记</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">169</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/index.html"><span class="site-state-item-count">43</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/index.html"><span class="site-state-item-count">58</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/wandouduoduo" title="GitHub &rarr; https://github.com/wandouduoduo" rel="noopener external nofollow noreferrer" target="_blank"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:wandouduoduo@163.com" title="E-Mail &rarr; mailto:wandouduoduo@163.com" rel="noopener external nofollow noreferrer" target="_blank"><i class="fa fa-fw fa-envelope"></i> E-Mail</a></span><span class="links-of-author-item"><a href="https://gitee.com/wandouduoduo" title="Gitee &rarr; https://gitee.com/wandouduoduo" rel="noopener external nofollow noreferrer" target="_blank"><i class="fa fa-fw fa-heartbeat"></i> Gitee</a></span><span class="links-of-author-item"><a href="https://weibo.com/u/1989032071/home?topnav=1&wvr=6" title="微博 &rarr; https://weibo.com/u/1989032071/home?topnav=1&wvr=6" rel="noopener external nofollow noreferrer" target="_blank"><i class="fa fa-fw fa-weibo"></i> 微博</a></span></div><div class="links-of-blogroll motion-element links-of-blogroll-inline"><div class="links-of-blogroll-title"><i class="fa fa-fw fa-link"></i> 友情链接</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"> <a href="https://www.runoob.com/" title="https://www.runoob.com/" rel="noopener external nofollow noreferrer" target="_blank">菜鸟教程</a></li><li class="links-of-blogroll-item"> <a href="https://code.ziqiangxuetang.com/" title="https://code.ziqiangxuetang.com/" rel="noopener external nofollow noreferrer" target="_blank">自强学堂</a></li><li class="links-of-blogroll-item"> <a href="http://www.zsythink.net/" title="http://www.zsythink.net/" rel="noopener external nofollow noreferrer" target="_blank">朱双印博客</a></li><li class="links-of-blogroll-item"> <a href="https://pincheng.xyz/" title="https://pincheng.xyz/" rel="noopener external nofollow noreferrer" target="_blank">运维饼铛</a></li></ul></div></div></div><div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#目的"><span class="nav-number">1.</span> <span class="nav-text">目的</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#环境"><span class="nav-number">2.</span> <span class="nav-text">环境</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#M-S模式实现"><span class="nav-number">3.</span> <span class="nav-text">M/S模式实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#创建Master镜像文件"><span class="nav-number">3.1.</span> <span class="nav-text">创建Master镜像文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#构建Master镜像"><span class="nav-number">3.2.</span> <span class="nav-text">构建Master镜像</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#启动YAML配置文件"><span class="nav-number">3.3.</span> <span class="nav-text">启动YAML配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#启动Jenkins-Master容器"><span class="nav-number">3.4.</span> <span class="nav-text">启动Jenkins Master容器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建Jenkins-slave镜像文件"><span class="nav-number">3.5.</span> <span class="nav-text">创建Jenkins slave镜像文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#构建Slave镜像"><span class="nav-number">3.6.</span> <span class="nav-text">构建Slave镜像</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查看镜像列表"><span class="nav-number">3.7.</span> <span class="nav-text">查看镜像列表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#浏览器访问"><span class="nav-number">3.8.</span> <span class="nav-text">浏览器访问</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#页面配置master"><span class="nav-number">3.9.</span> <span class="nav-text">页面配置master</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#升级和重置密码"><span class="nav-number">3.9.0.1.</span> <span class="nav-text">升级和重置密码</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#安装插件"><span class="nav-number">3.9.0.2.</span> <span class="nav-text">安装插件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#增加一个kubernetes云"><span class="nav-number">3.9.0.3.</span> <span class="nav-text">增加一个kubernetes云</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#配置K8s-Pod-Template"><span class="nav-number">3.9.0.4.</span> <span class="nav-text">配置K8s Pod Template</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#全局配置"><span class="nav-number">3.9.0.5.</span> <span class="nav-text">全局配置</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建流水线任务项目"><span class="nav-number">3.10.</span> <span class="nav-text">创建流水线任务项目</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#新建任务项目"><span class="nav-number">3.10.0.1.</span> <span class="nav-text">新建任务项目</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#构建"><span class="nav-number">3.10.0.2.</span> <span class="nav-text">构建</span></a></li></ol></li></ol><li class="nav-item nav-level-2"><a class="nav-link" href="#使用宿主机的kubectl命令"><span class="nav-number">4.</span> <span class="nav-text">使用宿主机的kubectl命令</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#镜像选择"><span class="nav-number">4.1.</span> <span class="nav-text">镜像选择</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#挂载kubectl工具"><span class="nav-number">4.2.</span> <span class="nav-text">挂载kubectl工具</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#pipline脚本"><span class="nav-number">4.3.</span> <span class="nav-text">pipline脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#构建，查看控制台输出"><span class="nav-number">4.4.</span> <span class="nav-text">构建，查看控制台输出</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用jenkins-salve创建nignx项目"><span class="nav-number">4.5.</span> <span class="nav-text">使用jenkins-salve创建nignx项目</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#pipline脚本-1"><span class="nav-number">4.5.0.1.</span> <span class="nav-text">pipline脚本</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#开始构建"><span class="nav-number">4.5.0.2.</span> <span class="nav-text">开始构建</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#查看命名空间下的pod验证"><span class="nav-number">4.5.0.3.</span> <span class="nav-text">查看命名空间下的pod验证</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#测试访问nginx"><span class="nav-number">4.5.0.4.</span> <span class="nav-text">测试访问nginx</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#编写pipline脚本"><span class="nav-number">4.5.0.5.</span> <span class="nav-text">编写pipline脚本</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#查看harbor仓库"><span class="nav-number">4.5.0.6.</span> <span class="nav-text">查看harbor仓库</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#补充"><span class="nav-number">5.</span> <span class="nav-text">补充</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#生成自定义Jenkins-master镜像"><span class="nav-number">5.1.</span> <span class="nav-text">生成自定义Jenkins master镜像</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#生成自定义Jenkins-slave镜像"><span class="nav-number">5.2.</span> <span class="nav-text">生成自定义Jenkins slave镜像</span></a></li></ol></li></div></div></div><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span id="scrollpercent"><span>0</span>%</span></div><script type="text/javascript" charset="utf-8" src="/js/tagcloud.js"></script><script type="text/javascript" charset="utf-8" src="/js/tagcanvas.js"></script><div class="widget-wrap"><div id="myCanvasContainer" class="widget tagcloud"><canvas width="250" height="250" id="resCanvas" style=""><ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Ai/">Ai</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Ansible/">Ansible</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Aplayer/">Aplayer</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Apollo/">Apollo</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Centos/">Centos</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cloud/">Cloud</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cmdb/">Cmdb</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Confd/">Confd</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Confluence/">Confluence</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Dns/">Dns</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/">Docker</a><span class="tag-list-count">16</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Elk/">Elk</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Experiences/">Experiences</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Flask/">Flask</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Git/">Git</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GlusterFS/">GlusterFS</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Go/">Go</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Haproxy/">Haproxy</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hexo/">Hexo</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Http/">Http</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Iptables/">Iptables</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/">Java</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Jenkins/">Jenkins</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/K8s/">K8s</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kali/">Kali</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Keepalived/">Keepalived</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a><span class="tag-list-count">15</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Lvs/">Lvs</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mesos/">Mesos</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MongoDB/">MongoDB</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mysql/">Mysql</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Network/">Network</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nexus/">Nexus</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nginx/">Nginx</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Open-falcon/">Open-falcon</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Openldap/">Openldap</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Opensips/">Opensips</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Openvpn/">Openvpn</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PostgreSQL/">PostgreSQL</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Prometheus/">Prometheus</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python/">Python</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis/">Redis</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redmine/">Redmine</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RocketChat/">RocketChat</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Saturn/">Saturn</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Selenium/">Selenium</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Sentry/">Sentry</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Shell/">Shell</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Stackstorm/">Stackstorm</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Supervisor/">Supervisor</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Tomcat/">Tomcat</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Uwsgi/">Uwsgi</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Web/">Web</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Wiki/">Wiki</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Windows/">Windows</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Xxl-job/">Xxl-job</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Zabbix/">Zabbix</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Zookeeper/">Zookeeper</a><span class="tag-list-count">1</span></li></ul></canvas></div></div><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-6677803223619857" data-ad-slot="8792470846" data-ad-format="auto" data-full-width-responsive="true"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2020</span><span class="with-love" id="animate"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">WanDouDuoDuo</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-area-chart"></i></span> <span class="post-meta-item-text">站点总字数：</span> <span title="站点总字数">364k</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span class="post-meta-item-text">站点阅读时长 &asymp;</span> <span title="站点阅读时长">5:31</span></div><div class="theme-info"><div class="powered-by"></div> <span class="post-count">博客全站共366.3k字</span></div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script> <span class="post-meta-item-icon"><i class="fa fa-user">访问人数:</i></span><span class="site-uv" title="总访客量"><span class="busuanzi-value" id="busuanzi_value_site_uv"></span></span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-eye">总阅读量:</i></span><span class="site-pv" title="总访问量"><span class="busuanzi-value" id="busuanzi_value_site_pv"></span></span></div><div><script type="text/javascript">var cnzz_protocol="https:"==document.location.protocol?"https://":"http://";document.write(unescape("%3Cspan id='cnzz_stat_icon_1277740757'%3E%3C/span%3E%3Cscript src='"+cnzz_protocol+"s23.cnzz.com/z_stat.php%3Fid%3D1277740757%26online%3D1%26show%3Dline' type='text/javascript'%3E%3C/script%3E"))</script></div></div></footer></div><script>"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script color="255,255,255" opacity="1" zindex="-1" count="150" src="//cdn.jsdelivr.net/gh/theme-next/theme-next-canvas-nest@1/canvas-nest.min.js"></script><script src="//cdn.jsdelivr.net/npm/jquery@2/dist/jquery.min.js"></script><script src="//cdn.jsdelivr.net/npm/velocity-animate@1/velocity.min.js"></script><script src="//cdn.jsdelivr.net/npm/velocity-animate@1/velocity.ui.min.js"></script><script src="/js/src/utils.js?v=6.7.0"></script><script src="/js/src/motion.js?v=6.7.0"></script><script src="/js/src/affix.js?v=6.7.0"></script><script src="/js/src/schemes/pisces.js?v=6.7.0"></script><script src="/js/src/scrollspy.js?v=6.7.0"></script><script src="/js/src/post-details.js?v=6.7.0"></script><script src="/js/src/bootstrap.js?v=6.7.0"></script><script src="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"><script src="//cdn.jsdelivr.net/npm/js-md5@0.7.3/src/md5.min.js"></script><script>var gitalk=new Gitalk({clientID:"ad83725549e82facce82",clientSecret:"b67c2056b52d0447f1d78f413f268a5b853e8a6e",repo:"wandouduoduo.github.io",owner:"wandouduoduo",admin:["wandouduoduo"],id:md5(location.pathname),distractionFreeMode:"true"});gitalk.render("gitalk-container")</script><script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><style>.copy-btn{display:inline-block;padding:6px 12px;font-size:13px;font-weight:700;line-height:20px;color:#333;white-space:nowrap;vertical-align:middle;cursor:pointer;background-color:#eee;background-image:linear-gradient(#fcfcfc,#eee);border:1px solid #d5d5d5;border-radius:3px;user-select:none;outline:0}.highlight-wrap .copy-btn{transition:opacity .3s ease-in-out;opacity:0;padding:2px 6px;position:absolute;right:4px;top:8px}.highlight-wrap .copy-btn:focus,.highlight-wrap:hover .copy-btn{opacity:1}.highlight-wrap{position:relative}</style><script>$(".highlight").each(function(e,t){var n=$("<div>").addClass("highlight-wrap");$(t).after(n),n.append($("<button>").addClass("copy-btn").append("复制").on("click",function(e){var t=$(this).parent().find(".code").find(".line").map(function(e,t){return $(t).text()}).toArray().join("\n"),n=document.createElement("textarea"),o=document.createRange(),a=window.getSelection(),i=window.pageYOffset||document.documentElement.scrollTop;n.style.top=i+"px",n.style.position="absolute",n.style.opacity="0",n.value=t,n.textContent=t,n.contentEditable=!0,n.readOnly=!1,document.body.appendChild(n),o.selectNode(n),a.removeAllRanges(),a.addRange(o),n.setSelectionRange(0,t.length),document.execCommand("copy")?$(this).text("复制成功"):$(this).text("复制失败"),n.blur(),$(this).blur()})).on("mouseleave",function(e){var t=$(this).find(".copy-btn");setTimeout(function(){t.text("复制")},300)}).append(t)})</script><style>#selectionCopyright{position:absolute;display:none;background:rgba(244,67,54,.7);color:#fff;border-radius:6px;box-shadow:none;border:none;font-size:14px}#selectionCopyright a{color:#fff;border-color:#fff}#selectionCopyright::before{content:"";width:0;height:0;border-style:solid;border-width:6px 8px 6px 0;border-color:transparent rgba(244,67,54,.7) transparent transparent;position:absolute;left:-8px;top:50%;transform:translateY(-50%)}</style> <button id="selectionCopyright" disabled="disabled">本文发表于[<a href="http://wandouduoduo.github.io/">豌豆多多</a>]分享请注明来源！</button><script>function selectText(){return document.selection?document.selection.createRange().text:window.getSelection().toString()}var content=document.getElementById("content"),scTip=document.getElementById("selectionCopyright");content.onmouseup=function(e){var t=(e=e||window.event).clientX,n=e.clientY,c=Math.max(document.body.scrollLeft,document.documentElement.scrollLeft),o=Math.max(document.body.scrollTop,document.documentElement.scrollTop);0<selectText().length?setTimeout(function(){scTip.style.display="inline-block",scTip.style.left=t+c+15+"px",scTip.style.top=n+o-15+"px"},100):scTip.style.display="none"},content.onclick=function(e){(e=e||window.event).cancelBubble=!0},document.onclick=function(){scTip.style.display="none"}</script><canvas class="fireworks" style="position:fixed;left:0;top:0;z-index:1;pointer-events:none"></canvas><script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script><script type="text/javascript" src="/js/src/fireworks.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,debug:!1,model:{jsonPath:"https://cdn.jsdelivr.net/gh/wandouduoduo/wandouduoduo.github.io@v1.0/live2dw/assets/shizuku.model.json"},display:{position:"right",width:150,height:300},mobile:{show:!0},log:!1})</script></body></html>