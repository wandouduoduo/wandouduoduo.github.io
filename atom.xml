<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>豌豆多多</title>
  
  <subtitle>Deveops Study Notes</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://wandouduoduo.netlify.com/"/>
  <updated>2019-10-25T06:29:49.993Z</updated>
  <id>https://wandouduoduo.netlify.com/</id>
  
  <author>
    <name>WanDouDuoDuo</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>zabbix教程之自动注册</title>
    <link href="https://wandouduoduo.netlify.com/articles/276c6656.html"/>
    <id>https://wandouduoduo.netlify.com/articles/276c6656.html</id>
    <published>2019-10-25T02:25:23.000Z</published>
    <updated>2019-10-25T06:29:49.993Z</updated>
    
    <content type="html"><![CDATA[<h2 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h2><p>对于监控服务器越来越多的情况，如果还单独一个一个添加，那效率也太低，因此就要实现批量添加监控服务器的操作，Zabbix提供两种批量自动监控的方式：</p><p><strong>自动发现：由服务端主动发起，Zabbix Server开启发现进程，定时扫描局域网中IP服务器、设备。</strong></p><p><strong>自动注册：由客户端主动发起，客户端必须安装并启动Agentd，否则无法被自动注册添加至主机列表。对于使用SNMP的就要采用自动发现了。</strong></p><p>本篇教程就是自动注册，让客户端自动向Server去注册。</p><a id="more"></a><h2 id="教程"><a href="#教程" class="headerlink" title="教程"></a>教程</h2><h4 id="zabbix-agent批量安装脚本"><a href="#zabbix-agent批量安装脚本" class="headerlink" title="zabbix-agent批量安装脚本"></a>zabbix-agent批量安装脚本</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># 功能：centos6.x或7.x都可以自动安装最新稳定版4.0.x agent</span></span><br><span class="line"></span><br><span class="line">vernum=`cat /etc/redhat-release|sed -r <span class="string">'s/.* ([0-9]+)\..*/\1/'</span>`</span><br><span class="line"><span class="comment"># vernum也可以这样获取： rpm -q centos-release|cut -d- -f3</span></span><br><span class="line"></span><br><span class="line">wget http://repo.zabbix.com/zabbix/4.0/rhel/<span class="variable">$&#123;vernum&#125;</span>/x86_64/zabbix-agent-4.0.9-3.el<span class="variable">$&#123;vernum&#125;</span>.x86_64.rpm</span><br><span class="line"></span><br><span class="line">rpm -ivh zabbix-agent-4.0.9-3.el<span class="variable">$&#123;vernum&#125;</span>.x86_64.rpm</span><br><span class="line"></span><br><span class="line">sed -i.ori <span class="string">'s#Server=127.0.0.1#Server=10.216.1.106#'</span> /etc/zabbix/zabbix_agentd.conf</span><br><span class="line">sed -i.ori <span class="string">'s#ServerActive=127.0.0.1#ServerActive=10.216.1.106#'</span> /etc/zabbix/zabbix_agentd.conf</span><br><span class="line">sed -i.ori <span class="string">'s#Hostname=Zabbix server#Hostname='</span>$(hostname)<span class="string">'#'</span> /etc/zabbix/zabbix_agentd.conf</span><br><span class="line">sed -i.ori <span class="string">'180a HostMetadataItem=system.uname'</span> /etc/zabbix/zabbix_agentd.conf</span><br><span class="line"></span><br><span class="line">service zabbix-agent start</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$vernum</span> == 6 ];<span class="keyword">then</span></span><br><span class="line">        chkconfig --add zabbix-agent</span><br><span class="line">        chkconfig zabbix-agent on</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">        systemctl <span class="built_in">enable</span>  zabbix-agent.service</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure><h4 id="zabbix-server页面配置"><a href="#zabbix-server页面配置" class="headerlink" title="zabbix-server页面配置"></a>zabbix-server页面配置</h4><p>配置—-&gt;动作—–&gt;事件源选择自动注册—-&gt;创建动作</p><p><img src="/articles/276c6656/1.png" alt></p><p>触发条件</p><p><img src="/articles/276c6656/2.png" alt></p><p>我这里因为都是linux服务器，并且服务器hostname都有相同后缀，所以可以设置两个条件共同满足才可以。</p><p><img src="/articles/276c6656/3.png" alt></p><p>选择操作—-&gt;添加操作：添加主机，添加群组、链接到模板</p><p><img src="/articles/276c6656/4.png" alt></p><p>点击添加完成</p><p>等待几分钟 ，新的agent就会自动注册到server上了。可以查看server和agent日志查看</p><p><img src="/articles/276c6656/5.png" alt></p><p><img src="/articles/276c6656/6.png" alt></p><h2 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h2><p>页面操作是主机元数据的值 </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos ~]<span class="comment"># uname</span></span><br><span class="line">Linux</span><br></pre></td></tr></table></figure><p>或者是</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos ~]<span class="comment"># zabbix_get -s 192.168.11.12 -p 10050 -k "system.uname"</span></span><br><span class="line">Linux ltt02.xxx.net 3.10.0-693.el7.x86_64 <span class="comment">#1 SMP Tue Aug 22 21:09:27 UTC 2017 x86_64</span></span><br></pre></td></tr></table></figure><p>获取到的就是agent配置中，把类型赋值给主机元数据，在条件中就可以设定</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HostMetadataItem=system.uname</span><br></pre></td></tr></table></figure><p>同理：hostname也是一样的。</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;目的&quot;&gt;&lt;a href=&quot;#目的&quot; class=&quot;headerlink&quot; title=&quot;目的&quot;&gt;&lt;/a&gt;目的&lt;/h2&gt;&lt;p&gt;对于监控服务器越来越多的情况，如果还单独一个一个添加，那效率也太低，因此就要实现批量添加监控服务器的操作，Zabbix提供两种批量自动监控的方式：&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;自动发现：由服务端主动发起，Zabbix Server开启发现进程，定时扫描局域网中IP服务器、设备。&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;自动注册：由客户端主动发起，客户端必须安装并启动Agentd，否则无法被自动注册添加至主机列表。对于使用SNMP的就要采用自动发现了。&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;本篇教程就是自动注册，让客户端自动向Server去注册。&lt;/p&gt;
    
    </summary>
    
      <category term="应用运维" scheme="https://wandouduoduo.netlify.com/categories/%E5%BA%94%E7%94%A8%E8%BF%90%E7%BB%B4/"/>
    
    
      <category term="Zabbix" scheme="https://wandouduoduo.netlify.com/tags/Zabbix/"/>
    
  </entry>
  
  <entry>
    <title>Zabbix在Ubuntu 14.04上apt-get安装</title>
    <link href="https://wandouduoduo.netlify.com/articles/aeb6452a.html"/>
    <id>https://wandouduoduo.netlify.com/articles/aeb6452a.html</id>
    <published>2019-10-24T14:25:16.000Z</published>
    <updated>2019-10-25T01:53:32.472Z</updated>
    
    <content type="html"><![CDATA[<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>安装Apache、Mysql、Php、zabbix</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update </span><br><span class="line">sudo apt-get install apache2 mysql-server libapache2-mod-php5 php5-gd php5-mysql  php5-common zabbix-server-mysql zabbix-frontend-php</span><br></pre></td></tr></table></figure><a id="more"></a><h2 id="服务端配置"><a href="#服务端配置" class="headerlink" title="服务端配置"></a>服务端配置</h2><h4 id="配置数据库连接"><a href="#配置数据库连接" class="headerlink" title="配置数据库连接"></a>配置数据库连接</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/zabbix/zabbix_server.conf</span><br></pre></td></tr></table></figure><p>修改相关</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">DBName=zabbix</span><br><span class="line">DBUser=zabbix</span><br><span class="line">DBPassword=zabbix</span><br><span class="line">#非必需，但推荐</span><br><span class="line">StartDiscoverers=5</span><br></pre></td></tr></table></figure><h4 id="创建mysql账号"><a href="#创建mysql账号" class="headerlink" title="创建mysql账号"></a>创建mysql账号</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p</span><br><span class="line">mysql&gt; create user &apos;zabbix&apos;@&apos;localhost&apos; identified by &apos;zabbix&apos;;</span><br><span class="line">mysql&gt; create database zabbix default character set utf8;</span><br><span class="line">mysql&gt; grant all privileges on zabbix.* to &apos;zabbix&apos;@&apos;localhost&apos;;</span><br><span class="line">mysql&gt; flush privileges;</span><br><span class="line">mysql&gt; exit;</span><br></pre></td></tr></table></figure><h4 id="导入初始化数据"><a href="#导入初始化数据" class="headerlink" title="导入初始化数据"></a>导入初始化数据</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/share/zabbix-server-mysql/</span><br><span class="line">sudo gunzip *.gz</span><br><span class="line">mysql -u zabbix -p zabbix &lt; schema.sql</span><br><span class="line">mysql -u zabbix -p zabbix &lt; images.sql</span><br><span class="line">mysql -u zabbix -p zabbix &lt; data.sql</span><br></pre></td></tr></table></figure><h4 id="修改-PHP-参数"><a href="#修改-PHP-参数" class="headerlink" title="修改 PHP 参数"></a>修改 PHP 参数</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/php5/apache2/php.ini</span><br></pre></td></tr></table></figure><p>修改项：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">post_max_size = 16M</span><br><span class="line">max_execution_time = 300</span><br><span class="line">max_input_time = 300</span><br><span class="line">date.timezone = &quot;Asia/Shanghai&quot;</span><br></pre></td></tr></table></figure><h4 id="配置网页"><a href="#配置网页" class="headerlink" title="配置网页"></a>配置网页</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo cp /usr/share/doc/zabbix-frontend-php/examples/zabbix.conf.php.example /etc/zabbix/zabbix.conf.php</span><br><span class="line">sudo vim /etc/zabbix/zabbix.conf.php</span><br></pre></td></tr></table></figure><p>修改项</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$DB[&apos;DATABASE&apos;] = &apos;zabbix&apos;;</span><br><span class="line">$DB[&apos;USER&apos;] = &apos;zabbix&apos;;</span><br><span class="line">$DB[&apos;PASSWORD&apos;] = &apos;zabbix&apos;</span><br></pre></td></tr></table></figure><p>配置apache</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo cp /usr/share/doc/zabbix-frontend-php/examples/apache.conf /etc/apache2/conf-available/zabbix.conf</span><br><span class="line">sudo a2enconf zabbix.conf</span><br><span class="line">sudo a2enmod alias</span><br><span class="line">sudo service apache2 restart</span><br></pre></td></tr></table></figure><h4 id="配置-zabbix-server-启动"><a href="#配置-zabbix-server-启动" class="headerlink" title="配置 zabbix server 启动"></a>配置 zabbix server 启动</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/default/zabbix-server</span><br></pre></td></tr></table></figure><p>修改项：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">START=yes</span><br></pre></td></tr></table></figure><p>启动：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo service zabbix-server start</span><br></pre></td></tr></table></figure><h4 id="本机监控"><a href="#本机监控" class="headerlink" title="本机监控"></a>本机监控</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install zabbix-agent</span><br><span class="line">sudo service zabbix-agent restart</span><br></pre></td></tr></table></figure><h4 id="访问"><a href="#访问" class="headerlink" title="访问"></a>访问</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://xxx.xxx.xxx.xxx/zabbix</span><br></pre></td></tr></table></figure><p>缺省的账户：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Username = admin</span><br><span class="line">Password = zabbix</span><br></pre></td></tr></table></figure><h2 id="客户端配置"><a href="#客户端配置" class="headerlink" title="客户端配置"></a>客户端配置</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install zabbix-agent</span><br></pre></td></tr></table></figure><p>修改配置</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/zabbix/zabbix_agentd.conf</span><br></pre></td></tr></table></figure><p>调整项</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Server=127.0.0.1 #修改为 zabbix server 服务器的IP，如果有网关或被监控机为虚拟机也加上母机的IP</span><br><span class="line">ServerActive=127.0.0.1 #修改为 zabbix server 服务器的IP</span><br><span class="line">Hostname=Zabbix server #修改为网页里面添加的Hostname，需要保持一致。</span><br></pre></td></tr></table></figure><h2 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h2><p><strong>中文显示</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install language-pack-zh-hans</span><br></pre></td></tr></table></figure><p><a href="http://www.ttlsa.com/monitor/zabbix/" target="_blank" rel="noopener">zabbix</a>是一个多语言监控系统，默认使用英文并且也支持中文语言，详见《<a href="http://www.ttlsa.com/zabbix/zabbix-convert-into-chinese-8-ttlsa/" target="_blank" rel="noopener">zabbix汉化方法</a>》，但是近期有人反映说zabbix里面看不到中文语言.请往下看</p><p><strong>zabbix不支持中文图</strong></p><p><img src="/articles/aeb6452a/1.png" alt="Linux"></p><p><strong>开启zabbix对中文的支持</strong></p><p>原来zabbix默认把对中文的支持给关闭了，我们需要修改zabbix的<a href="http://www.ttlsa.com/php/" target="_blank" rel="noopener">php</a>源文件. 修改站点根目录下include/locales.inc.php文件.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vim include/locales.inc.php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">getLocales</span></span>() &#123;</span><br><span class="line">        <span class="built_in">return</span> array(</span><br><span class="line">                <span class="string">'en_GB'</span> =&gt; array(<span class="string">'name'</span> =&gt; _(<span class="string">'English (en_GB)'</span>),        <span class="string">'display'</span> =&gt; <span class="literal">true</span>),</span><br><span class="line">                <span class="string">'en_US'</span> =&gt; array(<span class="string">'name'</span> =&gt; _(<span class="string">'English (en_US)'</span>),        <span class="string">'display'</span> =&gt; <span class="literal">true</span>),</span><br><span class="line">                <span class="string">'bg_BG'</span> =&gt; array(<span class="string">'name'</span> =&gt; _(<span class="string">'Bulgarian (bg_BG)'</span>),      <span class="string">'display'</span> =&gt; <span class="literal">true</span>),</span><br><span class="line">                <span class="string">'zh_CN'</span> =&gt; array(<span class="string">'name'</span> =&gt; _(<span class="string">'Chinese (zh_CN)'</span>),        <span class="string">'display'</span> =&gt; <span class="literal">true</span>),</span><br><span class="line">                //原本这里为<span class="literal">false</span>,请改为<span class="literal">true</span></span><br><span class="line">                ...........代码省略掉........</span><br><span class="line">        );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>中文乱码</strong></p><p>1、历史记录处出现 ???? 乱码：</p><p><img src="/articles/aeb6452a/2.png" alt="img"></p><p>出现原因：</p><p>mysql数据库默认字符集为 latin1，而 zabbix 需要使用 utf8，在初始化创建 zabbix 库时没有指定具体的字符集，倒入三张表时会继承 Mysql 的默认字符集，所以此处会出现乱码；</p><p><img src="/articles/aeb6452a/3.png" alt="img"></p><p>解决办法：</p><p>1、将 zabbix 数据库中的表备份；</p><p>2、手动删除 zabbix 数据库；</p><p>3、重新创建 zabbix 库时手动指定字符集为 utf8；</p><p>4、将倒出的 sql 文件中字符集为latin1的表字符集替换为 utf8；</p><p>5、将备份的zabbix库重新倒入即可；</p><p><img src="/articles/aeb6452a/4.png" alt="img"></p><p><img src="/articles/aeb6452a/5.png" alt="img"></p><p><img src="/articles/aeb6452a/6.png" alt="img"></p><p><img src="/articles/aeb6452a/7.png" alt="img"></p><p><img src="/articles/aeb6452a/8.png" alt="img"></p><p><img src="/articles/aeb6452a/9.png" alt="img"></p><p>此时重新访问 zabbix web页面，点击几次菜单，历史记录处一切正常；</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;安装&quot;&gt;&lt;a href=&quot;#安装&quot; class=&quot;headerlink&quot; title=&quot;安装&quot;&gt;&lt;/a&gt;安装&lt;/h2&gt;&lt;p&gt;安装Apache、Mysql、Php、zabbix&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;sudo apt-get update &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sudo apt-get install apache2 mysql-server libapache2-mod-php5 php5-gd php5-mysql  php5-common zabbix-server-mysql zabbix-frontend-php&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="应用运维" scheme="https://wandouduoduo.netlify.com/categories/%E5%BA%94%E7%94%A8%E8%BF%90%E7%BB%B4/"/>
    
    
      <category term="Zabbix" scheme="https://wandouduoduo.netlify.com/tags/Zabbix/"/>
    
  </entry>
  
  <entry>
    <title>git拉取项目下单个目录</title>
    <link href="https://wandouduoduo.netlify.com/articles/25be17f8.html"/>
    <id>https://wandouduoduo.netlify.com/articles/25be17f8.html</id>
    <published>2019-10-24T14:13:58.000Z</published>
    <updated>2019-10-25T01:53:32.481Z</updated>
    
    <content type="html"><![CDATA[<p>有时git库里的东西比较多，我们只希望像SVN一样，只拉取git库的一个目录。</p><p>例如：基础代码仓库infra-code_ops有很多基础代码，我们只想拉取仓库里nginx-conf目录的文件。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ git init infra-code_ops-nginx &amp;&amp; <span class="built_in">cd</span>  infra-code_ops-nginx          //初始化仓库,并进入该目录</span><br><span class="line">$ git remote add -f origin http:``//gitlab.xxx.com/ops/infra-code_ops.git   //添加远程仓库地址</span><br><span class="line">$ git config core.sparsecheckout ``<span class="literal">true</span>    //开启sparse checkout功能</span><br><span class="line">$ <span class="built_in">echo</span> ``<span class="string">"nginx-conf/"</span>` `&gt;&gt; .git/info/sparse-checkout   //将nginx-conf/目录写入到该文件中</span><br><span class="line">$ cat .git/info/sparse-checkout   //确认查看该文件内容</span><br><span class="line">$ git pull origin master    //拉取远程master分支</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;有时git库里的东西比较多，我们只希望像SVN一样，只拉取git库的一个目录。&lt;/p&gt;
&lt;p&gt;例如：基础代码仓库infra-code_ops有很多基础代码，我们只想拉取仓库里nginx-conf目录的文件。&lt;/p&gt;
&lt;figure class=&quot;highlight bash
      
    
    </summary>
    
      <category term="应用运维" scheme="https://wandouduoduo.netlify.com/categories/%E5%BA%94%E7%94%A8%E8%BF%90%E7%BB%B4/"/>
    
    
      <category term="Git" scheme="https://wandouduoduo.netlify.com/tags/Git/"/>
    
  </entry>
  
  <entry>
    <title>Docker知识点</title>
    <link href="https://wandouduoduo.netlify.com/articles/1e48ce52.html"/>
    <id>https://wandouduoduo.netlify.com/articles/1e48ce52.html</id>
    <published>2019-10-24T14:08:06.000Z</published>
    <updated>2019-10-25T01:53:32.471Z</updated>
    
    <content type="html"><![CDATA[<p>cadvisor docker监控</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run —cpu-period=100000 —cpu-quota=100000 -m 1g --volume=/:/rootfs:ro --volume=/var/run:/var/run:rw --volume=/sys:/sys:ro --volume=/var/lib/docker/:/var/lib/docker:ro --publish=9999:8080 --name=cadvisor google/cadvisor -storage_driver=influxdb -storage_driver_db=cadvisor -storage_driver_host=172.18.203.15:8086 -storage_driver_user=cadvisor -storage_driver_password=cadvisor</span><br></pre></td></tr></table></figure><p>启动postgresql容器</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run pgsql -p 0.0.0.0:5432:5432 -e POSTGRES_PASSWORD=jftest123 -v /data/postgres:/var/lib/postgresql/data -d postgres</span><br></pre></td></tr></table></figure><p>启动rocketmq namesrv 容器 </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker run --name rmq-namesrv \</span><br><span class="line">--net=host \</span><br><span class="line">-v $PWD/test/namesrv/logs:/opt/logs \</span><br><span class="line">-v $PWD/test/namesrv/store:/opt/store \</span><br><span class="line">-d registry-nexus.jr.qa.ly.com:10013/rocketmq-namesrv:4.2.0</span><br></pre></td></tr></table></figure><p>启动rocketmq broker 容器</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker run --name rmq-broker \</span><br><span class="line">--net=host \</span><br><span class="line">-v $PWD/test/broker/logs:/opt/logs \</span><br><span class="line">-v $PWD/test/broker/store:/opt/store \</span><br><span class="line">-v $PWD/test/broker/conf:/opt/conf \</span><br><span class="line">-d registry-nexus.jr.qa.ly.com:10013/rocketmq-broker:4.2.0 sh /opt/rocketmq-4.2.0/bin/mqbroker -c /opt/conf/broker.properties</span><br></pre></td></tr></table></figure><p>过滤ip</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep -E -o &quot;172.18.[0-9]&#123;1,3&#125;[\.][0-9]&#123;1,3&#125;&quot; filename</span><br></pre></td></tr></table></figure><p>linux删除乱码</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find . ! -regex &apos;.*\.jar\|.*\.war\|.*\.zip&apos;|xargs rm</span><br></pre></td></tr></table></figure><p>ansible命令</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ansible rabbitmq -m shell -a &quot;cp /etc/haproxy/haproxy.cfg /etc/haproxy/haproxy.20180315&quot;</span><br><span class="line">ansible rabbitmq -m shell -a &quot;mv /etc/haproxy/template.cfg.bak /etc/haproxy/haproxy.bak&quot;</span><br><span class="line">ansible rabbitmq -m shell -a &quot;mv /etc/haproxy/template.cfg /etc/haproxy/haproxy.cfg&quot;</span><br><span class="line">ansibel rabbitmq -m shell -a &quot;/etc/init.d/haproxy restart&quot;</span><br></pre></td></tr></table></figure><p>inluxdb保留策略</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SHOW RETENTION POLICIES ON cadvisor</span><br><span class="line">CREATE RETENTION POLICY &quot;15_days&quot; ON &quot;cadvisor&quot; DURATION 15d REPLICATION 1 DEFAULT</span><br><span class="line">drop retention POLICY &quot;15_days&quot; ON &quot;cadvisor&quot;</span><br></pre></td></tr></table></figure><p>elasticsearch</p><p>标准配置</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">cluster.name: sunelk</span><br><span class="line">node.name: node-195</span><br><span class="line">path.data: /home/es/elasticsearch/data/</span><br><span class="line">path.logs: /home/es/elasticsearch/logs/</span><br><span class="line"></span><br><span class="line">bootstrap.memory_lock: false</span><br><span class="line">bootstrap.system_call_filter: false</span><br><span class="line"></span><br><span class="line">node.master: true   </span><br><span class="line">node.data: false   </span><br><span class="line">node.ingest: false   </span><br><span class="line">search.remote.connect: false </span><br><span class="line"></span><br><span class="line">network.host: 0.0.0.0  </span><br><span class="line"></span><br><span class="line">http.port: 9200</span><br><span class="line"></span><br><span class="line">discovery.zen.ping.unicast.hosts: [&quot;10.10.0.193&quot;, &quot;10.10.0.194&quot;,&quot;10.10.0.195&quot;]     </span><br><span class="line">                                                                        </span><br><span class="line">discovery.zen.minimum_master_nodes: 2 </span><br><span class="line">      </span><br><span class="line">http.cors.enabled: true                                                                                                                                                                                                   </span><br><span class="line">http.cors.allow-origin: &quot;*&quot;</span><br></pre></td></tr></table></figure><p>验证</p><p><a href="http://10.10.0.195:9200/_cat/nodes?v" target="_blank" rel="noopener">http://10.10.0.195:9200/_cat/nodes?v</a></p><p><a href="http://10.10.0.195:9200/_cluster/health" target="_blank" rel="noopener">http://10.10.0.195:9200/_cluster/health</a></p><p>集群健康状况</p><p>curl ‘192.168.77.128:9200/_cluster/health?pretty’</p><p>集群详细情况</p><p>curl ‘192.168.77.128:9200/_cluster/state?pretty’</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;cadvisor docker监控&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td cl
      
    
    </summary>
    
      <category term="应用运维" scheme="https://wandouduoduo.netlify.com/categories/%E5%BA%94%E7%94%A8%E8%BF%90%E7%BB%B4/"/>
    
    
      <category term="Docker" scheme="https://wandouduoduo.netlify.com/tags/Docker/"/>
    
  </entry>
  
  <entry>
    <title>centos7 yum安装zabbix4.0长期稳定版及优化</title>
    <link href="https://wandouduoduo.netlify.com/articles/4140dae2.html"/>
    <id>https://wandouduoduo.netlify.com/articles/4140dae2.html</id>
    <published>2019-10-24T04:33:35.000Z</published>
    <updated>2019-10-24T08:40:37.384Z</updated>
    
    <content type="html"><![CDATA[<h2 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h2><p>zabbix监控系统是目前企业常用的监控系统之一。具有快速上手，监控简单明了等特点。通过本文教程快速安装zabbix4.0 LST监控系统，为企业搭建监控系统，保驾护航。</p><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><p>centos7.x</p><p>zabbix4.0.x  LST</p><h2 id="参考文档和下载地址"><a href="#参考文档和下载地址" class="headerlink" title="参考文档和下载地址"></a>参考文档和下载地址</h2><p><a href="https://www.zabbix.com/documentation/4.0/zh/manual" target="_blank" rel="noopener">官方文档</a></p><p><a href="http://repo.zabbix.com/zabbix/4.0/rhel/7/x86_64/" target="_blank" rel="noopener">下载地址</a></p><a id="more"></a><h2 id="环境确认"><a href="#环境确认" class="headerlink" title="环境确认"></a>环境确认</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/redhat-release <span class="comment">#  查看CentOS版本 </span></span><br><span class="line">cat /proc/version         <span class="comment">#查看存放与内核相关的文件</span></span><br></pre></td></tr></table></figure><p><img src="/articles/4140dae2/1.png" alt></p><h2 id="搭建之前的操作"><a href="#搭建之前的操作" class="headerlink" title="搭建之前的操作"></a><strong>搭建之前的操作</strong></h2><h4 id="升级系统组件到最新的版本"><a href="#升级系统组件到最新的版本" class="headerlink" title="升级系统组件到最新的版本"></a><strong>升级系统组件到最新的版本</strong></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y update</span><br></pre></td></tr></table></figure><p><img src="/articles/4140dae2/2.png" alt></p><h4 id="关闭selinux"><a href="#关闭selinux" class="headerlink" title="关闭selinux"></a><strong>关闭selinux</strong></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/selinux/config    <span class="comment">#将SELINUX=enforcing改为SELINUX=disabled 设置后需要重启才能生效</span></span><br></pre></td></tr></table></figure><p><img src="/articles/4140dae2/3.png" alt></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">setenforce 0       <span class="comment">#临时关闭命令</span></span><br><span class="line">getenforce         <span class="comment">#检测selinux是否关闭，Disabled 为关闭</span></span><br></pre></td></tr></table></figure><p><img src="/articles/4140dae2/4.png" alt></p><h4 id="关闭防火墙"><a href="#关闭防火墙" class="headerlink" title="关闭防火墙"></a><strong>关闭防火墙</strong></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --state    <span class="comment">#查看默认防火墙状态，关闭后显示not running，开启后显示running</span></span><br></pre></td></tr></table></figure><p><img src="/articles/4140dae2/5.png" alt></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld.service    <span class="comment">#临时关闭firewall</span></span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld.service <span class="comment">#禁止firewall开机启动</span></span><br></pre></td></tr></table></figure><p><img src="/articles/4140dae2/6.png" alt></p><h2 id="搭建LAMP环境"><a href="#搭建LAMP环境" class="headerlink" title="搭建LAMP环境"></a><strong>搭建LAMP环境</strong></h2><h4 id="安装所需所有软体仓库"><a href="#安装所需所有软体仓库" class="headerlink" title="安装所需所有软体仓库"></a><strong>安装所需所有软体仓库</strong></h4><p>Zabbix是建立在LAMP或者LNMP环境之上，在此为了方便就使用yum安装LAMP环境.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install -y httpd mariadb-server mariadb php php-mysql php-gd libjpeg* php-ldap php-odbc php-pear php-xml php-xmlrpc php-mhash</span><br><span class="line"></span><br><span class="line">rpm -qa httpd php mariadb            <span class="comment">#安装完成后检查应用版本</span></span><br></pre></td></tr></table></figure><p><img src="/articles/4140dae2/7.png" alt></p><p><img src="/articles/4140dae2/centos7-yum%E5%AE%89%E8%A3%85zabbix4-0%E9%95%BF%E6%9C%9F%E7%A8%B3%E5%AE%9A%E7%89%88%E5%8F%8A%E4%BC%98%E5%8C%96%5C8.png" alt></p><h4 id="编辑httpd"><a href="#编辑httpd" class="headerlink" title="编辑httpd"></a><strong>编辑httpd</strong></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/httpd/conf/httpd.conf</span><br><span class="line"></span><br><span class="line">ServerName www.zabbixyk.com      <span class="comment">#修改为主机名</span></span><br><span class="line">DirectoryIndex index.html index.php   <span class="comment"># 添加首页支持格式</span></span><br></pre></td></tr></table></figure><p><img src="/articles/4140dae2/9.png" alt></p><h4 id="编辑配置php，配置中国时区"><a href="#编辑配置php，配置中国时区" class="headerlink" title="编辑配置php，配置中国时区"></a><strong>编辑配置php，配置中国时区</strong></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/php.ini</span><br><span class="line"></span><br><span class="line">date.timezone = Asia/Shanghai   <span class="comment"># 配置时区</span></span><br></pre></td></tr></table></figure><p><img src="/articles/4140dae2/10.png" alt></p><h4 id="启动httpd和mysqld服务"><a href="#启动httpd和mysqld服务" class="headerlink" title="启动httpd和mysqld服务"></a><strong>启动httpd和mysqld服务</strong></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">systemctl start httpd   <span class="comment">#启动并加入开机自启动httpd</span></span><br><span class="line">systemctl <span class="built_in">enable</span> httpd</span><br><span class="line">systemctl start mariadb  <span class="comment">#启动并加入开机自启动mysqld</span></span><br><span class="line">systemctl <span class="built_in">enable</span> mariadb</span><br><span class="line"></span><br><span class="line">ss -anplt | grep httpd   <span class="comment">#查看httpd启动情况，80端口监控表示httpd已启动</span></span><br><span class="line">ss -naplt | grep mysqld  <span class="comment">#查看mysqld启动情况，3306端口监控表示mysqld已启动</span></span><br></pre></td></tr></table></figure><p><img src="/articles/4140dae2/11.png" alt></p><p><img src="/articles/4140dae2/12.png" alt></p><p><img src="/articles/4140dae2/13.png" alt></p><h4 id="创建一个测试页"><a href="#创建一个测试页" class="headerlink" title="创建一个测试页"></a><strong>创建一个测试页</strong></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vi /var/www/html/index.php <span class="comment">#创建一个测试页，并编辑</span></span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">phpinfo()</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p><img src="/articles/4140dae2/14.png" alt></p><p><img src="/articles/4140dae2/15.png" alt></p><h4 id="本地测试"><a href="#本地测试" class="headerlink" title="本地测试"></a>本地测试</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://127.0.0.1 -I         <span class="comment">#本地测试</span></span><br></pre></td></tr></table></figure><p><img src="/articles/4140dae2/16.png" alt></p><h4 id="配置mysql和权限"><a href="#配置mysql和权限" class="headerlink" title="配置mysql和权限"></a><strong>配置mysql和权限</strong></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqladmin -u root password ykadmin123           <span class="comment">#设置数据库root密码</span></span><br></pre></td></tr></table></figure><p><img src="/articles/4140dae2/17.png" alt></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p        <span class="comment">#root用户登陆数据库</span></span><br><span class="line">CREATE DATABASE zabbix character <span class="built_in">set</span> utf8 collate utf8_bin;       <span class="comment">#创建zabbix数据库（中文编码格式）</span></span><br><span class="line">GRANT all ON zabbix.* TO <span class="string">'zabbix'</span>@<span class="string">'%'</span> IDENTIFIED BY <span class="string">'ykadmin123'</span>;  <span class="comment">#授予zabbix用户zabbix数据库的所有权限，密码ykadmin123</span></span><br><span class="line">flush privileges;    <span class="comment">#刷新权限</span></span><br><span class="line">quit                 <span class="comment">#退出数据库</span></span><br></pre></td></tr></table></figure><p><img src="/articles/4140dae2/18.png" alt></p><p>为保证zabbix用户也可以登录数据库，若出现本地无法登录情况，解决方式如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p  <span class="comment">#使用root账户登录数据库；</span></span><br><span class="line">select user,host from mysql.user;   <span class="comment">#有空用户名称占用导致本地无法登录远程可登录</span></span><br><span class="line">drop user <span class="string">''</span>@localhost;  <span class="comment">#删除空用户</span></span><br></pre></td></tr></table></figure><p><img src="/articles/4140dae2/19.png" alt></p><h2 id="安装zabbix"><a href="#安装zabbix" class="headerlink" title="安装zabbix"></a>安装zabbix</h2><h4 id="安装依赖包-组件"><a href="#安装依赖包-组件" class="headerlink" title="安装依赖包 + 组件"></a><strong>安装依赖包 + 组件</strong></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install net-snmp net-snmp-devel curl curl-devel libxml2 libxml2-devel libevent-devel.x86_64 javacc.noarch  javacc-javadoc.noarch javacc-maven-plugin.noarch javacc*</span><br></pre></td></tr></table></figure><p><img src="/articles/4140dae2/20.png" alt></p><h4 id="安装zabbix-server，并初始化库"><a href="#安装zabbix-server，并初始化库" class="headerlink" title="安装zabbix-server，并初始化库"></a>安装zabbix-server，并初始化库</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">yum install php-bcmath php-mbstring -y <span class="comment">#安装php支持zabbix组件</span></span><br><span class="line"> </span><br><span class="line">rpm -ivh http://repo.zabbix.com/zabbix/4.0/rhel/7/x86_64/zabbix-release-4.0-1.el7.noarch.rpm  <span class="comment">#会自动生成yum源文件，保证系统可以上网</span></span><br><span class="line"> </span><br><span class="line">yum install zabbix-server-mysql zabbix-web-mysql -y    <span class="comment">#安装zabbix组件</span></span><br><span class="line"> </span><br><span class="line">zcat /usr/share/doc/zabbix-server-mysql-4.0.0/create.sql.gz | mysql -uzabbix -p -h 172.18.20.224 zabbix   <span class="comment">#导入数据到数据库zabbix中(最后一个zabbix是数据库zabbix)，且因为用户zabbix是%(任意主机)，所以登录时需要加上当前主机ip(-h 172.18.20.224),密码是用户zabbix登陆密码ykadmin123</span></span><br></pre></td></tr></table></figure><p><img src="/articles/4140dae2/21.png" alt></p><p><img src="/articles/4140dae2/22.png" alt></p><p><img src="/articles/4140dae2/23.png" alt></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vi  /etc/zabbix/zabbix_server.conf   <span class="comment">#配置数据库用户及密码</span></span><br><span class="line">grep -n <span class="string">'^'</span>[a-Z] /etc/zabbix/zabbix_server.conf   <span class="comment">#确认数据库用户及密码</span></span><br></pre></td></tr></table></figure><p><img src="/articles/4140dae2/24.png" alt></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/httpd/conf.d/zabbix.conf     //修改时区</span><br><span class="line"></span><br><span class="line">将<span class="comment"># php_value date.timezone Europe/Riga 变更成php_value date.timezone Asia/Shanghai</span></span><br><span class="line"></span><br><span class="line">systemctl <span class="built_in">enable</span> zabbix-server <span class="comment"># #启动并加入开机自启动zabbix-server</span></span><br><span class="line">systemctl start zabbix-server</span><br></pre></td></tr></table></figure><p><img src="/articles/4140dae2/25.png" alt></p><p><img src="/articles/4140dae2/26.png" alt></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -anpt | grep zabbix      //监听在10051端口上,如果没监听成功，可重启zabbix-server服务试试</span><br></pre></td></tr></table></figure><p><img src="/articles/4140dae2/27.png" alt></p><p>建议重启服务器，再继续。</p><h4 id="web界面安装zabbix"><a href="#web界面安装zabbix" class="headerlink" title="web界面安装zabbix"></a><strong>web界面安装zabbix</strong></h4><p>如果以上步骤无误，现在可以使用web打开  </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://172.18.20.224/zabbix　　//注意这里IE浏览器打不开，本次测试使用chrome浏览器</span><br></pre></td></tr></table></figure><p><img src="/articles/4140dae2/28.png" alt></p><p><img src="/articles/4140dae2/29.png" alt></p><p><img src="/articles/4140dae2/30.png" alt></p><p><img src="/articles/4140dae2/31.png" alt></p><p><img src="/articles/4140dae2/32.png" alt></p><p><img src="/articles/4140dae2/33.png" alt></p><p><img src="/articles/4140dae2/34.png" alt></p><p><img src="/articles/4140dae2/35.png" alt></p><h2 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h2><h4 id="安装graphtree"><a href="#安装graphtree" class="headerlink" title="安装graphtree"></a>安装graphtree</h4><p>graphtree的功能</p><blockquote><p>1)集中展示所有分组设备 </p><p>2)集中展示一个分组图像 </p><p>3)集中展示一个设备图像 </p><p>4)展示设备下的Application </p><p>5)展示每个Application下的图像</p><p> 6)展示每个Application下的日志 </p><p>7)对原生无图的监控项进行绘图 (注意问题:在组和主机级别，默认只显示<a href="https://www.2cto.com/os/" target="_blank" rel="noopener">系统</a>配置的graph)</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/share/zabbix</span><br><span class="line">wget https://raw.githubusercontent.com/OneOaaS/graphtrees/master/graphtree3.2.x.patch</span><br><span class="line">yum install -y patch</span><br><span class="line">patch -Np0 &lt; graphtree3.2.x.patch</span><br></pre></td></tr></table></figure><p><img src="/articles/4140dae2/36.png" alt></p><p><strong># 注意此处的权限，必须和nginx或者apache的用户一致，我用的是apache，则此处为chown -R apache:apache oneoaas</strong></p><p>graphtree的删除广告部分修改配置 进入graphtree配置文件，进行相关修改</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim oneoaas/templates/graphtree/graphtree.tpl</span><br></pre></td></tr></table></figure><p><img src="/articles/4140dae2/37.png" alt></p><p>修改logo</p><p><img src="/articles/4140dae2/38.png" alt></p><p><img src="/articles/4140dae2/39.png" alt></p><p>重启httpd服务然后查看效果</p><p><img src="/articles/4140dae2/40.png" alt></p><p><img src="/articles/4140dae2/41.png" alt></p><h4 id="中文乱码"><a href="#中文乱码" class="headerlink" title="中文乱码"></a>中文乱码</h4><p><img src="/articles/4140dae2/42.png" alt></p><h6 id="复制字体"><a href="#复制字体" class="headerlink" title="复制字体"></a>复制字体</h6><p>复制本地电脑C:\Windows\Fonts\simkai.ttf（楷体）上传到zabbix服务器网站目录的fonts目录下</p><p><img src="/articles/4140dae2/43.png" alt></p><p>yum或rpm安装的zabbix-server字体目录为：/usr/share/zabbix/assets/fonts</p><p><img src="/articles/4140dae2/44.png" alt></p><p>graphfont.ttf是zabbix默认字符集，simkai.ttf是从windows复制过来的字体文件，权限最好给777，要不会影响到zabbix图形显示异常。</p><h6 id="字体替换"><a href="#字体替换" class="headerlink" title="字体替换"></a>字体替换</h6><p>方法一：</p><p>修改此/usr/share/zabbix/include/defines.inc.php文件中字体的配置，将里面关于字体设置从graphfont都替换成simkai，注意:realpath的字体设置路径</p><p><img src="/articles/4140dae2/47.png" alt></p><p>方法二：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span>  /etc/alternatives/</span><br><span class="line">mv zabbix-web-font zabbix-web-font.bak   <span class="comment">#备份</span></span><br><span class="line">ln -sf /usr/share/zabbix/assets/fonts/simkai.ttf zabbix-web-font  <span class="comment">#新链接</span></span><br></pre></td></tr></table></figure><p><img src="/articles/4140dae2/45.png" alt></p><p>到页面刷新就可看到，如果没有更改，请重启zabbix-server</p><p><img src="/articles/4140dae2/46.png" alt></p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;目的&quot;&gt;&lt;a href=&quot;#目的&quot; class=&quot;headerlink&quot; title=&quot;目的&quot;&gt;&lt;/a&gt;目的&lt;/h2&gt;&lt;p&gt;zabbix监控系统是目前企业常用的监控系统之一。具有快速上手，监控简单明了等特点。通过本文教程快速安装zabbix4.0 LST监控系统，为企业搭建监控系统，保驾护航。&lt;/p&gt;
&lt;h2 id=&quot;环境&quot;&gt;&lt;a href=&quot;#环境&quot; class=&quot;headerlink&quot; title=&quot;环境&quot;&gt;&lt;/a&gt;环境&lt;/h2&gt;&lt;p&gt;centos7.x&lt;/p&gt;
&lt;p&gt;zabbix4.0.x  LST&lt;/p&gt;
&lt;h2 id=&quot;参考文档和下载地址&quot;&gt;&lt;a href=&quot;#参考文档和下载地址&quot; class=&quot;headerlink&quot; title=&quot;参考文档和下载地址&quot;&gt;&lt;/a&gt;参考文档和下载地址&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;https://www.zabbix.com/documentation/4.0/zh/manual&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;官方文档&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;http://repo.zabbix.com/zabbix/4.0/rhel/7/x86_64/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;下载地址&lt;/a&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="监控运维" scheme="https://wandouduoduo.netlify.com/categories/%E7%9B%91%E6%8E%A7%E8%BF%90%E7%BB%B4/"/>
    
    
      <category term="Zabbix" scheme="https://wandouduoduo.netlify.com/tags/Zabbix/"/>
    
  </entry>
  
  <entry>
    <title>jira低版本(7.4.1)发现漏洞升级到最新版本(8.4.1)</title>
    <link href="https://wandouduoduo.netlify.com/articles/ecacdd4f.html"/>
    <id>https://wandouduoduo.netlify.com/articles/ecacdd4f.html</id>
    <published>2019-09-27T03:55:30.000Z</published>
    <updated>2019-09-27T05:42:13.332Z</updated>
    
    <content type="html"><![CDATA[<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>早上到公司就接到总部信息安全组邮件。邮件内容是：Atlassian公开了一个Jira未授权SSRF漏洞。Jira的/plugins/servlet/gadgets/makeRequest资源存在SSRF漏洞，原因在于JiraWhitelist这个类的逻辑缺陷，成功利用此漏洞的远程攻击者可以以Jira服务端的身份访问内网资源。此漏洞无需任何凭据即可触发。</p><p><strong>影响范围</strong></p><p>版本小于8.4.0</p><p>漏洞详情链接： <a href="https://jira.atlassian.com/browse/JRASERVER-69793" target="_blank" rel="noopener">https://jira.atlassian.com/browse/JRASERVER-69793</a></p><p>基于以上情况，把在线上的jira 7.4.1版本升级为最新版本8.4.1，因为官方在8.4.0已经修复这个漏洞。</p><a id="more"></a><h2 id="程序目录"><a href="#程序目录" class="headerlink" title="程序目录"></a>程序目录</h2><ul><li>JIRA7.4.1安装目录(以下简称<strong>原目录</strong>): /opt/atlassian/jira-7.4.1-bak</li><li>JIRA7.4.1 HOME目录(以下简称<strong>原HOME</strong>): /var/atlassian/application-data/jira-7.4.1-bak</li><li>JIRA8.4.1安装目录(以下简称<strong>新目录</strong>): /opt/atlassian/jira</li><li>JIRA8.4.1 HOME目录(以下简称<strong>新HOME</strong>): /var/atlassian/application-data/jira</li></ul><h2 id="升级步骤"><a href="#升级步骤" class="headerlink" title="升级步骤"></a>升级步骤</h2><ul><li>注：本次升级是在同一服务器升级</li><li>JIRA7.4.1数据备份</li><li>JIRA8.4.1安装</li><li>备份数据导入JIRA8.4.1</li><li>后续</li></ul><h2 id="停止原JIRA服务"><a href="#停止原JIRA服务" class="headerlink" title="停止原JIRA服务"></a>停止原JIRA服务</h2><p>停止服务可以保证后续备份的干净。所以建议升级前先把服务停止。</p><ul><li><p>在<strong>原目录</strong>的bin文件夹下</p></li><li><p>执行 ./stop-jira.sh 停止JIRA服务</p></li></ul><h2 id="备份"><a href="#备份" class="headerlink" title="备份"></a>备份</h2><h3 id="备份数据库内容"><a href="#备份数据库内容" class="headerlink" title="备份数据库内容"></a>备份数据库内容</h3><p>有两种方法备份数据库内容：<strong>本地数据库备份工具或JIRA的XML备份工具</strong></p><ul><li><strong>本地数据库备份工具</strong><ul><li>调用诸如mysqldump或pg_dump之类的命令行工具</li></ul></li><li><strong>JIRA的XML备份工具</strong><ul><li>选择系统–&gt;导入和导出–&gt;备份系统，在’文件名’字段中，输入备份文件的名称。</li><li>点击’备份’按钮，JIRA会将您的XML备份保存为压缩的归档文件。备份完成后，将显示一条信息，确认JIRA已将其数据写入指定的文件。</li><li>备份将存储在JIRA应用程序主目录的export(<strong>HOME目录</strong> 下的export)子目录中</li></ul></li></ul><h3 id="备份data目录"><a href="#备份data目录" class="headerlink" title="备份data目录"></a>备份data目录</h3><p>该目录包含JIRA实例的应用数据，例如，问题附件存储在目录中。在Linux上，可以编写一个小的shell脚本，将其放到/etc/cron.daily一个目录中备份 /var/backup/jira。如果你将attachments目录放在自定义位置而不是data目录中，则需要attachments单独备份目录</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp -rf /var/atlassian/application-data/jira  /var/atlassian/application-data/jira-7.4.1-bak</span><br></pre></td></tr></table></figure><h3 id="程序目录备份"><a href="#程序目录备份" class="headerlink" title="程序目录备份"></a>程序目录备份</h3><p>将<strong>安装目录</strong>和<strong>HOME目录</strong>也进行备份</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp -rf /opt/atlassian/jira  /opt/atlassian//jira-7.4.1-bak</span><br></pre></td></tr></table></figure><h2 id="Jira新版本-8-4-1-安装"><a href="#Jira新版本-8-4-1-安装" class="headerlink" title="Jira新版本(8.4.1)安装"></a>Jira新版本(8.4.1)安装</h2><h3 id="下载程序"><a href="#下载程序" class="headerlink" title="下载程序"></a>下载程序</h3><p><a href="https://www.atlassian.com/software/jira/download" target="_blank" rel="noopener">官网下载地址</a></p><h3 id="安装程序"><a href="#安装程序" class="headerlink" title="安装程序"></a>安装程序</h3><h5 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h5><ul><li><p>安装JDK(JIRA8.4.1需要JVM1.8及以上环境)</p></li><li><p>由于本次为升级，因此默认以上环境已经安装</p></li><li><p>将下载的atlassian-jira-software-8.4.1.tar.gz压缩包解压到安装目录中(参考<strong>新目录</strong>)</p></li><li><p>解压后修改安装包名称为jira，即为<strong>新目录</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#下载</span></span><br><span class="line">wget https://product-downloads.atlassian.com/software/jira/downloads/atlassian-jira-software-8.4.1.tar.gz</span><br><span class="line"><span class="comment">#解压</span></span><br><span class="line">tar -xzvf  atlassian-jira-software-8.4.1.tar.gz -C /opt/atlassian/</span><br><span class="line">mv /opt/atlassian/mv atlassian-jira-software-8.4.1-standalone /opt/atlassian/jira</span><br></pre></td></tr></table></figure></li></ul><h5 id="修改配置"><a href="#修改配置" class="headerlink" title="修改配置"></a>修改配置</h5><p>配置文件列表</p><p><a href="https://confluence.atlassian.com/adminjiraserver/important-directories-and-files-938847744.html" target="_blank" rel="noopener">Jira中重要文件</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">server.xml</span><br><span class="line">dbconfig.xml</span><br><span class="line">jira-config.properties</span><br><span class="line">setenv.sh /  setenv.bat （内存分配和其他JVM参数）有关更多信息，请参阅  Jira中的重要文件链接</span><br></pre></td></tr></table></figure><ul><li><p>JAVA配置有两个办法：直接复制原目录的jre目录至新目录或者直接配置本机java环境</p><p>将<strong>原目录</strong>下的jre文件夹复制到<strong>新目录</strong>下</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp -r /opt/atlassian/jira-7.4.1/jre /opt/atlassian/jira</span><br></pre></td></tr></table></figure><ul><li>修改<strong>新目录</strong>bin文件夹下的setenv.sh,在 <strong>#!INSTALLER SET JAVA_HOME</strong> 下一行加入</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 复制目录配置</span></span><br><span class="line">JAVA_HOME=<span class="string">"/opt/atlassian/jira/jre/"</span>; <span class="built_in">export</span> JAVA_HOME</span><br><span class="line"><span class="comment"># 配置本机配置</span></span><br><span class="line">JAVA_HOME=<span class="string">"/usr/java/jdk1.8.0_202/jre/"</span>; <span class="built_in">export</span> JAVA_HOME</span><br></pre></td></tr></table></figure><ul><li>设置Jira HOME，编辑文件，设置Jira HOME目录<ul><li>查找jira-application.properties文件，设置jira.home</li></ul></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#查找配置文件</span><br><span class="line">find . -name jira-application.properties </span><br><span class="line">#编辑</span><br><span class="line">vim /opt/atlassian/jira/atlassian-jira/WEB-INF/classes/jira-application.properties</span><br><span class="line"></span><br><span class="line">jira.home = /var/atlassian/application-data/jira</span><br><span class="line">#创建Jira home目录</span><br><span class="line">mkdir -p /var/atlassian/application-data/jira</span><br></pre></td></tr></table></figure><h5 id="旧配置复制"><a href="#旧配置复制" class="headerlink" title="旧配置复制"></a>旧配置复制</h5><ul><li><p>把破解包里面的atlassian-extras-3.2.jar和mysql-connector-java-5.1.39-bin.jar两个文件复制到/opt/atlassian/jira/atlassian-jira/WEB-INF/lib/目录下。</p><p>其中atlassian-extras-3..2.jar是用来替换原来的atlassian-extras-3.2.jar文件，用作破解jira系统的。</p><p>而mysql-connector-java-5.1.39-bin.jar是用来连接mysql数据库的驱动软件包。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp /opt/atlassian/jira-7.4.1-bak/atlassian-jira/WEB-INF/lib/mysql-connector-java-5.1.39-bin.jar /opt/atlassian/jira/atlassian-jira/WEB-INF/lib/</span><br><span class="line">cp /opt/atlassian/jira-7.4.1-bak/atlassian-jira/WEB-INF/lib/atlassian-extras-3.2.jar /opt/atlassian/jira/atlassian-jira/WEB-INF/lib/</span><br></pre></td></tr></table></figure></li><li><p>数据库配置文件复制，因为安装数据库需要为空库，配置时需要创建配置文件。本教程为升级，所以直接复制原配置即可</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp /var/atlassian/application-data/jira-7.4.1-bak/dbconfig.xml /var/atlassian/application-data/jira/dbconfig.xml</span><br></pre></td></tr></table></figure></li></ul><h5 id="禁用自动重新索引"><a href="#禁用自动重新索引" class="headerlink" title="禁用自动重新索引"></a>禁用自动重新索引</h5><p>官方文档中指出：建议从平台升级（即从7.x升级到8.x）进行此步骤。</p><p>由于我们在Jira 8.0中引入了对索引的更改，因此您的旧索引与新版本不兼容。要创建一个新文件，Jira将在您启动它后立即触发自动重新索引。为避免两次重新编制索引（在启动后和升级应用程序之后），您可以禁用自动重新编制索引，并在准备就绪后再运行第二次重新编制索引。</p><p>编辑或创建以下文件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">touch /var/atlassian/application-data/jira/jira-config.properties</span><br></pre></td></tr></table></figure><p>添加以下行，并保存文件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">upgrade.reindex.allowed=<span class="literal">false</span></span><br></pre></td></tr></table></figure><ul><li><p>完成基础配置后，就可以启动Jira服务了(在<strong>新目录</strong>的bin文件夹下，执行./start-jira.sh)</p></li><li><p>浏览器访问</p></li><li><p>重置索引：点击设置-系统-高级-重新索引，<strong>重新索引操作</strong> 选择 <strong>后台重新索引</strong>，点击<strong>重新索引</strong></p></li></ul><h2 id="数据恢复"><a href="#数据恢复" class="headerlink" title="数据恢复"></a>数据恢复</h2><ul><li>将备份的.zip文件放入<strong>新HOME</strong>的import文件夹下，管理员账号访问浏览器，点击系统-恢复，选择文件后等待系统完成恢复。恢复完成后将重新登录JIRA，账号密码为原JIRA管理员信息</li><li>将备份的data文件下的数据放入<strong>新HOME</strong>的data文件夹下</li></ul><h2 id="后续"><a href="#后续" class="headerlink" title="后续"></a>后续</h2><h4 id="（可选）更新Jira服务台"><a href="#（可选）更新Jira服务台" class="headerlink" title="（可选）更新Jira服务台"></a>（可选）更新Jira服务台</h4><p>如果您使用的是Jira Service Desk，则可以直接在UI中进行更新，而无需下载单独的安装程序。</p><ol><li>转到  <strong>&gt;应用程序&gt;版本和许可证</strong>。</li><li>更新Jira服务台。这将自动将Service Desk更新到兼容版本。</li></ol><p>### </p><h4 id="升级应用程序（附加组件）"><a href="#升级应用程序（附加组件）" class="headerlink" title="升级应用程序（附加组件）"></a>升级应用程序（附加组件）</h4><p>现在，您可以升级同时具有<strong>兼容</strong>  状态的应用程序  。如果您一般需要有关状态和应用程序的更多信息，请参阅“  <a href="https://confluence.atlassian.com/adminjiraserver/preparing-for-the-upgrade-966063325.html" target="_blank" rel="noopener">准备升级”</a>。</p><ol><li>转到  <strong>&gt;管理应用&gt;管理应用</strong>。</li><li>将您的应用升级到支持的版本。</li><li>应用程序升级后，即可启用它们。</li></ol><p>### </p><h4 id="重建索引"><a href="#重建索引" class="headerlink" title="重建索引"></a>重建索引</h4><p>由于您的旧索引不兼容，因此请重新索引Jira以重建它。此步骤可能需要一些时间，具体取决于您遇到的问题和应用程序的数量。</p><ol><li>转到  <strong>&gt;索引编制</strong>，然后运行  <strong>Lock Jira并重建reindex</strong>。</li></ol><h2 id="做得好！"><a href="#做得好！" class="headerlink" title="做得好！"></a>做得好！</h2><p>您已将Jira升级到新版本。</p><h4 id="升级后登录页面"><a href="#升级后登录页面" class="headerlink" title="升级后登录页面"></a>升级后登录页面</h4><p>成功升级后，您应该会看到升级后的登录页面。它具有有关新版本的一些有用信息，如下所示。</p><p><img src="/articles/ecacdd4f/pulpscreen.png" alt></p><ol><li><strong>需要知道：</strong>  可能会影响您作为管理员工作的新功能列表。</li><li><strong>用户应用程序：</strong>升级后<strong>应用程序的</strong> 状态。</li><li><strong>应用程序链接：</strong>  您的应用程序链接的状态。</li><li><strong>发行说明：</strong>  链接到发行说明，您可以在其中查看有关已升级到的版本的更多详细信息</li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;背景&quot;&gt;&lt;a href=&quot;#背景&quot; class=&quot;headerlink&quot; title=&quot;背景&quot;&gt;&lt;/a&gt;背景&lt;/h2&gt;&lt;p&gt;早上到公司就接到总部信息安全组邮件。邮件内容是：Atlassian公开了一个Jira未授权SSRF漏洞。Jira的/plugins/servlet/gadgets/makeRequest资源存在SSRF漏洞，原因在于JiraWhitelist这个类的逻辑缺陷，成功利用此漏洞的远程攻击者可以以Jira服务端的身份访问内网资源。此漏洞无需任何凭据即可触发。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;影响范围&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;版本小于8.4.0&lt;/p&gt;
&lt;p&gt;漏洞详情链接： &lt;a href=&quot;https://jira.atlassian.com/browse/JRASERVER-69793&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://jira.atlassian.com/browse/JRASERVER-69793&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;基于以上情况，把在线上的jira 7.4.1版本升级为最新版本8.4.1，因为官方在8.4.0已经修复这个漏洞。&lt;/p&gt;
    
    </summary>
    
      <category term="应用运维" scheme="https://wandouduoduo.netlify.com/categories/%E5%BA%94%E7%94%A8%E8%BF%90%E7%BB%B4/"/>
    
    
      <category term="Confluence" scheme="https://wandouduoduo.netlify.com/tags/Confluence/"/>
    
  </entry>
  
  <entry>
    <title>nginx中https的配置和http强制跳转</title>
    <link href="https://wandouduoduo.netlify.com/articles/ebb4cd52.html"/>
    <id>https://wandouduoduo.netlify.com/articles/ebb4cd52.html</id>
    <published>2019-09-20T11:11:13.000Z</published>
    <updated>2019-09-20T14:39:00.626Z</updated>
    
    <content type="html"><![CDATA[<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>随着现在网络互联网的告诉发展，给人们带来的很多便利，但也出现了很多隐患。作为站长，网站的安全至关重要。怎么做才安全呢？建议把http改为https，因为增加了证书认证，相对来说就会安全很多，并且对用户的体验也比较好，谁也不想访问个网站，在地址栏中显示不安全或直接显示不安全等。</p><a id="more"></a><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><p>centos7</p><h2 id="前提"><a href="#前提" class="headerlink" title="前提"></a>前提</h2><p>1，nginx有安装ssl模块，这样才可以使用证书。<a href="https://wandouduoduo.github.io/articles/88000f44.html" target="_blank" rel="noopener">参考文档</a></p><p>2，购买或申请获取的证书文件。</p><h2 id="配置教程"><a href="#配置教程" class="headerlink" title="配置教程"></a>配置教程</h2><h4 id="放置证书"><a href="#放置证书" class="headerlink" title="放置证书"></a>放置证书</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /usr/local/nginx/conf/ssl</span><br><span class="line">cp 证书.zip /usr/local/nginx/conf/ssl/</span><br><span class="line">cd /usr/local/nginx/conf/ssl/</span><br><span class="line">unzip 证书.zip</span><br></pre></td></tr></table></figure><h4 id="配置https"><a href="#配置https" class="headerlink" title="配置https"></a>配置https</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen       443 ssl;</span><br><span class="line"></span><br><span class="line">    server_name wandouduoduo.com;</span><br><span class="line">    root /opt/www/webapps/;</span><br><span class="line">    index index.html index.htm;</span><br><span class="line"></span><br><span class="line">include block.conf;</span><br><span class="line"></span><br><span class="line">    ssl_session_cache shared:SSL:100m;</span><br><span class="line">    ssl_session_timeout  5m;</span><br><span class="line">    ssl_ciphers  HIGH:!aNULL:!MD5;</span><br><span class="line">    ssl_prefer_server_ciphers  on;</span><br><span class="line"></span><br><span class="line">    ssl_certificate     ssl/证书.pem;</span><br><span class="line">    ssl_certificate_key ssl/证书.key;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#禁止在header中出现服务器版本，防止黑客利用版本漏洞攻击</span></span><br><span class="line">    server_tokens off;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">         try_files <span class="variable">$uri</span> <span class="variable">$uri</span>/ =404;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="配置强制跳转"><a href="#配置强制跳转" class="headerlink" title="配置强制跳转"></a>配置强制跳转</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen      80;</span><br><span class="line">    server_name xxxxx;</span><br><span class="line">    rewrite ^(.*) https://<span class="variable">$server_name</span><span class="variable">$1</span> permanent;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>根据上述配置就可实现https，并让http强制跳转到https。</p><h2 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h2><p>nginx防SQL注入与文件注入等相关安全设置</p><p>可以把下面内容写个配置文件block.conf，在server块中include。如上面配置教程中</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#禁止sql注入</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$query_string</span> ~* <span class="string">".*[\;\'\&lt;\&gt;].*"</span> )&#123;</span><br><span class="line">    <span class="built_in">return</span> 404;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$request_uri</span> ~* <span class="string">"(cost\()|(concat\()"</span>) &#123;</span><br><span class="line">    <span class="built_in">return</span> 404;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$request_uri</span> ~* <span class="string">"[+|(%20)]union[+|(%20)]"</span>) &#123;</span><br><span class="line">    <span class="built_in">return</span> 404;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$request_uri</span> ~* <span class="string">"[+|(%20)]and[+|(%20)]"</span>) &#123;</span><br><span class="line">    <span class="built_in">return</span> 404;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$request_uri</span> ~* <span class="string">"[+|(%20)]select[+|(%20)]"</span>) &#123;</span><br><span class="line">    <span class="built_in">return</span> 404;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$query_string</span> ~ <span class="string">"(&lt;|%3C).*script.*(&gt;|%3E)"</span>) &#123;</span><br><span class="line">    <span class="built_in">return</span> 404;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$query_string</span> ~ <span class="string">"GLOBALS(=|[|%[0-9A-Z]&#123;0,2&#125;)"</span>) &#123;</span><br><span class="line">    <span class="built_in">return</span> 404;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$query_string</span> ~ <span class="string">"_REQUEST(=|[|%[0-9A-Z]&#123;0,2&#125;)"</span>) &#123;</span><br><span class="line">    <span class="built_in">return</span> 404;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$query_string</span> ~ <span class="string">"proc/self/environ"</span>) &#123;</span><br><span class="line">    <span class="built_in">return</span> 404;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$query_string</span> ~ <span class="string">"mosConfig_[a-zA-Z_]&#123;1,21&#125;(=|%3D)"</span>) &#123;</span><br><span class="line">    <span class="built_in">return</span> 404;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$query_string</span> ~ <span class="string">"base64_(en|de)code(.*)"</span>) &#123;</span><br><span class="line">    <span class="built_in">return</span> 404;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$query_string</span> ~ <span class="string">"select"</span>) &#123;</span><br><span class="line">    <span class="built_in">return</span> 404;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">#禁止文件注入 </span></span><br><span class="line"><span class="comment">## Block file injections</span></span><br><span class="line"><span class="built_in">set</span> <span class="variable">$block_file_injections</span> 0;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$query_string</span> ~ <span class="string">"[a-zA-Z0-9_]=(\.\.//?)+"</span>) &#123;</span><br><span class="line"><span class="built_in">set</span> <span class="variable">$block_file_injections</span> 1;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$query_string</span> ~ <span class="string">"[a-zA-Z0-9_]=/([a-z0-9_.]//?)+"</span>) &#123;</span><br><span class="line">    <span class="built_in">set</span> <span class="variable">$block_file_injections</span> 1;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$block_file_injections</span> = 1) &#123;</span><br><span class="line">    <span class="built_in">return</span> 444;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">## 禁掉溢出攻击</span></span><br><span class="line"><span class="built_in">set</span> <span class="variable">$block_common_exploits</span> 0;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$query_string</span> ~ <span class="string">"(&lt;|%3C).*script.*(&gt;|%3E)"</span>) &#123;</span><br><span class="line"><span class="built_in">set</span> <span class="variable">$block_common_exploits</span> 1;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$query_string</span> ~ <span class="string">"GLOBALS(=|[|%[0-9A-Z]&#123;0,2&#125;)"</span>) &#123;</span><br><span class="line">    <span class="built_in">set</span> <span class="variable">$block_common_exploits</span> 1;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$query_string</span> ~ <span class="string">"_REQUEST(=|[|%[0-9A-Z]&#123;0,2&#125;)"</span>) &#123;</span><br><span class="line">    <span class="built_in">set</span> <span class="variable">$block_common_exploits</span> 1;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$query_string</span> ~ <span class="string">"proc/self/environ"</span>) &#123;</span><br><span class="line">    <span class="built_in">set</span> <span class="variable">$block_common_exploits</span> 1;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$query_string</span> ~ <span class="string">"mosConfig_[a-zA-Z_]&#123;1,21&#125;(=|%3D)"</span>) &#123;</span><br><span class="line">    <span class="built_in">set</span> <span class="variable">$block_common_exploits</span> 1;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$query_string</span> ~ <span class="string">"base64_(en|de)code(.*)"</span>) &#123;</span><br><span class="line">    <span class="built_in">set</span> <span class="variable">$block_common_exploits</span> 1;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$block_common_exploits</span> = 1) &#123;</span><br><span class="line">    <span class="built_in">return</span> 444;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">## 禁spam字段</span></span><br><span class="line"><span class="built_in">set</span> <span class="variable">$block_spam</span> 0;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$query_string</span> ~ <span class="string">"b(ultram|unicauca|valium|viagra|vicodin|xanax|ypxaieo)b"</span>) &#123;</span><br><span class="line"><span class="built_in">set</span> <span class="variable">$block_spam</span> 1;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$query_string</span> ~ <span class="string">"b(erections|hoodia|huronriveracres|impotence|levitra|libido)b"</span>) &#123;</span><br><span class="line"><span class="built_in">set</span> <span class="variable">$block_spam</span> 1;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$query_string</span> ~ <span class="string">"b(ambien|bluespill|cialis|cocaine|ejaculation|erectile)b"</span>) &#123;</span><br><span class="line"><span class="built_in">set</span> <span class="variable">$block_spam</span> 1;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$query_string</span> ~ <span class="string">"b(lipitor|phentermin|pro[sz]ac|sandyauer|tramadol|troyhamby)b"</span>) &#123;</span><br><span class="line"><span class="built_in">set</span> <span class="variable">$block_spam</span> 1;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$block_spam</span> = 1) &#123;</span><br><span class="line">    <span class="built_in">return</span> 444;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">## 禁掉user-agents</span></span><br><span class="line"><span class="built_in">set</span> <span class="variable">$block_user_agents</span> 0;</span><br><span class="line"><span class="comment"># Don’t disable wget if you need it to run cron jobs!</span></span><br><span class="line"><span class="comment">#if ($http_user_agent ~ "Wget") &#123;</span></span><br><span class="line"><span class="comment"># set $block_user_agents 1;</span></span><br><span class="line"><span class="comment">#&#125;</span></span><br><span class="line"><span class="comment"># Disable Akeeba Remote Control 2.5 and earlier</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$http_user_agent</span> ~ <span class="string">"Indy Library"</span>) &#123;</span><br><span class="line"><span class="built_in">set</span> <span class="variable">$block_user_agents</span> 1;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># Common bandwidth hoggers and hacking tools.</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$http_user_agent</span> ~ <span class="string">"libwww-perl"</span>) &#123;</span><br><span class="line"><span class="built_in">set</span> <span class="variable">$block_user_agents</span> 1;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$http_user_agent</span> ~ <span class="string">"GetRight"</span>) &#123;</span><br><span class="line"><span class="built_in">set</span> <span class="variable">$block_user_agents</span> 1;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$http_user_agent</span> ~ <span class="string">"GetWeb!"</span>) &#123;</span><br><span class="line"><span class="built_in">set</span> <span class="variable">$block_user_agents</span> 1;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$http_user_agent</span> ~ <span class="string">"Go!Zilla"</span>) &#123;</span><br><span class="line"><span class="built_in">set</span> <span class="variable">$block_user_agents</span> 1;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$http_user_agent</span> ~ <span class="string">"Download Demon"</span>) &#123;</span><br><span class="line"><span class="built_in">set</span> <span class="variable">$block_user_agents</span> 1;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$http_user_agent</span> ~ <span class="string">"Go-Ahead-Got-It"</span>) &#123;</span><br><span class="line"><span class="built_in">set</span> <span class="variable">$block_user_agents</span> 1;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$http_user_agent</span> ~ <span class="string">"TurnitinBot"</span>) &#123;</span><br><span class="line"><span class="built_in">set</span> <span class="variable">$block_user_agents</span> 1;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$http_user_agent</span> ~ <span class="string">"GrabNet"</span>) &#123;</span><br><span class="line"><span class="built_in">set</span> <span class="variable">$block_user_agents</span> 1;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$http_user_agent</span> ~ <span class="string">"WebBench"</span>) &#123;</span><br><span class="line">    <span class="built_in">set</span> <span class="variable">$block_user_agents</span> 1;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$http_user_agent</span> ~ <span class="string">"ApacheBench"</span>) &#123;</span><br><span class="line">    <span class="built_in">set</span> <span class="variable">$block_user_agents</span> 1;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$http_user_agent</span> ~ ^$) &#123;</span><br><span class="line">    <span class="built_in">set</span> <span class="variable">$block_user_agents</span> 1;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$http_user_agent</span> ~ <span class="string">"Python-urllib"</span>) &#123;</span><br><span class="line">    <span class="built_in">set</span> <span class="variable">$block_user_agents</span> 1;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$block_user_agents</span> = 1) &#123;</span><br><span class="line"><span class="built_in">return</span> 444;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;背景&quot;&gt;&lt;a href=&quot;#背景&quot; class=&quot;headerlink&quot; title=&quot;背景&quot;&gt;&lt;/a&gt;背景&lt;/h2&gt;&lt;p&gt;随着现在网络互联网的告诉发展，给人们带来的很多便利，但也出现了很多隐患。作为站长，网站的安全至关重要。怎么做才安全呢？建议把http改为https，因为增加了证书认证，相对来说就会安全很多，并且对用户的体验也比较好，谁也不想访问个网站，在地址栏中显示不安全或直接显示不安全等。&lt;/p&gt;
    
    </summary>
    
      <category term="应用运维" scheme="https://wandouduoduo.netlify.com/categories/%E5%BA%94%E7%94%A8%E8%BF%90%E7%BB%B4/"/>
    
    
      <category term="Nginx" scheme="https://wandouduoduo.netlify.com/tags/Nginx/"/>
    
  </entry>
  
  <entry>
    <title>nginx升级或重新加载模块</title>
    <link href="https://wandouduoduo.netlify.com/articles/88000f44.html"/>
    <id>https://wandouduoduo.netlify.com/articles/88000f44.html</id>
    <published>2019-09-20T10:34:08.000Z</published>
    <updated>2019-09-20T11:38:51.045Z</updated>
    
    <content type="html"><![CDATA[<h2 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h2><p>在日常运维工作中，有几个场景：</p><p>1，nginx  web服务升级 。</p><p>2，https证书配置后，发现nginx编译没有加入ssl模块。</p><p>3，nginx配置后，有<code>nginx: [emerg] the &quot;xxx&quot; parameter requires</code>等等报错。</p><p>这些都需要重新编译nginx程序，并把需要的模块加载进去，但是对于不熟悉nginx的人，又头疼和担心，需要重新编译，会不会对原来有啥影响等等。本文就是针对这些场景给出解决方案。</p><a id="more"></a><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><p>centos7</p><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>首先，需要说明的是nginx因为其开放性而广受欢迎，其中开放性就是：松耦合，需要啥模块，重新加载编译后替换就可以了，所以完全不需要担心。</p><h4 id="安装依赖包"><a href="#安装依赖包" class="headerlink" title="安装依赖包"></a>安装依赖包</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y gcc gcc-c++ pcre pcre-devel zlib zlib-devel openssl openssl-devel</span><br></pre></td></tr></table></figure><h4 id="查看nginx原有模块"><a href="#查看nginx原有模块" class="headerlink" title="查看nginx原有模块"></a>查看nginx原有模块</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx -V</span><br></pre></td></tr></table></figure><p><img src="/articles/88000f44/1.png" alt></p><p>可以看到没有加载模块</p><h4 id="重新编译"><a href="#重新编译" class="headerlink" title="重新编译"></a>重新编译</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入到源码包</span></span><br><span class="line"><span class="built_in">cd</span> /opt/packages/sunscripts/install/packages/nginx-1.16.0</span><br><span class="line"><span class="comment"># 配置</span></span><br><span class="line">./configure --prefix=/usr/<span class="built_in">local</span>/nginx  --with-http_ssl_module  --with-http_stub_status_module  --with-http_gzip_static_module</span><br><span class="line"><span class="comment"># 编译</span></span><br><span class="line">make</span><br><span class="line">注意：这里不要进行make install，否则就是覆盖安装</span><br></pre></td></tr></table></figure><h4 id="替换"><a href="#替换" class="headerlink" title="替换"></a>替换</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 备份</span></span><br><span class="line">cp /usr/<span class="built_in">local</span>/nginx/sbin/nginx /usr/<span class="built_in">local</span>/nginx/sbin/nginx.bak</span><br><span class="line"><span class="comment"># 停nginx</span></span><br><span class="line">systemctl stop nginx.service</span><br><span class="line"><span class="comment"># 替换</span></span><br><span class="line">cp ./objs/nginx /usr/<span class="built_in">local</span>/nginx/sbin/</span><br><span class="line"><span class="comment"># 启动</span></span><br><span class="line">systemctl start nginx.service</span><br><span class="line"><span class="comment"># 检查验证</span></span><br><span class="line">/usr/<span class="built_in">local</span>/nginx/sbin/nginx -V</span><br></pre></td></tr></table></figure><p><img src="/articles/88000f44/2.png" alt></p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>按照上面的方案，按照自己需求加载模块，定制自己的nginx。</p><h2 id="一键安装nginx脚本"><a href="#一键安装nginx脚本" class="headerlink" title="一键安装nginx脚本"></a>一键安装nginx脚本</h2>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;目的&quot;&gt;&lt;a href=&quot;#目的&quot; class=&quot;headerlink&quot; title=&quot;目的&quot;&gt;&lt;/a&gt;目的&lt;/h2&gt;&lt;p&gt;在日常运维工作中，有几个场景：&lt;/p&gt;
&lt;p&gt;1，nginx  web服务升级 。&lt;/p&gt;
&lt;p&gt;2，https证书配置后，发现nginx编译没有加入ssl模块。&lt;/p&gt;
&lt;p&gt;3，nginx配置后，有&lt;code&gt;nginx: [emerg] the &amp;quot;xxx&amp;quot; parameter requires&lt;/code&gt;等等报错。&lt;/p&gt;
&lt;p&gt;这些都需要重新编译nginx程序，并把需要的模块加载进去，但是对于不熟悉nginx的人，又头疼和担心，需要重新编译，会不会对原来有啥影响等等。本文就是针对这些场景给出解决方案。&lt;/p&gt;
    
    </summary>
    
      <category term="应用运维" scheme="https://wandouduoduo.netlify.com/categories/%E5%BA%94%E7%94%A8%E8%BF%90%E7%BB%B4/"/>
    
    
      <category term="Nginx" scheme="https://wandouduoduo.netlify.com/tags/Nginx/"/>
    
  </entry>
  
  <entry>
    <title>centos7下使用yum源安装mysql5.7</title>
    <link href="https://wandouduoduo.netlify.com/articles/5449f5b8.html"/>
    <id>https://wandouduoduo.netlify.com/articles/5449f5b8.html</id>
    <published>2019-09-17T09:21:05.000Z</published>
    <updated>2019-09-17T09:43:59.324Z</updated>
    
    <content type="html"><![CDATA[<h2 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h2><p>现在centos上默认是没有yum源的，yum安装的是 MariaDB。本文详细介绍了centos7下使用yum源安装mysql5.7。</p><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><p>系统：centos7</p><a id="more"></a><h2 id="配置yum源"><a href="#配置yum源" class="headerlink" title="配置yum源"></a>配置yum源</h2><h4 id="下载yum源："><a href="#下载yum源：" class="headerlink" title="下载yum源："></a>下载yum源：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget <span class="string">'https://dev.mysql.com/get/mysql57-community-release-el7-11.noarch.rpm'</span></span><br></pre></td></tr></table></figure><p><img src="/articles/5449f5b8/1.png" alt></p><h4 id="安装yum源"><a href="#安装yum源" class="headerlink" title="安装yum源"></a>安装yum源</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -Uvh mysql57-community-release-el7-11.noarch.rpm</span><br></pre></td></tr></table></figure><p><img src="/articles/5449f5b8/2.png" alt></p><h2 id="安装mysql"><a href="#安装mysql" class="headerlink" title="安装mysql"></a>安装mysql</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y mysql-community-server</span><br></pre></td></tr></table></figure><p><img src="/articles/5449f5b8/3.png" alt></p><h2 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h2><p>启动mysql,要知道在centos7中，没有了service命令，都是使用systemctl命令。注意启动的时候是start mysqld而不是mysql。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动</span></span><br><span class="line">systemctl start mysqld</span><br><span class="line"><span class="comment"># 查看状态</span></span><br><span class="line">systemctl status mysqld</span><br></pre></td></tr></table></figure><p><img src="/articles/5449f5b8/4.png" alt></p><p>如图所示，是已经启动了</p><h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><h4 id="修改数据库密码"><a href="#修改数据库密码" class="headerlink" title="修改数据库密码"></a>修改数据库密码</h4><p>mysql5.7的新特性之一就是在初始化的时候会生成一个自定义的密码，然后你需要找到这个密码，登录的时候输入。注意，输入密码的时候是不显示。</p><p>找到密码: 红框的地方就是密码</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep <span class="string">'temporary password'</span> /var/<span class="built_in">log</span>/mysqld.log</span><br></pre></td></tr></table></figure><p><img src="/articles/5449f5b8/5.png" alt></p><p><strong>登录数据库：这里-p之后不用输入密码，回车后再输入。改过密码之后登录则是直接在-p后加密码了。</strong></p><p><strong>修改密码</strong></p><p>注意，修改的密码太简单会不给修改，把大小写字母和数字加上就肯定可以了。然后切记切记，mysql里面的命令要加分号！分号！分号！</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SET PASSWORD = PASSWORD(&apos;Sun123$%^&apos;);</span><br></pre></td></tr></table></figure><p><strong>设置远程可以登录</strong></p><p>现在这样是无法在本地用工具登录访问的，现在要做两件事，一件事是将云服务器上的3306端口开放；另一件事是配置远程可以访问。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GRANT ALL PRIVILEGES ON *.* TO &apos;root&apos;@&apos;%&apos; IDENTIFIED BY &apos;Admin123!&apos; WITH GRANT OPTION;</span><br><span class="line">flush privileges;</span><br></pre></td></tr></table></figure><p>先设置刚才的密码可以远程登录，然后使用flush命令使配置立即生效。<br>如果还不行可以尝试重启一下数据库。</p><p><img src="/articles/5449f5b8/6.png" alt></p><h4 id="优化配置"><a href="#优化配置" class="headerlink" title="优化配置"></a>优化配置</h4><p>mysql的配置文件真的很多，有的还很蛋疼。比如默认的字符集是拉丁字符集，每次创建数据库的时候要设置字符集；默认还不支持group by语句，默认的时区也不是我们现在的北京时间(东八区)，会导致我们的时间差了13个点。针对以上说几个简要的配置，更多的配置在以后遇到了再加上，或者留言吧！</p><p>打开配置文件，yum安装的默认在/etc文件夹下:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/my.cnf</span><br><span class="line"></span><br><span class="line"><span class="comment">#在[mysqld]下面添加，不需要分号</span></span><br><span class="line"><span class="comment">#字符集:注意是utf8而不是utf-8!</span></span><br><span class="line">character-set-server=utf8</span><br><span class="line"><span class="comment">#这时候使用show variables like 'char%';就可以查看到字符集都是utf8了</span></span><br><span class="line"><span class="comment">#sql支持group by语句</span></span><br><span class="line">sql_mode=STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION</span><br><span class="line"><span class="comment">#设置时区为东八区</span></span><br><span class="line">default-time_zone = <span class="string">'+8:00'</span></span><br></pre></td></tr></table></figure><p>最后重启数据库，使配置生效。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart mysqld</span><br></pre></td></tr></table></figure><h2 id="设置开机启动"><a href="#设置开机启动" class="headerlink" title="设置开机启动"></a><strong>设置开机启动</strong></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> mysqld</span><br><span class="line">systemctl daemon-reload</span><br></pre></td></tr></table></figure><p>安装记录就到这里，更多的配置在遇到后继续更新。</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;目的&quot;&gt;&lt;a href=&quot;#目的&quot; class=&quot;headerlink&quot; title=&quot;目的&quot;&gt;&lt;/a&gt;目的&lt;/h2&gt;&lt;p&gt;现在centos上默认是没有yum源的，yum安装的是 MariaDB。本文详细介绍了centos7下使用yum源安装mysql5.7。&lt;/p&gt;
&lt;h2 id=&quot;环境&quot;&gt;&lt;a href=&quot;#环境&quot; class=&quot;headerlink&quot; title=&quot;环境&quot;&gt;&lt;/a&gt;环境&lt;/h2&gt;&lt;p&gt;系统：centos7&lt;/p&gt;
    
    </summary>
    
      <category term="数据库运维" scheme="https://wandouduoduo.netlify.com/categories/%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%90%E7%BB%B4/"/>
    
    
      <category term="Mysql" scheme="https://wandouduoduo.netlify.com/tags/Mysql/"/>
    
  </entry>
  
  <entry>
    <title>docker安装redmine服务</title>
    <link href="https://wandouduoduo.netlify.com/articles/40baf0f.html"/>
    <id>https://wandouduoduo.netlify.com/articles/40baf0f.html</id>
    <published>2019-09-05T05:38:52.000Z</published>
    <updated>2019-09-05T11:02:44.711Z</updated>
    
    <content type="html"><![CDATA[<h2 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h2><p>快速搭建redmine服务，以便能够对项目和工作流进行管控。</p><h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><p><a href="https://hub.docker.com/_/redmine" target="_blank" rel="noopener">官方文档</a>或者<a href="https://docs.docker.com/samples/library/redmine/" target="_blank" rel="noopener">docker官方</a></p><a id="more"></a><h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h2><h4 id="用SQLite3运行Redmine"><a href="#用SQLite3运行Redmine" class="headerlink" title="用SQLite3运行Redmine"></a>用SQLite3运行Redmine</h4><p>这是最简单的方式</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name sunredmine redmine:3.4</span><br></pre></td></tr></table></figure><h4 id="使用数据库容器运行Redmine"><a href="#使用数据库容器运行Redmine" class="headerlink" title="使用数据库容器运行Redmine"></a>使用数据库容器运行Redmine</h4><p>建议使用数据库服务器运行Redmine。</p><p>1, 启动数据库容器</p><p>PostgreSQL</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name some-postgres --network some-network -e POSTGRES_PASSWORD=secret -e POSTGRES_USER=redmine postgres</span><br></pre></td></tr></table></figure><p>MySQL的（替代<code>-e REDMINE_DB_POSTGRES=some-postgres</code>与<code>-e REDMINE_DB_MYSQL=some-mysql</code>运行管理平台时）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name some-mysql --network some-network -e MYSQL_USER=redmine -e MYSQL_PASSWORD=secret -e MYSQL_DATABASE=redmine -e MYSQL_RANDOM_ROOT_PASSWORD=1 mysql:5.7</span><br></pre></td></tr></table></figure><p>2, 运行redmine</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name some-redmine --network some-network -e REDMINE_DB_POSTGRES=some-postgres -e REDMINE_DB_USERNAME=redmine -e REDMINE_DB_PASSWORD=secret redmine</span><br></pre></td></tr></table></figure><h2 id="完整例子"><a href="#完整例子" class="headerlink" title="完整例子"></a>完整例子</h2><p>假设已有postgres数据库容器</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">docker run --name pgsql -p 5432:5432 -e POSTGRES_PASSWORD=sunxu123 -v /data/postgres:/var/lib/postgresql/data -d postgres:9.4</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入容器后操作</span></span><br><span class="line">docker <span class="built_in">exec</span> -it pgsql /bin/bash</span><br><span class="line"><span class="comment"># 进Postgresql账号</span></span><br><span class="line">su postgres</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">CREATE USER redmine WITH PASSWORD <span class="string">'Sun123'</span>;</span><br><span class="line"><span class="comment"># 建库</span></span><br><span class="line">createdb -O redmine redmine 和 CREATE DATABASE redmine OWNER redmine等效,二选一即可</span><br><span class="line"><span class="comment"># 赋权</span></span><br><span class="line">GRANT ALL PRIVILEGES ON DATABASE redmine to redmine;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动redmine</span></span><br><span class="line">docker run  --name redmine -p 10083:3000 -v /data/redmine/data:/usr/src/redmine/files --link pgsql:remine -d redmine:3.4</span><br><span class="line"><span class="comment"># 查看日志</span></span><br><span class="line">docker logs -f remine</span><br></pre></td></tr></table></figure><h2 id="功能完善"><a href="#功能完善" class="headerlink" title="功能完善"></a>功能完善</h2><h4 id="邮件"><a href="#邮件" class="headerlink" title="邮件"></a>邮件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">docker redmine:/usr/src/redmine/config/configuration.yml.example  ./</span><br><span class="line">mv configuration.yml.example configuration.yml</span><br><span class="line">vim configuration.yml</span><br><span class="line"></span><br><span class="line">default:</span><br><span class="line">  email_delivery:</span><br><span class="line">    delivery_method: :smtp</span><br><span class="line">    smtp_settings:</span><br><span class="line">      enable_starttls_auto: <span class="literal">true</span></span><br><span class="line">      address: <span class="string">"xxxxxxxxxxx"</span></span><br><span class="line">      port: 587</span><br><span class="line">      authentication: :login</span><br><span class="line">      domain: <span class="string">'xxxxxxxxxxxxxx'</span></span><br><span class="line">      user_name: <span class="string">'xxxxxxxxxxxxx'</span></span><br><span class="line">      password: <span class="string">'xxxxxxxxxxxx'</span></span><br></pre></td></tr></table></figure><p><img src="/articles/40baf0f/1.png" alt></p><p><strong>测试是否配置成功：</strong><br>打开Redmine &gt;管理员登陆 &gt; 管理 &gt; 配置 &gt; 邮件通知 &gt;页面底部:发送测试邮件。将会发送邮件到你目前登陆的用户邮箱中。</p><p>如果没有配置成功，则这个选项卡显示的是黄色的字，如未对邮件进行配置，config/configuration.yml。</p><h4 id="ldap接入和用户同步"><a href="#ldap接入和用户同步" class="headerlink" title="ldap接入和用户同步"></a>ldap接入和用户同步</h4><p>原始的ldap认证，我试了下不完美，他需要创建用户然后使用ldap认证，也就是说还是需要先去创建用户。这样显得很麻烦</p><p><img src="/articles/40baf0f/2.png" alt></p><p>Base dn是基准DN</p><p>LDAP过滤器是用来过滤你需要加入到redmine里的用户，我这里是用对象类即objectclass去filter用户</p><p>认证模式改以下就好。</p><p>但是这样还是创建用户 还是麻烦 这个时候需要用到ldap的插件（Redmine LDAP Sync）</p><p>插件安装基本官网都有说</p><p>git：<a href="https://github.com/thorin/redmine_ldap_sync#rake-tasks" target="_blank" rel="noopener">https://github.com/thorin/redmine_ldap_sync#rake-tasks</a></p><p>里面有介绍我这里就不说了，大致上就两步</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">因为这个插件好多年不再维护了只能支持redmine3.4.x最新的redmine4.0.x不支持，会报错，这也是为什么docker启动时用3.4版本的原因</span><br><span class="line"></span><br><span class="line">1，在#&#123;RAILS_ROOT&#125;/plugins目录下下载插件</span><br><span class="line">git clone git://github.com/thorin/redmine_ldap_sync.git</span><br><span class="line">2，在#&#123;RAILS_ROOT&#125; 目录下执行</span><br><span class="line">rake -T redmine:plugins:ldap_sync RAILS_ENV=production</span><br></pre></td></tr></table></figure><p><img src="/articles/40baf0f/4.png" alt></p><p>插件安装好之后重启redmine也就是nginx</p><p>然后打开web发现会多一个ldap sync<br><img src="/articles/40baf0f/5.png" alt></p><p>填写好测试完成看看结果</p><p><img src="/articles/40baf0f/6.png" alt></p><p><img src="/articles/40baf0f/7.png" alt></p><p><img src="/articles/40baf0f/8.png" alt></p><p>配置项根据自己的环境设置，设置好之后点击第三栏菜单test是否可以取出成功，</p><p>可以的话就直接激活这个ldap sync</p><p>之后直接去登录就可以了。</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;目的&quot;&gt;&lt;a href=&quot;#目的&quot; class=&quot;headerlink&quot; title=&quot;目的&quot;&gt;&lt;/a&gt;目的&lt;/h2&gt;&lt;p&gt;快速搭建redmine服务，以便能够对项目和工作流进行管控。&lt;/p&gt;
&lt;h2 id=&quot;参考文档&quot;&gt;&lt;a href=&quot;#参考文档&quot; class=&quot;headerlink&quot; title=&quot;参考文档&quot;&gt;&lt;/a&gt;参考文档&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;https://hub.docker.com/_/redmine&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;官方文档&lt;/a&gt;或者&lt;a href=&quot;https://docs.docker.com/samples/library/redmine/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;docker官方&lt;/a&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="应用运维" scheme="https://wandouduoduo.netlify.com/categories/%E5%BA%94%E7%94%A8%E8%BF%90%E7%BB%B4/"/>
    
    
      <category term="Docker" scheme="https://wandouduoduo.netlify.com/tags/Docker/"/>
    
  </entry>
  
  <entry>
    <title>docker构建自己的openldap自助密码服务</title>
    <link href="https://wandouduoduo.netlify.com/articles/d83ca733.html"/>
    <id>https://wandouduoduo.netlify.com/articles/d83ca733.html</id>
    <published>2019-09-03T07:17:12.000Z</published>
    <updated>2019-09-03T10:09:07.771Z</updated>
    
    <content type="html"><![CDATA[<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>OpenLDAP安装完毕后，如果用户要修改密码的话，就需要通过OpenLDAP管理员来进行修改。为了解放管理员的工作，让OpenLDAP用户可以自行进行密码的修改和重置，就需要我们来搭建一套自助修改密码系统。</p><p>在此我们使用的是开源的基于php语言开发的ldap自助修改密码系统Self Service Password。</p><h2 id="教程"><a href="#教程" class="headerlink" title="教程"></a>教程</h2><p><a href="https://github.com/wandouduoduo/docker-ssp" target="_blank" rel="noopener">参考文档</a></p><a id="more"></a><p>按照参考文档正确配置并构建镜像，运行后，登录网页访问，通过网页修改账号密码验证</p><p><img src="/articles/d83ca733/1.png" alt></p><h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>如果遇到以下错误：</p><p><img src="/articles/d83ca733/2.png" alt></p><p>修改配置:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$keyphrase = &quot;secret&quot;;  改为  $keyphrase = &quot;sunxu&quot;; #任意字符串</span><br></pre></td></tr></table></figure><p>重启容器，再次访问。</p><h2 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h2><p>邮件重置密码：</p><p><img src="/articles/d83ca733/3.png" alt></p><p>查看邮件</p><p><img src="/articles/d83ca733/4.png" alt></p><p>修改完成会收到一条邮件：</p><p><img src="/articles/d83ca733/5.png" alt></p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;背景&quot;&gt;&lt;a href=&quot;#背景&quot; class=&quot;headerlink&quot; title=&quot;背景&quot;&gt;&lt;/a&gt;背景&lt;/h2&gt;&lt;p&gt;OpenLDAP安装完毕后，如果用户要修改密码的话，就需要通过OpenLDAP管理员来进行修改。为了解放管理员的工作，让OpenLDAP用户可以自行进行密码的修改和重置，就需要我们来搭建一套自助修改密码系统。&lt;/p&gt;
&lt;p&gt;在此我们使用的是开源的基于php语言开发的ldap自助修改密码系统Self Service Password。&lt;/p&gt;
&lt;h2 id=&quot;教程&quot;&gt;&lt;a href=&quot;#教程&quot; class=&quot;headerlink&quot; title=&quot;教程&quot;&gt;&lt;/a&gt;教程&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;https://github.com/wandouduoduo/docker-ssp&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;参考文档&lt;/a&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="应用运维" scheme="https://wandouduoduo.netlify.com/categories/%E5%BA%94%E7%94%A8%E8%BF%90%E7%BB%B4/"/>
    
    
      <category term="Openldap" scheme="https://wandouduoduo.netlify.com/tags/Openldap/"/>
    
  </entry>
  
  <entry>
    <title>confluence6.3.1升级最新版本6.15.8</title>
    <link href="https://wandouduoduo.netlify.com/articles/4afcf658.html"/>
    <id>https://wandouduoduo.netlify.com/articles/4afcf658.html</id>
    <published>2019-09-02T04:00:40.000Z</published>
    <updated>2019-09-06T10:12:19.870Z</updated>
    
    <content type="html"><![CDATA[<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>收到公司总部安全部门扫描测试，查出公司内部confluence的版本太低，存在安全漏洞。给出的解决方案是升级到最新版本，最新版本已经把该漏洞修复。本文就详细介绍下confluence的升级过程。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://www.cwiki.us/display/CONFLUENCEWIKI/Upgrading+Confluence" target="_blank" rel="noopener">官方文档</a></p><a id="more"></a><h2 id="升级流程"><a href="#升级流程" class="headerlink" title="升级流程"></a>升级流程</h2><h3 id="备份你的数据"><a href="#备份你的数据" class="headerlink" title="备份你的数据"></a>备份你的数据</h3><h4 id="官方备份方法"><a href="#官方备份方法" class="headerlink" title="官方备份方法"></a>官方备份方法</h4><p>点击一般设置的，点击备份和还原</p><p><img src="/articles/4afcf658/1.png" alt></p><h3 id="自行备份"><a href="#自行备份" class="headerlink" title="自行备份"></a>自行备份</h3><p>1，备份数据源。默认路径为：/var/atlassian/application-data/confluence/confluence.cfg.xml</p><p>2，备份附件。默认路径为：/var/atlassian/application-data/confluence/attachments</p><h2 id="安装部署最新版"><a href="#安装部署最新版" class="headerlink" title="安装部署最新版"></a>安装部署最新版</h2><h4 id="破解文件备份"><a href="#破解文件备份" class="headerlink" title="破解文件备份"></a>破解文件备份</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv /opt/atlassian/confluence/confluence/WEB-INF/lib/atlassian-extras-decoder-v2-3.4.1.jar ~/atlassian-extras-2.4.jar</span><br></pre></td></tr></table></figure><h4 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h4><p><a href="https://www.atlassian.com/software/confluence/download" target="_blank" rel="noopener">官网下载地址</a>，放在/opt</p><h4 id="执行"><a href="#执行" class="headerlink" title="执行"></a>执行</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chmod +x atlassian-confluence-6.15.1-x64.bin   <span class="comment">#赋予可执行权限</span></span><br><span class="line">./atlassian-confluence-6.15.1-x64.bin  <span class="comment">#执行安装</span></span><br></pre></td></tr></table></figure><p>到了红圈这步选择3，回车。表示升级</p><p><img src="/articles/4afcf658/2.png" alt></p><h4 id="备份"><a href="#备份" class="headerlink" title="备份"></a>备份</h4><p>下面询问你是否要备份，上面我们已经自己备份了，也可选他默认备份</p><p><img src="/articles/4afcf658/3.png" alt></p><h4 id="确认更新"><a href="#确认更新" class="headerlink" title="确认更新"></a>确认更新</h4><p>会展示了一些改变的文件（破解文件变了，下面伏笔），问你同意</p><p><img src="/articles/4afcf658/4.png" alt></p><h4 id="成功部署"><a href="#成功部署" class="headerlink" title="成功部署"></a>成功部署</h4><p>访问  ip:8090</p><h4 id="重新破解"><a href="#重新破解" class="headerlink" title="重新破解"></a>重新破解</h4><p>破解包被升级，有机会出现下面画面，代表验证不通过</p><p><img src="/articles/4afcf658/5.png" alt></p><p>把备份的atlassian-extras-2.4.jar文件复制到/opt/atlassian/confluence/confluence/WEB-INF/lib，并重命名为该版本的文件名</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv ~/atlassian-extras-2.4.jar /opt/atlassian/confluence/confluence/WEB-INF/lib/atlassian-extras-decoder-v2-3.4.1.jar</span><br></pre></td></tr></table></figure><p>重启服务</p><p>数据和附件，无损升级到，6.15.8</p><p><img src="/articles/4afcf658/6.png" alt></p><h2 id="破解教程"><a href="#破解教程" class="headerlink" title="破解教程"></a>破解教程</h2><p>有的同学可能没有备份破解文件，或者可能不是自己搭建的，现在刚刚接手。那么如何破解呢？</p><h4 id="下载破解工具"><a href="#下载破解工具" class="headerlink" title="下载破解工具"></a>下载破解工具</h4><p>链接: <a href="https://pan.baidu.com/s/13GZ-3XutMEyE3cUl9rwg_Q" target="_blank" rel="noopener">https://pan.baidu.com/s/13GZ-3XutMEyE3cUl9rwg_Q</a> 提取码: 7gtd </p><p>破解工具是个jar包，所以需要jdk环境。jdk环境配置在网上很多，这里省略。java -jar 破解文件.jar</p><p><img src="/articles/4afcf658/7.png" alt></p><h4 id="获取信息"><a href="#获取信息" class="headerlink" title="获取信息"></a>获取信息</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 升级时</span></span><br><span class="line">grep -Po <span class="string">"(?&lt;=server.id\"\&gt;).*(?=\&lt;)"</span> /var/atlassian/application-data/confluence/confluence.cfg.xml</span><br><span class="line"><span class="comment"># 全新安装此步骤跳过</span></span><br></pre></td></tr></table></figure><h4 id="生产key"><a href="#生产key" class="headerlink" title="生产key"></a>生产key</h4><p>先点.patch加载从服务器复制出来的atlassian-extras-2.4.jar文件，然后点.gen破解</p><p><img src="/articles/4afcf658/8.png" alt></p><h4 id="破解"><a href="#破解" class="headerlink" title="破解"></a>破解</h4><p>如权限安装，如下图填写</p><p><img src="/articles/4afcf658/9.png" alt></p><p>如升级，如下图更改配置</p><p>vim /var/atlassian/application-data/confluence/confluence.cfg.xml</p><p><img src="/articles/4afcf658/10.png" alt></p><p>把破解后的文件atlassian-extras-2.4.jar复制到服务器的/opt/atlassian/confluence/confluence/WEB-INF/lib/，并重命名为该版本的名称，如：atlassian-extras-decoder-v2-3.4.1.jar</p><h2 id="接入Ldap"><a href="#接入Ldap" class="headerlink" title="接入Ldap"></a>接入Ldap</h2><p>管理员登录，一般配置–&gt;用户目录–&gt;添加用户目录–&gt;Ldap</p><p><img src="/articles/4afcf658/11.png" alt></p><p>填写信息</p><p><img src="/articles/4afcf658/12.png" alt></p><p><img src="/articles/4afcf658/13.png" alt></p><p><img src="/articles/4afcf658/14.png" alt></p><p><img src="/articles/4afcf658/15.png" alt></p><p><img src="/articles/4afcf658/16.png" alt></p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;背景&quot;&gt;&lt;a href=&quot;#背景&quot; class=&quot;headerlink&quot; title=&quot;背景&quot;&gt;&lt;/a&gt;背景&lt;/h2&gt;&lt;p&gt;收到公司总部安全部门扫描测试，查出公司内部confluence的版本太低，存在安全漏洞。给出的解决方案是升级到最新版本，最新版本已经把该漏洞修复。本文就详细介绍下confluence的升级过程。&lt;/p&gt;
&lt;h2 id=&quot;参考&quot;&gt;&lt;a href=&quot;#参考&quot; class=&quot;headerlink&quot; title=&quot;参考&quot;&gt;&lt;/a&gt;参考&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;https://www.cwiki.us/display/CONFLUENCEWIKI/Upgrading+Confluence&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;官方文档&lt;/a&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="应用运维" scheme="https://wandouduoduo.netlify.com/categories/%E5%BA%94%E7%94%A8%E8%BF%90%E7%BB%B4/"/>
    
    
      <category term="Confluence" scheme="https://wandouduoduo.netlify.com/tags/Confluence/"/>
    
  </entry>
  
  <entry>
    <title>cmdbuild接入openldap方法</title>
    <link href="https://wandouduoduo.netlify.com/articles/364a7d87.html"/>
    <id>https://wandouduoduo.netlify.com/articles/364a7d87.html</id>
    <published>2019-08-30T10:19:54.000Z</published>
    <updated>2019-08-30T10:51:10.552Z</updated>
    
    <content type="html"><![CDATA[<h2 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h2><p>cmdbuid接入openldap用户权限，便于用户统一管理。</p><a id="more"></a><h2 id="前提条件"><a href="#前提条件" class="headerlink" title="前提条件"></a>前提条件</h2><p>已安装好cmdbuid和openldap。</p><p><a href="https://wandouduoduo.github.io/articles/4fcc594d.html" target="_blank" rel="noopener">安装cmdbuild</a></p><p><a href="https://wandouduoduo.github.io/articles/931613a4.html#more" target="_blank" rel="noopener">安装openldap</a></p><h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h2><p>1,  参考官方文档，如下图</p><p><img src="/articles/364a7d87/1.png" alt></p><p>翻译大意是</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">LDAP协议配置</span><br><span class="line">在本节中，我们将看到LDAP协议的配置选项。</span><br><span class="line">CMDBuild目前仅支持使用简单绑定进行身份验证。但是可以使用</span><br><span class="line">匿名绑定以在LDAP树中搜索用户。</span><br><span class="line">要在CMDBuild中处理用户权限，必须存在要进行身份验证的用户在用户数据库表中。</span><br><span class="line">例如，如果具有LDAP UID j.doe的用户需要访问CMDBuild使用Tech Group必须遵循以下步骤：</span><br><span class="line">•使用任何密码在CMDBuild中创建用户j.doe</span><br><span class="line">•创建Tech组并定义其权限</span><br><span class="line">•将j.doe添加到Tech组</span><br><span class="line">经过上面三步后，当用户j.doe尝试验证自己时，系统将验证提供的凭据在LDAP服务器上（按身份验证类型链指定的顺序）。</span><br><span class="line"></span><br><span class="line">所以就是所需要事先安装openldap树在cmdbuild中创建用户组和用户，这样配置后才能认证，感觉有点多次一举，我既然都事先创建了，干嘛还要接入openldap。最好的方法是直接读取认证，但是目前官方不支持。</span><br><span class="line">有个想法是直接写脚本把openldap信息读取出来定时写入到cmdbuild数据库中，这样就可以实现统一管控。</span><br></pre></td></tr></table></figure><p>2,  配置cmdbuild认证文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/<span class="built_in">local</span>/tomcat/webapps/ROOT/WEB-INF/conf/auth.conf</span><br><span class="line"></span><br><span class="line"><span class="comment">## Authentication method chain (the first match stops the auth chain)</span></span><br><span class="line"><span class="comment">#auth.methods=HeaderAuthenticator,CasAuthenticator,LdapAuthenticator,DBAuthenticator</span></span><br><span class="line">auth.methods=LdapAuthenticator</span><br><span class="line"></span><br><span class="line"><span class="comment">#auth.case.insensitive=false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#force.ws.password.digest=true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##</span></span><br><span class="line"><span class="comment">## HEADER</span></span><br><span class="line"><span class="comment">##</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#header.attribute.name=username</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##</span></span><br><span class="line"><span class="comment">## CAS</span></span><br><span class="line"><span class="comment">##</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#cas.server.url=https://casserver/cas</span></span><br><span class="line"><span class="comment">#cas.login.page=/login</span></span><br><span class="line"><span class="comment">#cas.service.param=service</span></span><br><span class="line"><span class="comment">#cas.ticket.param=ticket</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##</span></span><br><span class="line"><span class="comment">## LDAP</span></span><br><span class="line"><span class="comment">##</span></span><br><span class="line"></span><br><span class="line">ldap.server.address=xxx.xxx.xxxx.xxx</span><br><span class="line">ldap.server.port=389</span><br><span class="line">ldap.use.ssl=<span class="literal">false</span></span><br><span class="line">ldap.basedn=dc=wandouduoduo,dc=com</span><br><span class="line">ldap.bind.attribute=uid</span><br><span class="line"></span><br><span class="line">ldap.search.filter=(objectClass=*)</span><br><span class="line"><span class="comment">##Accept only none (anonymous bind) and simple (simple bind)</span></span><br><span class="line"><span class="comment">#ldap.search.auth.method=none</span></span><br><span class="line"><span class="comment">##This section is only for simple bind</span></span><br><span class="line">ldap.search.auth.method=simple</span><br><span class="line">ldap.search.auth.principal=cn=admin,dc=wandouduoduo,dc=com</span><br><span class="line">ldap.search.auth.password=xxxx</span><br></pre></td></tr></table></figure><p>3，重启cmdbuild，生效配置。</p><p>4，日志改为debug模式，便于观察。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/tomcat/webapps/ROOT/WEB-INF/conf/log4j.conf</span><br></pre></td></tr></table></figure><p><img src="/articles/364a7d87/2.png" alt></p><p>经过上述步骤就可实现接入步骤，观察日志，如下图：</p><p><img src="/articles/364a7d87/3.png" alt></p><p>表示认证成功，后续会补充同步脚本。</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;目的&quot;&gt;&lt;a href=&quot;#目的&quot; class=&quot;headerlink&quot; title=&quot;目的&quot;&gt;&lt;/a&gt;目的&lt;/h2&gt;&lt;p&gt;cmdbuid接入openldap用户权限，便于用户统一管理。&lt;/p&gt;
    
    </summary>
    
      <category term="应用运维" scheme="https://wandouduoduo.netlify.com/categories/%E5%BA%94%E7%94%A8%E8%BF%90%E7%BB%B4/"/>
    
    
      <category term="Cmdb" scheme="https://wandouduoduo.netlify.com/tags/Cmdb/"/>
    
      <category term="Openldap" scheme="https://wandouduoduo.netlify.com/tags/Openldap/"/>
    
  </entry>
  
  <entry>
    <title>Docker版快速安装OpenLDAP</title>
    <link href="https://wandouduoduo.netlify.com/articles/931613a4.html"/>
    <id>https://wandouduoduo.netlify.com/articles/931613a4.html</id>
    <published>2019-08-28T06:58:44.000Z</published>
    <updated>2019-08-30T10:57:18.170Z</updated>
    
    <content type="html"><![CDATA[<h2 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h2><p>互联网公司中，会开发很多平台系统，有开源的有自演的，但是每个平台或系统在用户认证方面都需要做，而且处于安全等因素考虑还必须做，统一的用户管理机制可以解决这一痛点。openldap就是这么一个工具。本文，通过docker快速搭建起来，让你体会到它的魅力。</p><a id="more"></a><h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><p><a href="http://www.openldap.org" target="_blank" rel="noopener">官网</a></p><p><a href="https://github.com/osixia/docker-openldap" target="_blank" rel="noopener">镜像文档</a></p><!--more--><h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h2><h4 id="拉取镜像"><a href="#拉取镜像" class="headerlink" title="拉取镜像"></a><strong>拉取镜像</strong></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull osixia/openldap</span><br></pre></td></tr></table></figure><h4 id="运行镜像"><a href="#运行镜像" class="headerlink" title="运行镜像"></a><strong>运行镜像</strong></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#存放数据库</span></span><br><span class="line">mkdir -p /data/openldap/ldap</span><br><span class="line"><span class="comment">#存放配置</span></span><br><span class="line">mkdir -p /data/openldap/slapd.d</span><br><span class="line"></span><br><span class="line">docker run -p 389:389 --name openldap -v /data/openldap/ldap:/var/lib/ldap -v /data/openldap/slapd.d:/etc/openldap/slapd.d --network bridge --hostname openldap-host --env LDAP_ORGANISATION=<span class="string">"wandouduoduo"</span> --env LDAP_DOMAIN=<span class="string">"wandouduoduo.com"</span> --env LDAP_ADMIN_PASSWORD=<span class="string">"Sun123456"</span> --detach osixia/openldap</span><br></pre></td></tr></table></figure><p>配置LDAP域：<code>--env LDAP_DOMAIN=&quot;wandouduoduo.com&quot;</code></p><p>配置LDAP密码：<code>--env LDAP_ADMIN_PASSWORD=&quot;Sun123456&quot;</code></p><p>默认登录用户名：<code>admin</code></p><h2 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h2><h4 id="LDAP-Admin客户端"><a href="#LDAP-Admin客户端" class="headerlink" title="LDAP Admin客户端"></a>LDAP Admin客户端</h4><p>Ldap Admin是一个用于LDAP目录管理的免费Windows LDAP客户端和管理工具。此应用程序允许您在LDAP服务器上浏览，搜索，修改，创建和删除对象。它还支持更复杂的操作，例如目录复制和在远程服务器之间移动，并扩展常用编辑功能以支持特定对象类型（例如组和帐户）。</p><p>支持系统：<code>Winndows&amp;Linux</code></p><p><a href="http://www.ldapadmin.org/" target="_blank" rel="noopener">官网</a></p><p>下载安装LDAP Admin客户端，新增连接如下：</p><p><img src="/articles/931613a4/1.png" alt></p><p>连接成功即表明OpenLDAP安装成功。</p><h4 id="PHPLdapAdmin客户端"><a href="#PHPLdapAdmin客户端" class="headerlink" title="PHPLdapAdmin客户端"></a>PHPLdapAdmin客户端</h4><p>phpLDAPadmin（也称为PLA）是一个基于Web的LDAP客户端。它为LDAP服务器提供简单，随处可访问的多语言管理。</p><p>其分层树查看器和高级搜索功能使您可以直观地浏览和管理LDAP目录。由于它是一个Web应用程序，因此该LDAP浏览器可在许多平台上运行，使您可以从任何位置轻松管理LDAP服务器。</p><p>phpLDAPadmin是LDAP专业人员和新手的完美LDAP浏览器。其用户群主要由LDAP管理专业人员组成。</p><p><a href="http://phpldapadmin.sourceforge.net/wiki/index.php/Main_Page" target="_blank" rel="noopener">官网</a></p><h4 id="使用docker-安装-PHPLdapAdmin"><a href="#使用docker-安装-PHPLdapAdmin" class="headerlink" title="使用docker 安装 PHPLdapAdmin"></a>使用docker 安装 PHPLdapAdmin</h4><p><a href="https://github.com/osixia/docker-phpLDAPadmin" target="_blank" rel="noopener">https://github.com/osixia/docker-phpLDAPadmin</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --privileged -p 10004:80 --name myphpldapadmin --env PHPLDAPADMIN_HTTPS=<span class="literal">false</span> --env PHPLDAPADMIN_LDAP_HOSTS=172.17.0.6 --detach osixia/phpldapadmin</span><br></pre></td></tr></table></figure><p>配置的Ldap地址：<code>--env PHPLDAPADMIN_LDAP_HOSTS=172.17.0.6</code></p><p>配置不开启HTTPS：<code>--env PHPLDAPADMIN_HTTPS=false</code>（默认是true）</p><p>如果开启HTTPS，需要配置443端口映射：<code>-p 8443:443</code>，并采用https访问</p><p><strong>通过访问<a href="http://localhost:10004" target="_blank" rel="noopener">http://localhost:10004</a> 来管理，登陆界面</strong></p><p><img src="/articles/931613a4/2.png" alt></p><p><strong>点击login进行登录</strong></p><p><strong>Login DN：</strong><code>cn=admin,dc=wandouduoduo,dc=com</code></p><p><strong>Password：</strong><code>ldap123</code></p><p><strong>登录成功后如下：</strong></p><p><img src="/articles/931613a4/3.png" alt></p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>通过本文可以快速搭建和使用openldap, 但是默认openldap是没有打开memerof功能的，如有兴趣，请参考</p><p><a href="https://wandouduoduo.github.io/articles/53f92c3c.html" target="_blank" rel="noopener">OpenLDAP启用MemberOf</a></p><p><a href="https://blog.csdn.net/Michaelwubo/article/details/80525284" target="_blank" rel="noopener">ldapsearch用法</a></p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;目的&quot;&gt;&lt;a href=&quot;#目的&quot; class=&quot;headerlink&quot; title=&quot;目的&quot;&gt;&lt;/a&gt;目的&lt;/h2&gt;&lt;p&gt;互联网公司中，会开发很多平台系统，有开源的有自演的，但是每个平台或系统在用户认证方面都需要做，而且处于安全等因素考虑还必须做，统一的用户管理机制可以解决这一痛点。openldap就是这么一个工具。本文，通过docker快速搭建起来，让你体会到它的魅力。&lt;/p&gt;
    
    </summary>
    
      <category term="应用运维" scheme="https://wandouduoduo.netlify.com/categories/%E5%BA%94%E7%94%A8%E8%BF%90%E7%BB%B4/"/>
    
    
      <category term="Openldap" scheme="https://wandouduoduo.netlify.com/tags/Openldap/"/>
    
  </entry>
  
  <entry>
    <title>OpenLDAP启用MemberOf</title>
    <link href="https://wandouduoduo.netlify.com/articles/53f92c3c.html"/>
    <id>https://wandouduoduo.netlify.com/articles/53f92c3c.html</id>
    <published>2019-08-28T06:35:09.000Z</published>
    <updated>2019-09-04T07:41:09.131Z</updated>
    
    <content type="html"><![CDATA[<h2 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h2><p>默认情况下OpenLDAP的用户组属性是Posixgroup，Posixgroup用户组和用户没有实际的对应关系。如果需要把Posixgroup和user关联起来则需要将用户添加到对应的组中。 通过如上配置可以满足大部分业务场景，但是如果需要通过用户组来查找用户的话，Posixgroup用户组属性，是无法满足要求的。此时需要使用OpenLDAP的groupOfUniqueNames用户组属性。本篇文章Fayson主要介绍如何为OpenLDAP启用MemberOf。</p><a id="more"></a><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><p>OpenLDAP版本为2.4.44</p><h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h2><h4 id="先查看openldap的数据库信息"><a href="#先查看openldap的数据库信息" class="headerlink" title="先查看openldap的数据库信息"></a>先查看openldap的数据库信息</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ls /etc/openldap/slapd.d/cn=config/</span><br><span class="line">或者</span><br><span class="line">ldapsearch -Q -LLL -Y EXTERNAL -H ldapi:/// -b cn=config dn</span><br></pre></td></tr></table></figure><p>得到的结果大概如下，不一样也不要害怕:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cn=module&#123;0&#125;.ldif cn=schema/ cn=schema.ldif olcDatabase=&#123;0&#125;config.ldif olcDatabase=&#123;-1&#125;frontend.ldif olcDatabase=&#123;1&#125;monitor.ldif olcDatabase=&#123;2&#125;bdb/ olcDatabase=&#123;2&#125;bdb.ldif</span><br></pre></td></tr></table></figure><p>其中有一个带什么<code>db.ldif</code>的就是你最终需要修改的数据库文件，我这里是<code>bdb.ldif</code>，你的可能是<code>mdb.ldif</code>，还有人是<code>hdb.ldif</code>，不管什么<code>db</code>，总之你要改的是一个叫<code>db</code>的文件就对了，你可以<code>cat</code>打开看一看，但是不要用<code>vi</code>去修改它。</p><h4 id="准备memberof-conf-ldif文件"><a href="#准备memberof-conf-ldif文件" class="headerlink" title="准备memberof_conf.ldif文件"></a>准备memberof_conf.ldif文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">vim memberof_conf.ldif</span><br><span class="line"></span><br><span class="line"><span class="comment">#开启memberof支持</span></span><br><span class="line">dn: cn=module&#123;0&#125;,cn=config</span><br><span class="line">cn: modulle&#123;0&#125;</span><br><span class="line">objectClass: olcModuleList</span><br><span class="line">objectclass: top</span><br><span class="line">olcModuleload: memberof.la</span><br><span class="line">olcModulePath: /usr/lib64/openldap</span><br><span class="line"></span><br><span class="line"><span class="comment">#新增用户支持memberof配置</span></span><br><span class="line">dn: olcOverlay=&#123;0&#125;memberof,olcDatabase=&#123;2&#125;hdb,cn=config</span><br><span class="line">objectClass: olcConfig</span><br><span class="line">objectClass: olcMemberOf</span><br><span class="line">objectClass: olcOverlayConfig</span><br><span class="line">objectClass: top</span><br><span class="line">olcOverlay: memberof</span><br><span class="line">olcMemberOfDangling: ignore</span><br><span class="line">olcMemberOfRefInt: TRUE</span><br><span class="line">olcMemberOfGroupOC: groupOfUniqueNames</span><br><span class="line">olcMemberOfMemberAD: uniqueMember</span><br><span class="line">olcMemberOfMemberOfAD: memberOf</span><br></pre></td></tr></table></figure><p><img src="/articles/53f92c3c/1.jpeg" alt></p><h4 id="编辑refint1-ldif文件"><a href="#编辑refint1-ldif文件" class="headerlink" title="编辑refint1.ldif文件"></a>编辑refint1.ldif文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim refint1.ldif </span><br><span class="line"></span><br><span class="line">dn: cn=module&#123;0&#125;,cn=config</span><br><span class="line">add: olcmoduleload</span><br><span class="line">olcmoduleload: refint</span><br></pre></td></tr></table></figure><p><img src="/articles/53f92c3c/2.png" alt></p><h4 id="编辑refint2-ldif文件"><a href="#编辑refint2-ldif文件" class="headerlink" title="编辑refint2.ldif文件"></a>编辑refint2.ldif文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> vim refint2.ldif </span><br><span class="line"> </span><br><span class="line">dn: olcOverlay=refint,olcDatabase=&#123;2&#125;hdb,cn=config</span><br><span class="line">objectClass: olcConfig</span><br><span class="line">objectClass: olcOverlayConfig</span><br><span class="line">objectClass: olcRefintConfig</span><br><span class="line">objectClass: top</span><br><span class="line">olcOverlay: refint</span><br><span class="line">olcRefintAttribute: memberof member manager owner</span><br><span class="line"><span class="comment">#olcRefintAttribute: memberof uniqueMember  manager owner</span></span><br></pre></td></tr></table></figure><p><img src="/articles/53f92c3c/3.jpeg" alt></p><h4 id="导入配置"><a href="#导入配置" class="headerlink" title="导入配置"></a>导入配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#注意：导入时文件路径跟绝对路径</span></span><br><span class="line">ldapadd -Q -Y EXTERNAL -H ldapi:/// -f  /data/disk1/openladp/memberof_conf.ldif </span><br><span class="line">ldapmodify -Q -Y EXTERNAL -H ldapi:/// -f  /data/disk1/openladp/refint1.ldif </span><br><span class="line">ldapadd -Q -Y EXTERNAL -H ldapi:/// -f /data/disk1/openladp/refint2.ldif</span><br></pre></td></tr></table></figure><p><img src="/articles/53f92c3c/4.jpeg" alt></p><p>以上步骤就完成了OpenLDAP的MemberOf模块启用。</p><h2 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h2><p>验证一下配置，这个命令可以列出所有配置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">slapcat -b cn=config</span><br></pre></td></tr></table></figure><p><strong>创建用户测试</strong></p><p>1, 创建一个测试用户cdsw_a,ldif文件内容如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">vim cdsw_user.ldif</span><br><span class="line"></span><br><span class="line">dn: uid=cdsw_a,ou=People,dc=fayson,dc=com</span><br><span class="line">uid: cdsw_a</span><br><span class="line">cn: cdsw_a</span><br><span class="line">objectClass: account</span><br><span class="line">objectClass: posixAccount</span><br><span class="line">objectClass: top</span><br><span class="line">objectClass: shadowAccount</span><br><span class="line">userPassword: 123456</span><br><span class="line">shadowLastChange: 17694</span><br><span class="line">shadowMin: 0</span><br><span class="line">shadowMax: 99999</span><br><span class="line">shadowWarning: 7</span><br><span class="line">loginShell: /bin/bash</span><br><span class="line">uidNumber: 10001</span><br><span class="line">gidNumber: 10001</span><br><span class="line">homeDirectory: /home/cdsw_a</span><br></pre></td></tr></table></figure><p>2, 执行如下命令将cdsw_a用户导入到OpenLDAP中</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldapadd -D &quot;cn=Manager,dc=fayson,dc=com&quot; -W -x -f cdsw_user.ldif</span><br></pre></td></tr></table></figure><p><img src="/articles/53f92c3c/5.png" alt></p><p>3, 创建一个新的groupOfUniqueNames用户组，并把cdsw_a用户添加到该组</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vim cdsw_group.ldif </span><br><span class="line"></span><br><span class="line">dn: cn=cdsw_admin,ou=Group,dc=fayson,dc=com</span><br><span class="line">objectClass: groupOfUniqueNames</span><br><span class="line">cn: cdsw_admin</span><br><span class="line">uniqueMember: uid=cdsw_a,ou=People,dc=fayson,dc=com</span><br></pre></td></tr></table></figure><p><img src="/articles/53f92c3c/6.png" alt></p><ol start="4"><li>将cdsw_admin组添加到OpenLDAP中</li></ol><p><img src="/articles/53f92c3c/7.png" alt></p><ol start="5"><li>通过命令查看用户所属组，命令如下</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldapsearch -LL -Y EXTERNAL -H ldapi:/// <span class="string">"(uid=cdsw_a)"</span> -b dc=fayson,dc=com memberOf</span><br></pre></td></tr></table></figure><p><img src="/articles/53f92c3c/10.jpeg" alt></p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a><strong>总结</strong></h2><p>在OpenLDAP中配置启用MemberOf时需要注意配置文件的通配符{0}/{2},这个数字不是随意指定的而是根据当前的/etc/openldap/slapd.d/cn=config/生成的内容得出</p><p><img src="/articles/53f92c3c/8.jpeg" alt></p><p>搜索例子</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># docker openldap</span><br><span class="line">docker exec xxxx ldapsearch -x -D &quot;cn=admin,dc=xxxx,dc=com&quot; -w &quot;xxxx&quot; -b &quot;dc=xxxx,dc=com&quot; &quot;cn=*&quot;</span><br><span class="line"></span><br><span class="line">#现在默认用docker安装openldap是开启了memberof，所以直接添加用户，添加用户组后，直接用下面命令验证</span><br><span class="line">ldapsearch -LL  -H ldapi:/// -D &quot;cn=admin,dc=xxx,dc=net&quot; -W &quot;(uid=sunxu)&quot; -b dc=xxx,dc=net memberOf</span><br></pre></td></tr></table></figure><p><img src="/articles/53f92c3c/8.png" alt></p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;目的&quot;&gt;&lt;a href=&quot;#目的&quot; class=&quot;headerlink&quot; title=&quot;目的&quot;&gt;&lt;/a&gt;目的&lt;/h2&gt;&lt;p&gt;默认情况下OpenLDAP的用户组属性是Posixgroup，Posixgroup用户组和用户没有实际的对应关系。如果需要把Posixgroup和user关联起来则需要将用户添加到对应的组中。 通过如上配置可以满足大部分业务场景，但是如果需要通过用户组来查找用户的话，Posixgroup用户组属性，是无法满足要求的。此时需要使用OpenLDAP的groupOfUniqueNames用户组属性。本篇文章Fayson主要介绍如何为OpenLDAP启用MemberOf。&lt;/p&gt;
    
    </summary>
    
      <category term="应用运维" scheme="https://wandouduoduo.netlify.com/categories/%E5%BA%94%E7%94%A8%E8%BF%90%E7%BB%B4/"/>
    
    
      <category term="Openldap" scheme="https://wandouduoduo.netlify.com/tags/Openldap/"/>
    
  </entry>
  
  <entry>
    <title>Centos7上配置最新版openldap服务多主模式(镜像模式)</title>
    <link href="https://wandouduoduo.netlify.com/articles/3337f7d4.html"/>
    <id>https://wandouduoduo.netlify.com/articles/3337f7d4.html</id>
    <published>2019-08-28T05:54:54.000Z</published>
    <updated>2019-08-28T11:26:27.212Z</updated>
    
    <content type="html"><![CDATA[<h2 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h2><p>在实际产线运维环境下，使用最多的就是镜像模式，当然多IDC机房的情况下也会结合使用其他模式，例如主从模式。</p><p>镜像模式只允许2个主节点，如果超过2个节点其他节点只会同步获取前面2个节点的配置（这个是博客文档里面看到的，没有验证）</p><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><table><thead><tr><th align="center">主机名称</th><th align="center">地址</th><th align="center">版本</th><th align="center">角色</th><th align="center">备注</th></tr></thead><tbody><tr><td align="center">sysldap-shylf-1</td><td align="center">10.116.72.11</td><td align="center">CentOS7.6 min</td><td align="center">openLdap, httpd, phpldapadmin</td><td align="center">主节点</td></tr><tr><td align="center">sysldap-shylf-2</td><td align="center">10.116.72.12</td><td align="center">CentOS7.6 min</td><td align="center">openLdap, httpd, phpldapadmin</td><td align="center">主节点</td></tr><tr><td align="center">systerm-shylf-1</td><td align="center">10.116.72.15</td><td align="center">CentOS7.6 min</td><td align="center">openLdap client</td><td align="center"></td></tr></tbody></table><p>前提条件，为了方便配置防火墙以及禁用selinux<br>配置示例:dc=example,dc=com</p><a id="more"></a><h2 id="OpenLDAP服务基础配置"><a href="#OpenLDAP服务基础配置" class="headerlink" title="OpenLDAP服务基础配置"></a>OpenLDAP服务基础配置</h2><p>本文档假设2个节点都已经设置好了<a href="https://wandouduoduo.github.io/articles/be8d00d3.html#more" target="_blank" rel="noopener">OpenLDAP服务基础配置</a></p><h2 id="配置OpenLDAP-双主结构（mirrormode）"><a href="#配置OpenLDAP-双主结构（mirrormode）" class="headerlink" title="配置OpenLDAP 双主结构（mirrormode）"></a>配置OpenLDAP 双主结构（mirrormode）</h2><h3 id="OpenLDAP的2个主节点都需要添加模块syncprov"><a href="#OpenLDAP的2个主节点都需要添加模块syncprov" class="headerlink" title="OpenLDAP的2个主节点都需要添加模块syncprov"></a>OpenLDAP的2个主节点都需要添加模块syncprov</h3><p><strong><code>2个主节点都需要执行</code></strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">vim mod_syncprov.ldif</span><br><span class="line"></span><br><span class="line">dn: cn=module,cn=config</span><br><span class="line">objectClass: olcModuleList</span><br><span class="line">cn: module</span><br><span class="line">olcModulePath: /usr/lib64/openldap</span><br><span class="line">olcModuleLoad: syncprov.la</span><br><span class="line"></span><br><span class="line"><span class="comment"># 发送配置使之生效</span></span><br><span class="line">ldapadd -Y EXTERNAL -H ldapi:/// -f mod_syncprov.ldif</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------------------</span></span><br><span class="line">vim syncprov.ldif</span><br><span class="line">dn: olcOverlay=syncprov,olcDatabase=&#123;2&#125;hdb,cn=config</span><br><span class="line">objectClass: olcOverlayConfig</span><br><span class="line">objectClass: olcSyncProvConfig</span><br><span class="line">olcOverlay: syncprov</span><br><span class="line">olcSpSessionLog: 100</span><br><span class="line"></span><br><span class="line"><span class="comment"># 发送配置使之生效</span></span><br><span class="line">ldapadd -Y EXTERNAL -H ldapi:/// -f syncprov.ldif</span><br></pre></td></tr></table></figure><h3 id="主节点1配置-10-116-72-11-同步"><a href="#主节点1配置-10-116-72-11-同步" class="headerlink" title="主节点1配置(10.116.72.11)同步"></a>主节点1配置(10.116.72.11)同步</h3><p>需要根据实际情况修改的参数：<br>provider 同步来源，也就是主节点，可以包含多个主节点<br>binddn 主节点管理账户<br>credentials 主节点管理账户密码<br>searchbase 根目录<br><strong><code>特别主机：2个主节点属性 olcServerID的值不能相同，provider指向对方</code></strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">vim master_node_1.ldif</span><br><span class="line">dn: cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">replace: olcServerID</span><br><span class="line">olcServerID: 0</span><br><span class="line"></span><br><span class="line">dn: olcDatabase=&#123;2&#125;hdb,cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">add: olcSyncRepl</span><br><span class="line">olcSyncRepl: rid=001</span><br><span class="line">  provider=ldap://10.116.72.12:389/</span><br><span class="line">  bindmethod=simple</span><br><span class="line">  binddn=<span class="string">"cn=Manager,dc=example,dc=com"</span></span><br><span class="line">  credentials=openldap</span><br><span class="line">  searchbase=<span class="string">"dc=example,dc=com"</span></span><br><span class="line">  scope=sub</span><br><span class="line">  schemachecking=on</span><br><span class="line">  <span class="built_in">type</span>=refreshAndPersist</span><br><span class="line">  retry=<span class="string">"30 5 300 3"</span></span><br><span class="line">  interval=00:00:05:00</span><br><span class="line">-</span><br><span class="line">add: olcMirrorMode</span><br><span class="line">olcMirrorMode: TRUE</span><br><span class="line"></span><br><span class="line">dn: olcOverlay=syncprov,olcDatabase=&#123;2&#125;hdb,cn=config</span><br><span class="line">changetype: add</span><br><span class="line">objectClass: olcOverlayConfig</span><br><span class="line">objectClass: olcSyncProvConfig</span><br><span class="line">olcOverlay: syncprov</span><br><span class="line"></span><br><span class="line"><span class="comment"># 发送配置使之生效</span></span><br><span class="line">ldapadd -Y EXTERNAL -H ldapi:/// -f master_node_1.ldif</span><br></pre></td></tr></table></figure><h3 id="主节点2配置-10-116-72-12-同步"><a href="#主节点2配置-10-116-72-12-同步" class="headerlink" title="主节点2配置(10.116.72.12)同步"></a>主节点2配置(10.116.72.12)同步</h3><p><strong>特别主机：2个主节点属性 olcServerID的值不能相同，provider指向对方</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">vim master_node_2.ldif</span><br><span class="line"></span><br><span class="line">dn: cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">replace: olcServerID</span><br><span class="line">olcServerID: 1</span><br><span class="line"></span><br><span class="line">dn: olcDatabase=&#123;2&#125;hdb,cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">add: olcSyncRepl</span><br><span class="line">olcSyncRepl: rid=001</span><br><span class="line">  provider=ldap://10.116.72.11:389/</span><br><span class="line">  bindmethod=simple</span><br><span class="line">  binddn=<span class="string">"cn=Manager,dc=example,dc=com"</span></span><br><span class="line">  credentials=openldap</span><br><span class="line">  searchbase=<span class="string">"dc=example,dc=com"</span></span><br><span class="line">  scope=sub</span><br><span class="line">  schemachecking=on</span><br><span class="line">  <span class="built_in">type</span>=refreshAndPersist</span><br><span class="line">  retry=<span class="string">"30 5 300 3"</span></span><br><span class="line">  interval=00:00:05:00</span><br><span class="line">-</span><br><span class="line">add: olcMirrorMode</span><br><span class="line">olcMirrorMode: TRUE</span><br><span class="line"></span><br><span class="line">dn: olcOverlay=syncprov,olcDatabase=&#123;2&#125;hdb,cn=config</span><br><span class="line">changetype: add</span><br><span class="line">objectClass: olcOverlayConfig</span><br><span class="line">objectClass: olcSyncProvConfig</span><br><span class="line">olcOverlay: syncprov</span><br><span class="line"></span><br><span class="line"><span class="comment"># 发送配置使之生效</span></span><br><span class="line">ldapadd -Y EXTERNAL -H ldapi:/// -f master_node_2.ldif</span><br></pre></td></tr></table></figure><ul><li>验证</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">从服务节点验证数据是否同步正常</span><br><span class="line">ldapsearch -x -b <span class="string">'ou=People,dc=example,dc=com'</span></span><br><span class="line">[输出内容省略]</span><br><span class="line"></span><br><span class="line">验证是OK的。</span><br></pre></td></tr></table></figure><h3 id="远程主机配置（客户端-10-116-72-15）"><a href="#远程主机配置（客户端-10-116-72-15）" class="headerlink" title="远程主机配置（客户端 10.116.72.15）"></a>远程主机配置（客户端 10.116.72.15）</h3><p>客户端 可以指定多个openldap uri 修改配置如下（当然也可以只配置其中1个）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">authconfig --enableldap --enableldapauth --ldapserver=<span class="string">"10.116.72.11,10.116.72.12"</span> --ldapbasedn=<span class="string">"dc=example,dc=com"</span> --update</span><br></pre></td></tr></table></figure><ul><li>验证</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ssh  800001@10.116.72.15</span><br><span class="line">Warning: Permanently added <span class="string">'10.116.72.15'</span> (ECDSA) to the list of known hosts.</span><br><span class="line">800001@10.116.72.15<span class="string">'s password: </span></span><br><span class="line"><span class="string">Last login: Thu Jul  4 17:59:32 2019 from 10.116.71.200</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[800001@systerm-shylf-1 ~]$</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;目的&quot;&gt;&lt;a href=&quot;#目的&quot; class=&quot;headerlink&quot; title=&quot;目的&quot;&gt;&lt;/a&gt;目的&lt;/h2&gt;&lt;p&gt;在实际产线运维环境下，使用最多的就是镜像模式，当然多IDC机房的情况下也会结合使用其他模式，例如主从模式。&lt;/p&gt;
&lt;p&gt;镜像模式只允许2个主节点，如果超过2个节点其他节点只会同步获取前面2个节点的配置（这个是博客文档里面看到的，没有验证）&lt;/p&gt;
&lt;h2 id=&quot;环境&quot;&gt;&lt;a href=&quot;#环境&quot; class=&quot;headerlink&quot; title=&quot;环境&quot;&gt;&lt;/a&gt;环境&lt;/h2&gt;&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th align=&quot;center&quot;&gt;主机名称&lt;/th&gt;
&lt;th align=&quot;center&quot;&gt;地址&lt;/th&gt;
&lt;th align=&quot;center&quot;&gt;版本&lt;/th&gt;
&lt;th align=&quot;center&quot;&gt;角色&lt;/th&gt;
&lt;th align=&quot;center&quot;&gt;备注&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;sysldap-shylf-1&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;10.116.72.11&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;CentOS7.6 min&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;openLdap, httpd, phpldapadmin&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;主节点&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;sysldap-shylf-2&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;10.116.72.12&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;CentOS7.6 min&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;openLdap, httpd, phpldapadmin&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;主节点&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;systerm-shylf-1&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;10.116.72.15&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;CentOS7.6 min&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;openLdap client&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;p&gt;前提条件，为了方便配置防火墙以及禁用selinux&lt;br&gt;配置示例:dc=example,dc=com&lt;/p&gt;
    
    </summary>
    
      <category term="应用运维" scheme="https://wandouduoduo.netlify.com/categories/%E5%BA%94%E7%94%A8%E8%BF%90%E7%BB%B4/"/>
    
    
      <category term="Openldap" scheme="https://wandouduoduo.netlify.com/tags/Openldap/"/>
    
  </entry>
  
  <entry>
    <title>Centos7上配置最新版openldap服务主从架构</title>
    <link href="https://wandouduoduo.netlify.com/articles/760f3c02.html"/>
    <id>https://wandouduoduo.netlify.com/articles/760f3c02.html</id>
    <published>2019-08-28T05:44:44.000Z</published>
    <updated>2019-08-28T06:06:51.100Z</updated>
    
    <content type="html"><![CDATA[<h2 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h2><p>在实际产线运维环境下，可能包含多个IDC机房，每个机房的主机都需要通过OpenLDAP体系管理运维账户登录。这种情况下可以配置OpenLDAP的主从架构实现(当然同一个机房也可以配置主从架构，客户端配置ldap uri指定多个地址)。主openldap节点称为“provider”可读可写，从openldap节点称为“consumer”只读。</p><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><table><thead><tr><th align="center">主机名称</th><th align="center">地址</th><th align="center">版本</th><th align="center">角色</th><th align="center">备注</th></tr></thead><tbody><tr><td align="center">sysldap-shylf-1</td><td align="center">10.116.72.11</td><td align="center">CentOS7.6 min</td><td align="center">openLdap, httpd, phpldapadmin</td><td align="center">主节点</td></tr><tr><td align="center">sysldap-shylf-2</td><td align="center">10.116.72.12</td><td align="center">CentOS7.6 min</td><td align="center">openLdap</td><td align="center">从节点，可以配置多从的</td></tr><tr><td align="center">systerm-shylf-1</td><td align="center">10.116.72.15</td><td align="center">CentOS7.6 min</td><td align="center">openLdap client</td><td align="center"></td></tr></tbody></table><p>前提条件，为了方便配置防火墙以及禁用selinux<br>配置示例:dc=example,dc=com</p><a id="more"></a><h2 id="OpenLDAP服务基础配置"><a href="#OpenLDAP服务基础配置" class="headerlink" title="OpenLDAP服务基础配置"></a>OpenLDAP服务基础配置</h2><p>本文档假设2个节点都已经设置好了<a href="https://wandouduoduo.github.io/articles/be8d00d3.html#more" target="_blank" rel="noopener">OpenLDAP服务基础配置</a></p><h2 id="配置OpenLDAP主从结构"><a href="#配置OpenLDAP主从结构" class="headerlink" title="配置OpenLDAP主从结构"></a>配置OpenLDAP主从结构</h2><h3 id="主节点配置-10-116-72-11-，添加模块syncprov"><a href="#主节点配置-10-116-72-11-，添加模块syncprov" class="headerlink" title="主节点配置(10.116.72.11)，添加模块syncprov"></a>主节点配置(10.116.72.11)，添加模块syncprov</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">vim mod_syncprov.ldif</span><br><span class="line"></span><br><span class="line">dn: cn=module,cn=config</span><br><span class="line">objectClass: olcModuleList</span><br><span class="line">cn: module</span><br><span class="line">olcModulePath: /usr/lib64/openldap</span><br><span class="line">olcModuleLoad: syncprov.la</span><br><span class="line"></span><br><span class="line"><span class="comment"># 发送配置使之生效</span></span><br><span class="line">ldapadd -Y EXTERNAL -H ldapi:/// -f mod_syncprov.ldif</span><br><span class="line"></span><br><span class="line"><span class="comment">#--------------------------------------</span></span><br><span class="line">vim syncprov.ldif</span><br><span class="line">dn: olcOverlay=syncprov,olcDatabase=&#123;2&#125;hdb,cn=config</span><br><span class="line">objectClass: olcOverlayConfig</span><br><span class="line">objectClass: olcSyncProvConfig</span><br><span class="line">olcOverlay: syncprov</span><br><span class="line">olcSpSessionLog: 100</span><br><span class="line"></span><br><span class="line"><span class="comment"># 发送配置使之生效</span></span><br><span class="line">ldapadd -Y EXTERNAL -H ldapi:/// -f syncprov.ldif</span><br></pre></td></tr></table></figure><h3 id="从节点配置-10-116-72-12-同步"><a href="#从节点配置-10-116-72-12-同步" class="headerlink" title="从节点配置(10.116.72.12)同步"></a>从节点配置(10.116.72.12)同步</h3><p>需要根据实际情况修改的参数：<br>provider 同步来源，也就是主节点，可以包含多个主节点<br>binddn 主节点管理账户<br>credentials 主节点管理账户密码<br>searchbase 根目录</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">vim syncrepl.ldif</span><br><span class="line"></span><br><span class="line">dn: olcDatabase=&#123;2&#125;hdb,cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">add: olcSyncRepl</span><br><span class="line">olcSyncRepl: rid=001</span><br><span class="line">  provider=ldap://10.116.72.11:389/</span><br><span class="line">  bindmethod=simple</span><br><span class="line">  binddn=<span class="string">"cn=Manager,dc=example,dc=com"</span></span><br><span class="line">  credentials=openldap</span><br><span class="line">  searchbase=<span class="string">"dc=example,dc=com"</span></span><br><span class="line">  scope=sub</span><br><span class="line">  schemachecking=on</span><br><span class="line">  <span class="built_in">type</span>=refreshAndPersist</span><br><span class="line">  retry=<span class="string">"30 5 300 3"</span></span><br><span class="line">  interval=00:00:05:00</span><br><span class="line"></span><br><span class="line"><span class="comment"># 发送配置使之生效</span></span><br><span class="line">ldapadd -Y EXTERNAL -H ldapi:/// -f syncrepl.ldif</span><br></pre></td></tr></table></figure><ul><li>验证</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">从服务节点验证数据是否同步正常</span><br><span class="line">ldapsearch -x -b &apos;ou=People,dc=example,dc=com&apos;</span><br><span class="line">[输出内容省略]</span><br><span class="line"></span><br><span class="line">验证是OK的。</span><br></pre></td></tr></table></figure><h3 id="远程主机配置（客户端-10-116-72-15）"><a href="#远程主机配置（客户端-10-116-72-15）" class="headerlink" title="远程主机配置（客户端 10.116.72.15）"></a>远程主机配置（客户端 10.116.72.15）</h3><p>客户端 可以指定多个openldap uri 修改配置如下（当然也可以只配置其中1个）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">authconfig --enableldap --enableldapauth --ldapserver=<span class="string">"10.116.72.11,10.116.72.12"</span> --ldapbasedn=<span class="string">"dc=example,dc=com"</span> --update</span><br></pre></td></tr></table></figure><ul><li>验证</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ssh  800001@10.116.72.15</span><br><span class="line">Warning: Permanently added <span class="string">'10.116.72.15'</span> (ECDSA) to the list of known hosts.</span><br><span class="line">800001@10.116.72.15<span class="string">'s password: </span></span><br><span class="line"><span class="string">Last login: Thu Jul  4 17:59:32 2019 from 10.116.71.200</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[800001@systerm-shylf-1 ~]$</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;目的&quot;&gt;&lt;a href=&quot;#目的&quot; class=&quot;headerlink&quot; title=&quot;目的&quot;&gt;&lt;/a&gt;目的&lt;/h2&gt;&lt;p&gt;在实际产线运维环境下，可能包含多个IDC机房，每个机房的主机都需要通过OpenLDAP体系管理运维账户登录。这种情况下可以配置OpenLDAP的主从架构实现(当然同一个机房也可以配置主从架构，客户端配置ldap uri指定多个地址)。主openldap节点称为“provider”可读可写，从openldap节点称为“consumer”只读。&lt;/p&gt;
&lt;h2 id=&quot;环境&quot;&gt;&lt;a href=&quot;#环境&quot; class=&quot;headerlink&quot; title=&quot;环境&quot;&gt;&lt;/a&gt;环境&lt;/h2&gt;&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th align=&quot;center&quot;&gt;主机名称&lt;/th&gt;
&lt;th align=&quot;center&quot;&gt;地址&lt;/th&gt;
&lt;th align=&quot;center&quot;&gt;版本&lt;/th&gt;
&lt;th align=&quot;center&quot;&gt;角色&lt;/th&gt;
&lt;th align=&quot;center&quot;&gt;备注&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;sysldap-shylf-1&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;10.116.72.11&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;CentOS7.6 min&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;openLdap, httpd, phpldapadmin&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;主节点&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;sysldap-shylf-2&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;10.116.72.12&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;CentOS7.6 min&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;openLdap&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;从节点，可以配置多从的&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td align=&quot;center&quot;&gt;systerm-shylf-1&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;10.116.72.15&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;CentOS7.6 min&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;openLdap client&lt;/td&gt;
&lt;td align=&quot;center&quot;&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;p&gt;前提条件，为了方便配置防火墙以及禁用selinux&lt;br&gt;配置示例:dc=example,dc=com&lt;/p&gt;
    
    </summary>
    
      <category term="应用运维" scheme="https://wandouduoduo.netlify.com/categories/%E5%BA%94%E7%94%A8%E8%BF%90%E7%BB%B4/"/>
    
    
      <category term="Openldap" scheme="https://wandouduoduo.netlify.com/tags/Openldap/"/>
    
  </entry>
  
  <entry>
    <title>Centos7上单节点安装配置最新版openldap服务</title>
    <link href="https://wandouduoduo.netlify.com/articles/be8d00d3.html"/>
    <id>https://wandouduoduo.netlify.com/articles/be8d00d3.html</id>
    <published>2019-08-28T03:31:13.000Z</published>
    <updated>2019-08-28T04:34:44.918Z</updated>
    
    <content type="html"><![CDATA[<h2 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h2><p>本文详细介绍了在centos7上安装最新版openldap的过程和常见场景。</p><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><p>操作系统：centos7.6</p><p>软件版本：openldap-2.4.44</p><p>配置示例:   dc=example,dc=com</p><a id="more"></a><h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><p>为了方便配置防火墙以及禁用selinux，或者关闭防火墙。</p><p>查看防火墙状态</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --state</span><br></pre></td></tr></table></figure><p>停止firewall</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld.service</span><br></pre></td></tr></table></figure><p>禁止firewall开机启动</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl disable firewalld.service</span><br></pre></td></tr></table></figure><p>关闭selinux </p><p>进入到/etc/selinux/config文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/selinux/config</span><br><span class="line">将SELINUX=enforcing改为SELINUX=disabled</span><br></pre></td></tr></table></figure><h2 id="OpenLDAP服务端配置"><a href="#OpenLDAP服务端配置" class="headerlink" title="OpenLDAP服务端配置"></a>OpenLDAP服务端配置</h2><p>创建一个配置目录，将相关配置文件放在这个目录下面</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">openldap</span><br><span class="line">├── base.ldif</span><br><span class="line">├── config.ldif</span><br><span class="line">├── demo.ldif</span><br><span class="line">├── loglevel.ldif</span><br><span class="line">├── schema</span><br><span class="line">│   ├── sudo.ldif</span><br><span class="line">│   └── sudo.schema</span><br><span class="line">├── sudo_ops_role.ldif</span><br><span class="line">└── SUODers.ldif</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> openldap</span><br></pre></td></tr></table></figure><h2 id="安装LDAP组件并启动服务"><a href="#安装LDAP组件并启动服务" class="headerlink" title="安装LDAP组件并启动服务"></a>安装LDAP组件并启动服务</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yum安装</span></span><br><span class="line">yum -y install openldap  openldap-clients openldap-servers </span><br><span class="line"></span><br><span class="line"><span class="comment"># 建立Ldap数据库</span></span><br><span class="line">cp /usr/share/openldap-servers/DB_CONFIG.example /var/lib/ldap/DB_CONFIG</span><br><span class="line">chown ldap:ldap /var/lib/ldap/*</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动和开机自启</span></span><br><span class="line">systemctl start slapd.service</span><br><span class="line">systemctl <span class="built_in">enable</span> slapd.service</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证</span></span><br><span class="line">netstat -antup | grep -i 389</span><br><span class="line">tcp     0    0 0.0.0.0:389      0.0.0.0:*   LISTEN      16349/slapd     </span><br><span class="line">tcp6    0    0 :::389           :::*        LISTEN      16349/slapd</span><br></pre></td></tr></table></figure><h2 id="配置OpenLDAP服务"><a href="#配置OpenLDAP服务" class="headerlink" title="配置OpenLDAP服务"></a>配置OpenLDAP服务</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成Ldap root密码</span></span><br><span class="line">~]<span class="comment"># slappasswd</span></span><br><span class="line">New password: openldap</span><br><span class="line">Re-enter new password: openldap </span><br><span class="line">&#123;SSHA&#125;npo7WhvpY+s4+p584zAnoduStQzeTxHE</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加需要的schemas [可以根据需要添加更多]</span></span><br><span class="line">ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/cosine.ldif</span><br><span class="line">ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/nis.ldif </span><br><span class="line">ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/inetorgperson.ldif</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置openLDAP服务</span></span><br><span class="line">vim config.ldif</span><br><span class="line"></span><br><span class="line">dn: olcDatabase=&#123;1&#125;monitor,cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">replace: olcAccess</span><br><span class="line">olcAccess: &#123;0&#125;to * by dn.base=<span class="string">"gidNumber=0+uidNumber=0,cn=peercred,cn=external, cn=auth"</span> <span class="built_in">read</span> by dn.base=<span class="string">"cn=Manager,dc=example,dc=com"</span> <span class="built_in">read</span> by * none</span><br><span class="line"></span><br><span class="line">dn: olcDatabase=&#123;2&#125;hdb,cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">replace: olcSuffix</span><br><span class="line">olcSuffix: dc=example,dc=com</span><br><span class="line"></span><br><span class="line">dn: olcDatabase=&#123;2&#125;hdb,cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">replace: olcRootDN</span><br><span class="line">olcRootDN: cn=Manager,dc=example,dc=com</span><br><span class="line"></span><br><span class="line">dn: olcDatabase=&#123;2&#125;hdb,cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">replace: olcRootPW</span><br><span class="line">olcRootPW: &#123;SSHA&#125;npo7WhvpY+s4+p584zAnoduStQzeTxHE</span><br><span class="line"></span><br><span class="line">dn: olcDatabase=&#123;2&#125;hdb,cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">add: olcAccess</span><br><span class="line">olcAccess: &#123;0&#125;to attrs=userPassword,shadowLastChange by dn=<span class="string">"cn=Manager,dc=example,dc=com"</span> write by anonymous auth by self write by * none</span><br><span class="line">olcAccess: &#123;1&#125;to dn.base=<span class="string">""</span> by * <span class="built_in">read</span></span><br><span class="line">olcAccess: &#123;2&#125;to * by dn=<span class="string">"cn=Manager,dc=example,dc=com"</span> write by * <span class="built_in">read</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 发送配置到LDAP服务</span></span><br><span class="line">ldapmodify -Y EXTERNAL  -H ldapi:/// -f config.ldif</span><br><span class="line"></span><br><span class="line"><span class="comment"># 域example.com配置</span></span><br><span class="line">vi base.ldif</span><br><span class="line"></span><br><span class="line">dn: dc=example,dc=com</span><br><span class="line">o: example com</span><br><span class="line">dc: example</span><br><span class="line">objectClass: top</span><br><span class="line">objectClass: dcObject</span><br><span class="line">objectClass: organization</span><br><span class="line"></span><br><span class="line">dn: cn=Manager,dc=example,dc=com</span><br><span class="line">objectClass: organizationalRole</span><br><span class="line">cn: Manager</span><br><span class="line">description: LDAP Manager</span><br><span class="line"></span><br><span class="line">dn: ou=People,dc=example,dc=com</span><br><span class="line">objectClass: organizationalUnit</span><br><span class="line">ou: People</span><br><span class="line"></span><br><span class="line">dn: ou=Group,dc=example,dc=com</span><br><span class="line">objectClass: organizationalUnit</span><br><span class="line">ou: Group</span><br><span class="line"></span><br><span class="line"><span class="comment"># 发送配置到LDAP服务</span></span><br><span class="line">ldapadd -x -W -D <span class="string">"cn=Manager,dc=example,dc=com"</span> -f base.ldif</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置ldap log</span></span><br><span class="line">vim loglevel.ldif</span><br><span class="line"></span><br><span class="line">dn: cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">replace: olcLogLevel</span><br><span class="line">olcLogLevel: stats</span><br><span class="line"></span><br><span class="line"><span class="comment"># 发送配置到LDAP服务</span></span><br><span class="line">ldapmodify -Y EXTERNAL -H ldapi:/// -f loglevel.ldif</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"local4.*  /var/log/slapd/slapd.log"</span> &gt;&gt; /etc/rsyslog.conf</span><br><span class="line"></span><br><span class="line">vi /etc/logrotate.d/slapd</span><br><span class="line"></span><br><span class="line">/var/<span class="built_in">log</span>/openldap.log &#123;</span><br><span class="line">    rotate 14</span><br><span class="line">    size 10M</span><br><span class="line">    missingok</span><br><span class="line">    compress</span><br><span class="line">    copytruncate</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">systemctl restart rsyslog</span><br><span class="line"><span class="comment"># 如果有需要还可以配置日志轮转</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个测试用户</span></span><br><span class="line">vi demo.ldif</span><br><span class="line"></span><br><span class="line">dn: uid=800001,ou=People,dc=example,dc=com</span><br><span class="line">objectClass: top</span><br><span class="line">objectClass: account</span><br><span class="line">objectClass: posixAccount</span><br><span class="line">objectClass: shadowAccount</span><br><span class="line">cn: demo</span><br><span class="line">uid: 800001</span><br><span class="line">uidNumber: 3000</span><br><span class="line">gidNumber: 100</span><br><span class="line">homeDirectory: /home/ldapusers</span><br><span class="line">loginShell: /bin/bash</span><br><span class="line">gecos: Demo [Demo user (at) example]</span><br><span class="line">userPassword: &#123;crypt&#125;x</span><br><span class="line">shadowLastChange: 17058</span><br><span class="line">shadowMin: 0</span><br><span class="line">shadowMax: 99999</span><br><span class="line">shadowWarning: 7</span><br><span class="line"></span><br><span class="line">dn: cn=ops,ou=Group,dc=example,dc=com</span><br><span class="line">objectClass: posixGroup</span><br><span class="line">objectClass: top</span><br><span class="line">cn: ops</span><br><span class="line">gidNumber: 80001</span><br><span class="line">memberUid: 800001</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建</span></span><br><span class="line">ldapadd -x -W -D <span class="string">"cn=Manager,dc=example,dc=com"</span> -f demo.ldif</span><br><span class="line"><span class="comment"># 改密</span></span><br><span class="line">ldappasswd -s <span class="string">'passwd@123'</span> -W -D <span class="string">"cn=Manager,dc=example,dc=com"</span> -x <span class="string">"uid=800001,ou=People,dc=example,dc=com"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证搜索</span></span><br><span class="line">ldapsearch -x uid=800001 -b dc=example,dc=com</span><br><span class="line"></span><br><span class="line">//删除使用如下命令，暂不删除，因后续实验需用到测试用户</span><br><span class="line">ldapdelete -W -D <span class="string">"cn=Manager,dc=example,dc=com"</span> -x <span class="string">"uid=800001,ou=People,dc=example,dc=com"</span></span><br></pre></td></tr></table></figure><h2 id="ldap客户端配置"><a href="#ldap客户端配置" class="headerlink" title="ldap客户端配置"></a>ldap客户端配置</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装组件</span></span><br><span class="line">yum install -y openldap-clients nss-pam-ldapd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加client服务器到LDAP服务,注意IP</span></span><br><span class="line">authconfig --enableldap --enableldapauth --ldapserver=<span class="string">"localhost"</span> --ldapbasedn=<span class="string">"dc=example,dc=com"</span> --update</span><br><span class="line"><span class="comment"># 这个指令修改了/etc/nsswitch.conf 以及/etc/openldap/ldap.conf文件</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动ldap客户端服务</span></span><br><span class="line">systemctl restart  nslcd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证</span></span><br><span class="line">getent passwd 800001</span><br><span class="line">800001:3000:100:Demo [Demo user (at) example]:/home/demo:/bin/bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 远程ssh登录验证</span></span><br><span class="line">ssh 800001@10.116.72.15</span><br><span class="line">800001@10.116.72.15<span class="string">'s password: demopassword</span></span><br><span class="line"><span class="string">-bash-4.2$ id 800001</span></span><br><span class="line"><span class="string">uid=3000(800001) gid=100(users) groups=100(users),80001(ops)</span></span><br><span class="line"><span class="string">-bash-4.2$ </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 这里可以看到没有配置自动生成账户的家目录，在实际的运维过程中，也不会去生成家目录（不然一堆的账户加目录），而是让运维账户统一一个家目录，并且设置为只读。</span></span><br><span class="line"><span class="string"># 不过如果有需要配置配置家目录自动生成，需要修改pam模块</span></span><br></pre></td></tr></table></figure><h2 id="配置LDAP使用公钥-publicKey-远程ssh登录客户主机"><a href="#配置LDAP使用公钥-publicKey-远程ssh登录客户主机" class="headerlink" title="配置LDAP使用公钥(publicKey)远程ssh登录客户主机"></a>配置LDAP使用公钥(publicKey)远程ssh登录客户主机</h2><h3 id="openldap服务端配置"><a href="#openldap服务端配置" class="headerlink" title="openldap服务端配置"></a>openldap服务端配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装openssh-ldap</span></span><br><span class="line">yum install openssh-ldap</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看</span></span><br><span class="line">rpm -aql |grep openssh-ldap</span><br><span class="line">/usr/share/doc/openssh-ldap-7.4p1</span><br><span class="line">/usr/share/doc/openssh-ldap-7.4p1/HOWTO.ldap-keys</span><br><span class="line">/usr/share/doc/openssh-ldap-7.4p1/ldap.conf</span><br><span class="line">/usr/share/doc/openssh-ldap-7.4p1/openssh-lpk-openldap.ldif</span><br><span class="line">/usr/share/doc/openssh-ldap-7.4p1/openssh-lpk-openldap.schema</span><br><span class="line">/usr/share/doc/openssh-ldap-7.4p1/openssh-lpk-sun.ldif</span><br><span class="line">/usr/share/doc/openssh-ldap-7.4p1/openssh-lpk-sun.schema</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置添加相关schema</span></span><br><span class="line">cp /usr/share/doc/openssh-ldap-7.4p1/openssh-lpk-openldap.ldif /etc/openldap/schema/</span><br><span class="line">cp /usr/share/doc/openssh-ldap-7.4p1/openssh-lpk-openldap.schema /etc/openldap/schema/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加</span></span><br><span class="line">ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/openssh-lpk-openldap.ldif</span><br><span class="line"></span><br><span class="line"><span class="comment"># 账户添加objectClass: ldapPublicKey 并添加属性sshPublicKey</span></span><br><span class="line"><span class="comment"># 具体修改流程，可以使用下面安装的ldapadmin或者phpldapadmin进行配置</span></span><br><span class="line">objectClass: ldapPublicKey</span><br><span class="line">sshPublicKey:  值是具体的publickey</span><br></pre></td></tr></table></figure><h3 id="客户主机配置"><a href="#客户主机配置" class="headerlink" title="客户主机配置"></a>客户主机配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装</span></span><br><span class="line">yum install openssh-ldap</span><br><span class="line">cp /usr/share/doc/openssh-ldap-7.4p1/ldap.conf /etc/ssh/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果使用TLS 配置TLS,这里不使用</span></span><br><span class="line">vim /etc/ssh/ldap.conf</span><br><span class="line"></span><br><span class="line">ssl no</span><br><span class="line">uri ldap://10.116.72.11/</span><br><span class="line"></span><br><span class="line">vim /etc/ssh/sshd_config</span><br><span class="line"><span class="comment"># 脚本将从LDAP获取密钥并将其提供给SSH服务器</span></span><br><span class="line">AuthorizedKeysCommand /usr/libexec/openssh/ssh-ldap-wrapper</span><br><span class="line">AuthorizedKeysCommandUser nobody</span><br><span class="line">PubkeyAuthentication yes</span><br></pre></td></tr></table></figure><h3 id="登录验证"><a href="#登录验证" class="headerlink" title="登录验证"></a>登录验证</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ssh -i ~/.ssh/id_rsa 800001@10.116.72.15</span><br><span class="line">Last login: Thu Jul  4 16:15:30 2019 from 10.116.71.200</span><br><span class="line">Could not <span class="built_in">chdir</span> to home directory /home/demo: No such file or directory</span><br><span class="line">-bash-4.2$</span><br></pre></td></tr></table></figure><h2 id="配置LDAP账户可以登录的主机列表"><a href="#配置LDAP账户可以登录的主机列表" class="headerlink" title="配置LDAP账户可以登录的主机列表"></a>配置LDAP账户可以登录的主机列表</h2><p>测试使用的远程ssh服务器是10.116.72.15，我们验证如下</p><ol><li><p>添加账户主机列表（host属性）不包含116.116.72.15 测试是否可以正常登录</p></li><li><p>添加账户主机列表（host属性）包含116.116.72.15 测试是否可以正常登录</p></li></ol><h3 id="需要通过Ldap远程登录的客户机配置"><a href="#需要通过Ldap远程登录的客户机配置" class="headerlink" title="需要通过Ldap远程登录的客户机配置"></a>需要通过Ldap远程登录的客户机配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/nsswitch.conf</span><br><span class="line"><span class="comment"># 添加如下过滤配置，包含本机主机名称。表示过滤匹配包括本机IP或者允许任意IP地址的账户授权信息</span></span><br><span class="line">filter passwd (|(host=10.116.72.15)(host=\*))(host=ALL)</span><br></pre></td></tr></table></figure><p>备注：如果远程主机是centos6，配置稍有不同</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/pam_ldap.conf</span><br><span class="line">pam_filter |(host=10.116.72.16)(host=\*)(host=ALL)</span><br></pre></td></tr></table></figure><h3 id="LDAP账户配置"><a href="#LDAP账户配置" class="headerlink" title="LDAP账户配置"></a>LDAP账户配置</h3><p>ldap命令或者ldapadmin管理工具为账户添加属性host，这个属性可以添加多次。</p><ul><li>第一次配置不包含测试主机10.116.72.15</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">ldapsearch -x uid=800001 -b <span class="string">'ou=People,dc=example,dc=com'</span></span><br><span class="line"></span><br><span class="line">dn: uid=800001,ou=People,dc=example,dc=com</span><br><span class="line">objectClass: top</span><br><span class="line">objectClass: account</span><br><span class="line">objectClass: posixAccount</span><br><span class="line">objectClass: shadowAccount</span><br><span class="line">cn: demo</span><br><span class="line">uid: 800001</span><br><span class="line">uidNumber: 3000</span><br><span class="line">gidNumber: 100</span><br><span class="line">homeDirectory: /home/demo</span><br><span class="line">loginShell: /bin/bash</span><br><span class="line">gecos: Demo [Admin (at) eju]</span><br><span class="line">shadowMin: 0</span><br><span class="line">shadowMax: 99999</span><br><span class="line">shadowWarning: 7</span><br><span class="line">host: 10.116.72.12</span><br><span class="line">host: 10.116.72.16</span><br><span class="line"></span><br><span class="line">测试登录</span><br><span class="line"><span class="comment"># ssh 800001@10.116.72.15</span></span><br><span class="line">800001@10.116.72.15<span class="string">'s password: </span></span><br><span class="line"><span class="string">Permission denied, please try again.</span></span><br></pre></td></tr></table></figure><ul><li>第二次配置包含测试主机10.116.72.15</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">ldapsearch -x uid=800001 -b <span class="string">'ou=People,dc=example,dc=com'</span></span><br><span class="line"></span><br><span class="line">dn: uid=800001,ou=People,dc=example,dc=com</span><br><span class="line">objectClass: top</span><br><span class="line">objectClass: account</span><br><span class="line">objectClass: posixAccount</span><br><span class="line">objectClass: shadowAccount</span><br><span class="line">cn: demo</span><br><span class="line">uid: 800001</span><br><span class="line">uidNumber: 3000</span><br><span class="line">gidNumber: 100</span><br><span class="line">homeDirectory: /home/demo</span><br><span class="line">loginShell: /bin/bash</span><br><span class="line">gecos: Demo [Admin (at) eju]</span><br><span class="line">shadowMin: 0</span><br><span class="line">shadowMax: 99999</span><br><span class="line">shadowWarning: 7</span><br><span class="line">host: 10.116.72.12</span><br><span class="line">host: 10.116.72.15</span><br><span class="line">host: 10.116.72.16</span><br><span class="line"></span><br><span class="line">测试登录</span><br><span class="line"><span class="comment"># ssh 800001@10.116.72.15</span></span><br><span class="line">800001@10.116.72.15<span class="string">'s password: </span></span><br><span class="line"><span class="string">Last login: Thu Jul  4 16:15:30 2019 from 10.116.71.200</span></span><br><span class="line"><span class="string">Could not chdir to home directory /home/demo: No such file or directory</span></span><br><span class="line"><span class="string">-bash-4.2$</span></span><br></pre></td></tr></table></figure><p>以上，测试通过。</p><h2 id="配置LDAP-sudo权限管理"><a href="#配置LDAP-sudo权限管理" class="headerlink" title="配置LDAP sudo权限管理"></a>配置LDAP sudo权限管理</h2><h3 id="服务配置"><a href="#服务配置" class="headerlink" title="服务配置"></a>服务配置</h3><p>CentOS7.6下安装的OpenLDAP是2.4.44 ,schema目录下并没有sudo.ldif以及sudo.schema文件，需要单独处理。 sudo是默认安装的，sudo相关目录下有sudo.schema模板文件schema.OpenLDAP</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">find / -name schema.OpenLDAP -<span class="built_in">exec</span> cp &#123;&#125; /etc/openldap/schema/sudo.schema \;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成sudo.ldif</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'include     /etc/openldap/schema/sudo.schema'</span> &gt; /tmp/sudo.conf</span><br><span class="line">mkdir /tmp/sudo</span><br><span class="line">slaptest -f /tmp/sudo.conf -F /tmp/sudo</span><br><span class="line"></span><br><span class="line">vim /tmp/sudo/cn=config/cn=schema/cn=&#123;0&#125;sudo.ldif</span><br><span class="line"></span><br><span class="line">替换（前3行）</span><br><span class="line">dn: cn=&#123;0&#125;sudo</span><br><span class="line">objectClass: olcSchemaConfig</span><br><span class="line">cn: &#123;0&#125;sudo</span><br><span class="line">为</span><br><span class="line">dn: cn=sudo,cn=schema,cn=config</span><br><span class="line">objectClass: olcSchemaConfig</span><br><span class="line">cn: sudo</span><br><span class="line">删除(最后7行)</span><br><span class="line">structuralObjectClass: olcSchemaConfig</span><br><span class="line">entryUUID: ec3b659a-31a9-1039-90ae-87c69280e4a2</span><br><span class="line">creatorsName: cn=config</span><br><span class="line">createTimestamp: 20190703064542Z</span><br><span class="line">entryCSN: 20190703064542.945991Z<span class="comment">#000000#000#000000</span></span><br><span class="line">modifiersName: cn=config</span><br><span class="line">modifyTimestamp: 20190703064542Z</span><br><span class="line"></span><br><span class="line">cp /tmp/sudo/cn=config/cn=schema/cn=&#123;0&#125;sudo.ldif /etc/openldap/schema/sudo.ldif</span><br><span class="line">ldapadd -Y EXTERNAL -H ldapi:/// -f /etc/openldap/schema/sudo.ldif</span><br><span class="line"></span><br><span class="line">rm -f /tmp/sudo.conf /tmp/sudo</span><br></pre></td></tr></table></figure><h3 id="权限配置"><a href="#权限配置" class="headerlink" title="权限配置"></a>权限配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">vim SUODers.ldif</span><br><span class="line"></span><br><span class="line">dn: ou=SUDOers,dc=example,dc=com</span><br><span class="line">ou: SUDOers</span><br><span class="line">objectClass: top</span><br><span class="line">objectClass: organizationalUnit</span><br><span class="line"></span><br><span class="line">dn: cn=defaults,ou=SUDOers,dc=example,dc=com</span><br><span class="line">objectClass: sudoRole</span><br><span class="line">cn: defaults</span><br><span class="line">sudoOption: requiretty</span><br><span class="line">sudoOption: !visiblepw</span><br><span class="line">sudoOption: always_set_home</span><br><span class="line">sudoOption: env_reset</span><br><span class="line">sudoOption: env_keep =  <span class="string">"COLORS DISPLAY HOSTNAME HISTSIZE INPUTRC KDEDIR LS_COLORS"</span></span><br><span class="line">sudoOption: env_keep += <span class="string">"MAIL PS1 PS2 QTDIR USERNAME LANG LC_ADDRESS LC_CTYPE"</span></span><br><span class="line">sudoOption: env_keep += <span class="string">"LC_COLLATE LC_IDENTIFICATION LC_MEASUREMENT LC_MESSAGES"</span></span><br><span class="line">sudoOption: env_keep += <span class="string">"LC_MONETARY LC_NAME LC_NUMERIC LC_PAPER LC_TELEPHONE"</span></span><br><span class="line">sudoOption: env_keep += <span class="string">"LC_TIME LC_ALL LANGUAGE LINGUAS _XKB_CHARSET XAUTHORITY"</span></span><br><span class="line">sudoOption: secure_path = /sbin:/bin:/usr/sbin:/usr/bin</span><br><span class="line">sudoOption: logfile = /var/<span class="built_in">log</span>/sudo</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加</span></span><br><span class="line">ldapadd -x -W -D <span class="string">"cn=Manager,dc=example,dc=com"</span> -f SUODers.ldif</span><br></pre></td></tr></table></figure><h3 id="将上面的demo（800001）账户配置为sudo权限"><a href="#将上面的demo（800001）账户配置为sudo权限" class="headerlink" title="将上面的demo（800001）账户配置为sudo权限"></a>将上面的demo（800001）账户配置为sudo权限</h3><p>这里配置一个运维sudo role，名称为sudo_ops_role，简单配置为sudo 到root所有权限，并将800001加入该role</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">vim sudo_ops_role.ldif</span><br><span class="line"></span><br><span class="line">dn: cn=sudo_ops_role,ou=SUDOers,dc=example,dc=com</span><br><span class="line">objectClass: sudoRole</span><br><span class="line">cn: sudo_ops_role</span><br><span class="line">sudoOption: !authenticate</span><br><span class="line">sudoRunAsUser: root</span><br><span class="line">sudoCommand: ALL</span><br><span class="line">sudoHost: ALL</span><br><span class="line">sudoUser: 800001</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加</span></span><br><span class="line">ldapadd -x -W -D <span class="string">"cn=Manager,dc=example,dc=com"</span> -f sudo_ops_role.ldif</span><br></pre></td></tr></table></figure><h3 id="客户端增加如下配置"><a href="#客户端增加如下配置" class="headerlink" title="客户端增加如下配置"></a>客户端增加如下配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/nsswitch.conf</span><br><span class="line"><span class="comment"># 追加内存</span></span><br><span class="line">sudoers:    files ldap</span><br><span class="line"></span><br><span class="line">mv /etc/sudo-ldap.conf&#123;,.bak&#125;</span><br><span class="line">vi /etc/sudo-ldap.conf</span><br><span class="line">uri ldap://10.116.72.11/ </span><br><span class="line">base dc=example,dc=com</span><br><span class="line">sudoers_base ou=SUDOers,dc=example,dc=com</span><br></pre></td></tr></table></figure><p>测试</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ssh 800001@10.116.72.15</span></span><br><span class="line">800001@10.116.72.15<span class="string">'s password: </span></span><br><span class="line"><span class="string">Could not chdir to home directory /home/ldapusers: No such file or directory</span></span><br><span class="line"><span class="string">-bash-4.2$ sudo su -</span></span><br><span class="line"><span class="string">Last login: Wed Jul  3 15:09:21 CST 2019 from 10.116.71.200 on pts/0</span></span><br><span class="line"><span class="string">[root@systerm-shylf-1 ~]#</span></span><br></pre></td></tr></table></figure><h2 id="基于web的OpenLDAP管理工具phpldapadmin"><a href="#基于web的OpenLDAP管理工具phpldapadmin" class="headerlink" title="基于web的OpenLDAP管理工具phpldapadmin"></a>基于web的OpenLDAP管理工具phpldapadmin</h2><p>实例在openldap安装，实际使用中可以部署在其他服务器上通过网络访问。前端还可以配置一个nginx去代理实现高可用</p><h3 id="安装配置phpldapadmin"><a href="#安装配置phpldapadmin" class="headerlink" title="安装配置phpldapadmin"></a>安装配置phpldapadmin</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装组件</span></span><br><span class="line">yum -y install epel-release</span><br><span class="line">yum -y install httpd phpldapadmin</span><br><span class="line"><span class="comment"># yum安装后的项目文件位置/usr/share/phpldapadmin/htdocs，配置文件位置/etc/phpldapadmin/config.php</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># phpldapadmin修改</span></span><br><span class="line">vim /etc/phpldapadmin/config.php</span><br><span class="line"></span><br><span class="line"><span class="comment"># 注释掉</span></span><br><span class="line">//<span class="variable">$servers</span>-&gt;setValue(<span class="string">'login'</span>,<span class="string">'attr'</span>,<span class="string">'uid'</span>);</span><br><span class="line"><span class="comment"># 或者修改为</span></span><br><span class="line"><span class="variable">$servers</span>-&gt;setValue(<span class="string">'login'</span>,<span class="string">'attr'</span>,<span class="string">'dn'</span>);</span><br><span class="line"><span class="variable">$servers</span>-&gt;newServer(<span class="string">'ldap_pla'</span>);</span><br><span class="line"><span class="variable">$servers</span>-&gt;setValue(<span class="string">'server'</span>,<span class="string">'name'</span>,<span class="string">'LDAP Server'</span>); </span><br><span class="line"><span class="variable">$servers</span>-&gt;setValue(<span class="string">'server'</span>,<span class="string">'host'</span>,<span class="string">'127.0.0.1'</span>); //根据需要修改为实际地址,这个部署到openldap本机直接保留127.0.0.1</span><br><span class="line"><span class="variable">$servers</span>-&gt;setValue(<span class="string">'server'</span>,<span class="string">'port'</span>,389);</span><br><span class="line"><span class="variable">$servers</span>-&gt;setValue(<span class="string">'server'</span>,<span class="string">'base'</span>,array(<span class="string">'dc=example,dc=com'</span>));   //</span><br><span class="line"><span class="variable">$servers</span>-&gt;setValue(<span class="string">'login'</span>,<span class="string">'auth_type'</span>,<span class="string">'cookie'</span>);</span><br><span class="line"><span class="variable">$servers</span>-&gt;setValue(<span class="string">'login'</span>,<span class="string">'bind_id'</span>,<span class="string">'cn=Manager,dc=example,dc=com'</span>);</span><br><span class="line"><span class="variable">$servers</span>-&gt;setValue(<span class="string">'login'</span>,<span class="string">'bind_pass'</span>,<span class="string">''</span>);</span><br><span class="line"><span class="variable">$servers</span>-&gt;setValue(<span class="string">'server'</span>,<span class="string">'tls'</span>,<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment"># httpd修改</span></span><br><span class="line">vim /etc/httpd/conf.d/phpldapadmin.conf</span><br><span class="line"></span><br><span class="line">Alias /phpldapadmin /usr/share/phpldapadmin/htdocs</span><br><span class="line">Alias /ldapadmin /usr/share/phpldapadmin/htdocs</span><br><span class="line"></span><br><span class="line">&lt;Directory /usr/share/phpldapadmin/htdocs&gt;</span><br><span class="line">  &lt;IfModule mod_authz_core.c&gt;</span><br><span class="line">    <span class="comment"># Apache 2.4</span></span><br><span class="line">    <span class="comment"># Require local</span></span><br><span class="line">    Require all granted</span><br><span class="line">  &lt;/IfModule&gt;</span><br><span class="line">  &lt;IfModule !mod_authz_core.c&gt;</span><br><span class="line">    <span class="comment"># Apache 2.2</span></span><br><span class="line">    Order Deny,Allow</span><br><span class="line">    Deny from all</span><br><span class="line">    Allow from 127.0.0.1</span><br><span class="line">    Allow from ::1</span><br><span class="line">    <span class="comment"># 根据需要配置许可</span></span><br><span class="line">    Allow from 10.116</span><br><span class="line">  &lt;/IfModule&gt;</span><br><span class="line">&lt;/Directory&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动httpd服务</span></span><br><span class="line">systemctl restart httpd</span><br></pre></td></tr></table></figure><h3 id="使用phpldapadmin"><a href="#使用phpldapadmin" class="headerlink" title="使用phpldapadmin"></a>使用phpldapadmin</h3><p><img src="/articles/be8d00d3/1.png" alt></p><p><img src="/articles/be8d00d3/2.png" alt></p><p>备注，如果报错如下</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Forbidden </span><br><span class="line">You don<span class="string">'t have permission to access /ldapadmin/ on this server.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">可以尝试修改httpd.conf</span></span><br><span class="line"><span class="string">vi /etc/httpd/conf/http.conf</span></span><br><span class="line"><span class="string">修改</span></span><br><span class="line"><span class="string">&lt;Directory /&gt;</span></span><br><span class="line"><span class="string">    AllowOverride none</span></span><br><span class="line"><span class="string">    Require all denied</span></span><br><span class="line"><span class="string">&lt;/Directory&gt;</span></span><br><span class="line"><span class="string">为</span></span><br><span class="line"><span class="string">&lt;Directory /&gt; </span></span><br><span class="line"><span class="string">Options Indexes FollowSymLinks </span></span><br><span class="line"><span class="string">AllowOverride None </span></span><br><span class="line"><span class="string">&lt;/Directory&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">systemctl restart httpd</span></span><br></pre></td></tr></table></figure><h3 id="为phpldapadmin添加suorole配置模版"><a href="#为phpldapadmin添加suorole配置模版" class="headerlink" title="为phpldapadmin添加suorole配置模版"></a>为phpldapadmin添加suorole配置模版</h3><p>从<a href="http://phpldapadmin.sourceforge.net/wiki/index.php/TemplatesContributed:Sudo" target="_blank" rel="noopener">官网地址</a> 可以获取到sudoRole模板，可以在这个基础上进行修改</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ll /usr/share/phpldapadmin/templates</span><br><span class="line"><span class="comment"># ll /usr/share/phpldapadmin/templates</span></span><br><span class="line">total 8</span><br><span class="line">drwxr-xr-x 2 root root 4096 Jul  4 15:32 creation</span><br><span class="line">drwxr-xr-x 2 root root   69 Jul  4 15:31 modification</span><br><span class="line">-rw-r--r-- 1 root root 2089 Oct  1  2012 template.dtd</span><br></pre></td></tr></table></figure><p>vim  /usr/share/phpldapadmin/templates/creation/sudo.xml 注意根据需要进行修改，我的sudo ou名称是SUDOers</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE template SYSTEM "template.dtd"&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>Sudo Policy<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">regexp</span>&gt;</span>^ou=SUDOers,dc=.*<span class="tag">&lt;/<span class="name">regexp</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">icon</span>&gt;</span>images/door.png<span class="tag">&lt;/<span class="name">icon</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">description</span>&gt;</span>New Sudo Policy<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">askcontainer</span>&gt;</span>1<span class="tag">&lt;/<span class="name">askcontainer</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">rdn</span>&gt;</span>cn<span class="tag">&lt;/<span class="name">rdn</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">visible</span>&gt;</span>1<span class="tag">&lt;/<span class="name">visible</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">objectClasses</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">objectClass</span> <span class="attr">id</span>=<span class="string">"sudoRole"</span>&gt;</span><span class="tag">&lt;/<span class="name">objectClass</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">objectClasses</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">attributes</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">attribute</span> <span class="attr">id</span>=<span class="string">"cn"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">display</span>&gt;</span>Policy Name<span class="tag">&lt;/<span class="name">display</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">order</span>&gt;</span>1<span class="tag">&lt;/<span class="name">order</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">page</span>&gt;</span>1<span class="tag">&lt;/<span class="name">page</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">attribute</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">attribute</span> <span class="attr">id</span>=<span class="string">"sudoOption"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">display</span>&gt;</span>Sudo Option<span class="tag">&lt;/<span class="name">display</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">order</span>&gt;</span>2<span class="tag">&lt;/<span class="name">order</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">page</span>&gt;</span>1<span class="tag">&lt;/<span class="name">page</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">spacer</span>&gt;</span>1<span class="tag">&lt;/<span class="name">spacer</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">attribute</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">attribute</span> <span class="attr">id</span>=<span class="string">"sudoRunAsUser"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">display</span>&gt;</span>Sudo Run As User<span class="tag">&lt;/<span class="name">display</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">order</span>&gt;</span>3<span class="tag">&lt;/<span class="name">order</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">page</span>&gt;</span>1<span class="tag">&lt;/<span class="name">page</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">spacer</span>&gt;</span>1<span class="tag">&lt;/<span class="name">spacer</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">attribute</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">attribute</span> <span class="attr">id</span>=<span class="string">"sudoCommand"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">display</span>&gt;</span>Sudo Command<span class="tag">&lt;/<span class="name">display</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">order</span>&gt;</span>4<span class="tag">&lt;/<span class="name">order</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">page</span>&gt;</span>1<span class="tag">&lt;/<span class="name">page</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">spacer</span>&gt;</span>1<span class="tag">&lt;/<span class="name">spacer</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">attribute</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">attribute</span> <span class="attr">id</span>=<span class="string">"sudoUser"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">display</span>&gt;</span>Sudo Users<span class="tag">&lt;/<span class="name">display</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">option</span>&gt;</span>=php.MultiList(/,(objectClass=posixAccount),uid,%uid%</span><br><span class="line">(%cn%),sudoUser)<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">order</span>&gt;</span>5<span class="tag">&lt;/<span class="name">order</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">page</span>&gt;</span>1<span class="tag">&lt;/<span class="name">page</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">spacer</span>&gt;</span>1<span class="tag">&lt;/<span class="name">spacer</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">attribute</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">attribute</span> <span class="attr">id</span>=<span class="string">"sudoHost"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">display</span>&gt;</span>Sudo Hosts<span class="tag">&lt;/<span class="name">display</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">array</span>&gt;</span>10<span class="tag">&lt;/<span class="name">array</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">order</span>&gt;</span>6<span class="tag">&lt;/<span class="name">order</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">page</span>&gt;</span>1<span class="tag">&lt;/<span class="name">page</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">spacer</span>&gt;</span>1<span class="tag">&lt;/<span class="name">spacer</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">attribute</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">attribute</span> <span class="attr">id</span>=<span class="string">"description"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">type</span>&gt;</span>textarea<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">display</span>&gt;</span>Description<span class="tag">&lt;/<span class="name">display</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">order</span>&gt;</span>7<span class="tag">&lt;/<span class="name">order</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">page</span>&gt;</span>1<span class="tag">&lt;/<span class="name">page</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">attribute</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">attributes</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br></pre></td></tr></table></figure><p>vim  /usr/share/phpldapadmin/templates/modification/sudo.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE template SYSTEM "template.dtd"&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>Sudo Policy<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">regexp</span>&gt;</span>^cn=.*,ou=SUDOers,dc=.*<span class="tag">&lt;/<span class="name">regexp</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">icon</span>&gt;</span>images/door.png<span class="tag">&lt;/<span class="name">icon</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">description</span>&gt;</span>Sudo Policy<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">askcontainer</span>&gt;</span>1<span class="tag">&lt;/<span class="name">askcontainer</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">rdn</span>&gt;</span>cn<span class="tag">&lt;/<span class="name">rdn</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">visible</span>&gt;</span>1<span class="tag">&lt;/<span class="name">visible</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">objectClasses</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">objectClass</span> <span class="attr">id</span>=<span class="string">"sudoRole"</span>&gt;</span><span class="tag">&lt;/<span class="name">objectClass</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">objectClasses</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">attributes</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">attribute</span> <span class="attr">id</span>=<span class="string">"cn"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">display</span>&gt;</span>Policy Name<span class="tag">&lt;/<span class="name">display</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">order</span>&gt;</span>1<span class="tag">&lt;/<span class="name">order</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">page</span>&gt;</span>1<span class="tag">&lt;/<span class="name">page</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">attribute</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">attribute</span> <span class="attr">id</span>=<span class="string">"sudoOption"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">display</span>&gt;</span>Sudo Option<span class="tag">&lt;/<span class="name">display</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">order</span>&gt;</span>2<span class="tag">&lt;/<span class="name">order</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">page</span>&gt;</span>1<span class="tag">&lt;/<span class="name">page</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">spacer</span>&gt;</span>1<span class="tag">&lt;/<span class="name">spacer</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">attribute</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">attribute</span> <span class="attr">id</span>=<span class="string">"sudoRunAsUser"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">display</span>&gt;</span>Sudo Run As User<span class="tag">&lt;/<span class="name">display</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">order</span>&gt;</span>3<span class="tag">&lt;/<span class="name">order</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">page</span>&gt;</span>1<span class="tag">&lt;/<span class="name">page</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">spacer</span>&gt;</span>1<span class="tag">&lt;/<span class="name">spacer</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">attribute</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">attribute</span> <span class="attr">id</span>=<span class="string">"sudoCommand"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">display</span>&gt;</span>Sudo Command<span class="tag">&lt;/<span class="name">display</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">order</span>&gt;</span>4<span class="tag">&lt;/<span class="name">order</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">page</span>&gt;</span>1<span class="tag">&lt;/<span class="name">page</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">spacer</span>&gt;</span>1<span class="tag">&lt;/<span class="name">spacer</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">attribute</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">attribute</span> <span class="attr">id</span>=<span class="string">"sudoUser"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">display</span>&gt;</span>Sudo Users<span class="tag">&lt;/<span class="name">display</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">order</span>&gt;</span>5<span class="tag">&lt;/<span class="name">order</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">page</span>&gt;</span>1<span class="tag">&lt;/<span class="name">page</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">spacer</span>&gt;</span>1<span class="tag">&lt;/<span class="name">spacer</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">attribute</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">attribute</span> <span class="attr">id</span>=<span class="string">"sudoHost"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">display</span>&gt;</span>Sudo Hosts<span class="tag">&lt;/<span class="name">display</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- &lt;array&gt;10&lt;/array&gt; --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">order</span>&gt;</span>6<span class="tag">&lt;/<span class="name">order</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">page</span>&gt;</span>1<span class="tag">&lt;/<span class="name">page</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">spacer</span>&gt;</span>1<span class="tag">&lt;/<span class="name">spacer</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">attribute</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">attribute</span> <span class="attr">id</span>=<span class="string">"description"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">type</span>&gt;</span>textarea<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">display</span>&gt;</span>Description<span class="tag">&lt;/<span class="name">display</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">order</span>&gt;</span>7<span class="tag">&lt;/<span class="name">order</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">page</span>&gt;</span>1<span class="tag">&lt;/<span class="name">page</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">cols</span>&gt;</span>200<span class="tag">&lt;/<span class="name">cols</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rows</span>&gt;</span>10<span class="tag">&lt;/<span class="name">rows</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">attribute</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">attributes</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br></pre></td></tr></table></figure><p>重启httpd服务</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart httpd</span><br></pre></td></tr></table></figure><p>浏览器查看(ou=SUODers,dc=example,dc=com 创建一条子目录 sudoRole)</p><p><img src="/articles/be8d00d3/3.png" alt></p><h2 id="windows下的一个OpenLDAP管理工具-LdapAdmin"><a href="#windows下的一个OpenLDAP管理工具-LdapAdmin" class="headerlink" title="windows下的一个OpenLDAP管理工具 LdapAdmin"></a>windows下的一个OpenLDAP管理工具 LdapAdmin</h2><p>下载地址 <a href="http://www.ldapadmin.org/download/ldapadmin.html" target="_blank" rel="noopener">LdapAdmin</a>, 当前最新版本是<a href="https://sourceforge.net/projects/ldapadmin/files/ldapadmin/1.8.3/LdapAdminExe-w64-1.8.3.zip/download" target="_blank" rel="noopener">1.8.3</a>。 下载后直接解压就是一个exe文件。</p><h3 id="创建连接到openldap服务"><a href="#创建连接到openldap服务" class="headerlink" title="创建连接到openldap服务"></a>创建连接到openldap服务</h3><p><img src="/articles/be8d00d3/4.png" alt></p><h3 id="配置一个运维组ops，然后将用户800001加入到ops组"><a href="#配置一个运维组ops，然后将用户800001加入到ops组" class="headerlink" title="配置一个运维组ops，然后将用户800001加入到ops组"></a>配置一个运维组ops，然后将用户800001加入到ops组</h3><p><img src="/articles/be8d00d3/5.png" alt></p><h2 id="开启memberOf"><a href="#开启memberOf" class="headerlink" title="开启memberOf"></a>开启memberOf</h2><p>默认情况下openldap的用户组属性是Posixgroup，Posixgroup用户组属性和用户没有实际的对应关系。如果要对应起来的话，就需要单独把用户设置到Posixgroup中</p><p>开启memberOf之后可以配置groupOfUniqueNames用户组属性，可以根据用户组过滤用户，这个过滤是唯一的</p><p>开启memberof，并让新增用户支持memberof</p><p>创建 memberof_config.ldif</p><figure class="highlight ldif"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">dn</span>: cn=module&#123;0&#125;,cn=config</span><br><span class="line"><span class="attribute">cn</span>: modulle&#123;0&#125;</span><br><span class="line"><span class="attribute">objectClass</span>: olcModuleList</span><br><span class="line"><span class="attribute">objectclass</span>: top</span><br><span class="line"><span class="attribute">olcModuleload</span>: memberof.la</span><br><span class="line"><span class="attribute">olcModulePath</span>: /usr/lib64/openldap</span><br><span class="line"></span><br><span class="line"><span class="attribute">dn</span>: olcOverlay=&#123;0&#125;memberof,olcDatabase=&#123;2&#125;hdb,cn=config</span><br><span class="line"><span class="attribute">objectClass</span>: olcConfig</span><br><span class="line"><span class="attribute">objectClass</span>: olcMemberOf</span><br><span class="line"><span class="attribute">objectClass</span>: olcOverlayConfig</span><br><span class="line"><span class="attribute">objectClass</span>: top</span><br><span class="line"><span class="attribute">olcOverlay</span>: memberof</span><br><span class="line"><span class="attribute">olcMemberOfDangling</span>: ignore</span><br><span class="line"><span class="attribute">olcMemberOfRefInt</span>: TRUE</span><br><span class="line"><span class="attribute">olcMemberOfGroupOC</span>: groupOfNames</span><br><span class="line"><span class="attribute">olcMemberOfMemberAD</span>: member</span><br><span class="line"><span class="attribute">olcMemberOfMemberOfAD</span>: memberOf</span><br></pre></td></tr></table></figure><p>创建 refint1.ldif</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dn: cn=module&#123;0&#125;,cn=config</span><br><span class="line">add: olcmoduleload</span><br><span class="line">olcmoduleload: refint</span><br></pre></td></tr></table></figure><p>创建 refint2.ldif</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">dn: olcOverlay=refint,olcDatabase=&#123;2&#125;hdb,cn=config</span><br><span class="line">objectClass: olcConfig</span><br><span class="line">objectClass: olcOverlayConfig</span><br><span class="line">objectClass: olcRefintConfig</span><br><span class="line">objectClass: top</span><br><span class="line">olcOverlay: refint</span><br><span class="line">olcRefintAttribute: memberof member manager owner</span><br></pre></td></tr></table></figure><p>导入配置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ldapadd -Q -Y EXTERNAL -H ldapi:/// -f memberof_config.ldif</span><br><span class="line">ldapmodify -Q -Y EXTERNAL -H ldapi:/// -f refint1.ldif</span><br><span class="line">ldapadd -Q -Y EXTERNAL -H ldapi:/// -f refint2.ldif</span><br><span class="line"><span class="comment"># 导入refint2时如果有报错，把最后一句改为：olcRefintAttribute: memberof uniqueMember  manager owner</span></span><br></pre></td></tr></table></figure><p>验证一下配置，这个命令可以列出所有配置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">slapcat -b cn=config</span><br></pre></td></tr></table></figure><h2 id="禁止匿名访问"><a href="#禁止匿名访问" class="headerlink" title="禁止匿名访问"></a><strong>禁止匿名访问</strong></h2><p>默认情况下匿名用户可以获取所有用户信息，甚至是密码字段，虽然密码字段是经过加密的那也很危险</p><p>创建disable_anon.ldif文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">dn: cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">add: olcDisallows</span><br><span class="line">olcDisallows: bind_anon</span><br><span class="line"></span><br><span class="line">dn: cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">add: olcRequires</span><br><span class="line">olcRequires: authc</span><br><span class="line"></span><br><span class="line">dn: olcDatabase=&#123;-1&#125;frontend,cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">add: olcRequires</span><br><span class="line">olcRequires: authc</span><br></pre></td></tr></table></figure><p>导入配置</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldapadd -Q -Y EXTERNAL -H ldapi:/// -f disable_anon.ldif</span><br></pre></td></tr></table></figure><h2 id="设置ACL"><a href="#设置ACL" class="headerlink" title="设置ACL"></a>设置ACL</h2><p>拒绝所有用户查看用户信息，并且添加有ldap管理账号</p><p>创建acl.ldif</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">dn: olcDatabase=&#123;2&#125;hdb,cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">replace: olcAccess</span><br><span class="line">olcAccess: to attrs=userPassword</span><br><span class="line">  by anonymous auth</span><br><span class="line">  by dn.base=&quot;cn=ldapadmin,ou=manage,dc=taovip,dc=com&quot; write</span><br><span class="line">  by * none</span><br><span class="line">olcAccess: to *</span><br><span class="line">  by anonymous auth</span><br><span class="line">  by dn.base=&quot;cn=ldapadmin,ou=manage,dc=taovip,dc=com&quot; write</span><br><span class="line">  by dn.base=&quot;cn=ldapread,ou=manage,dc=taovip,dc=com&quot; read</span><br><span class="line">  by * none</span><br></pre></td></tr></table></figure><p>导入配置</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldapmodify -Q -Y EXTERNAL -H ldapi:/// -f acl.ldif</span><br></pre></td></tr></table></figure><p>删除ACL</p><p>创建文件del_acl.ldif</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dn: olcDatabase=&#123;2&#125;hdb,cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">delete: olcAccess</span><br><span class="line">olcAccess: &#123;0&#125;</span><br></pre></td></tr></table></figure><p>导入配置</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldapmodify -Q -Y EXTERNAL -H ldapi:/// -f acl.ldif</span><br></pre></td></tr></table></figure><h2 id="创建管理用户"><a href="#创建管理用户" class="headerlink" title="创建管理用户"></a>创建管理用户</h2><p>创建add_ou.ldif</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">dn: ou=manage,dc=example,dc=com</span><br><span class="line">ou: manage</span><br><span class="line">description: Directory Manage</span><br><span class="line">objectClass: top</span><br><span class="line">objectClass: organizationalUnit</span><br></pre></td></tr></table></figure><p>创建add_manage_user.ldif</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">n: cn=ldapadmin,ou=manage,dc=example,dc=com</span><br><span class="line">cn: ldapadmin</span><br><span class="line">sn: ldapadmin</span><br><span class="line">uid: ldapadmin</span><br><span class="line">objectClass: top</span><br><span class="line">objectClass: shadowAccount</span><br><span class="line">objectClass: inetOrgPerson</span><br><span class="line">objectClass: organizationalPerson</span><br><span class="line">objectClass: person</span><br><span class="line">userPassword: &#123;SSHA&#125;4eDZHnxvfOOoAgSM6tDLDueCIUB9sRuDHVpVJ</span><br><span class="line"></span><br><span class="line">dn: cn=ldapread,ou=manage,dc=example,dc=com</span><br><span class="line">cn: ldapread</span><br><span class="line">sn: ldapread</span><br><span class="line">uid: ldapread</span><br><span class="line">objectClass: top</span><br><span class="line">objectClass: shadowAccount</span><br><span class="line">objectClass: inetOrgPerson</span><br><span class="line">objectClass: organizationalPerson</span><br><span class="line">objectClass: person</span><br><span class="line">userPassword: &#123;SSHA&#125;4eDZHnxvfOOoAgSM6tDLDueCIUB9sRuDHVpVJ</span><br></pre></td></tr></table></figure><p>导入配置</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ldapadd -x -D cn=root,dc=example,dc=com -W -f add_ou.ldif</span><br><span class="line">ldapadd -x -D cn=root,dc=example,dc=com -W -f add_manage_user.ldif</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;目的&quot;&gt;&lt;a href=&quot;#目的&quot; class=&quot;headerlink&quot; title=&quot;目的&quot;&gt;&lt;/a&gt;目的&lt;/h2&gt;&lt;p&gt;本文详细介绍了在centos7上安装最新版openldap的过程和常见场景。&lt;/p&gt;
&lt;h2 id=&quot;环境&quot;&gt;&lt;a href=&quot;#环境&quot; class=&quot;headerlink&quot; title=&quot;环境&quot;&gt;&lt;/a&gt;环境&lt;/h2&gt;&lt;p&gt;操作系统：centos7.6&lt;/p&gt;
&lt;p&gt;软件版本：openldap-2.4.44&lt;/p&gt;
&lt;p&gt;配置示例:   dc=example,dc=com&lt;/p&gt;
    
    </summary>
    
      <category term="应用运维" scheme="https://wandouduoduo.netlify.com/categories/%E5%BA%94%E7%94%A8%E8%BF%90%E7%BB%B4/"/>
    
    
      <category term="Openldap" scheme="https://wandouduoduo.netlify.com/tags/Openldap/"/>
    
  </entry>
  
  <entry>
    <title>基于OpenLDAP_MirrorMode的OpenLDAP高可用</title>
    <link href="https://wandouduoduo.netlify.com/articles/1c70a485.html"/>
    <id>https://wandouduoduo.netlify.com/articles/1c70a485.html</id>
    <published>2019-08-19T04:06:31.000Z</published>
    <updated>2019-08-28T06:06:19.186Z</updated>
    
    <content type="html"><![CDATA[<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>LDAP是一款轻量级目录访问协议（Lightweight Directory Access Protocol，简称LDAP），属于开源集中账号管理架构的实现，且支持众多系统版本，被广大互联网公司所采用。目录服务是一种特殊的数据库系统，对于数据的读取、浏览、搜索有很好的效果。同时做为用户中心，数据库的高可用显得尤为重要。在客户生产环境中使用的是客户的负载均衡设备，基于思杰的硬件负载均衡设备，后端配置的是OpenLDAP_MirrorMode,相当于Mysql的双主模式，后面某一台服务器出现问题，负载均衡会将后端的服务器剔除，另一台仍能提供服务，如下图所示<br><img src="/articles/1c70a485/1.png" alt="1"></p><a id="more"></a><h2 id="实验环境："><a href="#实验环境：" class="headerlink" title="实验环境："></a>实验环境：</h2><p>操作系统: centos 7.2<br>服务器A：10.10.1.134<br>服务器B：10.10.1.132</p><h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><ul><li><p>下载软件： </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir /home/admin/openldap &amp;&amp; cd /home/admin/openldap</span><br><span class="line"></span><br><span class="line">wget ftp://ftp.openldap.org/pub/OpenLDAP/openldap- release/openldap-2.4.23.tgz</span><br><span class="line">wget http://download.oracle.com/berkeley-db/db-4.6.21.tar.gz</span><br></pre></td></tr></table></figure></li><li><p>关闭selinux </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i '/SELINUX/s/enforcing/disabled/' /etc/selinux/config &amp;&amp; sestatus</span><br></pre></td></tr></table></figure></li><li><p>防火墙关闭 </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/bin/systemctl disable firewalld.service &amp;&amp; /bin/systemctl stop firewalld.service</span><br></pre></td></tr></table></figure></li><li><p>配置yum源为阿里云yum源</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">从阿里云镜像网站下载yum源配置文件到yum目录中</span></span><br><span class="line">wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo </span><br><span class="line"><span class="meta"> #</span><span class="bash">修改版本号为redhat7</span></span><br><span class="line">sed -i 's/$releasever/7/g' /etc/yum.repos.d/CentOS-Base.repo</span><br><span class="line"><span class="meta">#</span><span class="bash">清空yum缓存</span></span><br><span class="line">yum clean all</span><br><span class="line"><span class="meta">#</span><span class="bash">生成列表</span></span><br><span class="line">yum list</span><br></pre></td></tr></table></figure></li><li><p>安装openldap环境所需要的依赖包。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install libtool-ltdl libtool-ltdl-devel gcc openssl openssl-devel cyrus-sasl-lib.x86_64 cyrus-sasl-devel.x86_64 cyrus-sasl-plain.x86_64 cyrus-sasl-md5.x86_64 cyrus-sasl-ldap.x86_64</span><br></pre></td></tr></table></figure></li></ul><h2 id="安装openldap和Berkeley-DB"><a href="#安装openldap和Berkeley-DB" class="headerlink" title="安装openldap和Berkeley DB"></a>安装openldap和Berkeley DB</h2><h4 id="1-写在安装之前："><a href="#1-写在安装之前：" class="headerlink" title="1. 写在安装之前："></a>1. 写在安装之前：</h4><p>编译安装openldap需要数据库的支持，openldap的数据库支持<br>Berkeley DB,Oracle,Mysql,MariaDB,GDBM等数据库。默认openldap采用Berkeley DB，并且openldap对数据库有一定的要求，openldap 2.4的软件为例，需要Berkeley DB 4.4版本以上,所以在编译安装openldap源码包时需要先下载安装Berkeley DB</p><h4 id="2-编译安装Berkeley-DB"><a href="#2-编译安装Berkeley-DB" class="headerlink" title="2. 编译安装Berkeley DB"></a>2. 编译安装Berkeley DB</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">tar -xf db-4.6.21.tar.gz -C /usr/local/src</span><br><span class="line">cd /usr/local/src/db-4.6.21/build_unix/ &amp;&amp; mkdir /usr/local/BDB</span><br><span class="line">../dist/configure --prefix=/usr/local/BDB</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line">echo "/usr/local/BDB/lib/" &gt; /etc/ld.so.conf.d/bdb.conf</span><br><span class="line">ldconfig -v</span><br><span class="line">ln -sv /usr/local/BDB/include /usr/include/BDB</span><br></pre></td></tr></table></figure><h4 id="3-编译安装openldap"><a href="#3-编译安装openldap" class="headerlink" title="3. 编译安装openldap"></a>3. 编译安装openldap</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">tar -xf openldap-2.4.23.tgz -C /usr/<span class="built_in">local</span>/src/</span><br><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src/openldap-2.4.23/</span><br><span class="line">./configure --prefix=/usr/<span class="built_in">local</span>/openldap --<span class="built_in">enable</span>-syslog --<span class="built_in">enable</span>-modules --<span class="built_in">enable</span>-debug --with-tls CPPFLAGS=-I/usr/<span class="built_in">local</span>/BDB/include/ LDFLAGS=-L/usr/<span class="built_in">local</span>/BDB/lib/ --<span class="built_in">enable</span>-ldap --<span class="built_in">enable</span>-relay --<span class="built_in">enable</span>-accesslog --<span class="built_in">enable</span>-auditlog --<span class="built_in">enable</span>-syncprov --with-cyrus-sasl --<span class="built_in">enable</span>-spasswd</span><br><span class="line">make depend</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"/usr/local/openldap/lib/"</span> &gt; /etc/ld.so.conf.d/ldap.conf</span><br><span class="line">ldconfig -v</span><br><span class="line">ln -sv /usr/<span class="built_in">local</span>/openldap/include/ /usr/include/ldap</span><br><span class="line">ln -s /usr/<span class="built_in">local</span>/openldap/bin/* /usr/<span class="built_in">local</span>/bin/</span><br><span class="line">ln -s /usr/<span class="built_in">local</span>/openldap/sbin/* /usr/<span class="built_in">local</span>/sbin/</span><br></pre></td></tr></table></figure><h2 id="配置openldap"><a href="#配置openldap" class="headerlink" title="配置openldap"></a>配置openldap</h2><h4 id="1-配置openldap的方法有两种："><a href="#1-配置openldap的方法有两种：" class="headerlink" title="1. 配置openldap的方法有两种："></a>1. 配置openldap的方法有两种：</h4><ul><li>通过修改配置文件实现配置</li><li>通过配置数据库的形式完成配置（slapd.d下的数据库配置文件）,属于动态配置不需要重启slapd进程,<br>此配置文件在cn=config目录下的LDIF的配置文件 。此文件不建议手动修改，用ldap命令生成。</li></ul><h4 id="2-配置rootdn密码-optional"><a href="#2-配置rootdn密码-optional" class="headerlink" title="2. 配置rootdn密码(optional)"></a>2. 配置rootdn密码(optional)</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/openldap/bin/slappasswd  <span class="comment">#此密码记住，后面配置openldap会用到。</span></span><br></pre></td></tr></table></figure><h4 id="3-创建用户ldap"><a href="#3-创建用户ldap" class="headerlink" title="3. 创建用户ldap"></a>3. 创建用户ldap</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">useradd ldap</span><br></pre></td></tr></table></figure><h4 id="4-创建数据目录以及日志文件"><a href="#4-创建数据目录以及日志文件" class="headerlink" title="4. 创建数据目录以及日志文件"></a>4. 创建数据目录以及日志文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir /data/openldap/&#123;data,<span class="built_in">log</span>,var&#125; -p</span><br><span class="line"><span class="built_in">cd</span> /data/openldap/var/</span><br><span class="line">mkdir run</span><br></pre></td></tr></table></figure><h4 id="5-修改权限："><a href="#5-修改权限：" class="headerlink" title="5. 修改权限："></a>5. 修改权限：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cp /usr/<span class="built_in">local</span>/openldap/etc/openldap/DB_CONFIG.example /data/openldap/data/DB_CONFIG</span><br><span class="line">chown -R ldap:ldap /data/openldap/data</span><br><span class="line">chmod 700 -R /data/openldap/data</span><br></pre></td></tr></table></figure><h4 id="6-修改openldap配置文件"><a href="#6-修改openldap配置文件" class="headerlink" title="6. 修改openldap配置文件"></a>6. 修改openldap配置文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#编辑配置文件vim slapd.conf</span></span><br><span class="line"></span><br><span class="line">include /usr/<span class="built_in">local</span>/openldap/etc/openldap/schema/core.schema</span><br><span class="line">include /usr/<span class="built_in">local</span>/openldap/etc/openldap/schema/collective.schema</span><br><span class="line">include /usr/<span class="built_in">local</span>/openldap/etc/openldap/schema/corba.schema</span><br><span class="line">include /usr/<span class="built_in">local</span>/openldap/etc/openldap/schema/cosine.schema</span><br><span class="line">include /usr/<span class="built_in">local</span>/openldap/etc/openldap/schema/duaconf.schema</span><br><span class="line">include /usr/<span class="built_in">local</span>/openldap/etc/openldap/schema/dyngroup.schema</span><br><span class="line">include /usr/<span class="built_in">local</span>/openldap/etc/openldap/schema/inetorgperson.schema</span><br><span class="line">include /usr/<span class="built_in">local</span>/openldap/etc/openldap/schema/java.schema</span><br><span class="line">include /usr/<span class="built_in">local</span>/openldap/etc/openldap/schema/misc.schema</span><br><span class="line">include /usr/<span class="built_in">local</span>/openldap/etc/openldap/schema/nis.schema</span><br><span class="line">include /usr/<span class="built_in">local</span>/openldap/etc/openldap/schema/openldap.schema</span><br><span class="line">include /usr/<span class="built_in">local</span>/openldap/etc/openldap/schema/ppolicy.schema</span><br><span class="line">pidfile /data/openldap/var/run/slapd.pid</span><br><span class="line">argsfile /data/openldap/var/run/slapd.args</span><br><span class="line">loglevel 256</span><br><span class="line">logfile /data/openldap/<span class="built_in">log</span>/slapd.log</span><br><span class="line">moduleload syncprov.la <span class="comment"># 需要数据同步需要开启此模块</span></span><br><span class="line">database bdb</span><br><span class="line">directory /data/openldap/data</span><br><span class="line">suffix <span class="string">"dc=boe,dc=com"</span></span><br><span class="line">rootdn <span class="string">"cn=Manager,dc=boe,dc=com"</span></span><br><span class="line">rootpw &#123;SSHA&#125;eJtr5umAo23PqTKATU/X6D8swJ9yIlSx <span class="comment">#用slappasswd命令生成的密码</span></span><br><span class="line">index objectclass,entryCSN,entryUUID eq</span><br><span class="line">overlay syncprov</span><br><span class="line">syncprov-checkpoint 100 10</span><br><span class="line">syncprov-sessionlog 100</span><br><span class="line">serverID 2</span><br><span class="line">syncrepl rid=123</span><br><span class="line">provider=ldap://对端服务器ip</span><br><span class="line">bindmethod=simple</span><br><span class="line">binddn=<span class="string">"cn=Manager,dc=boe,dc=com"</span></span><br><span class="line">credentials=密码(管理员密码，这里是Manager的密码)</span><br><span class="line">searchbase=<span class="string">"dc=boe,dc=com"</span></span><br><span class="line">schemachecking=off</span><br><span class="line"><span class="built_in">type</span>=refreshAndPersist</span><br><span class="line">retry=<span class="string">"60 +"</span></span><br><span class="line">mirrormode on</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#两个服务器的配置文件有两个地方不一致</span></span><br><span class="line">1）serverID不一致 </span><br><span class="line">2）provider=ldap://对端的ip</span><br></pre></td></tr></table></figure><h4 id="7-开启日志功能"><a href="#7-开启日志功能" class="headerlink" title="7.开启日志功能"></a>7.开启日志功能</h4><ul><li>通过修改配置文件开启日志功能</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/etc/rsyslog.d/slapd.conf</span><br><span class="line">local4.* /data/openldap/<span class="built_in">log</span>/openldap.log</span><br><span class="line"></span><br><span class="line"><span class="comment">#重启rsyslog和slapd</span></span><br><span class="line">service rsyslog restart</span><br></pre></td></tr></table></figure><ul><li>通过修改数据库配置文件开启</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/root/loglevel.ldif &lt;&lt; EOF</span><br><span class="line">dn: cn=config</span><br><span class="line">changetype: modify</span><br><span class="line">replace: olcLogLevel</span><br><span class="line">olcLogLevel: stats</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment">#导入</span></span><br><span class="line">ldapadd -x -D <span class="string">"cn=Manager,dc=boe,dc=com"</span> -f ./loglevel.ldif -w secret</span><br></pre></td></tr></table></figure><h2 id="配置phpldpadmin工具"><a href="#配置phpldpadmin工具" class="headerlink" title="配置phpldpadmin工具"></a>配置phpldpadmin工具</h2><h4 id="1-安装和配置LDAP管理工具PHPldapadmin"><a href="#1-安装和配置LDAP管理工具PHPldapadmin" class="headerlink" title="1. 安装和配置LDAP管理工具PHPldapadmin"></a>1. 安装和配置LDAP管理工具PHPldapadmin</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum -y install httpd php php-ldap php-gd php-mbstring php-pear php-bcmath php-xml</span><br><span class="line">yum -y install epel-release</span><br><span class="line">yum --enablerepo=epel -y install phpldapadmin</span><br></pre></td></tr></table></figure><h4 id="2-修改配置文件"><a href="#2-修改配置文件" class="headerlink" title="2. 修改配置文件"></a>2. 修改配置文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/phpldapadmin/config.php +398</span><br><span class="line"><span class="comment">#397行取消注释，398行添加注释</span></span><br><span class="line"><span class="variable">$servers</span>-&gt;setValue(<span class="string">'login'</span>,<span class="string">'attr'</span>,<span class="string">'dn'</span>);</span><br><span class="line"></span><br><span class="line">vim /etc/httpd/密码 d/phpldapadmin.conf</span><br><span class="line">Apache 2.4</span><br><span class="line"></span><br><span class="line">Require all granted （修改此处)</span><br><span class="line">Order Deny,Allow</span><br><span class="line">Deny from all</span><br><span class="line">Allow from 127.0.0.1</span><br><span class="line">Allow from ::1</span><br></pre></td></tr></table></figure><h4 id="3-设置开机自启并启动Apache"><a href="#3-设置开机自启并启动Apache" class="headerlink" title="3. 设置开机自启并启动Apache"></a>3. 设置开机自启并启动Apache</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> httpd</span><br><span class="line">systemctl start httpd </span><br><span class="line"><span class="comment">#启动openldap</span></span><br><span class="line"><span class="comment">#/usr/local/openldap/libexec/slapd</span></span><br><span class="line"></span><br><span class="line">访问用http://ip/phpldapadmin访问如图</span><br></pre></td></tr></table></figure><p><img src="/articles/1c70a485/2.jpeg" alt="111"><br><img src="/articles/1c70a485/3.jpeg" alt="222"><br>在10.10.1.132上创建了一个OU名为testou,会发现10.10.1.132会自动同步到本地，如图:<br><img src="/articles/1c70a485/4.jpeg" alt="333"><br><img src="/articles/1c70a485/5.jpeg" alt="444"><br>两服务器日志如下：<br><img src="/articles/1c70a485/6.png" alt="555"><br><img src="https://yqfile.alicdn.com/224de6f3795b999de2bf35524cab63c4d066cb10.jpeg" alt="666"><br>以上结果得知，在镜像模式下，当其中一台服务器增加操作OU时，另一台也会同步增加，两台服务器均可进行读写操作，任何一台信息发生变化，都会以推的方式进行通知。</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;背景&quot;&gt;&lt;a href=&quot;#背景&quot; class=&quot;headerlink&quot; title=&quot;背景&quot;&gt;&lt;/a&gt;背景&lt;/h2&gt;&lt;p&gt;LDAP是一款轻量级目录访问协议（Lightweight Directory Access Protocol，简称LDAP），属于开源集中账号管理架构的实现，且支持众多系统版本，被广大互联网公司所采用。目录服务是一种特殊的数据库系统，对于数据的读取、浏览、搜索有很好的效果。同时做为用户中心，数据库的高可用显得尤为重要。在客户生产环境中使用的是客户的负载均衡设备，基于思杰的硬件负载均衡设备，后端配置的是OpenLDAP_MirrorMode,相当于Mysql的双主模式，后面某一台服务器出现问题，负载均衡会将后端的服务器剔除，另一台仍能提供服务，如下图所示&lt;br&gt;&lt;img src=&quot;/articles/1c70a485/1.png&quot; alt=&quot;1&quot;&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="应用运维" scheme="https://wandouduoduo.netlify.com/categories/%E5%BA%94%E7%94%A8%E8%BF%90%E7%BB%B4/"/>
    
    
      <category term="Openldap" scheme="https://wandouduoduo.netlify.com/tags/Openldap/"/>
    
  </entry>
  
  <entry>
    <title>自制yum源离线安装开发代码时的对应版本ansible</title>
    <link href="https://wandouduoduo.netlify.com/articles/fe96187b.html"/>
    <id>https://wandouduoduo.netlify.com/articles/fe96187b.html</id>
    <published>2019-08-16T08:59:17.000Z</published>
    <updated>2019-08-16T10:03:05.355Z</updated>
    
    <content type="html"><![CDATA[<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>由于在工作环境中，经常遇到批量安装的服务器，不具备连接互联网的条件。同时通过简单的下载安装 ansible 源码安装，又会遇到各种奇葩问题，推荐使用自制 yum 源方法，然后使用 yum安装 ansible。不得不说，ansible很好用，ansible团队也一致在维护和更新。但是，版本之间存在比较大的差异。以前写的代码，现在直接安装新版本的ansible后可能就不能用了，你想想下：代码中用到的类没有了，模块消失了，变量不见了等等，当然可以查看新的文档更改代码适应新版本，但是代码沉淀时间久了，做迁移还是会遇到这种问题，这个问题困扰了很多Devops。如何安装写代码时的版本，如何在断网模式下安装代码对应版本的ansible, 这成为了一种刚需和痛点，本文就以安装旧版本：2.3.1为例，详细阐述。</p><a id="more"></a><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><p><strong>操作系统版本</strong>：Centos7.2</p><p><strong>Python版本</strong>：  Python2.7.5</p><h2 id="操作步骤"><a href="#操作步骤" class="headerlink" title="操作步骤"></a>操作步骤</h2><h3 id="旧代码机器操作"><a href="#旧代码机器操作" class="headerlink" title="旧代码机器操作"></a>旧代码机器操作</h3><h5 id="安装-yumdownloader"><a href="#安装-yumdownloader" class="headerlink" title="安装 yumdownloader"></a>安装 yumdownloader</h5><p>准备一台可以连接互联网的相同版本系统的操作系统(安装环境一样)，使用yumdownloader工具下载ansible安装包以及所有依赖包。并以 root 身份安装 yumdownloader工具：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum  -y install  yum-utils</span><br></pre></td></tr></table></figure><h5 id="创建文件夹"><a href="#创建文件夹" class="headerlink" title="创建文件夹"></a>创建文件夹</h5><p>用于存放依赖的安装包</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir   /root/packages</span><br></pre></td></tr></table></figure><h5 id="更新国内yum源"><a href="#更新国内yum源" class="headerlink" title="更新国内yum源"></a>更新国内yum源</h5><p>由于默认的源里没有 ansible，需要安装国内快速稳定的yum源, 这里选择阿里源：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mv /etc/yum.repos.d/epel-7.repo /etc/yum.repos.d/epel-7.repo.bak</span><br><span class="line">wget -O /etc/yum.repos.d/epel-7.repo  http://mirrors.aliyun.com/repo/epel-7.repo </span><br><span class="line">yum clean all     <span class="comment"># 清除系统所有的yum缓存</span></span><br><span class="line">yum makecache     <span class="comment"># 生成yum缓存</span></span><br><span class="line">yum update</span><br></pre></td></tr></table></figure><h5 id="下载-ansible-和-所有依赖包"><a href="#下载-ansible-和-所有依赖包" class="headerlink" title="下载 ansible 和 所有依赖包"></a>下载 ansible 和 所有依赖包</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#下载ansible依赖包</span></span><br><span class="line">yumdownloader --resolve --destdir /root/packages   ansible</span><br><span class="line"><span class="comment">#下载createrepo依赖包</span></span><br><span class="line">yumdownloader --resolve --destdir /root/packages   createrepo</span><br><span class="line"></span><br><span class="line"><span class="comment"># 压缩安装包</span></span><br><span class="line">tar -Jcvf  packages.tar.xz   packages</span><br></pre></td></tr></table></figure><h3 id="新机器操作"><a href="#新机器操作" class="headerlink" title="新机器操作"></a>新机器操作</h3><p>将上面下载的所有 rpm 安装包打包，传输到需要批量的新服务器上，并解压到指定的文件夹里面</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 新机器解压到/mnt/下</span></span><br><span class="line">tar -Jxvf  packages.tar.xz   -C  /mnt/</span><br><span class="line"></span><br><span class="line">链接：https://pan.baidu.com/s/1FtZxpXk1AzZ_WcGVJFGE5w</span><br><span class="line">提取码：0sf2</span><br></pre></td></tr></table></figure><h5 id="首先创建-安装createrepo"><a href="#首先创建-安装createrepo" class="headerlink" title="首先创建 安装createrepo"></a>首先创建 安装createrepo</h5><p>进入 /mnt/packages 目录中</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rpm -ivh deltarpm-3.6-3.el7.x86_64.rpm</span><br><span class="line">rpm -ivh python-deltarpm-3.6-3.el7.x86_64.rpm</span><br><span class="line">rpm -ivh createrepo-0.9.9-28.el7.noarch.rpm</span><br></pre></td></tr></table></figure><h5 id="然后使用createrepo生成符合要求的yum仓库"><a href="#然后使用createrepo生成符合要求的yum仓库" class="headerlink" title="然后使用createrepo生成符合要求的yum仓库"></a>然后使用createrepo生成符合要求的yum仓库</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cd  /mnt</span></span><br><span class="line"><span class="comment"># createrepo /packages</span></span><br><span class="line"></span><br><span class="line">Spawning worker 0 with 25 pkgs</span><br><span class="line">Workers Finished</span><br><span class="line">Saving Primary metadata</span><br><span class="line">Saving file lists metadata</span><br><span class="line">Saving other metadata</span><br><span class="line">Generating sqlite DBs</span><br><span class="line">Sqlite DBs complete</span><br></pre></td></tr></table></figure><h5 id="配置本地-yum源"><a href="#配置本地-yum源" class="headerlink" title="配置本地 yum源"></a>配置本地 yum源</h5><p>把当前存在 yum 做备份，并移走别的目录</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vim  /etc/yum.repos.d/ansible.repo</span></span><br><span class="line">[ansibel]</span><br><span class="line">name=sun <span class="built_in">local</span> ansible</span><br><span class="line">baseurl=file:///mnt/packages</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line"></span><br><span class="line">保存退出，然后执行：</span><br><span class="line">yum clean all</span><br><span class="line">yum makecache</span><br></pre></td></tr></table></figure><h5 id="使用-yum安装-ansible"><a href="#使用-yum安装-ansible" class="headerlink" title="使用 yum安装 ansible"></a>使用 yum安装 ansible</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install ansible</span><br></pre></td></tr></table></figure><h5 id="验证安装成功："><a href="#验证安装成功：" class="headerlink" title="验证安装成功："></a>验证安装成功：</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ansible --version</span></span><br><span class="line">ansible 2.3.1.0</span><br><span class="line">  config file = /etc/ansible/ansible.cfg</span><br><span class="line">  configured module search path = Default w/o overrides</span><br><span class="line">  python version = 2.7.5 (default, Jun 20 2019, 20:27:34) [GCC 4.8.5 20150623 (Red Hat 4.8.5-36)]</span><br></pre></td></tr></table></figure><p>参考：<a href="https://www.jianshu.com/p/9a34d458de29" target="_blank" rel="noopener">https://www.jianshu.com/p/9a34d458de29</a></p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;背景&quot;&gt;&lt;a href=&quot;#背景&quot; class=&quot;headerlink&quot; title=&quot;背景&quot;&gt;&lt;/a&gt;背景&lt;/h2&gt;&lt;p&gt;由于在工作环境中，经常遇到批量安装的服务器，不具备连接互联网的条件。同时通过简单的下载安装 ansible 源码安装，又会遇到各种奇葩问题，推荐使用自制 yum 源方法，然后使用 yum安装 ansible。不得不说，ansible很好用，ansible团队也一致在维护和更新。但是，版本之间存在比较大的差异。以前写的代码，现在直接安装新版本的ansible后可能就不能用了，你想想下：代码中用到的类没有了，模块消失了，变量不见了等等，当然可以查看新的文档更改代码适应新版本，但是代码沉淀时间久了，做迁移还是会遇到这种问题，这个问题困扰了很多Devops。如何安装写代码时的版本，如何在断网模式下安装代码对应版本的ansible, 这成为了一种刚需和痛点，本文就以安装旧版本：2.3.1为例，详细阐述。&lt;/p&gt;
    
    </summary>
    
      <category term="应用运维" scheme="https://wandouduoduo.netlify.com/categories/%E5%BA%94%E7%94%A8%E8%BF%90%E7%BB%B4/"/>
    
    
      <category term="Ansible" scheme="https://wandouduoduo.netlify.com/tags/Ansible/"/>
    
  </entry>
  
</feed>
